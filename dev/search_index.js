var documenterSearchIndex = {"docs":
[{"location":"unitful/#Unitful","page":"Unitful","title":"Unitful","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Physical quantities in CarboKitten are always specified using the Unitful.jl framework.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">file:<i>test/Unitful.jl</i></div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@testset \"Unitful\" begin\n    using Unitful\n    using Unitful.DefaultSymbols\n    using CarboKitten.Utility\n\n    <<unitful-spec>>\nend","category":"page"},{"location":"unitful/#Variables-vs.-string-macros","page":"Unitful","title":"Variables vs. string macros","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Unitful package offers two basic ways to enter quantities: either using predefined symbols (polluting your namespace with one-letter variables), or using special string macros.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test 1.0m === 1.0u\"m\"\n@test 42J/s == 42u\"W\"","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"In many cases, your CarboKitten scripts will contain little else than the input specification. In such a case using Unitful.DefaultSymbols gives a bit cleaner, more readable look.","category":"page"},{"location":"unitful/#Reading-specs","page":"Unitful","title":"Reading specs","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Suppose we simulate a pendulum. We would have an input spec defined as follows:","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@kwdef struct Pendulum\n    length :: typeof(1.0m)\n    time_step :: typeof(1.0s)\n    phi0 :: typeof(1.0rad)\n    omega0 :: typeof(1.0rad/s)\nend","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Then input can be given as follows:","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"pendulum = Pendulum(\n    length = 2.0m,\n    time_step = 1ms,\n    phi0 = 30°,\n    omega0 = 0rad/s\n)","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Units are automatically converted to the types specified in the API.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test pendulum.time_step === 0.001s\n@test pendulum.phi0 === (π/6)rad","category":"page"},{"location":"unitful/#Dimensions","page":"Unitful","title":"Dimensions","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Unitful has dimensions of length 𝐋, mass 𝐌 and time 𝐓 as bold upper-case Unicode symbols. These can be entered in Julia with \\bfL, \\bfM etc. When you define a function that needs, say, an energy, which has SI units of rm J = (ms)^2 kg, we can construct the dimensions. Defining a few constants:","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"let 𝐄 = (𝐋/𝐓)^2 * 𝐌,\n    h = 6.62607015e-34u\"J*s\",\n    c = 299792458u\"m/s\"\n    <<unitful-photon-example>>\nend","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"We can abstract over the specific units by defining a generic method. Now we can compute the wavelength of a photon, given its energy in any unit of energy.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-photon-example⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"photon_wave_length(E::Quantity{Float64,𝐄,J}) where {J} =\n    uconvert(u\"Å\", h * c / E)\n\n@test photon_wave_length(2.38u\"eV\") ≈ 5209.4201u\"Å\"\n@test_throws MethodError photon_wave_length(1u\"m\")","category":"page"},{"location":"unitful/#Negating-Units","page":"Unitful","title":"Negating Units","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"There is a handy way of negating units (getting back to raw scalars) using the NoUnits function object.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test 23u\"km\" / u\"m\" |> NoUnits == 23000","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Now, suppose we have a Vector of which we don't know the exact units, but we want to save values in meters to HDF5. When we get a vector in meters, and divide by u\"m\", Unitful will simplify and return a plain Vector{Float64}. However, if the units were u\"km\", then we need to convert by multiplying by 1000. We could do vec .|> NoUnits, but this will always allocate a new vector, even when it is not needed. We have the short-hand in_units_of that solves this issue.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test 23u\"km\" |> in_units_of(u\"m\") == 23000\n@test [4, 5, 6]u\"m\" |> in_units_of(u\"m\") == [4, 5, 6]","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡utility⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"function in_units_of(unit)\n    function magnitude(a)\n        error(\"Units of $(a*unit) not compatible with $unit\")\n    end\n\n    function magnitude(a::AbstractArray{Quantity{RT, NoDims, U}, dim}) where {RT <: Real, U, dim}\n        return a .|> NoUnits\n    end\n\n    function magnitude(a::AbstractArray{RT, dim}) where {RT <: Real, dim}\n        return a\n    end\n\n    function magnitude(a::RT) where {RT <: Real}\n        return a\n    end\n\n    function magnitude(a::Quantity{RT, NoDims, U}) where {RT <: Real, U}\n        return a |> NoUnits\n    end\n\n    function (x)\n        x / unit |> magnitude\n    end\nend","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"","category":"page"},{"location":"references/#References","page":"References","title":"References","text":"","category":"section"},{"location":"references/","page":"References","title":"References","text":"H. Bosscher and W. Schlager. Computer simulation of reef growth. Sedimentology 39, 503–512 (1992).\n\n\n\nK. G. Miller, J. V. Browning, W. J. Schmelz, R. E. Kopp, G. S. Mountain and J. D. Wright. Cenozoic sea-level relative to modern from deep-sea geochemical and continental margin records (2020).\n\n\n\nP. M. Burgess. CarboCAT: A cellular automata model of heterogeneous carbonate strata. Computers & geosciences 53, 129–140 (2013).\n\n\n\nC. Paola, P. L. Heller and C. L. Angevine. The large-scale dynamics of grain-size variation in alluvial basins, 1: Theory. Basin research 4, 73–90 (1992).\n\n\n\nS. C. James, C. A. Jones, M. D. Grace and J. D. Roberts. Advances in sediment transport modelling. Journal of Hydraulic Research 48, 754–763 (2010).\n\n\n\nK. G. Miller, M. A. Kominz, J. V. Browning, J. D. Wright, G. S. Mountain, M. E. Katz, P. J. Sugarman, B. S. Cramer, N. Christie-Blick and S. F. Pekar. The Phanerozoic Record of Global Sea-Level Change. Science 310, 1293–1298 (2005). Publisher: American Association for the Advancement of Science.\n\n\n\nY. Yang, Y.-C. Lang, S. Xu, C.-Q. Liu, L.-F. Cui, S. P. Freeman and K. M. Wilcken. Combined unsteady denudation and climatic gradient factors constrain carbonate landscape evolution: New insights from in situ cosmogenic 36Cl. Quaternary Geochronology 58, 101075 (2020). Accessed on Jul 24, 2024.\n\n\n\nF. Thomas, V. Godard, O. Bellier, L. Benedetti, V. Ollivier, M. Rizza, V. Guillou, F. Hollender, G. Aumaître, D. L. Bourlès and K. Keddadouche. Limited influence of climatic gradients on the denudation of a Mediterranean carbonate landscape. Geomorphology 316, 44–58 (2018).\n\n\n\nK. Krklec, R. Braucher, D. Perica and D. Domínguez-Villar. Long-term denudation rate of karstic North Dalmatian Plain (Croatia) calculated from 36Cl cosmogenic nuclides. Geomorphology 413, 108358 (2022). Accessed on Jul 24, 2024.\n\n\n\nP. Thapa. Spatial estimation of soil erosion using RUSLE modeling: a case study of Dolakha district, Nepal. Environmental Systems Research 9, 15 (2020).\n\n\n\nG. Kaufmann and J. Braun. Modelling karst denudation on a synthetic landscape. Terra Nova 13, 313–320 (2001).\n\n\n\nF. Gabrovšek. On concepts and methods for the estimation of dissolutional denudation rates in karst areas. Geomorphology 106, 9–14 (2009). Accessed on Jul 11, 2024.\n\n\n\nG. Kaufmann and W. Dreybrodt. Calcite dissolution kinetics in the system CaCO3–H2O–CO2 at high undersaturation. Geochimica et Cosmochimica Acta 71, 1398–1410 (2007). Accessed on Jul 11, 2024.\n\n\n\nG. Tucker, S. Lancaster, N. Gasparini and R. Bras. The Channel-Hillslope Integrated Landscape Development Model (CHILD). In: Landscape Erosion and Evolution Modeling, edited by R. S. Harmon and W. W. Doe (Springer US, 2001); pp. 349–388. Accessed on Jul 24, 2024.\n\n\n\nM. J. Van De Wiel, T. J. Coulthard, M. G. Macklin and J. Lewin. Embedding reach-scale fluvial dynamics within the CAESAR cellular automaton landscape evolution model. Geomorphology 90, 283–301 (2007). Accessed on Jul 24, 2024.\n\n\n\n","category":"page"},{"location":"references/","page":"References","title":"References","text":"","category":"page"},{"location":"components/boxes/#Box","page":"Boxes","title":"Box","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"57.5\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"This module makes sure we have access to box properties.","category":"page"},{"location":"components/boxes/#Box-topology","page":"Boxes","title":"Box topology","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"CarboKitten has a 3-dimensional state space, where two dimensions represent cartesian topographic coordinates, and the third dimension is a track record of sedimentation. The cartesian topographic coordinates are always on a regular grid, but depending on the scenario you may choose different map topologies.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"periodic boundaries To study sedimentation in a small isolated patch, periodic boundaries seem sufficient. The field is assumed to be infinite in all directions.\nVon Neumann boundaries In the case of an island it is nicer to have boundaries with constant derivatives. Produced sediment that flows out of the box is lost to the seas.\ncoastal boundaries Supposing we simulate a narrow cross section of a coast, we'll have one periodic boundary (in y-direction) and Von Neumann boundaries in the x-direction.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"We parametrize these boundaries as type-level constants in Julia. This way we can use the multiple dispatch mechanism in Julia to obtain specialized implementations for each boundary case, selected at compile time, resulting in efficient run-times.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡boundary-types⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"abstract type Boundary{dim} end\nstruct Reflected{dim} <: Boundary{dim} end\nstruct Periodic{dim} <: Boundary{dim} end\nstruct Constant{dim,value} <: Boundary{dim} end\nstruct Coast <: Boundary{2} end\n\nconst Shelf = Coast  # FIXME: Old name, should be removed\n\n@inline modflip(a, l) = let b = mod1(a, 2l)\n    b > l ? 2l - b + 1 : b\nend\n\n@inline get_bounded(::Type{Constant{dim, value}}, a, i) where {dim, value} =\n    checkbounds(Bool, a, i) ? a[i] : val\n\n@inline get_bounded(::Type{Periodic{dim}}, a, i) where {dim} =\n    checkbounds(Bool, a, i) ? a[i] : a[mod1.(Tuple(i), size(a))...]\n\n@inline get_bounded(::Type{Reflected{dim}}, a, i) where {dim} =\n    checkbounds(Bool, a, i) ? a[i] : a[modflip.(Tuple(i), size(a))...]\n\n@inline get_bounded(::Type{Coast}, a, i) =\n    checkbounds(Bool, a, i) ? a[i] : a[modflip(i[1], size(a)[1]), mod1(i[2], size(a)[2])]","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"The Boundary type is part of the generic Box dimension specification.","category":"page"},{"location":"components/boxes/#Offset-indexing","page":"Boxes","title":"Offset indexing","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"Now we can use these topology types to define three methods for indexing on an offset from some index that is assumed to be within bounds.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡spec⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"@testset \"offset_value\" begin\n    @test CartesianIndex(1, 1) == offset_index(Reflected{2}, (3, 3), CartesianIndex(1, 1), CartesianIndex(0, 0))\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡offset-indexing⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"function offset_index(::Type{BT}, shape::NTuple{dim,Int}, i::CartesianIndex, Δi::CartesianIndex) where {dim, BT <: Boundary{dim}}\n    canonical(BT, shape, i + Δi)\nend\n\nfunction offset_value(BT::Type{B}, z::AbstractArray, i::CartesianIndex, Δi::CartesianIndex) where {dim,B<:Boundary{dim}}\n    z[offset_index(BT, size(z), i, Δi)]\nend\n\nfunction offset_value(::Type{Constant{dim,value}}, z::AbstractArray, i::CartesianIndex, Δi::CartesianIndex) where {dim,value}\n    j = i + Δi\n    (checkbounds(Bool, z, j) ? z[j] : value)\nend","category":"page"},{"location":"components/boxes/#Canonical-coordinates","page":"Boxes","title":"Canonical coordinates","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"For both Periodic and Reflected boundaries it is also possible to write a function that makes any coordinate within bounds. This uses the fact that reflected boundaries are also periodic for a box twice the size.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡canonical-coordinates⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"function canonical(::Type{Periodic{dim}}, shape::NTuple{dim,Int}, i::CartesianIndex) where {dim}\n    CartesianIndex(mod1.(Tuple(i), shape)...)\nend\n\nfunction canonical(::Type{Reflected{dim}}, shape::NTuple{dim,Int}, i::CartesianIndex) where {dim}\n    modflip(a, l) = let b = mod1(a, 2l)\n        b > l ? 2l - b + 1 : b\n    end\n    CartesianIndex(modflip.(Tuple(i), shape)...) \nend\n\nfunction canonical(::Type{Constant{dim, value}}, shape::NTuple{dim,Int}, i::CartesianIndex) where {dim, value}\n    all(checkindex.(Bool, range.(1, shape), Tuple(i))) ? i : nothing\nend","category":"page"},{"location":"components/boxes/#Coast-boundary","page":"Boxes","title":"Coast boundary","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"The Coast boundary type is specially designed for the simulation of a transect perpendicular to the coast direction. We are periodic in the y-direction and have a Neumannesque constant boundary at the edges of the simulation area.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡offset-indexing⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"function canonical(::Type{Coast}, shape::NTuple{2, Int}, i::CartesianIndex)\n    if i[1] < 1 || i[1] > shape[1]\n        return nothing\n    end\n    return CartesianIndex(i[1], mod1(i[2], shape[2]))\nend\n\nfunction offset_value(::Type{Coast}, z::AbstractArray, i::CartesianIndex, Δi::CartesianIndex)\n    j = i + Δi\n    shape = size(z)\n    if j[1] < 1\n        return z[1, mod1(j[2], shape[2])]\n    elseif j[1] > shape[1]\n        return z[shape[1], mod1(j[2], shape[2])]\n    else\n        return z[j[1], mod1(j[2], shape[2])]\n    end\nend","category":"page"},{"location":"components/boxes/#BoundaryTrait-module","page":"Boxes","title":"BoundaryTrait module","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/BoundaryTrait.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"# FIXME: Rename this module\nmodule BoundaryTrait\n\nexport Boundary, Reflected, Periodic, Constant, Coast, Shelf, offset_index, offset_value, canonical, get_bounded\n\n<<boundary-types>>\n<<offset-indexing>>\n<<canonical-coordinates>>\n\nend","category":"page"},{"location":"components/boxes/#Box-properties","page":"Boxes","title":"Box properties","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡box-type⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"const axes = box_axes\n\nphys_size(grid_size, phys_scale) = (\n    x = grid_size[1] * (phys_scale / m |> NoUnits),\n    y = grid_size[2] * (phys_scale / m |> NoUnits))","category":"page"},{"location":"components/boxes/#Floating-point-vectors","page":"Boxes","title":"Floating-point vectors","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"We need to define how particles move past boundaries. Similar to the grid based offset_index method, we define the offset method for a Vec2.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡vector-offset⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"Base.in(a::Vec2, box::Box) =\n    a.x >= 0.0 && a.x < box.phys_size.x && a.y >= 0.0 && a.y < box.phys_size.y\n\nfunction offset(box::AbstractBox{Reflected{2}}, a::Vec2, Δa::Vec2)\n    clip(i, a, b) = (i < a ? a + a - i : (i > b ? b + b - i : i))\n    (x=clip(a.x+Δa.x, 0.0, box.phys_size.x)\n    ,y=clip(a.y+Δa.y, 0.0, box.phys_size.y))\nend\n\nfunction offset(box::AbstractBox{Periodic{2}}, a::Vec2, Δa::Vec2)\n    (x=mod(a.x+Δa.x, box.phys_size.x)\n    ,y=mod(a.y+Δa.y, box.phys_size.y))\nend\n\nfunction offset(box::AbstractBox{Constant{2,Value}}, a::Vec2, Δa::Vec2) where Value\n    b = a + Δa\n    if b ∉ box\n        nothing\n    else\n        b\n    end\nend\n\nfunction offset(box::AbstractBox{Shelf}, a::Vec2, Δa::Vec2)\n    b = a + Δa\n    if b.x < 0.0 || b.x >= box.phys_size.x\n        nothing\n    else\n        (x=b.x, y=mod(b.y, box.phys_size.y))\n    end\nend","category":"page"},{"location":"components/boxes/#Modules","page":"Boxes","title":"Modules","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Boxes.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"module Boxes\n\nusing ..BoundaryTrait\nusing ..CarboKitten: AbstractBox, Box, box_axes\nusing ..Vectors\n\nusing Unitful\nusing Unitful.DefaultSymbols\n\nexport AbstractBox, Box, box_axes\n\n<<box-type>>\n<<vector-offset>>\n\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>test/Components/BoxesSpec.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"module BoxesSpec\n    using Test\n    using CarboKitten.Components.Common\n    using CarboKitten.Components.Boxes\n\n    @testset \"Components/Boxes\" begin\n        let box = Box{Periodic{2}}(grid_size=(10, 10), phys_scale=2.0u\"m\"),\n            input = Boxes.Input(box=box)\n            @test input.box.grid_size == (10, 10)\n            @test input.box.phys_scale == 2.0u\"m\"\n        end\n    end\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Components/Boxes.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"@compose module Boxes\nusing ..Common\n\n@kwdef struct Input <: AbstractInput\n    box::Box\nend\n\nfunction write_header(fid, input::AbstractInput)\n    x, y = box_axes(input.box)\n\n    gid = fid[\"input\"]\n    gid[\"x\"] = collect(x) |> in_units_of(u\"m\")\n    gid[\"y\"] = collect(y) |> in_units_of(u\"m\")\nend\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"","category":"page"},{"location":"components/production/#Production","page":"Production","title":"Production","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"500pt\" height=\"412pt\"\n viewBox=\"0.00 0.00 500.00 412.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 408)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-408 496,-408 496,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-404C150,-404 12,-404 12,-404 6,-404 0,-398 0,-392 0,-392 0,-337 0,-337 0,-331 6,-325 12,-325 12,-325 150,-325 150,-325 156,-325 162,-331 162,-337 162,-337 162,-392 162,-392 162,-398 156,-404 150,-404\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-373.5 155,-373.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-382.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-350.5 7,-373.5 54,-373.5 54,-350.5 7,-350.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-350.5 54,-350.5 54,-373.5 7,-373.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-358.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-350.5 54,-373.5 108,-373.5 108,-350.5 54,-350.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-350.5 54,-373.5 108,-373.5 108,-350.5 54,-350.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-358.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-350.5 108,-373.5 155,-373.5 155,-350.5 108,-350.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-373.5 108,-373.5 108,-350.5 155,-350.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-358.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-331.5 54,-350.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-338.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-331.5 108,-350.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-338.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-338.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node2\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-289C300,-289 42,-289 42,-289 36,-289 30,-283 30,-277 30,-277 30,-184 30,-184 30,-178 36,-172 42,-172 42,-172 300,-172 300,-172 306,-172 312,-178 312,-184 312,-184 312,-277 312,-277 312,-283 306,-289 300,-289\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-258.5 305,-258.5 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-267.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"37,-235.5 37,-258.5 154,-258.5 154,-235.5 37,-235.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-235.5 154,-235.5 154,-258.5 37,-258.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-243.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-235.5 154,-258.5 208,-258.5 208,-235.5 154,-235.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-235.5 154,-258.5 208,-258.5 208,-235.5 154,-235.5\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-243.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-235.5 208,-258.5 305,-258.5 305,-235.5 208,-235.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-258.5 208,-258.5 208,-235.5 305,-235.5 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-243.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-216.5 154,-235.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-216.5 208,-235.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-197.5 154,-216.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-197.5 208,-216.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-178.5 154,-197.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-178.5 208,-197.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M107.27,-324.97C113.07,-316.46 119.38,-307.21 125.69,-297.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"128.73,-299.7 131.48,-289.47 122.95,-295.76 128.73,-299.7\"/>\n</g>\n<!-- Production -->\n<g id=\"node5\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M414.5,-136C414.5,-136 167.5,-136 167.5,-136 161.5,-136 155.5,-130 155.5,-124 155.5,-124 155.5,-12 155.5,-12 155.5,-6 161.5,0 167.5,0 167.5,0 414.5,0 414.5,0 420.5,0 426.5,-6 426.5,-12 426.5,-12 426.5,-124 426.5,-124 426.5,-130 420.5,-136 414.5,-136\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"163,-106 420,-106 \"/>\n<text text-anchor=\"start\" x=\"247.5\" y=\"-114.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"163,-83 163,-106 232,-106 232,-83 163,-83\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"163,-83 232,-83 232,-106 163,-106 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-90.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"232,-83 232,-106 373,-106 373,-83 232,-83\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"232,-83 232,-106 373,-106 373,-83 232,-83\"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-90.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"373,-83 373,-106 420,-106 420,-83 373,-83\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"420,-106 373,-106 373,-83 420,-83 \"/>\n<text text-anchor=\"start\" x=\"377\" y=\"-90.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-64 232,-83 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-71\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"373,-64 373,-83 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-71\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"376\" y=\"-71\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-45 232,-64 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-52\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"373,-45 373,-64 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-52\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"376\" y=\"-52\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-26 232,-45 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"373,-26 373,-45 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"376\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-7 232,-26 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"373,-7 373,-26 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">production_offset</text>\n<text text-anchor=\"start\" x=\"376\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge3\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M214.32,-171.56C220.97,-162.67 227.91,-153.38 234.79,-144.18\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"237.62,-146.24 240.8,-136.14 232.01,-142.05 237.62,-146.24\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node3\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-404C330,-404 192,-404 192,-404 186,-404 180,-398 180,-392 180,-392 180,-337 180,-337 180,-331 186,-325 192,-325 192,-325 330,-325 330,-325 336,-325 342,-331 342,-337 342,-337 342,-392 342,-392 342,-398 336,-404 330,-404\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-373.5 335,-373.5 \"/>\n<text text-anchor=\"start\" x=\"237.5\" y=\"-382.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-350.5 187,-373.5 234,-373.5 234,-350.5 187,-350.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-350.5 234,-350.5 234,-373.5 187,-373.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-358.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-350.5 234,-373.5 288,-373.5 288,-350.5 234,-350.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-350.5 234,-373.5 288,-373.5 288,-350.5 234,-350.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-358.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-350.5 288,-373.5 335,-373.5 335,-350.5 288,-350.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-373.5 288,-373.5 288,-350.5 335,-350.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-358.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-331.5 234,-350.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-338.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-331.5 288,-350.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-338.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-338.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M234.73,-324.97C228.93,-316.46 222.62,-307.21 216.31,-297.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"219.05,-295.76 210.52,-289.47 213.27,-299.7 219.05,-295.76\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M480,-270C480,-270 342,-270 342,-270 336,-270 330,-264 330,-258 330,-258 330,-203 330,-203 330,-197 336,-191 342,-191 342,-191 480,-191 480,-191 486,-191 492,-197 492,-203 492,-203 492,-258 492,-258 492,-264 486,-270 480,-270\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-239.5 485,-239.5 \"/>\n<text text-anchor=\"start\" x=\"367\" y=\"-248.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"337,-216.5 337,-239.5 384,-239.5 384,-216.5 337,-216.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-216.5 384,-216.5 384,-239.5 337,-239.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"384,-216.5 384,-239.5 438,-239.5 438,-216.5 384,-216.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"384,-216.5 384,-239.5 438,-239.5 438,-216.5 384,-216.5\"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"438,-216.5 438,-239.5 485,-239.5 485,-216.5 438,-216.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"485,-239.5 438,-239.5 438,-216.5 485,-216.5 \"/>\n<text text-anchor=\"start\" x=\"442\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"384,-197.5 384,-216.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"438,-197.5 438,-216.5 \"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"441\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge4\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M381.95,-190.65C371.56,-176.74 359.45,-160.56 347.53,-144.61\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"350.12,-142.22 341.33,-136.31 344.51,-146.42 350.12,-142.22\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"The Production module specifies the production rate following the model by Bosscher & Schlager 1992 [1]. The growth rate is given as","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"g(w) = g_m tanhleft(I_0 e^-kw over I_kright)","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"This can be understood as a smooth transition between the maximum growth rate under saturated conditions, and exponential decay due to light intensity dropping with greater water depth.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">⪡component-production-rate⪢≣</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"function production_rate(insolation, facies, water_depth)\n    gₘ = facies.maximum_growth_rate\n    offset = facies.production_offset\n    I = insolation / facies.saturation_intensity\n    x = (water_depth - offset) * facies.extinction_coefficient\n    return x > 0.0 ? gₘ * tanh(I * exp(-x)) : 0.0u\"m/Myr\"\nend","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"From just this equation we can define a uniform production process. This requires that we have a Facies that defines the maximum_growth_rate, extinction_coefficient and saturation_intensity.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"The insolation input may be given as a scalar quantity, say 400u\"W/m^2\", or as a function of time.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"The production_offset is the uppermost length of the water column in which no production occurs. If production_offset is > 0, the maximum production is shifted downwards in the water column by production_offset.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">file:<i>src/Components/Production.jl</i></div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@compose module Production\n@mixin TimeIntegration, WaterDepth, FaciesBase\nusing ..Common\nusing ..WaterDepth: water_depth\nusing ..TimeIntegration: time, write_times\nusing HDF5\nusing Logging\n\nexport production_rate, uniform_production\n\n@kwdef struct Facies <: AbstractFacies\n    maximum_growth_rate::Rate\n    extinction_coefficient::typeof(1.0u\"m^-1\")\n    saturation_intensity::Intensity\n    production_offset::Height = 0.0u\"m\"\nend\n\n@kwdef struct Input <: AbstractInput\n    insolation\nend\n\nfunction insolation(input::AbstractInput)\n    insolation = input.insolation\n    tprop = input.time\n    if insolation isa Quantity\n        return s -> insolation\n    end\n    if insolation isa AbstractVector\n        @info \"Reading insolation from a table\"\n        return s -> insolation[s.step+1]\n    end\n    @info \"Reading insolation from a function\"\n    function (s::AbstractState)\n        t = time(tprop, s)\n        return insolation(t)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    if input.insolation isa Quantity\n        fid[\"input\"][\"insolation\"] = fill(input.insolation |> in_units_of(u\"W/m^2\"), input.time.steps)\n    elseif input.insolation isa AbstractVector\n        fid[\"input\"][\"insolation\"] = input.insolation |> in_units_of(u\"W/m^2\")\n    else\n        t = write_times(input)[1:end-1]\n        fid[\"input\"][\"insolation\"] = input.insolation.(t) |> in_units_of(u\"W/m^2\")\n    end\n\n    # fid[\"input\"][\"insolation\"] = insolation(input) |> in_units_of(u\"W/m^2\")\n    for (i, f) in enumerate(input.facies)\n        attr = attributes(fid[\"input/facies$(i)\"])\n        attr[\"maximum_growth_rate\"] = f.maximum_growth_rate |> in_units_of(u\"m/Myr\")\n        attr[\"extinction_coefficient\"] = f.extinction_coefficient |> in_units_of(u\"m^-1\")\n        attr[\"saturation_intensity\"] = f.saturation_intensity |> in_units_of(u\"W/m^2\")\n    end\nend\n\n<<component-production-rate>>\n\nfunction uniform_production(input::AbstractInput)\n    w = water_depth(input)\n    na = [CartesianIndex()]\n    insolation_func = insolation(input)\n    facies = input.facies\n\n    return function (state::AbstractState)\n        return production_rate.(\n            insolation_func(state),\n            facies[:, na, na],\n            w(state)[na, :, :])\n    end\nend\nend","category":"page"},{"location":"components/production/#CA-Production","page":"Production","title":"CA Production","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"614pt\" height=\"484pt\"\n viewBox=\"0.00 0.00 613.50 484.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 480)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-480 609.5,-480 609.5,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M210,-476C210,-476 72,-476 72,-476 66,-476 60,-470 60,-464 60,-464 60,-409 60,-409 60,-403 66,-397 72,-397 72,-397 210,-397 210,-397 216,-397 222,-403 222,-409 222,-409 222,-464 222,-464 222,-470 216,-476 210,-476\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-445.5 215,-445.5 \"/>\n<text text-anchor=\"start\" x=\"75.5\" y=\"-454.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"67,-422.5 67,-445.5 114,-445.5 114,-422.5 67,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-422.5 114,-422.5 114,-445.5 67,-445.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"114,-422.5 114,-445.5 168,-445.5 168,-422.5 114,-422.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"114,-422.5 114,-445.5 168,-445.5 168,-422.5 114,-422.5\"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"168,-422.5 168,-445.5 215,-445.5 215,-422.5 168,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"215,-445.5 168,-445.5 168,-422.5 215,-422.5 \"/>\n<text text-anchor=\"start\" x=\"172\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"114,-403.5 114,-422.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"168,-403.5 168,-422.5 \"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"171\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M270,-361C270,-361 12,-361 12,-361 6,-361 0,-355 0,-349 0,-349 0,-256 0,-256 0,-250 6,-244 12,-244 12,-244 270,-244 270,-244 276,-244 282,-250 282,-256 282,-256 282,-349 282,-349 282,-355 276,-361 270,-361\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-330.5 275,-330.5 \"/>\n<text text-anchor=\"start\" x=\"93.5\" y=\"-339.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-307.5 7,-330.5 124,-330.5 124,-307.5 7,-307.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-307.5 124,-307.5 124,-330.5 7,-330.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-315.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"124,-307.5 124,-330.5 178,-330.5 178,-307.5 124,-307.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"124,-307.5 124,-330.5 178,-330.5 178,-307.5 124,-307.5\"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-315.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"178,-307.5 178,-330.5 275,-330.5 275,-307.5 178,-307.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-330.5 178,-330.5 178,-307.5 275,-307.5 \"/>\n<text text-anchor=\"start\" x=\"182\" y=\"-315.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-288.5 124,-307.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-295.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-288.5 178,-307.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-295.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-295.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-269.5 124,-288.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-269.5 178,-288.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-250.5 124,-269.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-250.5 178,-269.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M141,-396.97C141,-388.98 141,-380.34 141,-371.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"144.5,-371.47 141,-361.47 137.5,-371.47 144.5,-371.47\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node2\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M474,-476C474,-476 336,-476 336,-476 330,-476 324,-470 324,-464 324,-464 324,-409 324,-409 324,-403 330,-397 336,-397 336,-397 474,-397 474,-397 480,-397 486,-403 486,-409 486,-409 486,-464 486,-464 486,-470 480,-476 474,-476\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"331,-445.5 479,-445.5 \"/>\n<text text-anchor=\"start\" x=\"381.5\" y=\"-454.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"331,-422.5 331,-445.5 378,-445.5 378,-422.5 331,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"331,-422.5 378,-422.5 378,-445.5 331,-445.5 \"/>\n<text text-anchor=\"start\" x=\"335\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"378,-422.5 378,-445.5 432,-445.5 432,-422.5 378,-422.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"378,-422.5 378,-445.5 432,-445.5 432,-422.5 378,-422.5\"/>\n<text text-anchor=\"start\" x=\"382\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"432,-422.5 432,-445.5 479,-445.5 479,-422.5 432,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"479,-445.5 432,-445.5 432,-422.5 479,-422.5 \"/>\n<text text-anchor=\"start\" x=\"436\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"378,-403.5 378,-422.5 \"/>\n<text text-anchor=\"start\" x=\"335\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"432,-403.5 432,-422.5 \"/>\n<text text-anchor=\"start\" x=\"382\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"435\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M327.93,-396.97C308.35,-387.18 286.82,-376.41 265.54,-365.77\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"266.95,-362.56 256.44,-361.22 263.82,-368.82 266.95,-362.56\"/>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node7\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M593.5,-189C593.5,-189 332.5,-189 332.5,-189 326.5,-189 320.5,-183 320.5,-177 320.5,-177 320.5,-103 320.5,-103 320.5,-97 326.5,-91 332.5,-91 332.5,-91 593.5,-91 593.5,-91 599.5,-91 605.5,-97 605.5,-103 605.5,-103 605.5,-177 605.5,-177 605.5,-183 599.5,-189 593.5,-189\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"328,-159 599,-159 \"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-167.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"328,-136 328,-159 421,-159 421,-136 328,-136\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"328,-136 421,-136 421,-159 328,-159 \"/>\n<text text-anchor=\"start\" x=\"332\" y=\"-143.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"421,-136 421,-159 526,-159 526,-136 421,-136\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"421,-136 421,-159 526,-159 526,-136 421,-136\"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-143.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"526,-136 526,-159 599,-159 599,-136 526,-136\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"599,-159 526,-159 526,-136 599,-136 \"/>\n<text text-anchor=\"start\" x=\"530\" y=\"-143.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"421,-117 421,-136 \"/>\n<text text-anchor=\"start\" x=\"332\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"526,-117 526,-136 \"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"529\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"421,-98 421,-117 \"/>\n<text text-anchor=\"start\" x=\"332\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"526,-98 526,-117 \"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"529\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge7\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M448.74,-396.61C457.81,-386.05 466.1,-373.93 471,-361 490.78,-308.84 485.41,-244.64 477.13,-199.09\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"480.53,-198.25 475.21,-189.08 473.66,-199.57 480.53,-198.25\"/>\n</g>\n<!-- Production -->\n<g id=\"node5\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M290.5,-208C290.5,-208 43.5,-208 43.5,-208 37.5,-208 31.5,-202 31.5,-196 31.5,-196 31.5,-84 31.5,-84 31.5,-78 37.5,-72 43.5,-72 43.5,-72 290.5,-72 290.5,-72 296.5,-72 302.5,-78 302.5,-84 302.5,-84 302.5,-196 302.5,-196 302.5,-202 296.5,-208 290.5,-208\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"39,-178 296,-178 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-186.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"39,-155 39,-178 108,-178 108,-155 39,-155\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"39,-155 108,-155 108,-178 39,-178 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-162.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-155 108,-178 249,-178 249,-155 108,-155\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"108,-155 108,-178 249,-178 249,-155 108,-155\"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-162.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"249,-155 249,-178 296,-178 296,-155 249,-155\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"296,-178 249,-178 249,-155 296,-155 \"/>\n<text text-anchor=\"start\" x=\"253\" y=\"-162.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-136 108,-155 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-143\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"249,-136 249,-155 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-143\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"252\" y=\"-143\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-117 108,-136 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"249,-117 249,-136 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"252\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-98 108,-117 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"249,-98 249,-117 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"252\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-79 108,-98 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-86\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"249,-79 249,-98 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-86\" font-family=\"monospace\" font-size=\"10.00\">production_offset</text>\n<text text-anchor=\"start\" x=\"252\" y=\"-86\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge3\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150.39,-243.56C151.72,-235.29 153.12,-226.69 154.5,-218.14\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"157.98,-218.57 156.12,-208.14 151.07,-217.45 157.98,-218.57\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M450,-342C450,-342 312,-342 312,-342 306,-342 300,-336 300,-330 300,-330 300,-275 300,-275 300,-269 306,-263 312,-263 312,-263 450,-263 450,-263 456,-263 462,-269 462,-275 462,-275 462,-330 462,-330 462,-336 456,-342 450,-342\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-311.5 455,-311.5 \"/>\n<text text-anchor=\"start\" x=\"337\" y=\"-320.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"307,-288.5 307,-311.5 354,-311.5 354,-288.5 307,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-288.5 354,-288.5 354,-311.5 307,-311.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"354,-288.5 354,-311.5 408,-311.5 408,-288.5 354,-288.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"354,-288.5 354,-311.5 408,-311.5 408,-288.5 354,-288.5\"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"408,-288.5 408,-311.5 455,-311.5 455,-288.5 408,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"455,-311.5 408,-311.5 408,-288.5 455,-288.5 \"/>\n<text text-anchor=\"start\" x=\"412\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"354,-269.5 354,-288.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"408,-269.5 408,-288.5 \"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"411\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge4\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M329.47,-262.85C309.97,-248.23 287.08,-231.06 264.73,-214.3\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"266.63,-211.35 256.53,-208.15 262.43,-216.95 266.63,-211.35\"/>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge8\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M400.85,-262.65C410.72,-243.33 422.84,-219.6 433.75,-198.24\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"436.91,-199.75 438.35,-189.26 430.68,-196.57 436.91,-199.75\"/>\n</g>\n<!-- CAProduction -->\n<g id=\"node6\" class=\"node\">\n<title>CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M364.5,-36C364.5,-36 265.5,-36 265.5,-36 259.5,-36 253.5,-30 253.5,-24 253.5,-24 253.5,-12 253.5,-12 253.5,-6 259.5,0 265.5,0 265.5,0 364.5,0 364.5,0 370.5,0 376.5,-6 376.5,-12 376.5,-12 376.5,-24 376.5,-24 376.5,-30 370.5,-36 364.5,-36\"/>\n<text text-anchor=\"start\" x=\"260.5\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAProduction</text>\n</g>\n<!-- Production&#45;&gt;CAProduction -->\n<g id=\"edge6\" class=\"edge\">\n<title>Production&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M249.65,-71.98C262.61,-61.48 275.21,-51.26 285.83,-42.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"288.33,-45.13 293.89,-36.11 283.92,-39.69 288.33,-45.13\"/>\n</g>\n<!-- CellularAutomaton&#45;&gt;CAProduction -->\n<g id=\"edge5\" class=\"edge\">\n<title>CellularAutomaton&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M403.66,-90.88C383.2,-74.3 361.19,-56.45 344.21,-42.69\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"346.29,-39.86 336.31,-36.28 341.88,-45.3 346.29,-39.86\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"The CAProduction component gives production that depends on the provided CA.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">file:<i>src/Components/CAProduction.jl</i></div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@compose module CAProduction\n    @mixin TimeIntegration, CellularAutomaton, Production\n    using ..Common\n    using ..Production: production_rate, insolation\n    using ..WaterDepth: water_depth\n    using Logging\n\n    function production(input::AbstractInput)\n        w = water_depth(input)\n        na = [CartesianIndex()]\n        output = Array{Amount, 3}(undef, n_facies(input), input.box.grid_size...)\n\n        w = water_depth(input)\n        s = insolation(input)\n        n_f = n_facies(input)\n        facies = input.facies\n        Δt = input.time.Δt\n\n        return function(state::AbstractState)\n            insolation = s(state)\n            for f = 1:n_f\n                output[f, :, :] = ifelse.(\n                    state.ca .== f,\n                    production_rate.(insolation, (facies[f],), w(state)) .* Δt,\n                    0.0u\"m\")\n            end\n            return output\n        end\n    end\nend","category":"page"},{"location":"components/production/#Tests","page":"Production","title":"Tests","text":"","category":"section"},{"location":"components/production/#If-production-is-higher-in-shallower-water","page":"Production","title":"If production is higher in shallower water","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">⪡production-spec⪢≣</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@testset \"Components/Production\" begin\n    let facies = Facies(\n            maximum_growth_rate = 500u\"m/Myr\",\n            extinction_coefficient = 0.8u\"m^-1\",\n            saturation_intensity = 60u\"W/m^2\"),\n        input = Input(\n            box = Box{Periodic{2}}(grid_size=(10, 1), phys_scale=1.0u\"m\"),\n            time = TimeProperties(Δt=1.0u\"kyr\", steps=10),\n            sea_level = t -> 0.0u\"m\",\n            initial_topography = (x, y) -> -10u\"m\",\n            subsidence_rate = 0.0u\"m/Myr\",\n            facies = [facies],\n            insolation = 400.0u\"W/m^2\")\n\n        state = initial_state(input)\n        prod = uniform_production(input)(state)\n        @test all(prod[1:end-1,:] .>= prod[2:end,:])\n    end\nend","category":"page"},{"location":"components/production/#Variable-insolation","page":"Production","title":"Variable insolation","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"If insolation increases linearly with time, production at t = 10 should be higher than at t = 1.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">⪡production-spec⪢≣</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@testset \"Components/Production/variable_insolation\" begin\n    let facies = Facies(\n            maximum_growth_rate = 500u\"m/Myr\",\n            extinction_coefficient = 0.8u\"m^-1\",\n            saturation_intensity = 60u\"W/m^2\"),\n        input = Input(\n            box = Box{Periodic{2}}(grid_size=(10, 1), phys_scale=1.0u\"m\"),\n            time = TimeProperties(Δt=1.0u\"kyr\", steps=10),\n            sea_level = t -> 0.0u\"m\",\n            initial_topography = (x, y) -> -10u\"m\",\n            subsidence_rate = 0.0u\"m/Myr\",\n            facies = [facies],\n            insolation = t -> 40.0u\"W/m^2/kyr\" * t)\n\n        state = initial_state(input)\n        state.step = 1\n        prod1 = copy(uniform_production(input)(state))\n        state.step = 10\n        prod2 = copy(uniform_production(input)(state))\n        @test all(prod2 .> prod1)\n    end\nend","category":"page"},{"location":"components/production/#Production-offset","page":"Production","title":"Production offset","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"Check if there is no production above the offset depth.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">⪡production-spec⪢≣</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@testset \"Components/Production/offset\" begin\n    let facies = Facies(\n            maximum_growth_rate = 500u\"m/Myr\",\n            extinction_coefficient = 0.8u\"m^-1\",\n            saturation_intensity = 60u\"W/m^2\",\n            production_offset = 5.0u\"m\"),\n        input = Input(\n            box = Box{Periodic{2}}(grid_size=(10, 1), phys_scale=1.0u\"m\"),\n            time = TimeProperties(Δt=1.0u\"kyr\", steps=10),\n            sea_level = t -> 0.0u\"m\",\n            initial_topography = (x, y) -> -x,\n            subsidence_rate = 0.0u\"m/Myr\",\n            facies = [facies],\n            insolation = 400.0u\"W/m^2\")\n\n        state = initial_state(input)\n        prod = uniform_production(input)(state)\n        @test all(prod[1,1:5,1] .== 0.0u\"m/Myr\")\n        @test all(prod[1,7:10,1] .> 0.0u\"m/Myr\")\n    end\nend","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">file:<i>test/Components/ProductionSpec.jl</i></div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"module ProductionSpec\n    using Test\n    using CarboKitten.Components.Common\n    using CarboKitten.Components.Production: Facies, Input, uniform_production\n    using CarboKitten.Components.WaterDepth: initial_state\n\n    <<production-spec>>\nend","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"","category":"page"},{"location":"active-layer-transport/#Active-Layer-Transport","page":"Active Layer Transport","title":"Active Layer Transport","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The following is inspired on well-known active layer approaches in river bed sediment transport [4] [5] [1]. All quantities with subscript f are facies dependent. Sediment is measured in meters of deposited material. P_f is the production of sediment per facies in ms. Further unit calculations would be more readable if we consider the unit of sediment as separate, so for instance it doesn't cancel against m^2 in the units of sediment flux. In the implementation, nu has the units of rm m which is totaly weird. TBC","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"[1]: Literature on active (or mixing) layer transport modeling is vast. Most of which is concerned with much smaller time scales, and more complicated physics than we are mostly dealing with.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"In a model without transport, we could write","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"sigma + sum_f partial eta_f over partial t = sum_f P_f","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"where sigma is the subsidence rate in ms. We consider the mass balance for each facies separately.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"We suppose that loose sediment, either fresh production or disintegrated older sediment, is being transported in a layer on top of the sea bed. The flux in this layer is assumed to be directly proportional to the local slope of the sea bed  nabla_x eta_* , where eta_* = sum_f eta_f, the sum over all facies contributions, including eta_0, the initial bedrock eleveation.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Schematic of Active Layer approach)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The active layer now contains a concentration C_f particles of different grain size (for each facies f). If needed, C_f = alpha_f P_f where alpha_f is some facies parameter determining the fraction of production that is available for transport. The sediment flux is given as,","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"bf q_f = -nu_f C_f bf nabla_x eta_*","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The following is the mass balance:","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"sigma + partial eta_* over partial t = -sum_f bf nabla_x cdot bf q_f + sum_f P_f","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"In our modelling we keep track of individual contributions per facies over time [2].","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"[2]: Note that in other approaches to active layer transport, like Paola 1992, there would be a factor 1C_f. Here we have a different interpretation to what the concentration means: the sediment settles down after transport, such that the concentration has no impact on the change in sediment surface elevation.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Combining these equations, and ignoring subsidence for the moment (which is a global effect and can't be expressed on a per-facies basis), we get a component-wise diffusion equation","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"partial eta_f(x)overpartial t = bf nabla_x cdot big nu_f alpha_f P_f(x) bf nabla_x eta_*(x) big + P_f(x)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"In our model we need to solve this equation one time-step each iteration. If we solve this using forward methods, we should be reminded of the CFL limit for diffusion equations (depending on the diffusion constants and grid size we shouldn't pick the time steps too large). Alternatively, for these two-dimensional situations, an implicit approach is feasible. Also we should take care that somehow nabla(nualpha P nabla eta) + P  0. The interpretation being that we can't transport more than we produce, even if there is capacity to do so.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"To solve this equation, it is nicer to expand the transport-diffusion term using the product rule, in short notation:","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"partial_t eta_f = nu nabla P_f(x) cdot nabla eta(x) + nu P_f(x) nabla^2 eta(x) + P_f(x)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"where nu = nu_f alpha_f","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"So we have a advection component with velocity nu nabla P_f and a diffusion component with a coefficient nu P_f.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"As part of the production P_f we disintegrate older sediment at a fixed rate.","category":"page"},{"location":"active-layer-transport/#Test-1:-production-transport","page":"Active Layer Transport","title":"Test 1: production transport","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Suppose we have an incline in one direction, as per usual on a coastal slice. Production is happening in a circular patch in our box, with constant rate. In addition, we'll release the top 1m of sediment for further transport.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<details><summary>Test model</summary>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/active-layer.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"module ActiveLayer\n\nusing Unitful\nusing CarboKitten.Config: Box, axes\nusing CarboKitten.BoundaryTrait: Shelf\nusing CarboKitten.Utility: in_units_of\nusing CarboKitten.Transport.ActiveLayer: pde_stencil, Amount, Rate\n\n<<example-active-layer>>\n\nend","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"</details>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Our input structure facilitates a single facies, specifying an initial bedrock elevation, sediment layer and a function for a location dependent constant production rate. The transport is parametrized by a disintegration rate and a diffusion coefficient.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡example-active-layer⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"@kwdef struct Input\n    box\n    Δt::typeof(1.0u\"Myr\")\n    t_end::typeof(1.0u\"Myr\")\n    initial_topography   # function (x::u\"m\", y::u\"m\") -> u\"m\"\n    initial_sediment    # function (x::u\"m\", y::u\"m\") -> u\"m\"\n    production          # function (x::u\"m\", y::u\"m\") -> u\"m/s\"\n    disintegration_rate::typeof(1.0u\"m/Myr\")\n    subsidence_rate::typeof(1.0u\"m/Myr\")\n    diffusion_coefficient::typeof(1.0u\"m/yr\")\nend","category":"page"},{"location":"active-layer-transport/#Production-patch","page":"Active Layer Transport","title":"Production patch","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Establish a grid of 100x50, 15km on each side, dropping from 0 to 50m depth. Keeping the disintegration rate to a similar value as the production rate seems a sensible choice.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡example-active-layer⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"production_patch(center, radius, rate) = function(x, y)\n    (pcx, pcy) = center\n    (x - pcx)^2 + (y - pcy)^2 < radius^2 ?\n        rate :\n        0.0u\"m/Myr\"\nend\n\nconst input = Input(\n    box=Box{Shelf}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n    Δt=0.001u\"Myr\",\n    t_end=1.0u\"Myr\",\n\n    initial_topography = (x, y) -> -x / 300.0,\n    initial_sediment = (x, y) -> 0.0u\"m\",\n\n    production = production_patch(\n        (5000.0u\"m\", 3750.0u\"m\"),\n        2.0u\"km\",\n        50.0u\"m/Myr\"),\n\n    disintegration_rate = 50.0u\"m/Myr\",\n    subsidence_rate = 50.0u\"m/Myr\",\n\n    diffusion_coefficient = 10.0u\"m/yr\"\n)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Production patch on an inclining bedrock)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/active-layer-plot-production.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| requires: examples/transport/active-layer.jl\n#| creates: docs/src/_fig/active-layer-production-patch.png\n#| collect: figures\n\ninclude(\"active-layer.jl\")\nusing Unitful\nusing CarboKitten.Config: axes\nusing CarboKitten.Utility: in_units_of\nusing CairoMakie\nusing .ActiveLayer: input\n\nfunction main()\n  (x, y) = axes(input.box)\n  η = input.initial_topography.(x, y')\n  p = input.production.(x, y')\n\n  fig = Figure()\n  ax = Axis3(fig[1,1], xlabel=\"x (km)\", ylabel=\"y (km)\", zlabel=\"η (m)\", azimuth=5π/3)\n  surface!(ax, x |> in_units_of(u\"km\"), y |> in_units_of(u\"km\"), η |> in_units_of(u\"m\"), color = p |> in_units_of(u\"m/Myr\"))\n  save(\"docs/src/_fig/active-layer-production-patch.png\", fig)\nend\n\nmain()","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"</details>","category":"page"},{"location":"active-layer-transport/#Solving-the-PDE","page":"Active Layer Transport","title":"Solving the PDE","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Just as a reminder:","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"partial_t eta_f = nu nabla P_f(x) cdot nabla eta(x) + nu P_f(x) nabla^2 eta(x) + P_f(x)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Below is the kernel encoding a central differencing scheme i.e. [-1, 0, 1]/(2Δx) for first derivative and [0 -1 0; -1 4 -1; 0 -1 0]/Δx^2 for the laplacian.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>src/Transport/ActiveLayer.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"module ActiveLayer\n\nusing Unitful\nusing StaticArrays\nusing ...BoundaryTrait\nusing ...Boxes: Box\nusing ...Stencil: stencil!\n\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Amount = typeof(1.0u\"m\")\n\nfunction pde_stencil(box::Box{BT}, Δt, ν, out, η, C) where {BT<:Boundary{2}}\n    Δx = box.phys_scale\n    d = ν * Δt\n\n    stencil!(BT, Size(3, 3), out, η, C) do η, C\n        adv = d * ((η[3, 2] - η[1, 2]) * (C[3, 2] - C[1, 2]) +\n                   (η[2, 3] - η[2, 1]) * (C[2, 3] - C[2, 1])) /\n              (2Δx)^2\n\n        dif = d * C[2, 2] * (η[3, 2] + η[2, 3] + η[1, 2] +\n                             η[2, 1] - 4 * η[2, 2]) / (Δx)^2\n\n        prd = C[2, 2]\n\n        max(0.0u\"m\", adv + dif + prd)\n    end\nend\n\nend","category":"page"},{"location":"active-layer-transport/#Model-loop","page":"Active Layer Transport","title":"Model loop","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Every iteration we determine the maximum disintegrated sediment. If the total amount of sediment is smaller than the maximum, then that amount is disintegrated instead. We compute the concentrations in the active layer in terms of amounts of sediment, so P Delta t. Since P appears in every term of the PDE, we're free to do so.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡example-active-layer⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"mutable struct State\n    time::typeof(1.0u\"Myr\")\n    sediment::Matrix{typeof(1.0u\"m\")}\nend\n\nfunction initial_state(input)\n    x, y = axes(input.box)\n    State(0.0u\"Myr\", input.initial_sediment.(x, y'))\nend\n\nstruct Frame\n    t::typeof(1.0u\"Myr\")\n    δ::Matrix{Amount}\nend\n\nfunction propagator(input)\n    δ = Matrix{Amount}(undef, input.box.grid_size...)\n    x, y = axes(input.box)\n    μ0 = input.initial_topography.(x, y')\n    box = input.box\n    Δt = input.Δt\n    disintegration_rate = input.disintegration_rate\n    production = input.production\n    d = input.diffusion_coefficient\n\n    function active_layer(state)\n        max_amount = disintegration_rate * Δt\n        amount = min.(max_amount, state.sediment)\n        state.sediment .-= amount\n\n        production.(x, y') * Δt .+ amount\n    end\n\n    function (state)\n        p = active_layer(state)\n        pde_stencil(box, Δt, d, δ, state.sediment .+ μ0, p)\n        return Frame(state.time, δ)\n    end\nend\n\nfunction run_model(input)\n    state = initial_state(input)\n    prop = propagator(input)\n\n    Channel{State}() do ch\n        while state.time < input.t_end\n            Δ = prop(state)\n            state.sediment .+= Δ.δ\n            state.time += input.Δt\n            put!(ch, state)\n        end\n    end\nend","category":"page"},{"location":"active-layer-transport/#Running-the-model","page":"Active Layer Transport","title":"Running the model","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"We run the model with 1000 time steps but only inspect one in every 100.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Active layer test)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/active-layer-plot-result.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| requires: examples/transport/active-layer.jl\n#| creates: docs/src/_fig/active-layer-test.png\n#| collect: figures\n\nmodule ActiveLayerPlot\n\ninclude(\"active-layer.jl\")\nusing CairoMakie\nusing Unitful\nusing CarboKitten.Config: axes\nusing CarboKitten.Utility: in_units_of\nusing .ActiveLayer: input, run_model\n\nfunction main()\n  result = Iterators.map(deepcopy,\n      Iterators.filter(x -> mod(x[1], 100) == 0, enumerate(run_model(input)))) |> collect\n\n    (x, y) = axes(input.box)\n    η = input.initial_topography.(x, y') .+ result[10][2].sediment .- input.subsidence_rate * result[10][2].time\n    # p = input.production.(x, y')\n\n    fig = Figure(size=(800, 1000))\n    ax = Axis3(fig[1:2,1], xlabel=\"x (km)\", ylabel=\"y (km)\", zlabel=\"η (m)\", azimuth=5π/3)\n    surface!(ax, x |> in_units_of(u\"km\"), y |> in_units_of(u\"km\"), η |> in_units_of(u\"m\"))\n\n    ax2 = Axis(fig[3,1], xlabel=\"x (km)\", ylabel=\"η (m)\")\n\n    for i in 1:10\n        η = input.initial_topography.(x, y') .+ result[i][2].sediment .- input.subsidence_rate * result[i][2].time\n\n        lines!(ax2, x |> in_units_of(u\"km\"), η[:, 25] |> in_units_of(u\"m\"))\n    end\n\n    save(\"docs/src/_fig/active-layer-test.png\", fig)\nend\n\nend\n\nActiveLayerPlot.main()","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"</details>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Note in the bottom figure, due to sedimentation not keeping up with subsidence, the lines go down in time. We see the sediment transport being favoured to downslope areas, which is what we want. This effect could be made more extreme by increasing the disintegration rate.","category":"page"},{"location":"active-layer-transport/#Test-2:-erosion","page":"Active Layer Transport","title":"Test 2: erosion","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Suppose now we have no production, but we start with a steep gradient in the existing sediment. We expect this gradient to erode.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"In the input we set the production to zero, but we specify an initial sediment that contains both a step and a top-hat function. Erodability of these kind of features could be a measurable quantity to which we could potentially calibrate this transport model.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Note that, due to the way we populate the active layer, the gradient nabla P will vanish, leaving us with a pure diffusion system.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡example-active-layer-erosion⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"function initial_sediment(x, y)\n  if x < 5.0u\"km\"\n    return 30.0u\"m\"\n  end\n\n  if x > 10.0u\"km\" && x < 11.0u\"km\"\n    return 20.0u\"m\"\n  end\n\n  return 5.0u\"m\"\nend\n\nconst INPUT = ActiveLayer.Input(\n    box                   = Box{Shelf}(grid_size=(100, 1), phys_scale=150.0u\"m\"),\n    Δt                    = 0.001u\"Myr\",\n    t_end                 = 1.0u\"Myr\",\n\n    initial_topography     = (x, y) -> -30.0u\"m\",\n    initial_sediment      = initial_sediment,\n    production            = (x, y) -> 0.0u\"m/Myr\",\n\n    disintegration_rate   = 50.0u\"m/Myr\",\n    subsidence_rate       = 50.0u\"m/Myr\",\n    diffusion_coefficient = 10.0u\"m/yr\")","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Active layer erosion test)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/active-layer-erosion.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| requires: examples/transport/active-layer.jl\n#| creates: docs/src/_fig/active-layer-erosion.png\n#| collect: figures\n\nmodule ActiveLayerErosion\n\ninclude(\"active-layer.jl\")\n\nusing Unitful\nusing CarboKitten.BoundaryTrait: Shelf\nusing CarboKitten.Config: Box, axes\nusing CarboKitten.Utility: in_units_of\nusing CairoMakie\n\n<<example-active-layer-erosion>>\n\nfunction main(input)\n    y_idx = 1\n    result = Iterators.map(deepcopy,\n          Iterators.filter(x -> mod(x[1]-1, 400) == 0, enumerate(ActiveLayer.run_model(input)))) |> collect\n\n    (x, y) = axes(input.box)\n    # p = input.production.(x, y')\n\n    fig = Figure(size=(800, 600))\n    # ax = Axis3(fig[1:2,1], xlabel=\"x (km)\", ylabel=\"y (km)\", zlabel=\"η (m)\", azimuth=5π/3)\n    # surface!(ax, x |> in_units_of(u\"km\"), y |> in_units_of(u\"km\"), η |> in_units_of(u\"m\"))\n\n    ax2 = Axis(fig[1,1], xlabel=\"x (km)\", ylabel=\"η (m)\")\n\n    for r in result\n        η = input.initial_topography.(x, y') .+ r[2].sediment .- input.subsidence_rate * r[2].time\n\n        lines!(ax2, x |> in_units_of(u\"km\"), η[:, y_idx] |> in_units_of(u\"m\"))\n    end\n\n    save(\"docs/src/_fig/active-layer-erosion.png\", fig)\nend\n\nend\n\nActiveLayerErosion.main(ActiveLayerErosion.INPUT)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"</details>","category":"page"},{"location":"active-layer-transport/#Active-Layer-Component","page":"Active Layer Transport","title":"Active Layer Component","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"800pt\" height=\"393pt\"\n viewBox=\"0.00 0.00 800.00 393.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 389)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-389 796,-389 796,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M210,-385C210,-385 72,-385 72,-385 66,-385 60,-379 60,-373 60,-373 60,-318 60,-318 60,-312 66,-306 72,-306 72,-306 210,-306 210,-306 216,-306 222,-312 222,-318 222,-318 222,-373 222,-373 222,-379 216,-385 210,-385\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-354.5 215,-354.5 \"/>\n<text text-anchor=\"start\" x=\"75.5\" y=\"-363.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"67,-331.5 67,-354.5 114,-354.5 114,-331.5 67,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-331.5 114,-331.5 114,-354.5 67,-354.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"114,-331.5 114,-354.5 168,-354.5 168,-331.5 114,-331.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"114,-331.5 114,-354.5 168,-354.5 168,-331.5 114,-331.5\"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"168,-331.5 168,-354.5 215,-354.5 215,-331.5 168,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"215,-354.5 168,-354.5 168,-331.5 215,-331.5 \"/>\n<text text-anchor=\"start\" x=\"172\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"114,-312.5 114,-331.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"168,-312.5 168,-331.5 \"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"171\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node2\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M270,-270C270,-270 12,-270 12,-270 6,-270 0,-264 0,-258 0,-258 0,-165 0,-165 0,-159 6,-153 12,-153 12,-153 270,-153 270,-153 276,-153 282,-159 282,-165 282,-165 282,-258 282,-258 282,-264 276,-270 270,-270\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-239.5 275,-239.5 \"/>\n<text text-anchor=\"start\" x=\"93.5\" y=\"-248.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-216.5 7,-239.5 124,-239.5 124,-216.5 7,-216.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-216.5 124,-216.5 124,-239.5 7,-239.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"124,-216.5 124,-239.5 178,-239.5 178,-216.5 124,-216.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"124,-216.5 124,-239.5 178,-239.5 178,-216.5 124,-216.5\"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"178,-216.5 178,-239.5 275,-239.5 275,-216.5 178,-216.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-239.5 178,-239.5 178,-216.5 275,-216.5 \"/>\n<text text-anchor=\"start\" x=\"182\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-197.5 124,-216.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-197.5 178,-216.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-178.5 124,-197.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-178.5 178,-197.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-159.5 124,-178.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-159.5 178,-178.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M141,-305.97C141,-297.98 141,-289.34 141,-280.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"144.5,-280.47 141,-270.47 137.5,-280.47 144.5,-280.47\"/>\n</g>\n<!-- ActiveLayer -->\n<g id=\"node6\" class=\"node\">\n<title>ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M528.5,-117C528.5,-117 233.5,-117 233.5,-117 227.5,-117 221.5,-111 221.5,-105 221.5,-105 221.5,-12 221.5,-12 221.5,-6 227.5,0 233.5,0 233.5,0 528.5,0 528.5,0 534.5,0 540.5,-6 540.5,-12 540.5,-12 540.5,-105 540.5,-105 540.5,-111 534.5,-117 528.5,-117\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"229,-86.5 534,-86.5 \"/>\n<text text-anchor=\"start\" x=\"335.5\" y=\"-95.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">ActiveLayer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"229,-63.5 229,-86.5 352,-86.5 352,-63.5 229,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"229,-63.5 352,-63.5 352,-86.5 229,-86.5 \"/>\n<text text-anchor=\"start\" x=\"233\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"352,-63.5 352,-86.5 487,-86.5 487,-63.5 352,-63.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"352,-63.5 352,-86.5 487,-86.5 487,-63.5 352,-63.5\"/>\n<text text-anchor=\"start\" x=\"356\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"487,-63.5 487,-86.5 534,-86.5 534,-63.5 487,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"534,-86.5 487,-86.5 487,-63.5 534,-63.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"352,-44.5 352,-63.5 \"/>\n<text text-anchor=\"start\" x=\"233\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">disintegration_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-44.5 487,-63.5 \"/>\n<text text-anchor=\"start\" x=\"356\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">diffusion_coefficient</text>\n<text text-anchor=\"start\" x=\"490\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"352,-25.5 352,-44.5 \"/>\n<text text-anchor=\"start\" x=\"233\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\">transport_solver</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-25.5 487,-44.5 \"/>\n<text text-anchor=\"start\" x=\"356\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\">wave_velocity</text>\n<text text-anchor=\"start\" x=\"490\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"352,-6.5 352,-25.5 \"/>\n<text text-anchor=\"start\" x=\"233\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">transport_substeps</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-6.5 487,-25.5 \"/>\n<text text-anchor=\"start\" x=\"356\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"490\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;ActiveLayer -->\n<g id=\"edge4\" class=\"edge\">\n<title>WaterDepth&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M232.42,-152.98C248.18,-143.07 264.64,-132.71 280.62,-122.66\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"282.84,-125.4 289.44,-117.11 279.11,-119.47 282.84,-125.4\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node3\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M547,-385C547,-385 409,-385 409,-385 403,-385 397,-379 397,-373 397,-373 397,-318 397,-318 397,-312 403,-306 409,-306 409,-306 547,-306 547,-306 553,-306 559,-312 559,-318 559,-318 559,-373 559,-373 559,-379 553,-385 547,-385\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"404,-354.5 552,-354.5 \"/>\n<text text-anchor=\"start\" x=\"454.5\" y=\"-363.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"404,-331.5 404,-354.5 451,-354.5 451,-331.5 404,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"404,-331.5 451,-331.5 451,-354.5 404,-354.5 \"/>\n<text text-anchor=\"start\" x=\"408\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"451,-331.5 451,-354.5 505,-354.5 505,-331.5 451,-331.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"451,-331.5 451,-354.5 505,-354.5 505,-331.5 451,-331.5\"/>\n<text text-anchor=\"start\" x=\"455\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"505,-331.5 505,-354.5 552,-354.5 552,-331.5 505,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"552,-354.5 505,-354.5 505,-331.5 552,-331.5 \"/>\n<text text-anchor=\"start\" x=\"509\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"451,-312.5 451,-331.5 \"/>\n<text text-anchor=\"start\" x=\"408\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"505,-312.5 505,-331.5 \"/>\n<text text-anchor=\"start\" x=\"455\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"508\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M396.85,-312.71C365.3,-300.35 328.09,-285.78 291.97,-271.63\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"292.91,-268.24 282.32,-267.85 290.35,-274.76 292.91,-268.24\"/>\n</g>\n<!-- SedimentBuffer -->\n<g id=\"node5\" class=\"node\">\n<title>SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M780,-260.5C780,-260.5 492,-260.5 492,-260.5 486,-260.5 480,-254.5 480,-248.5 480,-248.5 480,-174.5 480,-174.5 480,-168.5 486,-162.5 492,-162.5 492,-162.5 780,-162.5 780,-162.5 786,-162.5 792,-168.5 792,-174.5 792,-174.5 792,-248.5 792,-248.5 792,-254.5 786,-260.5 780,-260.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-230.5 785,-230.5 \"/>\n<text text-anchor=\"start\" x=\"573\" y=\"-239.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">SedimentBuffer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"487,-207.5 487,-230.5 634,-230.5 634,-207.5 487,-207.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-207.5 634,-207.5 634,-230.5 487,-230.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-215.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"634,-207.5 634,-230.5 688,-230.5 688,-207.5 634,-207.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"634,-207.5 634,-230.5 688,-230.5 688,-207.5 634,-207.5\"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-215.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"688,-207.5 688,-230.5 785,-230.5 785,-207.5 688,-207.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"785,-230.5 688,-230.5 688,-207.5 785,-207.5 \"/>\n<text text-anchor=\"start\" x=\"692\" y=\"-215.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"634,-188.5 634,-207.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-195.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer_size</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"688,-188.5 688,-207.5 \"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-195.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"691\" y=\"-195.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"634,-169.5 634,-188.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-176.5\" font-family=\"monospace\" font-size=\"10.00\">depositional_resolution</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"688,-169.5 688,-188.5 \"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-176.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"691\" y=\"-176.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;SedimentBuffer -->\n<g id=\"edge3\" class=\"edge\">\n<title>Boxes&#45;&gt;SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M524.12,-305.97C538.55,-293.91 554.76,-280.37 570.27,-267.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"572.87,-269.81 578.3,-260.71 568.38,-264.43 572.87,-269.81\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M450,-251C450,-251 312,-251 312,-251 306,-251 300,-245 300,-239 300,-239 300,-184 300,-184 300,-178 306,-172 312,-172 312,-172 450,-172 450,-172 456,-172 462,-178 462,-184 462,-184 462,-239 462,-239 462,-245 456,-251 450,-251\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-220.5 455,-220.5 \"/>\n<text text-anchor=\"start\" x=\"337\" y=\"-229.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"307,-197.5 307,-220.5 354,-220.5 354,-197.5 307,-197.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-197.5 354,-197.5 354,-220.5 307,-220.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-205.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"354,-197.5 354,-220.5 408,-220.5 408,-197.5 354,-197.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"354,-197.5 354,-220.5 408,-220.5 408,-197.5 354,-197.5\"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-205.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"408,-197.5 408,-220.5 455,-220.5 455,-197.5 408,-197.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"455,-220.5 408,-220.5 408,-197.5 455,-197.5 \"/>\n<text text-anchor=\"start\" x=\"412\" y=\"-205.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"354,-178.5 354,-197.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"408,-178.5 408,-197.5 \"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"411\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;ActiveLayer -->\n<g id=\"edge5\" class=\"edge\">\n<title>FaciesBase&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M381,-171.61C381,-158.12 381,-142.58 381,-127.44\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"384.5,-127.05 381,-117.05 377.5,-127.05 384.5,-127.05\"/>\n</g>\n<!-- SedimentBuffer&#45;&gt;ActiveLayer -->\n<g id=\"edge6\" class=\"edge\">\n<title>SedimentBuffer&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M554.62,-162.31C533.26,-149.66 509.9,-135.83 487.44,-122.53\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"488.94,-119.35 478.55,-117.26 485.37,-125.37 488.94,-119.35\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>src/Components/ActiveLayer.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"@compose module ActiveLayer\n@mixin WaterDepth, FaciesBase, SedimentBuffer\n\nexport disintegrator, transporter\n\nusing ..Common\nusing CarboKitten.Transport.Advection: transport, advection_coef!, transport_dC!, max_dt\nusing CarboKitten.Transport.Solvers: runge_kutta_4, forward_euler\nusing Unitful\nusing GeometryBasics\n\n@kwdef struct Facies <: AbstractFacies\n    diffusion_coefficient::typeof(1.0u\"m/yr\") = 0.0u\"m/Myr\"\n    wave_velocity = _ -> (Vec2(0.0u\"m/Myr\", 0.0u\"m/Myr\"), Vec2(0.0u\"1/Myr\", 0.0u\"1/Myr\"))\nend\n\n@kwdef struct Input <: AbstractInput\n    disintegration_rate::Rate = 50.0u\"m/Myr\"\n    transport_solver = Val{:RK4}\n    transport_substeps = :adaptive \nend\n\ncourant_max(::Type{Val{:RK4}}) = 2.0\ncourant_max(::Type{Val{:forward_euler}}) = 1.0\n\ntransport_solver(f, _) = f\ntransport_solver(::Type{Val{:RK4}}, box) = runge_kutta_4(typeof(1.0u\"m\"), box)\ntransport_solver(::Type{Val{:forward_euler}}, _) = forward_euler\n\nfunction adaptive_transporter(input)\n    solver = transport_solver(input.transport_solver, input.box)\n\n    w = water_depth(input)\n    box = input.box\n    Δt = input.time.Δt  # / input.transport_substeps\n    fs = input.facies\n    adv = Matrix{Vec2{Rate}}(undef, box.grid_size...)\n    rct = Matrix{typeof(1.0u\"1/Myr\")}(undef, box.grid_size...)\n    dC = Matrix{Rate}(undef, box.grid_size...)\n    cm = courant_max(input.transport_solver)\n\n    return function (state, C::Array{Amount,3})\n        wd = w(state)\n\n        for (i, f) in pairs(fs)\n            advection_coef!(box, f.diffusion_coefficient, f.wave_velocity, wd, adv, rct)\n            m = max_dt(adv, box.phys_scale, cm)\n            steps = ceil(Int, Δt / m)\n\n            # @debug \"step $(state.step) - transport substeps $(steps)\"\n            subdt = Δt / steps\n            for j in 1:steps\n                solver(\n                    (C, _) -> transport_dC!(input.box, adv, rct, C, dC),\n                    view(C, i, :, :), TimeIntegration.time(input, state), subdt)\n            end\n        end\n\n        for i in eachindex(C)\n            if C[i] < zero(Amount)\n                C[i] = zero(Amount)\n            end\n        end\n    end\nend\n\n\"\"\"\n    disintegrator(input) -> f!\n\nPrepares the disintegration step. Returns a function `f!(state::State)`. The returned function\nmodifies the state, popping sediment from the `sediment_buffer` and returns an array of `Amount`.\n\"\"\"\nfunction disintegrator(input)\n    max_h = input.disintegration_rate * input.time.Δt\n    w = water_depth(input)\n    output = Array{Float64,3}(undef, n_facies(input), input.box.grid_size...)\n    depositional_resolution = input.depositional_resolution\n    @info \"maximum disintegration per time step: max_h = $max_h\"\n\n    return function (state)\n        wn = w(state)\n        h = min.(max_h, state.sediment_height)\n        h[wn.<=0.0u\"m\"] .= 0.0u\"m\"\n\n        @assert all(h .<= max_h)\n        state.sediment_height .-= h\n        pop_sediment!(state.sediment_buffer, h ./ depositional_resolution .|> NoUnits, output)\n        return output .* depositional_resolution\n    end\nend\n\n\"\"\"\n    transporter(input::Input) -> f\n\nPrepares the transportation step. Returns a function `f(state::State, active_layer)`,\ntransporting the active layer, returning a transported `Amount` of sediment.\n\"\"\"\nfunction transporter(input)\n    if input.transport_substeps == :adaptive\n        return adaptive_transporter(input)\n    end\n\n    solver = transport_solver(input.transport_solver, input.box)\n\n    w = water_depth(input)\n    box = input.box\n    Δt = input.time.Δt / input.transport_substeps\n    steps = input.transport_substeps\n    fs = input.facies\n\n    return function (state, C::Array{Amount,3})\n        wd = w(state)\n\n        for (i, f) in pairs(fs)\n            for j in 1:steps\n                solver(\n                    (C, _) -> transport(\n                        input.box, f.diffusion_coefficient, f.wave_velocity,\n                        C, wd),\n                    view(C, i, :, :), TimeIntegration.time(input, state), Δt)\n            end\n        end\n\n        for i in eachindex(C)\n            if C[i] < zero(Amount)\n                C[i] = zero(Amount)\n            end\n        end\n    end\nend\n\nend","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"","category":"page"},{"location":"components/run_model/#Running-a-Model","page":"Model Runner","title":"Running a Model","text":"","category":"section"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"350pt\" height=\"159pt\"\n viewBox=\"0.00 0.00 350.00 159.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 155)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-155 346,-155 346,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-151C150,-151 12,-151 12,-151 6,-151 0,-145 0,-139 0,-139 0,-84 0,-84 0,-78 6,-72 12,-72 12,-72 150,-72 150,-72 156,-72 162,-78 162,-84 162,-84 162,-139 162,-139 162,-145 156,-151 150,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-120.5 155,-120.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-97.5 7,-120.5 54,-120.5 54,-97.5 7,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-97.5 54,-97.5 54,-120.5 7,-120.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-97.5 108,-120.5 155,-120.5 155,-97.5 108,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-120.5 108,-120.5 108,-97.5 155,-97.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-78.5 54,-97.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-78.5 108,-97.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- Models -->\n<g id=\"node3\" class=\"node\">\n<title>Models</title>\n<path fill=\"none\" stroke=\"black\" d=\"M195,-36C195,-36 147,-36 147,-36 141,-36 135,-30 135,-24 135,-24 135,-12 135,-12 135,-6 141,0 147,0 147,0 195,0 195,0 201,0 207,-6 207,-12 207,-12 207,-24 207,-24 207,-30 201,-36 195,-36\"/>\n<text text-anchor=\"start\" x=\"142\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Models</text>\n</g>\n<!-- TimeIntegration&#45;&gt;Models -->\n<g id=\"edge2\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;Models</title>\n<path fill=\"none\" stroke=\"black\" d=\"M118.91,-71.96C128.42,-62.29 138.36,-52.18 146.99,-43.41\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"149.66,-45.69 154.18,-36.1 144.67,-40.78 149.66,-45.69\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node2\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-151C330,-151 192,-151 192,-151 186,-151 180,-145 180,-139 180,-139 180,-84 180,-84 180,-78 186,-72 192,-72 192,-72 330,-72 330,-72 336,-72 342,-78 342,-84 342,-84 342,-139 342,-139 342,-145 336,-151 330,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-120.5 335,-120.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-97.5 187,-120.5 234,-120.5 234,-97.5 187,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-97.5 234,-97.5 234,-120.5 187,-120.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-97.5 234,-120.5 288,-120.5 288,-97.5 234,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-97.5 234,-120.5 288,-120.5 288,-97.5 234,-97.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-97.5 288,-120.5 335,-120.5 335,-97.5 288,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-120.5 288,-120.5 288,-97.5 335,-97.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-78.5 234,-97.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-78.5 288,-97.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Models -->\n<g id=\"edge1\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Models</title>\n<path fill=\"none\" stroke=\"black\" d=\"M223.09,-71.96C213.58,-62.29 203.64,-52.18 195.01,-43.41\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"197.33,-40.78 187.82,-36.1 192.34,-45.69 197.33,-40.78\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"Running a model, we store the changes in each time step. The Frame type stores the production, disintegration and deposited material after transport.","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"<div class=\"noweb-label\">file:<i>src/Components/Models.jl</i></div>","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"@compose module Models\n    @mixin FaciesBase, TimeIntegration\n    using ..Common\n    using ..FaciesBase: n_facies\n    using ..TimeIntegration: n_writes\n\n    import ...CarboKitten: run_model\n\n    using Unitful\n    using ProgressLogging\n\n    Base.zeros(::Type{Frame}, input::AbstractInput) = Frame(\n        disintegration=zeros(Sediment, n_facies(input), input.box.grid_size...),\n        production=zeros(Sediment, n_facies(input), input.box.grid_size...),\n        deposition=zeros(Sediment, n_facies(input), input.box.grid_size...))\n\n    function increment!(a::Frame, b::Frame)\n        if !isnothing(b.disintegration)\n            a.disintegration .+= b.disintegration\n        end\n        if !isnothing(b.production)\n            a.production .+= b.production\n        end\n        if !isnothing(b.deposition)\n            a.deposition .+= b.deposition\n        end\n    end\n\n    \"\"\"\n        run_model(f, ::Type{Model{M}}, input::AbstractInput) where M\n        run_model(f, ::Type{Model{M}}, input::AbstractInput, state::AbstractState) where M\n\n    Run a model and send `Frame`s to callback `f`. The type parameter `M` should be a model,\n    being a module with both `initial_state!` and `step!` defined.\n\n    The second version with explicit state is used by `H5Writer` so we can perform an additional\n    action between creating the initial state and starting the model run (saving metadata to the\n    HDF5 file).\n    \"\"\"\n    run_model(f, ::Type{Model{M}}, input::AbstractInput) where M =\n        run_model(f, Model{M}, input, M.initial_state(input))\n\n    function run_model(f, ::Type{Model{M}}, input::AbstractInput, state::AbstractState) where M\n        step! = M.step!(input)\n\n        @progress for w = 1:n_writes(input)\n            df = zeros(Frame, input)\n            for n = 1:input.time.write_interval\n                increment!(df, step!(state))\n            end\n            f(w, df)\n        end\n    end\n\nend","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"","category":"page"},{"location":"denudation/physical_erosion/#Physical-erosion-and-sediment-redistribution","page":"Physical Erosion","title":"Physical erosion and sediment redistribution","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"This method not only considers the amount of materials that have been removed, but also how the eroded materials are being distributed to the neighboring regions depending on slopes on each direction.","category":"page"},{"location":"denudation/physical_erosion/#Physical-erosion","page":"Physical Erosion","title":"Physical erosion","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"The equations used to estimate how much material could one cell provide to the lower cells is described underneath. The equation is found in [14]. We choose this equation mainly because it specifically deals with bedrock substrates instead of loose sediments. In the equation, k_v is erodibility, and the default value is 0.0023 according to the paper. (1 - I_f) indicates run-off generated in one cell and slope is the slope calculated based on ArcGis: how slope works. Note that the algorithms to calculate slope does not work on depressions.","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"D_phys = -k_v * (1 - I_f)^13 nabla h^23","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"This equation for the physical dedundation rate, D_phys is implemented in  code as follows:","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<div class=\"noweb-label\">⪡physical-erosion⪢≣</div>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"function physical_erosion(slope::Float64, inf::Float64, erodibility::Any)\n    -1 * -erodibility .* (1 - inf) .^ (1 / 3) .* slope .^ (2 / 3)\nend","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"and the output of this function for a range of slope angles is plotted here:","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"(Image: Erodability as function of slope)","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<div class=\"noweb-label\">file:<i>examples/denudation/physical-test.jl</i></div>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"#| requires: examples/denudation/physical-test.jl\n#| creates: docs/src/_fig/PhysicalSlope.png\n#| collect: figures\nmodule PhysicalSpec\n\nusing CairoMakie\nusing CarboKitten.Denudation.EmpiricalDenudationMod: slope_kernel\nusing CarboKitten.Denudation.PhysicalErosionMod: physical_erosion, redistribution_kernel\nusing CarboKitten.Stencil: Boundary, Periodic, offset_value, offset_index, stencil\nusing CarboKitten.BoundaryTrait\nimport CarboKitten.Config: Box\n\nconst inf = 0.5\nconst erodibility = 0.0025\n\nfunction main()\n    SLOPE = collect(1:0.2:30)\n    DEN_MASS = Vector{Float64}(undef,size(SLOPE))\n\n    for i in eachindex(SLOPE)\n        DEN_MASS[i] = physical_erosion(SLOPE[i],inf,erodibility)\n    end\n\n    w = 10 .* [ 0.0663001  0.115606  0.646196\n    0.601523   0.130196  0.390821\n    0.864734   0.902935  0.670354]\n\n    fig = Figure()\n    ax = Axis(fig[1,1],xlabel=\"Slope (degrees)\", ylabel=\"Denudation rates (m/Myr)\")\n    lines!(ax,SLOPE,DEN_MASS)\n    save(\"docs/src/_fig/PhysicalSlope.png\",fig)\nend\n\nend\n\nPhysicalSpec.main()","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"</details>","category":"page"},{"location":"denudation/physical_erosion/#Redistribution-of-sediments","page":"Physical Erosion","title":"Redistribution of sediments","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"The redistribution of sediments after physical erosion is based on [15]: the eroded sediments calculated from the above equation are distributed to the neighboring 8 cells according to the slopes (defined as elevation differences/horizontal differences) towards each direction. The amount of sediments of one cell received is calculated by following steps:","category":"page"},{"location":"denudation/physical_erosion/#Current-implementation","page":"Physical Erosion","title":"Current implementation","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<div class=\"noweb-label\">file:<i>src/Denudation/PhysicalErosionMod.jl</i></div>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"module PhysicalErosionMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...Stencil: Boundary, Periodic, offset_value, offset_index, stencil\nusing ...BoundaryTrait\nusing ...Boxes: Box\n\nusing Unitful\n\n@kwdef struct PhysicalErosion <: DenudationType end\n\nconst Amount = typeof(1.0u\"m\")\n\n<<physical-erosion>>\n\nfunction redistribution_kernel(w::Array{Float64}, cellsize::Float64)\n    s = zeros(Float64, (3, 3))\n    s[1, 1] = (w[1, 1] - w[2, 2]) / cellsize\n    s[1, 2] = (w[1, 2] - w[2, 2]) / cellsize / sqrt(2)\n    s[1, 3] = (w[1, 3] - w[2, 2]) / cellsize\n    s[2, 1] = (w[2, 1] - w[2, 2]) / cellsize / sqrt(2)\n    s[2, 2] = (w[2, 2] - w[2, 2]) / cellsize\n    s[2, 3] = (w[2, 3] - w[2, 2]) / cellsize / sqrt(2)\n    s[3, 1] = (w[3, 1] - w[2, 2]) / cellsize\n    s[3, 2] = (w[3, 2] - w[2, 2]) / cellsize / sqrt(2)\n    s[3, 3] = (w[3, 3] - w[2, 2]) / cellsize\n\n    s[s.<0.0] .= 0.0\n    sumslope = sum(s)\n\n    if sumslope == 0.0\n        return zeros(Float64, (3, 3))\n    else\n        return s ./ sumslope\n    end\nend\n\nfunction mass_erosion(box::Box{BT}, denudation_mass, water_depth::Array{Float64}, i::CartesianIndex) where {BT<:Boundary{2}}\n    wd = zeros(Float64, 3, 3)\n    for (k, Δi) in enumerate(CartesianIndices((-1:1, -1:1)))\n        wd[k] = offset_value(BT, water_depth, i, Δi)\n    end\n    cell_size = box.phys_scale ./ u\"m\"\n\n    return (redistribution_kernel(wd, cell_size) .* denudation_mass[i])\nend\n\nfunction total_mass_redistribution(box::Box{BT}, denudation_mass, water_depth, mass) where {BT<:Boundary{2}}\n        for i in CartesianIndices(mass)\n            redis = mass_erosion(box, denudation_mass, water_depth, i)\n\n            for subidx in CartesianIndices((-1:1, -1:1))\n                target = offset_index(BT, size(water_depth), i, subidx)\n                if target === nothing\n                    continue\n                end\n                mass[target] += redis[2+subidx[1], 2+subidx[2]]\n            end\n        end\n    return mass\n\nend\n\nfunction total_mass_redistribution(box::Box{BT}, denudation_mass, water_depth) where {BT<:Boundary{2}}\n    mass = zeros(Amount, length(denudation_mass[:,1,1]), box.grid_size...)\n    @views for f in 1:length(denudation_mass[:,1,1])\n        total_mass_redistribution(box, denudation_mass[f,:,:], water_depth, mass[f,:,:])\n    end\n    return mass\n\nend\n\nfunction denudation(::Box, p::PhysicalErosion, water_depth::Any, slope, facies, state)\n    denudation_rate = zeros(typeof(1.0u\"m/Myr\"), length(facies), size(slope)...)\n\n    for idx in CartesianIndices(state.ca)\n        f = state.ca[idx]\n        if f == 0\n            continue\n        end\n        if water_depth[idx] <= 0\n            denudation_rate[f, idx[1], idx[2]] = physical_erosion.(slope[idx], facies[f].infiltration_coefficient, facies[f].erodibility)\n        end\n    end\n\n    return denudation_rate\nend\n\nfunction redistribution(box::Box{BT}, p::PhysicalErosion, denudation_mass, water_depth) where {BT<:Boundary}\n    return total_mass_redistribution(box, denudation_mass, water_depth)\nend\n\nend","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"","category":"page"},{"location":"carbocat/#About","page":"Summary","title":"About","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"CarboCAT is primarily based on a very simple cellular automaton (CA). We may explore this CA as a first step in implementing the model in Julia.","category":"page"},{"location":"carbocat/#Overview","page":"Summary","title":"Overview","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"The CarboCAT model [3] consists of several components, many of which are optional or contain optional levels of complexity.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Species habitation: an algorithm is in place to evolve the locality of a number of factory species.\nSediment production: each species will produce sediment according to some model.\nTransport: sediment may be transported from a production site to elsewhere due to gravity, waves or other types of mixing.\nErosion: sediment may erode depending on local circumstances or sediment type.\nCompactification: different types of sediment may respond to compression forces differently.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"These processes describe the intrinsic properties of the model. Any parameters that change these processes will be referred to as model parameters. Next to that, there are some extrinsic parameters that change the specific output of a model: the initial depth of the sea bed (also known as bathymetry) and variation in sea level (including subsidence). These we call input parameters.","category":"page"},{"location":"carbocat/#Carbonate-production","page":"Summary","title":"Carbonate production","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"By itself, a sediment production model is enough to model a cross-section of a carbonate platform [BS92: @Bosscher1992]. As a first step, we have reproduced some results of BS92. Using a reasonably simple approximation of a growth rate as","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"[partial_t h = - g_m tanh leftfracI_0I_k exp(-k * (h - s(t))right]{#eq:growth-rate-eqn}","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"where h is the depth of the sea floor, g_m is the maximum growth rate, I_0 the surface light intensity, I_k the saturating light intensity, k the extinction coefficient, and s the (extrinsic) sea-level. In one example given by BS92, we arrived at the following profile.","category":"page"},{"location":"carbocat/#Species-habitation","page":"Summary","title":"Species habitation","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"These species can be anything, just remember that they are the progenitor of some (limestone) facies type. In the original 2013 model, this stage is implemented by a celullar automaton (or CA). The CA has the nice property of giving pseudo-random output with at least some degree of coherence. There is no physical basis to the CA model, but neither is there very much data to test a physical model against.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"We have implemented the CA used in Burgess 2013. Using three species with identical 4-6-10-10 rules (survival between 4 to 10 neighbours, birth between 6-10 live neighbours).","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"(Image: )","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"An interesting question is under what rules is this CA stable (i.e. keeps evolving)?","category":"page"},{"location":"carbocat/#Combination","page":"Summary","title":"Combination","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"The minimal Carbocat model would consist of only species habitation and production.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":":::details","category":"page"},{"location":"carbocat/#Crowding","page":"Summary","title":"Crowding","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"In crowded areas carbonate production rates are reduced. For cells where","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"n_min le n le n_opt","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"and","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"n_opt le n le n_max","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"(n_min and n_max for living cells are 4 and 10)","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"we have a linear increase and linear decrease of production rate (i.e. a triangle function).","category":"page"},{"location":"carbocat/#Subsidence","page":"Summary","title":"Subsidence","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Subsidence refers to gradual lowering or lifting of the underlying floor bed. This could be either sea level rise due to climate change, but also tectonic activity. Sea level also changes according to a given recipe with say three sinusoidals (e.g. Milankovich cycles). When a cell gets \"subaerial exposure\", i.e. the water level drops below the cell elevation (stupid jargon), accumulation stops and the cell becomes dormant. On reflooding, the cell resumes activity. From the text it is not entirely clear, but I think deactivated cells don't take part in the CA, so they count as dead neighbours.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"reference on accommodation, also links to a model called SedFlux.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"T + E = S + W","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Saying Tectonic subsidence plus Eustatic sea-level change equals Sedimentation plus change in Water depth.","category":"page"},{"location":"carbocat/#Steps","page":"Summary","title":"Steps","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Update waterdepth, given subsidence\nUpdate sea level elevation, given eustatics\nRun CA\nCompute thickness of carbonate production\nCompute sediment transport","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"We need to keep a state with the following components:","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"height map\nspecies\nglobal time, implying:\nsea level and subsidence","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Every cycle we may export a layer of sediment to archive.","category":"page"},{"location":"carbocat/#References","page":"Summary","title":"References","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"","category":"page"},{"location":"visualization/#Visualization","page":"Visualizations","title":"Visualization","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"The visualization of CarboKitten output is implemented in a Julia package extension. This is done so that CarboKitten.jl itself doesn't have to depend on Makie.jl (our main visualization tool), which has a large transient dependency stack. To make the Visualization extension of CarboKitten available, make sure to activate a Julia project where Makie is installed.","category":"page"},{"location":"visualization/#Makie-primer","page":"Visualizations","title":"Makie primer","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"Makie.jl is a visualization package that creates exceptionally good looking (publication quality) plots in both 2D and 3D. There are three back-ends for Makie:","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"CairoMakie for publication quality vector graphics, writing to SVG, PDF or PNG.\nGLMakie has better run-time performance than CairoMakie, especially when dealing with larger datasets and/or 3D visualizations. However, GLMakie can only produce rasterized images, so PNG, JPEG or directly to screen for interactive use.\nWGLMakie for online publication using WebGL. If you want interactive plots, like 3D plots that you can rotate in the browser, this is the one to use. Fair warning: this is also the least stable back-end for Makie.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"To work with Makie, you need to import one of the three back-end packages. In general, every plot available in Makie has two variants. One is a direct function for plotting:","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"using CairoMakie\n\nx = randn(10)\ny = randn(10)\n\nscatter(x, y)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"The other requires a bit more prep, but gives you more control.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"fig = Figure()\nax = Axis(fig[1,1])\nscatter!(ax, x, y)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"Here, we create a figure explicitly, then create a new set of axes somewhere on the grid in the figure, and then plot on that set of axes. The plotting functions accepting an Axis argument actually modify an existing context, which is why these functions always end with an exclamation mark, in this case scatter!.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"If you like to know more about Makie, their \"Getting started\" is a good place to start.","category":"page"},{"location":"visualization/#Colours","page":"Visualizations","title":"Colours","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"We like to use colorblind safe pallete of colours as described on Paul Tol's website: '#4477AA', '#EE6677', '#228833', '#CCBB44', '#66CCEE', '#AA3377', '#BBBBBB'.","category":"page"},{"location":"visualization/#Project-Extension","page":"Visualizations","title":"Project Extension","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"The Project Extension requires a front-end where the available methods are exposed.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>src/Visualization.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module Visualization\nexport sediment_profile!, sediment_profile, wheeler_diagram!, wheeler_diagram, production_curve!,\n       production_curve, glamour_view!, summary_plot\n\nfunction print_instructions(func_name, args)\n    println(\"Called `$(func_name)` with args `$(typeof.(args))`\")\n    println(\"This is an extension and only becomes available when you import {Cairo,GL,WGL}Makie before using this.\")\nend\n\nsediment_profile!(args...) = print_instructions(\"sediment_profile!\", args)\nsediment_profile(args...) = print_instructions(\"sediment_profile\", args)\nwheeler_diagram!(args...) = print_instructions(\"wheeler_diagram!\", args)\nwheeler_diagram(args...) = print_instructions(\"wheeler_diagram\", args)\nproduction_curve(args...) = print_instructions(\"production_curve\", args)\nproduction_curve!(args...) = print_instructions(\"production_curve!\", args)\nstratigraphic_column!(args...) = print_instructions(\"production_curve!\", args)\nage_depth_model!(args...) = print_instructions(\"age_depth_model!\", args)\nglamour_view!(args...) = print_instructions(\"glamour_view!\", args)\nsummary_plot(args...) = print_instructions(\"summary_plot\", args)\n\nend  # module","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/VisualizationExt.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module VisualizationExt\n\ninclude(\"WheelerDiagram.jl\")\ninclude(\"ProductionCurve.jl\")\ninclude(\"StratigraphicColumn.jl\")\ninclude(\"AgeDepthModel.jl\")\ninclude(\"SedimentProfile.jl\")\ninclude(\"GlamourView.jl\")\ninclude(\"SummaryPlot.jl\")\n\nend","category":"page"},{"location":"visualization/#Summary-collage","page":"Visualizations","title":"Summary collage","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Collage)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/SummaryPlot.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module SummaryPlot\n\nusing CarboKitten.Visualization\nimport CarboKitten.Visualization: summary_plot\nusing CarboKitten.Export: read_header, read_slice\nusing CarboKitten.Utility: in_units_of\nusing HDF5\nusing Unitful\nusing Makie\n\nsummary_plot(filename::AbstractString; kwargs...) = h5open(fid->summary_plot(fid; kwargs...), filename, \"r\")\n\nfunction summary_plot(fid::HDF5.File; wheeler_smooth=(1, 1))\n\theader = read_header(fid)\n    y_slice = div(length(header.axes.y), 2) + 1\n    max_depth = minimum(header.initial_topography)\n\tdata = read_slice(fid, :, y_slice)\n\n\tn_facies = size(data.production)[1]\n\tfig = Figure(size=(1200, 1000), backgroundcolor=:gray80)\n\n\tax1 = Axis(fig[1:2,1:2])\n\tsediment_profile!(ax1, header, data)\n\n\tax2 = Axis(fig[4,1])\n\tax3 = Axis(fig[4,2])\n\tsm, df = wheeler_diagram!(ax2, ax3, header, data; smooth_size=wheeler_smooth)\n\tColorbar(fig[3,1], sm; vertical=false, label=\"sediment accumulation [m/Myr]\")\n\tColorbar(fig[3,2], df; vertical=false, label=\"dominant facies\", ticks=1:n_facies)\n\n\tax4 = Axis(fig[4,3], title=\"sealevel curve\", xlabel=\"sealevel [m]\",\n        limits=(nothing, (header.axes.t[1] |> in_units_of(u\"Myr\"),\n\t\t\t\t\t\t  header.axes.t[end] |> in_units_of(u\"Myr\"))))\n\tlines!(ax4, header.sea_level |> in_units_of(u\"m\"), header.axes.t |> in_units_of(u\"Myr\"))\n\n\tax5 = Axis(fig[2,3])\n\tproduction_curve!(ax5, fid[\"input\"], max_depth=max_depth)\n\n\tlinkyaxes!(ax2, ax3, ax4)\n\n\tax = Axis3(fig[1, 3]; zlabel=\"depth [m]\", xlabel=\"x [km]\", ylabel=\"y [km]\")\n\tglamour_view!(ax, fid)\n\n\tfig\nend\n\nend","category":"page"},{"location":"visualization/#Wheeler-diagram","page":"Visualizations","title":"Wheeler diagram","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Wheeler diagram)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/wheeler_diagram.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/wheeler_diagram.png\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nmodule Script\n\nusing CairoMakie\nusing CarboKitten.Export: read_slice\nusing CarboKitten.Visualization: wheeler_diagram\n\nfunction main()\n  header, data = read_slice(\"data/output/alcap-example.h5\", :, 25)\n  fig = wheeler_diagram(header, data)\n  save(\"docs/src/_fig/wheeler_diagram.png\", fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/WheelerDiagram.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module WheelerDiagram\n\nimport CarboKitten.Visualization: wheeler_diagram, wheeler_diagram!\nusing CarboKitten.Export: Header, Data, DataSlice, read_data, read_slice\nusing CarboKitten.Utility: in_units_of\nusing Makie\nusing Unitful\nusing CarboKitten.BoundaryTrait\nusing CarboKitten.Stencil: convolution\n\n\nconst na = [CartesianIndex()]\n\nelevation(h::Header, d::DataSlice) =\n    let bl = h.initial_topography[d.slice..., na],\n        sr = h.axes.t[end] * h.subsidence_rate\n\n        bl .+ d.sediment_elevation .- sr\n    end\n\nwater_depth(header::Header, data::DataSlice) =\n    let h = elevation(header, data),\n        s = header.subsidence_rate .* (header.axes.t .- header.axes.t[end]),\n        l = header.sea_level\n\n        h .- (s.+l)[na, :]\n    end\n\nconst Rate = typeof(1.0u\"m/Myr\")\n\nfunction sediment_accumulation!(ax::Axis, header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    colormap=Reverse(:curl),\n    range::NTuple{2,Rate}=(-100.0u\"m/Myr\", 100.0u\"m/Myr\"))\n    magnitude = sum(data.deposition .- data.disintegration; dims=1)[1, :, :] ./ (header.Δt * header.write_interval)\n    blur = convolution(Shelf, ones(Float64, smooth_size...) ./ *(smooth_size...))\n    wd = zeros(Float64, length(header.axes.x), length(header.axes.t))\n    blur(water_depth(header, data) / u\"m\", wd)\n    mag = zeros(Float64, length(header.axes.x), length(header.axes.t) - 1)\n    blur(magnitude / u\"m/Myr\", mag)\n\n    ax.ylabel = \"time [Myr]\"\n    ax.xlabel = \"position [km]\"\n    xkm = header.axes.x |> in_units_of(u\"km\")\n    tmyr = header.axes.t |> in_units_of(u\"Myr\")\n\n    sa = heatmap!(ax, xkm, tmyr, mag;\n        colormap=colormap, colorrange=range ./ u\"m/Myr\")\n    contour!(ax, xkm, tmyr, wd;\n        levels=[0], color=:red, linewidth=2, linestyle=:dash)\n    return sa\nend\n\nfunction dominant_facies!(ax::Axis, header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    colors=Makie.wong_colors())\n    n_facies = size(data.production)[1]\n    colormax(d) = getindex.(argmax(d; dims=1)[1, :, :], 1)\n\n    dominant_facies = colormax(data.deposition)\n    blur = convolution(Shelf, ones(Float64, smooth_size...) ./ *(smooth_size...))\n    wd = zeros(Float64, length(header.axes.x), length(header.axes.t))\n    blur(water_depth(header, data) / u\"m\", wd)\n\n    ax.ylabel = \"time [Myr]\"\n    ax.xlabel = \"position [km]\"\n\n    xkm = header.axes.x |> in_units_of(u\"km\")\n    tmyr = header.axes.t |> in_units_of(u\"Myr\")\n    ft = heatmap!(ax, xkm, tmyr, dominant_facies;\n        colormap=cgrad(colors[1:n_facies], n_facies, categorical=true),\n        colorrange=(0.5, n_facies + 0.5))\n    contourf!(ax, xkm, tmyr, wd;\n        levels=[0.0, 10000.0], colormap=Reverse(:grays))\n    contour!(ax, xkm, tmyr, wd;\n        levels=[0], color=:black, linewidth=2)\n    return ft\nend\n\nfunction wheeler_diagram!(ax1::Axis, ax2::Axis, header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    range::NTuple{2,Rate}=(-100.0u\"m/Myr\", 100.0u\"m/Myr\"))\n\n    linkyaxes!(ax1, ax2)\n    sa = sediment_accumulation!(ax1, header, data; smooth_size=smooth_size, range=range)\n    ft = dominant_facies!(ax2, header, data; smooth_size=smooth_size)\n    ax2.ylabel = \"\"\n\n    return sa, ft\nend\n\nfunction wheeler_diagram(header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    range::NTuple{2,Rate}=(-100.0u\"m/Myr\", 100.0u\"m/Myr\"))\n\n    fig = Figure(size=(1000, 600))\n    ax1 = Axis(fig[2, 1])\n    ax2 = Axis(fig[2, 2])\n\n    sa, ft = wheeler_diagram!(ax1, ax2, header, data; smooth_size=smooth_size, range=range)\n\n    Colorbar(fig[1, 1], sa; vertical=false, label=\"sediment accumulation [m/Myr]\")\n    Colorbar(fig[1, 2], ft; vertical=false, ticks=1:3, label=\"dominant facies\")\n    fig\nend\n\nend","category":"page"},{"location":"visualization/#Production-curve","page":"Visualizations","title":"Production curve","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Production curve)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/production_curve.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/production_curve.svg\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nusing CairoMakie\nusing CarboKitten.Visualization: production_curve\n\nsave(\"docs/src/_fig/production_curve.svg\", production_curve(\"data/output/alcap-example.h5\"))","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/ProductionCurve.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module ProductionCurve\n\nusing Makie\nusing Unitful\nusing HDF5\n\nimport CarboKitten.Components.Common: AbstractInput\nimport CarboKitten.Visualization: production_curve!, production_curve\nusing CarboKitten.Components.Production: Facies, production_rate\n\nfunction production_curve!(ax, input::I) where I <: AbstractInput\n    ax.title = \"production at $(sprint(show, input.insolation; context=:fancy_exponent=>true))\"\n    ax.xlabel = \"production [m/Myr]\"\n    ax.ylabel = \"depth [m]\"\n    ax.yreversed = true\n\n    for f in input.facies\n        depth = (0.1:0.1:50.0)u\"m\"\n        prod = [production_rate(input.insolation, f, d) for d in depth]\n        lines!(ax, prod / u\"m/Myr\", depth / u\"m\")\n    end\nend\n\nfunction production_curve(input::I) where I <: AbstractInput\n    fig = Figure()\n    ax = Axis(fig[1, 1])\n    production_curve!(ax, input)\n    fig\nend\n\nfunction production_curve(filename::AbstractString)\n    h5open(filename, \"r\") do fid\n        fig = Figure()\n        ax = Axis(fig[1, 1])\n        production_curve!(ax, fid[\"input\"])\n        fig\n    end\nend\n\nfunction production_curve!(ax, g::HDF5.Group; max_depth=-50.0u\"m\")\n    a = HDF5.attributes(g)\n    insolation = 400.0u\"W/m^2\"  # a[\"insolation\"][] * u\"W/m^2\"\n\n    ax.title = \"production at $(sprint(show, insolation; context=:fancy_exponent=>true))\"\n    ax.xlabel = \"production [m/Myr]\"\n    ax.ylabel = \"depth [m]\"\n\n    for i in 1:a[\"n_facies\"][]\n        fa = HDF5.attributes(g[\"facies$(i)\"])\n        f = Facies(\n            fa[\"maximum_growth_rate\"][] * u\"m/Myr\",\n            fa[\"extinction_coefficient\"][] * u\"m^-1\",\n            fa[\"saturation_intensity\"][] * u\"W/m^2\")\n        depth = (0.1u\"m\":0.1u\"m\":-max_depth)\n        prod = [production_rate(insolation, f, d) for d in depth]\n        lines!(ax, prod / u\"m/Myr\", - depth / u\"m\")\n    end\nend\n\nend","category":"page"},{"location":"visualization/#Sediment-profile","page":"Visualizations","title":"Sediment profile","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Sediment profile)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/sediment_profile.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/sediment_profile.png\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nusing CairoMakie\nusing CarboKitten.Export: read_slice\nusing CarboKitten.Visualization: sediment_profile\n\nsave(\"docs/src/_fig/sediment_profile.png\",\n    sediment_profile(read_slice(\"data/output/alcap-example.h5\", :, 25)...))","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/SedimentProfile.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module SedimentProfile\n\nimport CarboKitten.Visualization: sediment_profile, sediment_profile!\n\nusing CarboKitten.Visualization\nusing CarboKitten.Utility: in_units_of\nusing CarboKitten.Export: Header, Data, DataSlice, read_data, read_slice\nusing CarboKitten.Skeleton: skeleton\n\nusing Makie\nusing GeometryBasics\nusing Unitful\n\nusing Statistics: mean\n\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Amount = typeof(1.0u\"m\")\nconst Length = typeof(1.0u\"m\")\nconst Time = typeof(1.0u\"Myr\")\n\nconst na = [CartesianIndex()]\n\nelevation(h::Header, d::Data) =\n    let bl = h.initial_topography[:, :, na],\n        sr = h.axes.t[end] * h.subsidence_rate\n\n        bl .+ d.sediment_elevation .- sr\n    end\n\nelevation(h::Header, d::DataSlice) =\n    let bl = h.initial_topography[d.slice..., na],\n        sr = h.axes.t[end] * h.subsidence_rate\n\n        bl .+ d.sediment_elevation .- sr\n    end\n\ncolormax(d::Data) = getindex.(argmax(d.deposition; dims=1)[1, :, :, :], 1)\ncolormax(d::DataSlice) = getindex.(argmax(d.deposition; dims=1)[1, :, :], 1)\n\n\"\"\"\n    explode_quad_vertices(v)\n\nTakes a three dimensional array representing a grid of vertices. This function duplicates these\nvertices in the vertical direction, so that an amount of sediment can be given a single color.\n\nReturns a tuple of vertices and faces (triangles), suitable for plotting with Makie's `mesh`\nfunction.\n\"\"\"\nfunction explode_quad_vertices(v::Array{Float64,3})\n    w, h, d = size(v)\n    points = zeros(Float64, w, h - 1, 2, d)\n    n_vertices = 2 * w * (h - 1)\n    n_quads = (w - 1) * (h - 1)\n    @views points[:, :, 1, :] = v[1:end, 1:end-1, :]\n    @views points[:, :, 2, :] = v[1:end, 2:end, :]\n    idx = reshape(1:n_vertices, w, (h - 1), 2)\n    vtx1 = reshape(idx[1:end-1, :, 1], n_quads)\n    vtx2 = reshape(idx[2:end, :, 1], n_quads)\n    vtx3 = reshape(idx[2:end, :, 2], n_quads)\n    vtx4 = reshape(idx[1:end-1, :, 2], n_quads)\n    return reshape(points, n_vertices, d),\n    vcat(hcat(vtx1, vtx2, vtx3), hcat(vtx1, vtx3, vtx4))\nend\n\nfunction sediment_profile!(ax::Axis, header::Header, data::DataSlice)\n    x = header.axes.x |> in_units_of(u\"km\")\n    t = header.axes.t |> in_units_of(u\"Myr\")\n    n_facies = size(data.production)[1]\n    ξ = elevation(header, data)  # |> in_units_of(u\"m\")\n\n    verts = zeros(Float64, length(x), length(t), 2)\n    @views verts[:, :, 1] .= x\n    @views verts[:, :, 2] .= ξ |> in_units_of(u\"m\")\n    v, f = explode_quad_vertices(verts)\n\n    water_depth = ξ .- (header.subsidence_rate.*(header.axes.t.-header.axes.t[end]).+header.sea_level)[na, :]\n    hiatus = skeleton(water_depth .> 0.0u\"m\")\n\n    total_subsidence = header.subsidence_rate * header.axes.t[end]\n    bedrock = (header.initial_topography[data.slice...] .- total_subsidence) |> in_units_of(u\"m\")\n    lower_limit = minimum(bedrock) - 20\n    band!(ax, x, lower_limit, bedrock; color=:gray)\n    lines!(ax, x, bedrock; color=:black)\n    ylims!(ax, lower_limit + 10, nothing)\n    xlims!(ax, x[1], x[end])\n    ax.xlabel = \"position [km]\"\n    ax.ylabel = \"depth [m]\"\n    ax.title = \"sediment profile\"\n\n    c = reshape(colormax(data)[:, :], length(x) * (length(t) - 1))\n    mesh!(ax, v, f, color=vcat(c, c), alpha=1.0, colormap=cgrad(Makie.wong_colors()[1:n_facies], n_facies, categorical=true))\n\n    if !isempty(hiatus[1])\n        verts = [(x[pt[1]], ξ[pt...] |> in_units_of(u\"m\")) for pt in hiatus[1]]\n        linesegments!(ax, vec(permutedims(verts[hiatus[2]])); color=:white, linestyle=:dash, linewidth=2)\n    end\nend\n\nfunction sediment_profile(header::Header, data_slice::DataSlice)\n    fig = Figure(size=(1000, 600))\n    ax = Axis(fig[1, 1])\n    sediment_profile!(ax, header, data_slice)\n    return fig\nend\n\nend  # module","category":"page"},{"location":"visualization/#Stratigraphic-Column","page":"Visualizations","title":"Stratigraphic Column","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/StratigraphicColumn.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module StratigraphicColumn\n\nusing Makie\nusing Unitful\n\nimport CarboKitten.Visualization: stratigraphic_column!\nusing CarboKitten.Export: Header, DataColumn, stratigraphic_column, age_depth_model\n\n\nfunction scdata(header::Header, data::DataColumn)\n    n_facies = size(data.production)[1]\n    n_times = length(header.axes.t) - 1\n    sc = zeros(Float64, n_facies, n_times)\n    for f = 1:n_facies\n        sc[f, :] = stratigraphic_column(header, data, f) / u\"m\"\n    end\n\n    colormax(d) = getindex.(argmax(d; dims=1)[1, :], 1)\n    adm = age_depth_model(data.sediment_elevation)\n\n    return (ys_low=adm[1:end-1] / u\"m\", ys_high=adm[2:end] / u\"m\", facies=colormax(sc)[1:end])\nend\n\n\nfunction stratigraphic_column!(ax::Axis, header::Header, data::DataColumn; color=Makie.wong_colors())\n    (ys_low, ys_high, facies) = scdata(header, data)\n    hspan!(ax, ys_low, ys_high; color=color[facies])\nend\n\nfunction stratigraphic_column!(ax::Axis, header::Header, data::Observable{DataColumn}; color=Makie.wong_colors())\n    _scdata = lift(d -> scdata(header, d), data)\n    _ys_low = lift(d -> d.ys_low, _scdata)\n    _ys_high = lift(d -> d.ys_high, _scdata)\n    _color = lift(d -> color[d.facies], _scdata)\n    hspan!(ax, _ys_low, _ys_high; color=_color)\nend\n\nend","category":"page"},{"location":"visualization/#Skeleton","page":"Visualizations","title":"Skeleton","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>src/Skeleton.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module Skeleton\n\nusing .Iterators: filter, map as imap, product, flatten, drop\nusing ..Utility: enumerate_seq, find_ranges\n\nconst Vertex = Tuple{Int, UnitRange{Int}}\n\npairs(it) = zip(it, drop(it, 1))\nedge(a::Vertex, b::Vertex) = isempty(a[2] ∩ b[2]) ? nothing : (a[1], b[1])\nedges_between(a, b) = filter(!isnothing, imap(splat(edge), product(a, b)))\nmiddle(a::UnitRange{Int}) = (a.start + a.stop) ÷ 2\n\n\"\"\"\n    skeleton(bitmap::AbstractMatrix{Bool})\n\nComputes the skeleton of a bitmap, i.e. reduces features with some thickness to\na set of line segments. This function is designed with stratigraphic application\nin mind: we scan each row in the bitmap for connected regions, then link neighbouring\nregions when they overlap. The result is a graph that represents hiatus in the sediment\naccumulation.\n\nReturns a tuple of `vertices` and `edges`, where `vertices` is a vector of 2-tuples and\n`edges` is a nx2 matrix of indices into the `vertices`.\n\"\"\"\nfunction skeleton(bitmap::AbstractMatrix{Bool}; minwidth=10)\n    vertex_rows = (filter(r->length(r)>=minwidth, find_ranges(row)) for row in eachrow(bitmap))\n    edges::Vector{Tuple{Int,Int}} = collect(flatten(map(splat(edges_between), pairs(enumerate_seq(vertex_rows)))))\n    vertices::Vector{Tuple{Int,Int}} = collect(flatten(((i, middle(v)) for v in vs) for (i, vs) in enumerate(vertex_rows)))\n    return vertices, reshape(reinterpret(Int, edges), (2,:))'\nend\n\nend","category":"page"},{"location":"visualization/#Glamour-View-(3D)","page":"Visualizations","title":"Glamour View (3D)","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"Not very useful but highly glamourous.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Glamour view)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/glamour_view.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/glamour_view.png\n#| requires: data/output/cap1.h5\n#| collect: figures\n\nmodule Script\n\nusing CairoMakie\nusing CarboKitten.Visualization: glamour_view!\nusing HDF5\n\nfunction main()\n    fig = Figure()\n    ax = Axis3(fig[1,1])\n    h5open(\"data/output/cap1.h5\", \"r\") do fid\n        glamour_view!(ax, fid)\n    end\n    save(\"docs/src/_fig/glamour_view.png\", fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/GlamourView.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module GlamourView\n\nimport CarboKitten.Visualization: glamour_view!\nusing CarboKitten.Utility: in_units_of\nusing CarboKitten.Export: read_header\nusing Makie\nusing HDF5\nusing Unitful\n\nfunction glamour_view!(ax::Makie.Axis3, fid::HDF5.File; colormap=Reverse(:speed))\n\theader = read_header(fid)\n\tx = header.axes.x |> in_units_of(u\"km\")\n\ty = header.axes.y |> in_units_of(u\"km\")\n\txy_aspect = x[end] / y[end]\n\n\tax.aspect = (xy_aspect, 1, 1)\n\tax.azimuth = -π/3\n\n\tn_steps = length(header.axes.t)\n\tgrid_size = (length(x), length(y))\n\tsteps_between = 2\n\tselected_steps = [1, ((1:steps_between) .* n_steps .÷ (steps_between + 1))..., n_steps]\n\tbedrock = header.initial_topography .- header.axes.t[end] * header.subsidence_rate\n\n\tresult = Array{Float64, 3}(undef, grid_size..., length(selected_steps))\n\tfor (i, j) in enumerate(selected_steps)\n\t\tresult[:, :, i] = fid[\"sediment_height\"][:,:,j] .+ bedrock / u\"m\"\n\tend\n\n\tsurface!(ax, x, y, result[:,:,1];\n\t\tcolor=ones(grid_size),\n\t\tcolormap=:grays)\n\n\tfor s in eachslice(result[:,:,2:end-1], dims=3)\n\t\tsurface!(ax, x, y, s;\n\t\t\tcolormap=(colormap, 0.7))\n\tend\n\n\tsurface!(ax, x, y, result[:,:,end];\n\t\tcolormap=colormap)\n\tlines!(ax, x, zeros(grid_size[1]), result[:, 1, end]; color=(:white, 0.5), linewidth=1)\n\tlines!(ax, fill(x[end], grid_size[2]), y, result[end, :, end]; color=(:white, 0.5), linewidth=1)\nend\n\nend","category":"page"},{"location":"visualization/#Age-depth-Model","page":"Visualizations","title":"Age-depth Model","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/AgeDepthModel.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module AgeDepthModel\n\nusing Makie\nusing Unitful\n\nusing CarboKitten.Visualization\nusing CarboKitten.Export\n\nend","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"","category":"page"},{"location":"denudation/denudation/#Denudation","page":"Denudation","title":"Denudation","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Denudation can be applied in three ways: modelling physical erosion, modelling chemical dissolution and estimating total denudation rates based on chlorine (Cl) isotope data.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Physical Erosion\nChemical Dissolution\nEmpirical Denudation","category":"page"},{"location":"denudation/denudation/#How-to-use?","page":"Denudation","title":"How to use?","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"In CarboKitten, you could choose which type of the three you would like to apply. To do this you could simply change the erosion_type in the input.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Example: in examples, you find caps_miller_diss.jl, caps_miller_emp.jl, caps_miller_phys.jl, for chemical dissolution, empirical denudation or physical denudation, respectively. This file uses the [6] cure as sea level curve input. You could try different erosion types by changing the erosion_type:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"NoDenudation means no erosion, and is used for debugging only.\nDissolution means chemical dissolution. The default input parameters are: Temperature = 273K, precipitation = 1000mm/yr, atmospheric CO2 partial pressure = 10^(-1.5)* ATM, and reaction rate = 0.002 m/yr.\nPhysicalErosion means physical erosion and sediments redistribution. The default parameters is erodability = 0.001 m/yr.\nEmpericalDenudation means total denudation calculated based on emperical relationship by Cl isotope observations. The default input parameter is: precipitation = 1000mm/yr.","category":"page"},{"location":"denudation/denudation/#Tests-for-three-modes-of-denudation","page":"Denudation","title":"Tests for three modes of denudation","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"In this module, 7 tests are implemented.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Tests 1:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_LOW_T) < sum(denudation_mass_HIGH_T)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means that higher temperature would dissolve faster than the colder scenario. It tests the Dissolution mode.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test2:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_LOW_P) < sum(denudation_mass_HIGH_P)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means more humid scenario has higher denudation rates than the arid scenario. This tests emperical denudation mode.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test3:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_phys) > sum(denudation_mass_phys_flat)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means more topography has higher denudation rates than the flatter topography. This tests physical erosion.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test4:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_phys) ≈ sum(redistribution_mass)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means in physical erosion mode, the total amount of eroded material = the total amount of redistributed material. In this case, boundary condition of 'Periodic has been used.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test 5 to 7 are regression tests: the outputs from the module is similar to the values calculated by calculator.","category":"page"},{"location":"denudation/denudation/#API","page":"Denudation","title":"API","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"The different denudation models all follow the same API.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"<div class=\"noweb-label\">file:<i>src/Denudation/Abstract.jl</i></div>","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"module Abstract\n\nusing ...BoundaryTrait: Boundary\nusing ...Boxes: Box\n\nusing Unitful\n\nabstract type DenudationType end\n\n\"\"\"\n    denudation(box, param, state)\n\n\nComputes the denudation for a single time-step, given denudation parameters `param` and a simulation state `state`. `param` should have a `DenudationType` type and `state` should contain the `height` property and `sealevel`.\n\nReturns denudation mass in units of meters.\n\"\"\"\nfunction denudation(input)\n\n    function (state, water_depth, slope)\n        if denudation(input.box, input.denudation, water_depth, slope, input.facies,state) !== nothing\n        return denudation(input.box, input.denudation, water_depth, slope, input.facies,state) .* input.time.Δt\n        else\n        return nothing\n        end\n    end\nend\n\n\"\"\"\n    denudation(box::Box, param::DenudationType, water_depth, slope, facies)\n\nComputes the amount of denudation. This function is called on a pixel by pixel basis, so all arguments can be assumed to be scalar. The `param` argument should be of a subtype of `DenudationType` containing all the input parameters for this specific denudation model.\n\"\"\"\nfunction denudation(box::Box, param::DenudationType, water_depth, slope, facies, state)\n    error(\"Abstract `denudation` function called.\")\nend\n\n\"\"\"\n    redistribution()\n\nTakes `state`, `water_depth` in meters and `denudation_mass` as a 3D array (facies, x and y coordinates) in units of meters.\n\"\"\"\nfunction redistribution(input)\n    function (state, water_depth, denudation_mass)\n        return redistribution(input.box, input.denudation, denudation_mass, water_depth)\n    end\nend\n\nfunction redistribution(box::Box, param::DenudationType, denudation_mass, water_depth)\n    error(\"Abstract `redistribution` function called.\")\nend\n\nend  # module","category":"page"},{"location":"denudation/denudation/#No-Denudation","page":"Denudation","title":"No Denudation","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"<div class=\"noweb-label\">file:<i>src/Denudation/NoDenudationMod.jl</i></div>","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"\"\"\"\n    module NoDenudation\n\nDoesn't do any denudation: used for testing purposes.\n\"\"\"\nmodule NoDenudationMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...Boxes: Box\nusing Unitful\n\nstruct NoDenudation <: DenudationType end\n\nfunction denudation(box::Box, p::NoDenudation, water_depth::Any, slope, facies, state)\n    return nothing\nend\n\nfunction redistribution(box::Box, p::NoDenudation, denudation_mass, water_depth)\n    return nothing\nend\n\nend","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"","category":"page"},{"location":"onshore-transport/#Onshore-transport","page":"Onshore Transport","title":"Onshore transport","text":"","category":"section"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"In the Active Layer approach, we derived a diffusion equation for our transport model starting with a proposition for the sediment flux as,","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"q_f = -nu_f P_f nabla eta","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"where nu_f is the diffusion coefficient, P_f the production and eta the sediment height. Then inserting that into the mass balance equation,","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"partial_t eta_f = -nabla cdot q_f + P_f","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Now we'll add a vector component P_f w_f(eta) to the flux:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"q_f = -nu_f P_f nabla eta + P_f w_f(eta)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"This leads to the modified advection-diffusion equation:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"partial_t eta_f = nu_f (P_f nabla^2 eta + nabla P_f cdot nabla eta) - nabla cdot (P_f w_f(eta)) + P_f","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Using the chain-rule nabla cdot (P_f w_f(eta)) = P_f (w_f cdot nabla eta) + nabla P_f cdot w_f, we arrive at:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"partial_t eta_f = nu_f P_f nabla^2 eta + (nu_f nabla P_f - P_f w_f) cdot nabla eta - nabla P_f cdot w_f + P_f","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"So we modify the advection component in the active layer approach with P_f w_f, the derivative of the wave induced flux with respect to water depth and add a new term nabla P_f cdot w_f.","category":"page"},{"location":"onshore-transport/#Xi-and-Burgess-2022","page":"Onshore Transport","title":"Xi & Burgess 2022","text":"","category":"section"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Xi & Burgess use the following equation for the phase velocity of waves as a function of depth:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v(w) = sqrtfraclambda gk rm tanh (k w)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"where k = 2pilambda and g is the gravitational acceleration. It could be that the square root should be extended over the rm tanh function, following the derivation on Airy wave theory on Wikipedia. It should be noted that this velocity is the phase-velocity of surface waves, given the total depth of the water. To evaluate the transport velocity at deeper levels, we need to look at the Stokes drift. This will effectively multiply the phase velocity with a factor exp(-kw). We'll leave the proportionality as an input parameter.","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v(w) propto tanhk w exp-kw","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Derivative of tanh is 1 - tanh^2, so:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v(w) = A tanh(k w) exp(- k w)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"beginaligned\nv(w) = A k (1 - tanh^2(k w)) exp(- k w) - tanh(k w) exp(-k w)\n      = A k exp(-k w) 1 - tanh^2(k w) - tanh(k w)\nendaligned","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"<div class=\"noweb-label\">⪡wave-transport-magnitude⪢≣</div>","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v_prof(v_max, max_depth, w) = \n  \tlet k = sqrt(0.5) / max_depth,\n\t\t    A = 3.331 * v_max,\n\t\t    α = tanh(k * w),\n\t\t    β = exp(-k * w)\n\t\t    (A * α * β, -A * k * β * (1 - α - α^2))\n\t  end","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"(Image: Plot of wave transport magnitude with a maximum velocity of 10 m/yr at a depth of 20 m.)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"#| creates: docs/src/_fig/wave-transport-magnitude.svg\n#| collect: figures\nmodule PlotWaveTransportMagnitude\nusing CairoMakie\nusing Unitful\n\n<<wave-transport-magnitude>>\n\nfunction main()\n  w = LinRange(0, 100.0, 1000)u\"m\"\n\tf = v_prof.(10.0u\"m/yr\", 20.0u\"m\", w)\n\n\tv = first.(f)\n\ts = last.(f)\n\t\n\tfig = Figure()\n\tax1 = Axis(fig[1, 1], title=\"transport velocity\", yreversed=true, xlabel=\"velocity [m/yr]\", ylabel=\"depth [m]\")\n\tax2 = Axis(fig[1, 2], title=\"transport shear\", yreversed=true, xlabel=\"shear [1/yr]\", ylabel=\"depth [m]\")\n\tlines!(ax1, v / u\"m/yr\", w / u\"m\")\n\tlines!(ax2, s / u\"1/yr\", w / u\"m\")\n\tsave(\"docs/src/_fig/wave-transport-magnitude.svg\", fig)\nend\n\nend\n\nPlotWaveTransportMagnitude.main()","category":"page"},{"location":"onshore-transport/#","page":"Onshore Transport","title":"","text":"","category":"section"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"","category":"page"},{"location":"bosscher-1992/#Carbonate-Production","page":"Bosscher and Schlager 1992","title":"Carbonate Production","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The paper by Bosscher and Schlager (1992) [1] is an early computer model for simulating reef growth. This paper contains some of the essential ingredients that we find back in CarboKitten. We reproduce their results within the framework of CarboKitten's larger design.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The BS92 model assumes a direct relation between water depth and sediment accumulation rate. That way we can model reef growth by integrating an Ordinary Differential Equation (ODE). The Production component provides this model for the rest of CarboKitten.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: summary plot)","category":"page"},{"location":"bosscher-1992/#Parameters","page":"Bosscher and Schlager 1992","title":"Parameters","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Maximum growth rate G_m. The maximum rate of reef growth is in the range of 10-15 rm mm yr^-1 (Macintyre etal., 1977; Adey, 1978; Davies, 1983).\nExtinction coefficient k. This is a measure of the extinction of photosynthetically active radiation (PAR), i.e. light with a wavelength of 400-700 nm.  The value of k for oceanic waters ranges from 004 to 016 rm m^-1 (Jerlov, 1976); reported values for reef waters also lie within this range (Brakel, 1979; Van den Hoek et al., 1975; Weinberg, 1976; Chalker, 1981; Porter, 1985).\nSurface light intensity I_0. The light intensity at the water surface at midday in the tropics lies in the range of 2000-2250 rm mu E m^-2s^-1.\nSaturating light intensity I_k. Light saturating intensities are in the range 50-450 rm mu E m^-2s^-1, depending on species and water depth (Chalker, 1981; Wyman et al., 1987). Photoadaptation of reef-building corals has not been taken into account. More generally, light does not become a limiting factor for coral growth until it reaches roughly 10% of its surface value (B. E. Chalker, in Done, 1983).","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"from BS92","category":"page"},{"location":"bosscher-1992/#Growth-Rate","page":"Bosscher and Schlager 1992","title":"Growth Rate","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The growth rate is given as","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"g(w) = g_m tanhleft(I_0 e^-kw over I_kright)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">⪡carbonate-production⪢≣</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"g(gₘ, I₀, Iₖ, k, w) = gₘ * tanh(I₀/Iₖ * exp(-w * k))","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">⪡b92-model⪢≣</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<<carbonate-production>>\n\nstruct Parameters\n     I₀::Float64\n     Iₖ::Float64\n     k::Float64\n     gₘ::Float64\nend\n\ng(p::Parameters, w) = g(p.gₘ, p.I₀, p.Iₖ, p.k, w)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"where w is the water depth in meters, g_m is the maximum growth rate in rm m rm My^-1, I_0 is surface light intensity, I_k is saturation light intensity, and k is the extinction coefficient. We have exponential decay of light intensity as we get to deeper water, and the carbonate factories respond to light intensity through a tanh (hyperbolic tangent function). This is by no means an exact relation, rather the tanh function interpolates smoothly between one and zero. We specify a maximum growth rate and a typical intensity at which the species is no longer productive.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The shape of tanh circ exp look like this:","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: Tangens hyperbolicus)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Notice that the numbers inside the exponential need to be unit-free, so does the output. The value of tanh circ exp at a depth of 0 is 07615dots. This does not make much sense, as I believe we should start at a value of 1 at the surface. By setting I_0  I_k to some value 1 this can be alleviated, but it changes the interpretation of the constants a little. The idea is that above a certain insolation, light is not the limiting factor to the rate of photosynthesis.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"To reproduce Figure 2 in B13, I had to change the values for g_m to 500, 250, and 125 respectively, the other values from Table 2 remained the same. I guess this was done for illustration purposes.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: Production curves)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/plot-tanh.gnuplot</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"set term svg size 700, 300 font \"sans serif, 14\" linewidth 1.5\nset xrange [-5:10]\nset yrange [-0.1:1.1]\nset grid\nset key outside\nset xlabel \"x\"\nset ylabel \"y\"\nplot tanh(exp(-x)) lc rgb 'black', tanh(exp(4)*exp(-x)), tanh(exp(-0.5*x))","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/burgess2013-fig2.gnuplot</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"set term svg size 500, 600 font \"sans serif,14\" linewidth 1.5\nset trange [0:100]\nset yrange [100:0]\nset xrange [-20:520]\nset parametric\nset key right bottom\nset grid\nset ylabel \"Water depth (m)\"\nset xlabel \"Production rates\"\nplot 500*tanh(6.7 * exp(-0.8 * t)), t title 'Carbonate factory 1', \\\n     250*tanh(6.7 * exp(-0.1 * t)), t title 'Carbonate factory 2', \\\n     125*tanh(6.7 * exp(-0.005 * t)), t title 'Carbonate factory 3'","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"</details>","category":"page"},{"location":"bosscher-1992/#Depth-Evolution","page":"Bosscher and Schlager 1992","title":"Depth Evolution","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The use of water depth in both BS92 and B13 can be a bit confusing. Plots are shown up-side-down and little is done to disambiguate depth with sea level rising or lowering, or sediment accreting. Growth in deposition should give shallower sea bed. BS92 write w = (h_0 + h(t)) - (s_0 + s(t)). Actually s_0 is best set to 0, or simply included into s(t) and h_0 can be replaced with setting h(t=0) = h_0. Then, as we have the growth rate as a function of water depth g(w), we can say","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"partial_t h = -g_m rm tanhleftfracI_0I_k exp(-k (h - s(t)))right","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">⪡b92-model⪢≣</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"function model(p::Parameters, s, t_end::Float64, h₀::Float64)\n     ∂h(h::Float64, t::Float64) = let w = h - s(t)\n          w >= 0.0 ? -g(p, h - s(t)) : 0.0\n     end\n\n     dt = 1000.0\n     times = 0.0:dt:t_end\n     result = zeros(Float64, length(times))\n     result[1] = h₀\n     for (i, t) in enumerate(times[1:end-1])\n          h = result[i]\n          for j = 0:99\n               h += ∂h(h, t + j * dt/100) * (dt/100)\n          end\n          result[i+1] = h\n     end\n     return result\nend","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"It seems Eq. 5 in BS92 (the most important equation in the paper mind you!) is missing both a minus sign and a set of parentheses. Also, we should remark that at negative depth (subareal exposure) we should halt all growth.","category":"page"},{"location":"bosscher-1992/#Crosssection","page":"Bosscher and Schlager 1992","title":"Crosssection","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The most impressive result in BS92 is the last figure. They show an input curve for s(t) but give no functional description. The curve starts with a linear drop from 0 to 120m depth over a time of 20000 years, then slowly rises with s(t) = a +  bt + A sin(2pi t  P), with a period P = sim 15-20 rm kyr, amplitude A = sim 40 rm m. It might be easiest to take a screenshot of the PDF and convert the graph into a table.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Using DifferentialEquations.jl we can integrate Equation @eq:growth-eqn. Interestingly, the only integrator that gave me noise free results is Euler. This may be due to the sudden shut-down of production at w = 0.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/using_ode.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"module BS92\n\nusing CarboKitten.DataSets: bosscher_schlager_1992\nusing Interpolations\nusing Unitful\n\n<<b92-model>>\n\nfunction sealevel_curve()\n     data = bosscher_schlager_1992()\n     linear_interpolation(data.time / u\"yr\", data.sealevel / u\"m\")\nend\n\nstruct Scenario\n     param::Parameters\n     sealevel\n     t_end::Float64\nend\n\nmodel(s::Scenario, h₀::Float64) = model(s.param, s.sealevel, s.t_end, h₀)\n\nSCENARIO_A = Scenario(\n     Parameters(2000.0, 250.0, 0.05, 0.005),\n     sealevel_curve(),\n     80_000.0)\n\nend","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Finally, we can try to reproduce figure 8 in BS92.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: stratigraphy following fig. 8 in BS92)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Note the simplicity of this result: there is no dependency on space, only on the initial depth h_0.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/fig8.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: docs/src/_fig/bs92-fig8.svg\n#| requires: examples/model/bs92/using_ode.jl\n#| collect: figures\n\nmodule Script\n     include(\"using_ode.jl\")\n     using CairoMakie\n\n     function main()\n          h0 = LinRange(0, 200, 101)\n          result = hcat([BS92.model(BS92.SCENARIO_A, h) for h in h0]...)\n          t = LinRange(0, 80_000, 81)\n\n          fig = Figure(resolution=(600,900))\n          ax = Axis(fig[1,1], xlabel=\"initial depth (m)\", ylabel=\"depth (m)\", yreversed=true)\n          for l in eachrow(result)\n               lines!(ax, h0, vec(l); color=:steelblue4, linewidth=0.5)\n          end\n          ax = Axis(fig[2,1], xlabel=\"time (years)\", ylabel=\"depth (m)\", yreversed=true)\n          lines!(ax, t, BS92.SCENARIO_A.sealevel(t); color=:steelblue4)\n\n          save(\"docs/src/_fig/bs92-fig8.svg\", fig)\n     end\nend\n\nScript.main()","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"</details>","category":"page"},{"location":"bosscher-1992/#BS92-in-CarboKitten-stack","page":"Bosscher and Schlager 1992","title":"BS92 in CarboKitten stack","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"624pt\" height=\"484pt\"\n viewBox=\"0.00 0.00 624.00 484.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 480)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-480 620,-480 620,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M274,-476C274,-476 136,-476 136,-476 130,-476 124,-470 124,-464 124,-464 124,-409 124,-409 124,-403 130,-397 136,-397 136,-397 274,-397 274,-397 280,-397 286,-403 286,-409 286,-409 286,-464 286,-464 286,-470 280,-476 274,-476\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"131,-445.5 279,-445.5 \"/>\n<text text-anchor=\"start\" x=\"181.5\" y=\"-454.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"131,-422.5 131,-445.5 178,-445.5 178,-422.5 131,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"131,-422.5 178,-422.5 178,-445.5 131,-445.5 \"/>\n<text text-anchor=\"start\" x=\"135\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"178,-422.5 178,-445.5 232,-445.5 232,-422.5 178,-422.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"178,-422.5 178,-445.5 232,-445.5 232,-422.5 178,-422.5\"/>\n<text text-anchor=\"start\" x=\"182\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"232,-422.5 232,-445.5 279,-445.5 279,-422.5 232,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"279,-445.5 232,-445.5 232,-422.5 279,-422.5 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-403.5 178,-422.5 \"/>\n<text text-anchor=\"start\" x=\"135\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-403.5 232,-422.5 \"/>\n<text text-anchor=\"start\" x=\"182\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"235\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M424,-361C424,-361 166,-361 166,-361 160,-361 154,-355 154,-349 154,-349 154,-256 154,-256 154,-250 160,-244 166,-244 166,-244 424,-244 424,-244 430,-244 436,-250 436,-256 436,-256 436,-349 436,-349 436,-355 430,-361 424,-361\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"161,-330.5 429,-330.5 \"/>\n<text text-anchor=\"start\" x=\"247.5\" y=\"-339.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"161,-307.5 161,-330.5 278,-330.5 278,-307.5 161,-307.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"161,-307.5 278,-307.5 278,-330.5 161,-330.5 \"/>\n<text text-anchor=\"start\" x=\"165\" y=\"-315.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"278,-307.5 278,-330.5 332,-330.5 332,-307.5 278,-307.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"278,-307.5 278,-330.5 332,-330.5 332,-307.5 278,-307.5\"/>\n<text text-anchor=\"start\" x=\"282\" y=\"-315.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"332,-307.5 332,-330.5 429,-330.5 429,-307.5 332,-307.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"429,-330.5 332,-330.5 332,-307.5 429,-307.5 \"/>\n<text text-anchor=\"start\" x=\"336\" y=\"-315.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"278,-288.5 278,-307.5 \"/>\n<text text-anchor=\"start\" x=\"165\" y=\"-295.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"332,-288.5 332,-307.5 \"/>\n<text text-anchor=\"start\" x=\"282\" y=\"-295.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"335\" y=\"-295.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"278,-269.5 278,-288.5 \"/>\n<text text-anchor=\"start\" x=\"165\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"332,-269.5 332,-288.5 \"/>\n<text text-anchor=\"start\" x=\"282\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"335\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"278,-250.5 278,-269.5 \"/>\n<text text-anchor=\"start\" x=\"165\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"332,-250.5 332,-269.5 \"/>\n<text text-anchor=\"start\" x=\"282\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"335\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M231.27,-396.97C237.07,-388.46 243.38,-379.21 249.69,-369.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"252.73,-371.7 255.48,-361.47 246.95,-367.76 252.73,-371.7\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M454,-476C454,-476 316,-476 316,-476 310,-476 304,-470 304,-464 304,-464 304,-409 304,-409 304,-403 310,-397 316,-397 316,-397 454,-397 454,-397 460,-397 466,-403 466,-409 466,-409 466,-464 466,-464 466,-470 460,-476 454,-476\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"311,-445.5 459,-445.5 \"/>\n<text text-anchor=\"start\" x=\"319.5\" y=\"-454.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"311,-422.5 311,-445.5 358,-445.5 358,-422.5 311,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"311,-422.5 358,-422.5 358,-445.5 311,-445.5 \"/>\n<text text-anchor=\"start\" x=\"315\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"358,-422.5 358,-445.5 412,-445.5 412,-422.5 358,-422.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"358,-422.5 358,-445.5 412,-445.5 412,-422.5 358,-422.5\"/>\n<text text-anchor=\"start\" x=\"362\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"412,-422.5 412,-445.5 459,-445.5 459,-422.5 412,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"459,-445.5 412,-445.5 412,-422.5 459,-422.5 \"/>\n<text text-anchor=\"start\" x=\"416\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"358,-403.5 358,-422.5 \"/>\n<text text-anchor=\"start\" x=\"315\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"412,-403.5 412,-422.5 \"/>\n<text text-anchor=\"start\" x=\"362\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"415\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M358.73,-396.97C352.93,-388.46 346.62,-379.21 340.31,-369.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"343.05,-367.76 334.52,-361.47 337.27,-371.7 343.05,-367.76\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node7\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M546.5,-158C546.5,-158 481.5,-158 481.5,-158 475.5,-158 469.5,-152 469.5,-146 469.5,-146 469.5,-134 469.5,-134 469.5,-128 475.5,-122 481.5,-122 481.5,-122 546.5,-122 546.5,-122 552.5,-122 558.5,-128 558.5,-134 558.5,-134 558.5,-146 558.5,-146 558.5,-152 552.5,-158 546.5,-158\"/>\n<text text-anchor=\"start\" x=\"476.5\" y=\"-137.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge7\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M410.95,-243.95C428.5,-233.08 445.79,-221 461,-208 474.96,-196.06 487.82,-179.99 497.38,-166.58\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"500.35,-168.44 503.16,-158.22 494.59,-164.46 500.35,-168.44\"/>\n</g>\n<!-- Production -->\n<g id=\"node8\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M439.5,-208C439.5,-208 192.5,-208 192.5,-208 186.5,-208 180.5,-202 180.5,-196 180.5,-196 180.5,-84 180.5,-84 180.5,-78 186.5,-72 192.5,-72 192.5,-72 439.5,-72 439.5,-72 445.5,-72 451.5,-78 451.5,-84 451.5,-84 451.5,-196 451.5,-196 451.5,-202 445.5,-208 439.5,-208\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"188,-178 445,-178 \"/>\n<text text-anchor=\"start\" x=\"272.5\" y=\"-186.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"188,-155 188,-178 257,-178 257,-155 188,-155\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"188,-155 257,-155 257,-178 188,-178 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-162.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"257,-155 257,-178 398,-178 398,-155 257,-155\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"257,-155 257,-178 398,-178 398,-155 257,-155\"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-162.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"398,-155 398,-178 445,-178 445,-155 398,-155\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"445,-178 398,-178 398,-155 445,-155 \"/>\n<text text-anchor=\"start\" x=\"402\" y=\"-162.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"257,-136 257,-155 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-143\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-136 398,-155 \"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-143\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"401\" y=\"-143\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"257,-117 257,-136 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-117 398,-136 \"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"401\" y=\"-124\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"257,-98 257,-117 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-98 398,-117 \"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"401\" y=\"-105\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"257,-79 257,-98 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-86\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-79 398,-98 \"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-86\" font-family=\"monospace\" font-size=\"10.00\">production_offset</text>\n<text text-anchor=\"start\" x=\"401\" y=\"-86\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge8\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M302.58,-243.56C303.66,-235.29 304.79,-226.69 305.91,-218.14\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"309.39,-218.51 307.22,-208.14 302.45,-217.6 309.39,-218.51\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M604,-342C604,-342 466,-342 466,-342 460,-342 454,-336 454,-330 454,-330 454,-275 454,-275 454,-269 460,-263 466,-263 466,-263 604,-263 604,-263 610,-263 616,-269 616,-275 616,-275 616,-330 616,-330 616,-336 610,-342 604,-342\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"461,-311.5 609,-311.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-320.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"461,-288.5 461,-311.5 508,-311.5 508,-288.5 461,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"461,-288.5 508,-288.5 508,-311.5 461,-311.5 \"/>\n<text text-anchor=\"start\" x=\"465\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"508,-288.5 508,-311.5 562,-311.5 562,-288.5 508,-288.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"508,-288.5 508,-311.5 562,-311.5 562,-288.5 508,-288.5\"/>\n<text text-anchor=\"start\" x=\"512\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"562,-288.5 562,-311.5 609,-311.5 609,-288.5 562,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"609,-311.5 562,-311.5 562,-288.5 609,-288.5 \"/>\n<text text-anchor=\"start\" x=\"566\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"508,-269.5 508,-288.5 \"/>\n<text text-anchor=\"start\" x=\"465\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"562,-269.5 562,-288.5 \"/>\n<text text-anchor=\"start\" x=\"512\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"565\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge6\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M529.92,-262.65C526.11,-233.59 521.01,-194.55 517.61,-168.62\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"521.04,-167.84 516.27,-158.38 514.1,-168.75 521.04,-167.84\"/>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge9\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M482.27,-262.85C462.23,-248.17 438.68,-230.91 415.71,-214.08\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"417.76,-211.24 407.62,-208.15 413.62,-216.88 417.76,-211.24\"/>\n</g>\n<!-- BS92 -->\n<g id=\"node5\" class=\"node\">\n<title>BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M332,-36C332,-36 300,-36 300,-36 294,-36 288,-30 288,-24 288,-24 288,-12 288,-12 288,-6 294,0 300,0 300,0 332,0 332,0 338,0 344,-6 344,-12 344,-12 344,-24 344,-24 344,-30 338,-36 332,-36\"/>\n<text text-anchor=\"start\" x=\"295\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">BS92</text>\n</g>\n<!-- Tag -->\n<g id=\"node6\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-179.5C150,-179.5 12,-179.5 12,-179.5 6,-179.5 0,-173.5 0,-167.5 0,-167.5 0,-112.5 0,-112.5 0,-106.5 6,-100.5 12,-100.5 12,-100.5 150,-100.5 150,-100.5 156,-100.5 162,-106.5 162,-112.5 162,-112.5 162,-167.5 162,-167.5 162,-173.5 156,-179.5 150,-179.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-149 155,-149 \"/>\n<text text-anchor=\"start\" x=\"67\" y=\"-157.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-126 7,-149 54,-149 54,-126 7,-126\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-126 54,-126 54,-149 7,-149 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-133.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-126 54,-149 108,-149 108,-126 54,-126\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-126 54,-149 108,-149 108,-126 54,-126\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-133.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-126 108,-149 155,-149 155,-126 108,-126\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-149 108,-149 108,-126 155,-126 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-133.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-107 54,-126 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-114\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-107 108,-126 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-114\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-114\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Tag&#45;&gt;BS92 -->\n<g id=\"edge3\" class=\"edge\">\n<title>Tag&#45;&gt;BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M127.39,-100.48C140.92,-90.37 156.09,-80.05 171,-72 205.64,-53.29 248.27,-38.6 278.31,-29.48\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"279.4,-32.81 287.99,-26.6 277.41,-26.1 279.4,-32.81\"/>\n</g>\n<!-- H5Writer&#45;&gt;BS92 -->\n<g id=\"edge4\" class=\"edge\">\n<title>H5Writer&#45;&gt;BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M504.28,-121.94C494.93,-106.91 479.51,-85.38 461,-72 428.7,-48.65 385.01,-34.54 354.05,-26.82\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"354.61,-23.36 344.07,-24.44 352.99,-30.17 354.61,-23.36\"/>\n</g>\n<!-- Production&#45;&gt;BS92 -->\n<g id=\"edge5\" class=\"edge\">\n<title>Production&#45;&gt;BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M316,-71.98C316,-62.93 316,-54.1 316,-46.32\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"319.5,-46.11 316,-36.11 312.5,-46.11 319.5,-46.11\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Within the CarboKitten design, we can express the BS92 model a bit more succinctly. The following produces output that is fully compatible with other CarboKitten models and the included post processing and visualization stack. The H5Writer module provides a run method that expects the initial_state, step! and write_header methods to be available.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>src/Models/BS92.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"@compose module BS92\n@mixin Tag, H5Writer, Production\n\nusing ..Common\nusing ..Production: uniform_production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    sediment_height = zeros(Height, input.box.grid_size...)\n    return State(0, sediment_height)\nend\n\nfunction step!(input::Input)\n    τ = uniform_production(input)\n    function (state::State)\n        prod = τ(state) .* input.time.Δt\n        Δη = sum(prod; dims=1)[1, :, :]\n        state.sediment_height .+= Δη\n        state.step += 1\n        return Frame(\n            production = prod,\n            deposition = prod)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\n\nend","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/run.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: data/output/bs92.h5\n\nmodule Script\n\nusing CarboKitten\nusing CarboKitten.DataSets: bosscher_schlager_1992\n\nusing Interpolations\nusing Unitful\n\nfunction sealevel_curve()\n    data = bosscher_schlager_1992()\n    linear_interpolation(data.time, data.sealevel)\nend\n\nconst INPUT = BS92.Input(\n    tag = \"example model BS92\",\n    box = Box{Coast}(grid_size=(100, 1), phys_scale=600.0u\"m\"),\n    time = TimeProperties(\n      Δt = 10.0u\"yr\",\n      steps = 8000,\n      write_interval = 100),\n    sea_level = let sc = sealevel_curve()\n      t -> -sc(t)\n    end,\n    initial_topography = (x, y) -> - x / 300.0,\n    subsidence_rate = 0.0u\"m/yr\",\n    insolation = 400.0u\"W/m^2\",\n    facies = [BS92.Facies(\n      maximum_growth_rate = 0.005u\"m/yr\",\n      saturation_intensity = 50.0u\"W/m^2\",\n      extinction_coefficient = 0.05u\"m^-1\"\n    )])\n\nfunction main()\n    run_model(Model{BS92}, INPUT, \"data/output/bs92.h5\")\nend\n\nend\n\nScript.main()","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/plot.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: docs/src/_fig/bs92-summary.png\n#| requires: data/output/bs92.h5\n#| collect: figures\n\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/bs92-summary.png\", summary_plot(\"data/output/bs92.h5\"))","category":"page"},{"location":"bosscher-1992/#Multiple-facies","page":"Bosscher and Schlager 1992","title":"Multiple facies","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Using the above implementation of the model by Bosscher and Schlager, we can run the same model with multiple facies. We use the same parameters as Burgess2013, but divide the maximum_growth_rate by four, since we have no CA running and all facies produce at the same time.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/multi-facies-run.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: data/output/bs92-multi-facies.h5\n\nmodule Script\n\nusing CarboKitten\n\nconst FACIES = [\n    BS92.Facies(\n         maximum_growth_rate=500u\"m/Myr\"/4,\n         extinction_coefficient=0.8u\"m^-1\",\n         saturation_intensity=60u\"W/m^2\"),\n    BS92.Facies(\n         maximum_growth_rate=400u\"m/Myr\"/4,\n         extinction_coefficient=0.1u\"m^-1\",\n         saturation_intensity=60u\"W/m^2\"),\n    BS92.Facies(\n         maximum_growth_rate=100u\"m/Myr\"/4,\n         extinction_coefficient=0.005u\"m^-1\",\n         saturation_intensity=60u\"W/m^2\")]\n\nconst INPUT = BS92.Input(\n    tag = \"example model BS92\",\n    box = Box{Coast}(grid_size=(100, 1), phys_scale=150.0u\"m\"),\n    time = TimeProperties(\n        Δt = 200.0u\"yr\",\n        steps = 5000,\n        write_interval = 1),\n    sea_level = t -> 4.0u\"m\" * sin(2π * t / 0.2u\"Myr\"),\n    initial_topography = (x, y) -> - x / 300.0,\n    subsidence_rate = 50.0u\"m/Myr\",\n    insolation = 400.0u\"W/m^2\",\n    facies = FACIES)\n\nfunction main()\n    run_model(Model{BS92}, INPUT, \"data/output/bs92-multi-facies.h5\")\nend\n\nend\n\nScript.main()","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/multi-facies-plot.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: docs/src/_fig/bs92-multi-facies.png\n#| requires: data/output/bs92-multi-facies.h5\n#| collect: figures\n\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/bs92-multi-facies.png\", summary_plot(\"data/output/bs92-multi-facies.h5\", wheeler_smooth=(3, 5)))","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: BS92 with multiple facies)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"","category":"page"},{"location":"model-alcap/#Model-with-CA,-Production-and-Active-Layer-transport-(ALCAP)","page":"ALCAPS","title":"Model with CA, Production and Active Layer transport (ALCAP)","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"The following Sedimentation model includes the Burgess 2013 Cellular Automaton, Bosscher & Schlager 1992 Production curves and an Active Layer transport model, based on Paola 1992, henceforth ALCAP.","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"(Image: Result from alternative input)","category":"page"},{"location":"model-alcap/#Example-Input","page":"ALCAPS","title":"Example Input","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"The following is a complete example input.","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">⪡alcap-example-input⪢≣</div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"const TAG = \"alcap-example\"\n\nconst FACIES = [\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=500u\"m/Myr\",\n        extinction_coefficient=0.8u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=50.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=400u\"m/Myr\",\n        extinction_coefficient=0.1u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=25.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=100u\"m/Myr\",\n        extinction_coefficient=0.005u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=12.5u\"m/yr\")\n]\n\nconst PERIOD = 0.2u\"Myr\"\nconst AMPLITUDE = 4.0u\"m\"\n\nconst INPUT = ALCAP.Input(\n    tag=\"$TAG\",\n    box=Box{Coast}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n    time=TimeProperties(\n        Δt=0.0002u\"Myr\",\n        steps=1000,\n        write_interval=1),\n    ca_interval=1,\n    initial_topography=(x, y) -> -x / 300.0,\n    sea_level=t -> AMPLITUDE * sin(2π * t / PERIOD),\n    subsidence_rate=50.0u\"m/Myr\",\n    disintegration_rate=50.0u\"m/Myr\",\n    insolation=400.0u\"W/m^2\",\n    sediment_buffer_size=50,\n    depositional_resolution=0.5u\"m\",\n    facies=FACIES)","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>examples/model/alcap/run.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"#| requires: src/Models/ALCAP.jl\n#| creates: data/output/alcap-example.h5\n\nmodule Script\n\nusing Unitful\nusing CarboKitten\nusing CarboKitten.Export: data_export, CSV\nusing CarboKitten.Transport.Solvers: forward_euler\n\nconst PATH = \"data/output\"\n\n<<alcap-example-input>>\n\nfunction main()\n    run_model(Model{ALCAP}, INPUT, \"$(PATH)/$(TAG).h5\")\n\n    data_export(\n        CSV(tuple.(10:20:70, 25),\n            :sediment_accumulation_curve => \"$(PATH)/$(TAG)_sac.csv\",\n            :age_depth_model => \"$(PATH)/$(TAG)_adm.csv\",\n            :stratigraphic_column => \"$(PATH)/$(TAG)_sc.csv\",\n            :water_depth => \"$(PATH)/$(TAG)_wd.csv\",\n            :metadata => \"$(PATH)/$(TAG).toml\"),\n        \"$(PATH)/$(TAG).h5\")\nend\n\nend\n\nScript.main()","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>examples/model/alcap/plot.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"#| creates: docs/src/_fig/alcaps-alternative.png\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/alcaps-alternative.png\", summary_plot(\"data/output/alcap-example.h5\"))","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"</details>","category":"page"},{"location":"model-alcap/#Modular-Implementation","page":"ALCAPS","title":"Modular Implementation","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"1116pt\" height=\"599pt\"\n viewBox=\"0.00 0.00 1115.50 599.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 595)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-595 1111.5,-595 1111.5,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M630,-591C630,-591 492,-591 492,-591 486,-591 480,-585 480,-579 480,-579 480,-524 480,-524 480,-518 486,-512 492,-512 492,-512 630,-512 630,-512 636,-512 642,-518 642,-524 642,-524 642,-579 642,-579 642,-585 636,-591 630,-591\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-560.5 635,-560.5 \"/>\n<text text-anchor=\"start\" x=\"537.5\" y=\"-569.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"487,-537.5 487,-560.5 534,-560.5 534,-537.5 487,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-537.5 534,-537.5 534,-560.5 487,-560.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"534,-537.5 534,-560.5 588,-560.5 588,-537.5 534,-537.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"534,-537.5 534,-560.5 588,-560.5 588,-537.5 534,-537.5\"/>\n<text text-anchor=\"start\" x=\"538\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"588,-537.5 588,-560.5 635,-560.5 635,-537.5 588,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"635,-560.5 588,-560.5 588,-537.5 635,-537.5 \"/>\n<text text-anchor=\"start\" x=\"592\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"534,-518.5 534,-537.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"588,-518.5 588,-537.5 \"/>\n<text text-anchor=\"start\" x=\"538\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"591\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M600,-476C600,-476 342,-476 342,-476 336,-476 330,-470 330,-464 330,-464 330,-371 330,-371 330,-365 336,-359 342,-359 342,-359 600,-359 600,-359 606,-359 612,-365 612,-371 612,-371 612,-464 612,-464 612,-470 606,-476 600,-476\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-445.5 605,-445.5 \"/>\n<text text-anchor=\"start\" x=\"423.5\" y=\"-454.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"337,-422.5 337,-445.5 454,-445.5 454,-422.5 337,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-422.5 454,-422.5 454,-445.5 337,-445.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"454,-422.5 454,-445.5 508,-445.5 508,-422.5 454,-422.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"454,-422.5 454,-445.5 508,-445.5 508,-422.5 454,-422.5\"/>\n<text text-anchor=\"start\" x=\"458\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"508,-422.5 508,-445.5 605,-445.5 605,-422.5 508,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"605,-445.5 508,-445.5 508,-422.5 605,-422.5 \"/>\n<text text-anchor=\"start\" x=\"512\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"454,-403.5 454,-422.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"508,-403.5 508,-422.5 \"/>\n<text text-anchor=\"start\" x=\"458\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"511\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"454,-384.5 454,-403.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"508,-384.5 508,-403.5 \"/>\n<text text-anchor=\"start\" x=\"458\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"511\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"454,-365.5 454,-384.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"508,-365.5 508,-384.5 \"/>\n<text text-anchor=\"start\" x=\"458\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"511\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M534.73,-511.97C528.93,-503.46 522.62,-494.21 516.31,-484.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"519.05,-482.76 510.52,-476.47 513.27,-486.7 519.05,-482.76\"/>\n</g>\n<!-- SedimentBuffer -->\n<g id=\"node6\" class=\"node\">\n<title>SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-466.5C300,-466.5 12,-466.5 12,-466.5 6,-466.5 0,-460.5 0,-454.5 0,-454.5 0,-380.5 0,-380.5 0,-374.5 6,-368.5 12,-368.5 12,-368.5 300,-368.5 300,-368.5 306,-368.5 312,-374.5 312,-380.5 312,-380.5 312,-454.5 312,-454.5 312,-460.5 306,-466.5 300,-466.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-436.5 305,-436.5 \"/>\n<text text-anchor=\"start\" x=\"93\" y=\"-445.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">SedimentBuffer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-413.5 7,-436.5 154,-436.5 154,-413.5 7,-413.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-413.5 154,-413.5 154,-436.5 7,-436.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-421.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-413.5 154,-436.5 208,-436.5 208,-413.5 154,-413.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-413.5 154,-436.5 208,-436.5 208,-413.5 154,-413.5\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-421.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-413.5 208,-436.5 305,-436.5 305,-413.5 208,-413.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-436.5 208,-436.5 208,-413.5 305,-413.5 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-421.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-394.5 154,-413.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-401.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer_size</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-394.5 208,-413.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-401.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-401.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-375.5 154,-394.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-382.5\" font-family=\"monospace\" font-size=\"10.00\">depositional_resolution</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-375.5 208,-394.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-382.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-382.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;SedimentBuffer -->\n<g id=\"edge10\" class=\"edge\">\n<title>Boxes&#45;&gt;SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M479.8,-515.04C476.84,-513.98 473.9,-512.96 471,-512 405.92,-490.44 386.79,-495.3 321,-476 314.1,-473.97 307.05,-471.83 299.96,-469.61\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"300.85,-466.22 290.26,-466.53 298.74,-472.89 300.85,-466.22\"/>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node10\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M1095.5,-304C1095.5,-304 834.5,-304 834.5,-304 828.5,-304 822.5,-298 822.5,-292 822.5,-292 822.5,-218 822.5,-218 822.5,-212 828.5,-206 834.5,-206 834.5,-206 1095.5,-206 1095.5,-206 1101.5,-206 1107.5,-212 1107.5,-218 1107.5,-218 1107.5,-292 1107.5,-292 1107.5,-298 1101.5,-304 1095.5,-304\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"830,-274 1101,-274 \"/>\n<text text-anchor=\"start\" x=\"890\" y=\"-282.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"830,-251 830,-274 923,-274 923,-251 830,-251\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"830,-251 923,-251 923,-274 830,-274 \"/>\n<text text-anchor=\"start\" x=\"834\" y=\"-258.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"923,-251 923,-274 1028,-274 1028,-251 923,-251\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"923,-251 923,-274 1028,-274 1028,-251 923,-251\"/>\n<text text-anchor=\"start\" x=\"927\" y=\"-258.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"1028,-251 1028,-274 1101,-274 1101,-251 1028,-251\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"1101,-274 1028,-274 1028,-251 1101,-251 \"/>\n<text text-anchor=\"start\" x=\"1032\" y=\"-258.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"923,-232 923,-251 \"/>\n<text text-anchor=\"start\" x=\"834\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"1028,-232 1028,-251 \"/>\n<text text-anchor=\"start\" x=\"927\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"1031\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"923,-213 923,-232 \"/>\n<text text-anchor=\"start\" x=\"834\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"1028,-213 1028,-232 \"/>\n<text text-anchor=\"start\" x=\"927\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"1031\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge17\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M642,-538.46C691.41,-528.09 753.89,-509.32 801,-476 860.68,-433.79 907.74,-363.14 935.86,-313.3\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"939.1,-314.7 940.89,-304.25 932.98,-311.29 939.1,-314.7\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M450,-591C450,-591 312,-591 312,-591 306,-591 300,-585 300,-579 300,-579 300,-524 300,-524 300,-518 306,-512 312,-512 312,-512 450,-512 450,-512 456,-512 462,-518 462,-524 462,-524 462,-579 462,-579 462,-585 456,-591 450,-591\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-560.5 455,-560.5 \"/>\n<text text-anchor=\"start\" x=\"315.5\" y=\"-569.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"307,-537.5 307,-560.5 354,-560.5 354,-537.5 307,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-537.5 354,-537.5 354,-560.5 307,-560.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"354,-537.5 354,-560.5 408,-560.5 408,-537.5 354,-537.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"354,-537.5 354,-560.5 408,-560.5 408,-537.5 354,-537.5\"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"408,-537.5 408,-560.5 455,-560.5 455,-537.5 408,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"455,-560.5 408,-560.5 408,-537.5 455,-537.5 \"/>\n<text text-anchor=\"start\" x=\"412\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"354,-518.5 354,-537.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"408,-518.5 408,-537.5 \"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"411\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M407.27,-511.97C413.07,-503.46 419.38,-494.21 425.69,-484.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"428.73,-486.7 431.48,-476.47 422.95,-482.76 428.73,-486.7\"/>\n</g>\n<!-- ActiveLayer -->\n<g id=\"node4\" class=\"node\">\n<title>ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M396.5,-313.5C396.5,-313.5 101.5,-313.5 101.5,-313.5 95.5,-313.5 89.5,-307.5 89.5,-301.5 89.5,-301.5 89.5,-208.5 89.5,-208.5 89.5,-202.5 95.5,-196.5 101.5,-196.5 101.5,-196.5 396.5,-196.5 396.5,-196.5 402.5,-196.5 408.5,-202.5 408.5,-208.5 408.5,-208.5 408.5,-301.5 408.5,-301.5 408.5,-307.5 402.5,-313.5 396.5,-313.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"97,-283 402,-283 \"/>\n<text text-anchor=\"start\" x=\"203.5\" y=\"-291.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">ActiveLayer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"97,-260 97,-283 220,-283 220,-260 97,-260\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"97,-260 220,-260 220,-283 97,-283 \"/>\n<text text-anchor=\"start\" x=\"101\" y=\"-267.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"220,-260 220,-283 355,-283 355,-260 220,-260\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"220,-260 220,-283 355,-283 355,-260 220,-260\"/>\n<text text-anchor=\"start\" x=\"224\" y=\"-267.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"355,-260 355,-283 402,-283 402,-260 355,-260\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"402,-283 355,-283 355,-260 402,-260 \"/>\n<text text-anchor=\"start\" x=\"359\" y=\"-267.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"220,-241 220,-260 \"/>\n<text text-anchor=\"start\" x=\"101\" y=\"-248\" font-family=\"monospace\" font-size=\"10.00\">disintegration_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"355,-241 355,-260 \"/>\n<text text-anchor=\"start\" x=\"224\" y=\"-248\" font-family=\"monospace\" font-size=\"10.00\">diffusion_coefficient</text>\n<text text-anchor=\"start\" x=\"358\" y=\"-248\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"220,-222 220,-241 \"/>\n<text text-anchor=\"start\" x=\"101\" y=\"-229\" font-family=\"monospace\" font-size=\"10.00\">transport_solver</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"355,-222 355,-241 \"/>\n<text text-anchor=\"start\" x=\"224\" y=\"-229\" font-family=\"monospace\" font-size=\"10.00\">wave_velocity</text>\n<text text-anchor=\"start\" x=\"358\" y=\"-229\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"220,-203 220,-222 \"/>\n<text text-anchor=\"start\" x=\"101\" y=\"-210\" font-family=\"monospace\" font-size=\"10.00\">transport_substeps</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"355,-203 355,-222 \"/>\n<text text-anchor=\"start\" x=\"224\" y=\"-210\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"358\" y=\"-210\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;ActiveLayer -->\n<g id=\"edge3\" class=\"edge\">\n<title>WaterDepth&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M391.17,-358.78C373.6,-346.08 354.89,-332.56 337.02,-319.63\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"339.03,-316.77 328.87,-313.74 334.92,-322.44 339.03,-316.77\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node7\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M503.5,-273C503.5,-273 438.5,-273 438.5,-273 432.5,-273 426.5,-267 426.5,-261 426.5,-261 426.5,-249 426.5,-249 426.5,-243 432.5,-237 438.5,-237 438.5,-237 503.5,-237 503.5,-237 509.5,-237 515.5,-243 515.5,-249 515.5,-249 515.5,-261 515.5,-261 515.5,-267 509.5,-273 503.5,-273\"/>\n<text text-anchor=\"start\" x=\"433.5\" y=\"-252.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge7\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M471,-358.56C471,-332.98 471,-304.13 471,-283.55\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"474.5,-283.33 471,-273.33 467.5,-283.33 474.5,-283.33\"/>\n</g>\n<!-- Production -->\n<g id=\"node8\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M792.5,-323C792.5,-323 545.5,-323 545.5,-323 539.5,-323 533.5,-317 533.5,-311 533.5,-311 533.5,-199 533.5,-199 533.5,-193 539.5,-187 545.5,-187 545.5,-187 792.5,-187 792.5,-187 798.5,-187 804.5,-193 804.5,-199 804.5,-199 804.5,-311 804.5,-311 804.5,-317 798.5,-323 792.5,-323\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"541,-293 798,-293 \"/>\n<text text-anchor=\"start\" x=\"625.5\" y=\"-301.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"541,-270 541,-293 610,-293 610,-270 541,-270\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"541,-270 610,-270 610,-293 541,-293 \"/>\n<text text-anchor=\"start\" x=\"545\" y=\"-277.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"610,-270 610,-293 751,-293 751,-270 610,-270\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"610,-270 610,-293 751,-293 751,-270 610,-270\"/>\n<text text-anchor=\"start\" x=\"614\" y=\"-277.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"751,-270 751,-293 798,-293 798,-270 751,-270\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"798,-293 751,-293 751,-270 798,-270 \"/>\n<text text-anchor=\"start\" x=\"755\" y=\"-277.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"610,-251 610,-270 \"/>\n<text text-anchor=\"start\" x=\"545\" y=\"-258\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"751,-251 751,-270 \"/>\n<text text-anchor=\"start\" x=\"614\" y=\"-258\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"754\" y=\"-258\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"610,-232 610,-251 \"/>\n<text text-anchor=\"start\" x=\"545\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"751,-232 751,-251 \"/>\n<text text-anchor=\"start\" x=\"614\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"754\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"610,-213 610,-232 \"/>\n<text text-anchor=\"start\" x=\"545\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"751,-213 751,-232 \"/>\n<text text-anchor=\"start\" x=\"614\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"754\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"610,-194 610,-213 \"/>\n<text text-anchor=\"start\" x=\"545\" y=\"-201\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"751,-194 751,-213 \"/>\n<text text-anchor=\"start\" x=\"614\" y=\"-201\" font-family=\"monospace\" font-size=\"10.00\">production_offset</text>\n<text text-anchor=\"start\" x=\"754\" y=\"-201\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge8\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M542.2,-358.78C553.93,-349.27 566.23,-339.3 578.36,-329.47\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"580.74,-332.05 586.3,-323.03 576.33,-326.61 580.74,-332.05\"/>\n</g>\n<!-- ALCAP -->\n<g id=\"node12\" class=\"node\">\n<title>ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M564.5,-36C564.5,-36 521.5,-36 521.5,-36 515.5,-36 509.5,-30 509.5,-24 509.5,-24 509.5,-12 509.5,-12 509.5,-6 515.5,0 521.5,0 521.5,0 564.5,0 564.5,0 570.5,0 576.5,-6 576.5,-12 576.5,-12 576.5,-24 576.5,-24 576.5,-30 570.5,-36 564.5,-36\"/>\n<text text-anchor=\"start\" x=\"516.5\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">ALCAP</text>\n</g>\n<!-- ActiveLayer&#45;&gt;ALCAP -->\n<g id=\"edge16\" class=\"edge\">\n<title>ActiveLayer&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M321.3,-196.21C383.11,-146.8 468.93,-78.21 513.49,-42.59\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"515.95,-45.1 521.57,-36.13 511.58,-39.64 515.95,-45.1\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node5\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M780,-457C780,-457 642,-457 642,-457 636,-457 630,-451 630,-445 630,-445 630,-390 630,-390 630,-384 636,-378 642,-378 642,-378 780,-378 780,-378 786,-378 792,-384 792,-390 792,-390 792,-445 792,-445 792,-451 786,-457 780,-457\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"637,-426.5 785,-426.5 \"/>\n<text text-anchor=\"start\" x=\"667\" y=\"-435.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"637,-403.5 637,-426.5 684,-426.5 684,-403.5 637,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"637,-403.5 684,-403.5 684,-426.5 637,-426.5 \"/>\n<text text-anchor=\"start\" x=\"641\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"684,-403.5 684,-426.5 738,-426.5 738,-403.5 684,-403.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"684,-403.5 684,-426.5 738,-426.5 738,-403.5 684,-403.5\"/>\n<text text-anchor=\"start\" x=\"688\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"738,-403.5 738,-426.5 785,-426.5 785,-403.5 738,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"785,-426.5 738,-426.5 738,-403.5 785,-403.5 \"/>\n<text text-anchor=\"start\" x=\"742\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"684,-384.5 684,-403.5 \"/>\n<text text-anchor=\"start\" x=\"641\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"738,-384.5 738,-403.5 \"/>\n<text text-anchor=\"start\" x=\"688\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"741\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;ActiveLayer -->\n<g id=\"edge4\" class=\"edge\">\n<title>FaciesBase&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M658.11,-377.9C646.35,-370.71 633.61,-363.92 621,-359 535.64,-325.69 506.15,-348.01 418,-323 411.37,-321.12 404.64,-319.07 397.88,-316.9\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"398.55,-313.43 387.96,-313.63 396.36,-320.08 398.55,-313.43\"/>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge6\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M654.44,-377.84C643.57,-371.14 632.11,-364.56 621,-359 580.24,-338.62 561.94,-349.68 525,-323 509.7,-311.95 496.35,-295.49 486.75,-281.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"489.46,-279.4 481,-273.02 483.63,-283.28 489.46,-279.4\"/>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge9\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M700.83,-377.65C697.33,-364.25 693.27,-348.74 689.25,-333.37\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"692.53,-332.1 686.61,-323.31 685.76,-333.87 692.53,-332.1\"/>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge18\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M772.16,-377.85C804.51,-357.41 844.72,-332 880.05,-309.68\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"882.33,-312.38 888.91,-304.08 878.59,-306.46 882.33,-312.38\"/>\n</g>\n<!-- SedimentBuffer&#45;&gt;ActiveLayer -->\n<g id=\"edge5\" class=\"edge\">\n<title>SedimentBuffer&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M183.9,-368.34C192.22,-353.99 201.49,-337.99 210.37,-322.67\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"213.55,-324.16 215.54,-313.75 207.5,-320.65 213.55,-324.16\"/>\n</g>\n<!-- H5Writer&#45;&gt;ALCAP -->\n<g id=\"edge14\" class=\"edge\">\n<title>H5Writer&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M476.29,-236.72C488.7,-196.23 519.72,-94.98 534.68,-46.16\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"538.11,-46.89 537.7,-36.31 531.42,-44.84 538.11,-46.89\"/>\n</g>\n<!-- CAProduction -->\n<g id=\"node9\" class=\"node\">\n<title>CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M691.5,-129.5C691.5,-129.5 592.5,-129.5 592.5,-129.5 586.5,-129.5 580.5,-123.5 580.5,-117.5 580.5,-117.5 580.5,-105.5 580.5,-105.5 580.5,-99.5 586.5,-93.5 592.5,-93.5 592.5,-93.5 691.5,-93.5 691.5,-93.5 697.5,-93.5 703.5,-99.5 703.5,-105.5 703.5,-105.5 703.5,-117.5 703.5,-117.5 703.5,-123.5 697.5,-129.5 691.5,-129.5\"/>\n<text text-anchor=\"start\" x=\"587.5\" y=\"-108.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAProduction</text>\n</g>\n<!-- Production&#45;&gt;CAProduction -->\n<g id=\"edge12\" class=\"edge\">\n<title>Production&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M656.21,-186.98C653.01,-170.18 649.75,-153.11 647.16,-139.55\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"650.56,-138.67 645.24,-129.5 643.68,-139.98 650.56,-138.67\"/>\n</g>\n<!-- CAProduction&#45;&gt;ALCAP -->\n<g id=\"edge15\" class=\"edge\">\n<title>CAProduction&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M623.38,-93.29C608.03,-79.1 586.09,-58.82 569,-43.03\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"571.26,-40.35 561.54,-36.13 566.51,-45.49 571.26,-40.35\"/>\n</g>\n<!-- CellularAutomaton&#45;&gt;CAProduction -->\n<g id=\"edge11\" class=\"edge\">\n<title>CellularAutomaton&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M859.42,-205.95C844.25,-199.4 828.78,-192.9 814,-187 769.74,-169.32 756.52,-170.42 713,-151 702.11,-146.14 690.61,-140.26 680.12,-134.57\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"681.64,-131.41 671.19,-129.65 678.26,-137.54 681.64,-131.41\"/>\n</g>\n<!-- Tag -->\n<g id=\"node11\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M872,-151C872,-151 734,-151 734,-151 728,-151 722,-145 722,-139 722,-139 722,-84 722,-84 722,-78 728,-72 734,-72 734,-72 872,-72 872,-72 878,-72 884,-78 884,-84 884,-84 884,-139 884,-139 884,-145 878,-151 872,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"729,-120.5 877,-120.5 \"/>\n<text text-anchor=\"start\" x=\"789\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"729,-97.5 729,-120.5 776,-120.5 776,-97.5 729,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"729,-97.5 776,-97.5 776,-120.5 729,-120.5 \"/>\n<text text-anchor=\"start\" x=\"733\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"776,-97.5 776,-120.5 830,-120.5 830,-97.5 776,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"776,-97.5 776,-120.5 830,-120.5 830,-97.5 776,-97.5\"/>\n<text text-anchor=\"start\" x=\"780\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"830,-97.5 830,-120.5 877,-120.5 877,-97.5 830,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"877,-120.5 830,-120.5 830,-97.5 877,-97.5 \"/>\n<text text-anchor=\"start\" x=\"834\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"776,-78.5 776,-97.5 \"/>\n<text text-anchor=\"start\" x=\"733\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"830,-78.5 830,-97.5 \"/>\n<text text-anchor=\"start\" x=\"780\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"833\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Tag&#45;&gt;ALCAP -->\n<g id=\"edge13\" class=\"edge\">\n<title>Tag&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M721.71,-75.29C718.78,-74.16 715.87,-73.06 713,-72 670.5,-56.33 620.95,-41.23 586.35,-31.19\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"587.14,-27.77 576.56,-28.37 585.2,-34.5 587.14,-27.77\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>src/Models/ALCAP/Example.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"module Example\n\nusing Unitful\nusing ..ALCAP: ALCAP\nusing CarboKitten.Boxes: Box, Coast\nusing CarboKitten.Config: TimeProperties\n\n<<alcap-example-input>>\n\nend","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>src/Models/ALCAP.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"@compose module ALCAP\n@mixin Tag, H5Writer, CAProduction, ActiveLayer\n\nusing ..Common\nusing ..CAProduction: production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::AbstractInput)\n    ca_state = CellularAutomaton.initial_state(input)\n    for _ in 1:20\n        CellularAutomaton.step!(input)(ca_state)\n    end\n\n    sediment_height = zeros(Height, input.box.grid_size...)\n    sediment_buffer = zeros(Float64, input.sediment_buffer_size, n_facies(input), input.box.grid_size...)\n\n    return State(\n        step=0, sediment_height=sediment_height,\n        sediment_buffer=sediment_buffer,\n        ca=ca_state.ca, ca_priority=ca_state.ca_priority)\nend\n\nfunction step!(input::Input)\n    step_ca! = CellularAutomaton.step!(input)\n    disintegrate! = ActiveLayer.disintegrator(input)\n    produce = production(input)\n    transport! = ActiveLayer.transporter(input)\n\n    function (state::State)\n        if mod(state.step, input.ca_interval) == 0\n            step_ca!(state)\n        end\n\n        p = produce(state)\n        d = disintegrate!(state)\n\n        active_layer = p .+ d\n        transport!(state, active_layer)\n\n        push_sediment!(state.sediment_buffer, active_layer ./ input.depositional_resolution .|> NoUnits)\n        state.sediment_height .+= sum(active_layer; dims=1)[1,:,:]\n        state.step += 1\n\n        return Frame(\n            production = p,\n            disintegration = d,\n            deposition = active_layer)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\n\ninclude(\"ALCAP/Example.jl\")\n\nend","category":"page"},{"location":"model-alcap/#API","page":"ALCAPS","title":"API","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"Modules = [CarboKitten.Models.ALCAP]","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"","category":"page"},{"location":"first_tutorial/","page":"Tutorial (Pluto notebook)","title":"Tutorial (Pluto notebook)","text":"","category":"page"},{"location":"getting-started/#Getting-Started","page":"Getting Started","title":"Getting Started","text":"","category":"section"},{"location":"getting-started/#TODO","page":"Getting Started","title":"TODO","text":"","category":"section"},{"location":"getting-started/","page":"Getting Started","title":"Getting Started","text":"[ ] Xianhi: outline a user story\n[ ] Johan: implement","category":"page"},{"location":"getting-started/","page":"Getting Started","title":"Getting Started","text":"","category":"page"},{"location":"components/denudation/#Denudation-component","page":"Denudation component","title":"Denudation component","text":"","category":"section"},{"location":"components/denudation/","page":"Denudation component","title":"Denudation component","text":"<div class=\"noweb-label\">file:<i>src/Components/Denudation.jl</i></div>","category":"page"},{"location":"components/denudation/","page":"Denudation component","title":"Denudation component","text":"@compose module Denudation\n    @mixin Boxes, WaterDepth, SedimentBuffer, FaciesBase\n    using ..Common\n    using CarboKitten.Denudation: DenudationType\n    using CarboKitten.BoundaryTrait\n    using CarboKitten.Stencil: stencil\n    using CarboKitten.Denudation: Dissolution, EmpiricalDenudation, PhysicalErosion, NoDenudation, denudation, redistribution, slope_kernel\n\n    export slope_function\n    export Dissolution, EmpiricalDenudation, PhysicalErosion, NoDenudation, denudation, redistribution, slope_kernel\n\n\n    @kwdef struct Facies <: AbstractFacies\n        reactive_surface::typeof(1.0u\"m^2/m^3\") #reactive surface\n        mass_density::typeof(1.0u\"kg/m^3\") #density of different carb factory\n        infiltration_coefficient::Float64 #infiltration coeff\n        erodibility::typeof(1.0u\"m/yr\")\n    end\n\n    @kwdef struct Input <: AbstractInput\n        denudation::DenudationType\n    end\n\n    function slope_function(input,box::Box{BT}) where {BT<:Boundary}\n        return stencil(Float64, BT, (3, 3), slope_kernel) \n    end\nend","category":"page"},{"location":"components/denudation/","page":"Denudation component","title":"Denudation component","text":"","category":"page"},{"location":"components/facies/#Facies-Base","page":"Facies","title":"Facies Base","text":"","category":"section"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- FaciesBase -->\n<g id=\"node1\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"37\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"Base module for including facies.","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"<div class=\"noweb-label\">file:<i>test/Components/FaciesBaseSpec.jl</i></div>","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"module FaciesBaseSpec\n    using Test\n    using CarboKitten.Components.Common\n    using CarboKitten.Components.FaciesBase: Facies, Input, n_facies\n\n    @testset \"Components/FaciesBase\" begin\n        let input = Input(facies=fill(Facies(), 23))\n            @test n_facies(input) == 23\n        end\n    end\nend","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"<div class=\"noweb-label\">file:<i>src/Components/FaciesBase.jl</i></div>","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"@compose module FaciesBase\nusing ..Common\n\nusing HDF5\nexport n_facies\n\n@kwdef struct Facies <: AbstractFacies\nend\n\n@kwdef struct Input <: AbstractInput\n    facies::Vector{Facies} = []\nend\n\nn_facies(input::AbstractInput) = length(input.facies)\n\nfunction write_header(fid, input::AbstractInput)\n    attr = attributes(fid[\"input\"])\n    attr[\"n_facies\"] = n_facies(input)\n    for i in 1:n_facies(input)\n        create_group(fid[\"input\"], \"facies$(i)\")\n    end\nend\nend","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"","category":"page"},{"location":"models/with-denudation/#Model-including-denudation","page":"Model including denudation","title":"Model including denudation","text":"","category":"section"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"This is largely identical to the ALCAP model.","category":"page"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"<div class=\"noweb-label\">file:<i>src/Models/WithDenudation.jl</i></div>","category":"page"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"@compose module WithDenudation\n@mixin Tag, H5Writer, CAProduction, ActiveLayer, Denudation\n\nusing ..Common\nusing ..CAProduction: production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\nusing ...Stencil\nusing ...BoundaryTrait\nusing ...Denudation.EmpiricalDenudationMod: slope_kernel\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    ca_state = CellularAutomaton.initial_state(input)\n    for _ in 1:20\n        CellularAutomaton.step!(input)(ca_state)\n    end\n\n    sediment_height = zeros(Height, input.box.grid_size...)\n    sediment_buffer = zeros(Float64, input.sediment_buffer_size, n_facies(input), input.box.grid_size...)\n\n    return State(\n        step=0, sediment_height=sediment_height,\n        sediment_buffer=sediment_buffer,\n        ca=ca_state.ca, ca_priority=ca_state.ca_priority)\nend\n\nfunction step!(input::Input)\n    step_ca! = CellularAutomaton.step!(input)\n    disintegrate! = disintegration(input)\n    produce = production(input)\n    transport = transportation(input)\n    denudate = denudation(input)\n    redistribute = redistribution(input)\n    water_depth_fn = water_depth(input)\n    slopefn = slope_function(input,input.box)\n    # Somehow deal with the units here\n\n    slope = Array{Float64}(undef, input.box.grid_size...)\n    denuded_sediment = Array{Float64}(undef, n_facies(input), input.box.grid_size...)\n\n    function (state::State)\n        if mod(state.step, input.ca_interval) == 0\n            step_ca!(state)\n        end\n\n        w = water_depth_fn(state) ./u\"m\"\n        slopefn(w, slope, input.box.phys_scale ./ u\"m\")\n\n        # submarine: production and transport\n        p = produce(state)\n        d = disintegrate!(state)\n\n        active_layer = p .+ d\n        sediment = transport(state, active_layer)\n\n\n        # subaerial: denudation and redistribution\n        # this code should go into the Denudation component\n        denudation_mass = denudate(state,w,slope)\n        if denudation_mass !== nothing\n            denudation_mass = denudate(state,w,slope) |> x -> sum(x,dims=1) |> x -> dropdims(x,dims=1) |> x -> min.(x, state.sediment_height)\n\n            state.sediment_height -= denudation_mass\n            pop_sediment!(state.sediment_buffer, denudation_mass ./ input.depositional_resolution .|> NoUnits, denuded_sediment)\n\n            d += denuded_sediment .* input.depositional_resolution\n\n            redistribution_mass = redistribute(state, w, denuded_sediment .* input.depositional_resolution)\n            if redistribution_mass !== nothing\n                sediment .+= redistribution_mass\n            end\n        end\n\n        push_sediment!(state.sediment_buffer, sediment ./ input.depositional_resolution .|> NoUnits)\n\n        state.sediment_height .+= sum(sediment; dims=1)[1,:,:]\n        state.step += 1\n\n        return Frame(\n            production = p,\n            disintegration = d,\n            deposition = sediment)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\nend","category":"page"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"","category":"page"},{"location":"components/tag/#Tags","page":"Tags","title":"Tags","text":"","category":"section"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- Tag -->\n<g id=\"node1\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"67\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"This module allows simulations to be tagged with a string.","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"<div class=\"noweb-label\">file:<i>src/Components/Tag.jl</i></div>","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"@compose module Tag\nusing ..Common\nusing HDF5\n\n@kwdef struct Input <: AbstractInput\n    tag::String = \"untagged run\"\nend\n\nfunction write_header(fid, input::AbstractInput)\n    attr = attributes(fid[\"input\"])\n    attr[\"tag\"] = input.tag\nend\nend","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"","category":"page"},{"location":"architecture/#Architecture","page":"Architecture","title":"Architecture","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"CarboKitten is modular in design. This gives us the advantage of few repetitions in the code, but it also means a little study getting in to developing CarboKitten.","category":"page"},{"location":"architecture/#Models","page":"Architecture","title":"Models","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"A model is a module that must have certain data structures and methods implemented.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"struct Input <: AbstractInput: contains all input parameters\nstruct State <: AbstractState: contains all run-time state\nfunction initial_state(input): creates an initial State from an Input\nfunction step!(input)(state): curried function to advance state and return a H5Writer.DataFrame\nfunction write_header(fid, input): writes meta-data to an open HDF5 file","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"For most models the Input and State structures are generated from a hierarchy of components, which is explained below.","category":"page"},{"location":"architecture/#step!","page":"Architecture","title":"step!","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"The step! method deserves some extra attention: this is where the high-level logic of a model goes. Running a model is nothing but a repeated application of step!(input) on the state. Note that the step! function is curried: the input and state parameters are given on separate occasions. This allows the model to prepare later execution on state in a more efficient manner. For example, we may allocate memory or prepare quantities derived from input variables.","category":"page"},{"location":"architecture/#Components","page":"Architecture","title":"Components","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"A model in CarboKitten is composed of components. Each component extends the Input and/or State data structures with members and can also provide functions that work on those elements. Components can inherit from each other. For instance, the WaterDepth component inherits from Boxes component to have a notion of the grid size, and the TimeIntegration component to obtain a time coordinate from the state.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"A component has the following syntax:","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"@compose module MyComponent\n    @mixin DependencyA, DependencyB\n    using ..Common\n\n    @kwdef struct Input <: AbstractInput\n        ...\n    end\n\n    ...\nend","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"Here the Common module is a normal Julia module living in the same scope as the component. This Common module contains common definitions used throughout the CarboKitten code base.","category":"page"},{"location":"architecture/#H5Writer","page":"Architecture","title":"H5Writer","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"The H5Writer component is special as it serves to execute a model. For example, if we have a model MyModel with all the required definitions,","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"@component module MyModel\n    @mixin Tag, H5Writer, ...\n    ...\n\n    function step!(input)\n        ...\n        return function (state)\n            ...\n            return H5Writer.DataFrame(...)\n        end\n    end\n\n    ...\nend","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"We can run that model as follows:","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"H5Writer.run(Model{MyModel}, MyModel.Input(), \"output.h5\")","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"This will call MyModel.initial_state first, then repeatedly MyModel.step!, which should return a H5Writer.DataFrame for writing to HDF5. Here Model is a value type (defined in CarboKitten.Components.Common).","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"","category":"page"},{"location":"data-export/#Data-export","page":"CSV Export","title":"Data export","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We provide several ways to export reduced data from CarboKitten to CSV files that are easier to read, visualize and post-process for most people.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-specification⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"abstract type ExportSpecification end\n\n@kwdef struct CSV <: ExportSpecification\n    grid_locations::Vector{NTuple{2,Int}}\n    output_files::IdDict{Symbol,String}\nend\n\nCSV(grid_locations, kwargs...) = CSV(grid_locations, IdDict(kwargs...))","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"using CarboKitten.Export: CSV\n\nCSV(tuple.(10:20:70, 25),\n  :sediment_accumulation_curve => \"run_06_sac.csv\",\n  :age_depth_model             => \"run_06_adm.csv\",\n  :stratigraphic_column        => \"run_06_sc.csv\",\n  :water_depth                 => \"run_06_wd.csv\",\n  :metadata                    => \"run_06.toml\")","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"There is a data_export function that can be overloaded with any ExportSpcification. When given a CSV specification, files are written as given.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":":sediment_accumulation_curve  (SAC) is another term for sediment_height elsewhere in the code.\n:age_depth_model (ADM) is a monotonic version of the SAC, relating depth to age.\n:stratigraphic_column amount of deposited material per facies per time step, corrected for disintegrated material. The cumulative sum of the SC should add up to the ADM.\n:water_depth the water depth as a function of time.\n:metadata some metadata, written as a TOML file.","category":"page"},{"location":"data-export/#Tests","page":"CSV Export","title":"Tests","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We have a test case with just three pixels.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"Uniform production\nUniform production, top-hat disintegration, making the sediment accumulation non-monotonic\nLinearly increasing production (not sure what this adds)","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test-case⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"const AXES1 = Axes(\n    x=[0.0, 1.0, 2.0] * u\"m\",\n    y=[1.0] * u\"m\",\n    t=(0.0:0.1:1.0) * u\"Myr\")\n\nconst HEADER1 = Header(\n    tag=\"test\",\n    axes=AXES1,\n    write_interval=1,\n    Δt=0.1u\"Myr\",\n    time_steps=10,\n    initial_topography=zeros(typeof(1.0u\"m\"), 3, 3),\n    sea_level=zeros(typeof(1.0u\"m\"), 10),\n    subsidence_rate=10u\"m/Myr\")\n\nconst PRODUCTION1 = reshape(\n    hcat(ones(Amount, 10),\n        ones(Amount, 10),\n        cumsum(ones(Amount, 10)) / 5.5)',\n    1, 3, 1, 10)\n\nconst DISINTEGRATION1 = reshape(\n    hcat(zeros(Amount, 10),\n        1:10 .|> (x -> x < 4 || x > 6 ? 0.0u\"m\" : 2.0u\"m\"),\n        zeros(Amount, 10))',\n    1, 3, 1, 10)\n\nconst ELEVATION1 = cat(\n    [0.0, 0.0, 0.0]u\"m\",\n    cumsum(PRODUCTION1 .- DISINTEGRATION1; dims=4)[1, :, :, :];\n    dims=3)\n\nconst DATA1 = Data(\n    disintegration=DISINTEGRATION1,\n    production=PRODUCTION1,\n    deposition=PRODUCTION1 .- DISINTEGRATION1,\n    sediment_elevation=ELEVATION1)\n\nconst GRID_LOCATIONS1 = [(1, 1), (2, 1), (3, 1)]","category":"page"},{"location":"data-export/#Sediment-Accumulation","page":"CSV Export","title":"Sediment Accumulation","text":"","category":"section"},{"location":"data-export/#Writing-CSV-files","page":"CSV Export","title":"Writing CSV files","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"The CSV.jl module lets us write a DataFrame to CSV, but doesn't work so well in combination with Units.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"\"\"\"\n    unitful_headers(df::DataFrame)\n\nGets a string representation for all column names including their unit.\nReturns a `Vector{String}`.\n\"\"\"\nunitful_headers(df::DataFrame) =\n    [\"$(e.variable) [$(unit(e.eltype))]\" for e in eachrow(describe(df))]\n\n\"\"\"\n    ustrip(df::DataFrame)\n\nStrip units from a `DataFrame`. Returns a new `DataFrame`.\n\"\"\"\nUnitful.ustrip(df::DataFrame) =\n    DataFrame((e.variable => df[!, e.variable] / unit(e.eltype)\n               for e in eachrow(describe(df)))...)\n\n\"\"\"\n    write_unitful_csv(io::IO, df::DataFrame)\n\nWrite a CSV from a `DataFrame` with `Unitful` units. The units will be\nrepresented in the CSV header, and stripped from the individual values.\n\"\"\"\nwrite_unitful_csv(io, df::DataFrame) =\n    write_csv(io, ustrip(df), header=unitful_headers(df))","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We may test that writing and reading the CSV back, gives the same result:","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"@testset \"Hither and Dither\" begin\n    io = IOBuffer(UInt8[], read=true, write=true)\n    data_export(CSVExportTrait{:sediment_accumulation_curve}, io, HEADER1, DATA1, GRID_LOCATIONS1)\n    seek(io, 0)\n    df = read_csv(io, DataFrame)\n    rename!(df, (n => split(n)[1] for n in names(df))...)\n    @test df.sac1 ≈ ELEVATION1[1, 1, :] / u\"m\"\n    @test df.sac2 ≈ ELEVATION1[2, 1, :] / u\"m\"\n    @test df.sac3 ≈ ELEVATION1[3, 1, :] / u\"m\"\nend","category":"page"},{"location":"data-export/#Age-depth-model","page":"CSV Export","title":"Age-depth model","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"Base.accumulate(f) = (args...; kwargs...) -> accumulate(f, args...; kwargs...)\n\n\"\"\"\n    age_depth_model(sediment_accumulation_curve::Vector)\n    age_depth_model(sediment_accumulation_curve::DataFrame)\n\nCompute the ADM from the SAC. Implemented as:\n\n    reverse ∘ accumulate(min) ∘ reverse\n\nThe `DataFrame` version `select`s SAC columns, transformed into ADM.\n\"\"\"\nage_depth_model(sac::Vector{T}) where {T} = sac |> reverse |> accumulate(min) |> reverse\nage_depth_model(sac_df::DataFrame) =\n    let sac_cols = filter(contains(\"sac\"), names(sac_df)),\n        adm_cols = replace.(sac_cols, \"sac\" => \"adm\")\n\n        select(sac_df, \"time\", (sac => age_depth_model => adm\n                                for (sac, adm) in zip(sac_cols, adm_cols))...)\n    end","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We test that the constructed ADM is monotonic increasing in time:","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"@testset \"ADM Monotonicity\" begin\n    sac = extract_sac(HEADER1, DATA1, GRID_LOCATIONS1)\n    adm = sac |> age_depth_model\n\n    @test sac.sac1 == adm.adm1\n    @test sac.sac3 == adm.adm3\n    @test sac.sac2 != adm.adm2\n\n    @test all(adm.adm2[2:end] .- adm.adm2[1:end-1] .>= 0.0u\"m\")\nend","category":"page"},{"location":"data-export/#Stratigraphic-Column","page":"CSV Export","title":"Stratigraphic Column","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"\"\"\"\n    stratigraphic_column(header::Header, data::Data, loc::NTuple{2,Int}, facies::Int)\n\nCompute the Stratigraphic Column for a given grid position `loc` and `facies` index.\nReturns an `Array{Quantity, 2}` where the `Quantity` is in units of meters.\n\"\"\"\nfunction stratigraphic_column(header::Header, data::Data, loc::NTuple{2,Int}, facies::Int)\n    dc = DataColumn(\n        loc,\n        data.disintegration[:, loc..., :],\n        data.production[:, loc..., :],\n        data.deposition[:, loc..., :],\n        data.sediment_elevation[loc..., :])\n    return stratigraphic_column(header, dc, facies)\nend\n\nfunction stratigraphic_column(header::Header, data::DataColumn, facies::Int)\n    n_times = length(header.axes.t) - 1\n    sc = zeros(typeof(1.0u\"m\"), n_times)\n\n    for ts = 1:n_times\n        acc = data.deposition[facies, ts] - data.disintegration[facies, ts]\n        if acc > 0.0u\"m\"\n            sc[ts] = acc\n            continue\n        end\n        ts_down = ts - 1\n        while acc < 0.0u\"m\"\n            ts_down < 1 && break\n            if -acc < sc[ts_down]\n                sc[ts_down] -= acc\n                break\n            else\n                acc += sc[ts_down]\n                sc[ts_down] = 0.0u\"m\"\n            end\n            ts_down -= 1\n        end\n    end\n\n    sc\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"The stratigraphic column should sum to the age-depth model.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"@testset \"SC sum equals ADM\" begin\n    sac = extract_sac(HEADER1, DATA1, GRID_LOCATIONS1)\n    adm = sac |> age_depth_model\n    sc = extract_sc(HEADER1, DATA1, GRID_LOCATIONS1)\n    @test [0.0u\"m\"; cumsum(sc.sc1_f1)] ≈ adm.adm1\n    @test [0.0u\"m\"; cumsum(sc.sc2_f1)] ≈ adm.adm2\n    @test [0.0u\"m\"; cumsum(sc.sc3_f1)] ≈ adm.adm3\nend","category":"page"},{"location":"data-export/#Dispatch","page":"CSV Export","title":"Dispatch","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"struct CSVExportTrait{S} end\n\nfunction data_export(spec::T, filepath::String) where {T<:ExportSpecification}\n    data_export(spec, read_data(filepath)...)\nend\n\nfunction data_export(spec::CSV, header::Header, data::Data)\n    for (key, filename) in spec.output_files\n        if key == :metadata\n            md = Dict(\n                \"global\" => Dict(\n                    \"tag\" => header.tag,\n                    \"subsidence_rate\" => header.subsidence_rate,\n                    \"time_steps\" => header.time_steps,\n                    \"delta_t\" => header.Δt),\n                \"locations\" => [Dict(\n                    \"number\" => i,\n                    \"x\" => header.axes.x[loc[1]],\n                    \"y\" => header.axes.y[loc[2]],\n                    \"initial_topography\" => header.initial_topography[loc...])\n                                for (i, loc) in enumerate(spec.grid_locations)],\n                \"files\" => spec.output_files)\n            open(filename, \"w\") do io\n                TOML.print(io, md) do obj\n                    if obj isa Quantity\n                        [ustrip(obj), string(unit(obj))]\n                    else\n                        obj\n                    end\n                end\n            end\n            continue\n        end\n        open(filename, \"w\") do io\n            data_export(CSVExportTrait{key}, io, header, data, spec.grid_locations)\n        end\n    end\nend\n\nfunction data_export(::Type{CSVExportTrait{S}}, args...) where {S}\n    error(\"Unknown CSV data export: `$(S)`\")\nend\n\nfunction data_export(::Type{CSVExportTrait{:sediment_accumulation_curve}},\n    io::IO, header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\n    sac = extract_sac(header, data, grid_locations)\n    write_unitful_csv(io, sac)\nend\n\nfunction data_export(::Type{CSVExportTrait{:age_depth_model}},\n    io::IO, header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\n    adm = extract_sac(header, data, grid_locations) |> age_depth_model\n    write_unitful_csv(io, adm)\nend\n\nfunction data_export(::Type{CSVExportTrait{:stratigraphic_column}},\n    io::IO, header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\n    sc = extract_sc(header, data, grid_locations)\n    write_unitful_csv(io, sc)\nend\n\nfunction data_export(::Type{CSVExportTrait{:water_depth}},\n    io::IO, header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n    wd = extract_wd(header, data, grid_locations)\n    write_unitful_csv(io, wd)\nend\n\n\"\"\"\n    extract_sac(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\nExtract Sediment Accumumlation Curve (SAC) from the data. The SAC is directly copied from\n`data.sediment_elevation`. Returns a `DataFrame` with `time` and `sac<n>` columns where `<n>`\nis in the range `1:length(grid_locations)`.\n\"\"\"\nfunction extract_sac(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n    DataFrame(:time => header.axes.t[1:end],\n        (Symbol(\"sac$(i)\") => data.sediment_elevation[loc..., :]\n         for (i, loc) in enumerate(grid_locations))...)\nend\n\n\"\"\"\n    extract_sc(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\nExtract Stratigraphic Column (SC) from the data. Returns a `DataFrame` with `time` and `sc<n>` columns where `<n>`\nis in the range `1:length(grid_locations)`.\n\"\"\"\nfunction extract_sc(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n    n_facies = size(data.production)[1]\n    DataFrame(\"time\" => header.axes.t[1:end-1],\n        (\"sc$(i)_f$(f)\" => stratigraphic_column(header, data, loc, f)\n         for f in 1:n_facies, (i, loc) in enumerate(grid_locations))...)\nend\n\n\"\"\"\n    extract_wd(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\nExtract the water depth from the data. Returns a `DataFrame` with `time` and `wd<n>` columns where `<n>`\nis in the range `1:length(grid_locations)`.\n\"\"\"\nfunction extract_wd(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n    na = [CartesianIndex()]\n    wd = header.subsidence_rate .* header.axes.t[na, na, :] .- header.initial_topography[:, :, na] .- data.sediment_elevation\n    DataFrame(\"time\" => header.axes.t,\n        (\"wd$(i)\" => wd[loc..., :] for (i, loc) in enumerate(grid_locations))...)\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">file:<i>src/Export.jl</i></div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"module Export\n\nexport Data, DataSlice, DataColumn, Header, CSV, read_data, read_slice, read_column, data_export\n\nusing HDF5\nimport CSV: write as write_csv\nusing TOML\n\nusing Unitful\nusing DataFrames\nusing .Iterators: flatten\n\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Amount = typeof(1.0u\"m\")\nconst Length = typeof(1.0u\"m\")\nconst Time = typeof(1.0u\"Myr\")\n\nconst na = [CartesianIndex()]\n\n<<export-specification>>\n\n@kwdef struct Axes\n    x::Vector{Length}\n    y::Vector{Length}\n    t::Vector{Time}\nend\n\n@kwdef struct Header\n    tag::String\n    axes::Axes\n    Δt::Time\n    write_interval::Int\n    time_steps::Int\n    initial_topography::Matrix{Amount}\n    sea_level::Vector{Length}\n    subsidence_rate::Rate\nend\n\n@kwdef struct Data\n    disintegration::Array{Amount,4}\n    production::Array{Amount,4}\n    deposition::Array{Amount,4}\n    sediment_elevation::Array{Amount,3}\nend\n\nstruct DataSlice\n    slice::NTuple{2,Union{Colon,Int}}\n    disintegration::Array{Amount,3}\n    production::Array{Amount,3}\n    deposition::Array{Amount,3}\n    sediment_elevation::Array{Amount,2}\nend\n\nstruct DataColumn\n    slice::NTuple{2,Int}\n    disintegration::Array{Amount,2}\n    production::Array{Amount,2}\n    deposition::Array{Amount,2}\n    sediment_elevation::Array{Amount,1}\nend\n\nfunction read_header(fid)\n    attrs = HDF5.attributes(fid[\"input\"])\n\n    axes = Axes(\n        fid[\"input/x\"][] * u\"m\",\n        fid[\"input/y\"][] * u\"m\",\n        fid[\"input/t\"][] * u\"Myr\")\n\n    return Header(\n        attrs[\"tag\"][],\n        axes,\n        attrs[\"delta_t\"][] * u\"Myr\",\n        attrs[\"write_interval\"][],\n        attrs[\"time_steps\"][],\n        fid[\"input/initial_topography\"][] * u\"m\",\n        fid[\"input/sea_level\"][] * u\"m\",\n        attrs[\"subsidence_rate\"][] * u\"m/Myr\")\nend\n\nfunction read_data(filename)\n    h5open(filename) do fid\n        header = read_header(fid)\n        data = Data(\n            fid[\"disintegration\"][] * u\"m\",\n            fid[\"production\"][] * u\"m\",\n            fid[\"deposition\"][] * u\"m\",\n            fid[\"sediment_height\"][] * u\"m\")\n        header, data\n    end\nend\n\nread_slice(fid::HDF5.File, slice...) = DataSlice(\n    slice,\n    fid[\"disintegration\"][:, slice..., :] * u\"m\",\n    fid[\"production\"][:, slice..., :] * u\"m\",\n    fid[\"deposition\"][:, slice..., :] * u\"m\",\n    fid[\"sediment_height\"][slice..., :] * u\"m\")\n\nfunction read_slice(filename::AbstractString, slice...)\n    h5open(filename) do fid\n        header = read_header(fid)\n        data = read_slice(fid, slice...)\n        header, data\n    end\nend\n\nread_column(fid::HDF5.File, slice...) = DataColumn(\n    slice,\n    fid[\"disintegration\"][:, slice..., :] * u\"m\",\n    fid[\"production\"][:, slice..., :] * u\"m\",\n    fid[\"deposition\"][:, slice..., :] * u\"m\",\n    fid[\"sediment_height\"][slice..., :] * u\"m\")\n\nfunction read_column(filename::AbstractString, slice...)\n    h5open(filename) do fid\n        header = read_header(fid)\n        data = read_column(fid, slice...)\n        header, data\n    end\nend\n\n<<export-function>>\n\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">file:<i>test/ExportSpec.jl</i></div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"using CarboKitten.Export: Axes, Header, Data, data_export, CSVExportTrait,\n    age_depth_model, extract_sac, extract_sc, CSV\nusing CSV: read as read_csv\nusing TOML\nusing DataFrames\nusing Unitful\n\nconst Amount = typeof(1.0u\"m\")\n\n<<export-test-case>>\n\n@testset \"Data Export\" begin\n    <<export-test>>\n\n    @testset \"Write to folder\" begin\n        mktempdir() do path\n            spec = CSV(GRID_LOCATIONS1,\n                :sediment_accumulation_curve => joinpath(path, \"sac.csv\"),\n                :age_depth_model => joinpath(path, \"adm.csv\"),\n                :stratigraphic_column => joinpath(path, \"sc.csv\"),\n                :water_depth => joinpath(path, \"wd.csv\"),\n                :metadata => joinpath(path, \"metadata.toml\"))\n            data_export(spec, HEADER1, DATA1)\n            for f in values(spec.output_files)\n                @test isfile(f)\n            end\n\n            metadata = TOML.parsefile(spec.output_files[:metadata])\n            @test IdDict(Symbol(k) => v for (k, v) in metadata[\"files\"]) == spec.output_files\n            @test length(metadata[\"locations\"]) == 3\n            adm = read_csv(spec.output_files[:age_depth_model], DataFrame)\n            rename!(adm, (n => split(n)[1] for n in names(adm))...)\n            @test adm == ustrip(extract_sac(HEADER1, DATA1, GRID_LOCATIONS1) |> age_depth_model)\n        end\n    end\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"","category":"page"},{"location":"cases/tabular-sea-level/#Tabular-sea-levels","page":"Tabular Sea Levels","title":"Tabular sea levels","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"In CarboKitten, the sea-level curve is given as a function of time. This means you can generate sea levels automatically, or if you like interpolate them on a table. In this demo, we show how we can read values from a file and interpolate those for input into the CarboKitten ALCAP model.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"CarboKitten has convenience functions for reading tabular data, both TSV and CSV are supported.","category":"page"},{"location":"cases/tabular-sea-level/#The-data","page":"Tabular Sea Levels","title":"The data","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"In this example we load the sea level data compilation from Miller 2020 [2].","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"(Image: Miller 2020 sea level data)","category":"page"},{"location":"cases/tabular-sea-level/#Loading","page":"Tabular Sea Levels","title":"Loading","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"For this example we have a tab-separated data file, that is distributed with CarboKitten. However, you can have filename point to any tabular data on your filesystem.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"You can use the readdlm function in DelimitedFiles to read most text based table formats. See the DataFrames documentation to find out how to read from most popular data file formats.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"function miller_2020()\n    dir = artifact_dir()\n    filename = joinpath(dir, \"Miller2020\", \"Cenozoic_sea_level_reconstruction.tab\")\n\n    data, header = readdlm(filename, '\\t', header=true)\n    return DataFrame(\n        time=-data[:,4] * u\"kyr\",\n        sealevel=data[:,7] * u\"m\",\n        refkey=categorical(data[:,2]),\n        reference=categorical(data[:,3]))\nend","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"In this example we'll only use the Lisiecky data set.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"using CarboKitten.DataSets: miller_2020\nusing DataFrames\n\ndf = miller_2020()\nlevels(df.refkey)","category":"page"},{"location":"cases/tabular-sea-level/#Interpolating","page":"Tabular Sea Levels","title":"Interpolating","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"There are many ways to interpolate the data we have. We will now stick to the package Interpolations and use the linear interpolator in there.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"function sea_level()\n    df = miller_2020()\n    lisiecki_df = df[df.refkey .== \"846 Lisiecki\", :]\n    sort!(lisiecki_df, [:time])\n\n    return linear_interpolation(\n        lisiecki_df.time,\n        lisiecki_df.sealevel)\nend","category":"page"},{"location":"cases/tabular-sea-level/#Inspecting-our-interval","page":"Tabular Sea Levels","title":"Inspecting our interval","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"We will be running a simulation from 2 million years BA, to 1 million years BA with a time step of 200 years.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"const TIME_PROPERTIES = TimeProperties(\n    t0 = -2.0u\"Myr\",\n    Δt = 200.0u\"yr\",\n    steps = 5000\n)","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"(Image: Our selection from the Miller/Lisiecki dataset)","category":"page"},{"location":"cases/tabular-sea-level/#Other-parameters","page":"Tabular Sea Levels","title":"Other parameters","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"We keep the facies parameters the same as in our other examples. However, because the sea level is fluctuating quite a bit more than in our other examples, we increased the slope two-fold so that the resulting platform fits in our box.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"const PATH = \"data/output\"\nconst TAG = \"lisiecki-sea-level\"\n\nconst FACIES = [\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=500u\"m/Myr\",\n        extinction_coefficient=0.8u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=50.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=400u\"m/Myr\",\n        extinction_coefficient=0.1u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=25.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=100u\"m/Myr\",\n        extinction_coefficient=0.005u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=35.0u\"m/yr\")\n]\n\nconst INPUT = ALCAP.Input(\n    tag=\"$TAG\",\n    box=CarboKitten.Box{Coast}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n    time=TIME_PROPERTIES,\n    ca_interval=1,\n    initial_topography=(x, y) -> -x / 200.0 - 100.0u\"m\",\n    sea_level=sea_level(),\n    subsidence_rate=50.0u\"m/Myr\",\n    disintegration_rate=50.0u\"m/Myr\",\n    insolation=400.0u\"W/m^2\",\n    sediment_buffer_size=50,\n    depositional_resolution=0.5u\"m\",\n    facies=FACIES)\n\nfunction main()\n    run_model(Model{ALCAP}, INPUT, \"$(PATH)/$(TAG).h5\")\nend","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"(Image: Summary plot)","category":"page"},{"location":"cases/tabular-sea-level/#Running-the-model","page":"Tabular Sea Levels","title":"Running the model","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/run.jl</i></div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"#| creates: data/output/lisiecki-sea-level.h5\n\nmodule TabularSeaLevel\n\nusing CarboKitten\n\nusing DelimitedFiles: readdlm\nusing DataFrames\nusing CarboKitten.DataSets: artifact_dir\nusing Interpolations\nusing CategoricalArrays\n\n<<tabular-sea-level>>\n\nend\n\nTabularSeaLevel.main()","category":"page"},{"location":"cases/tabular-sea-level/#Plotting-code","page":"Tabular Sea Levels","title":"Plotting code","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/plot.jl</i></div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"#| requires: data/output/lisiecki-sea-level.h5\n#| creates:\n#|      - docs/src/_fig/miller-sea-level.svg\n#|      - docs/src/_fig/lisiecki-selection.svg\n#|      - docs/src/_fig/lisiecki-sea-level-summary.png\n#| collect: figures\n\nmodule PlotTabularSeaLevel\n\nusing CarboKitten\nusing CarboKitten.DataSets: artifact_dir\nusing CarboKitten.Visualization: summary_plot\n\nusing DelimitedFiles: readdlm\nusing CairoMakie\nusing DataFrames\nusing Unitful\nusing Interpolations\nusing CategoricalArrays\n\n<<tabular-sea-level>>\n\nfunction plot_miller_data()\n    df = miller_2020()\n    fig = Figure(size=(1000,300))\n    ax = Axis(fig[1, 1]; xlabel=\"time (Ma BP)\", ylabel=\"sealevel (m)\")\n\n    for ref in levels(df.reference)\n        subset = df[df.reference .== ref,:]\n        lines!(ax, subset.time |> in_units_of(u\"Myr\"), subset.sealevel |> in_units_of(u\"m\"), label=ref)\n    end\n    fig[1, 2] = Legend(fig, ax)\n\n    save(\"docs/src/_fig/miller-sea-level.svg\", fig)\n    fig\nend\n\nfunction plot_lisiecki_data()\n    df = miller_2020()\n    lisiecki_df = df[df.refkey .== \"846 Lisiecki\", :]\n    sort!(lisiecki_df, [:time])\n\n    sl = sea_level()\n\n    fig = Figure(size=(1000, 400))\n    ax = Axis(fig[1, 1]; xlabel=\"time (Ma BP)\", ylabel=\"sealevel (m)\", limits=((-2.2, -0.8), nothing))\n\n\n    times = time_axis(TIME_PROPERTIES)\n    lines!(ax, times |> in_units_of(u\"Myr\"), sl.(times) |> in_units_of(u\"m\"), label=\"interpolated sealevel\", color=Makie.wong_colors()[2])\n\n    scatter!(ax, lisiecki_df.time |> in_units_of(u\"Myr\"), lisiecki_df.sealevel |> in_units_of(u\"m\"), label=\"Lisiecki data\")\n    fig[1,2] = Legend(fig, ax)\n\n    save(\"docs/src/_fig/lisiecki-selection.svg\", fig)\n    fig\nend\n\nfunction plot_result()\n    fig = summary_plot(\"data/output/lisiecki-sea-level.h5\")\n    save(\"docs/src/_fig/lisiecki-sea-level-summary.png\", fig)\nend\n\nend\n\nPlotTabularSeaLevel.plot_miller_data()\nPlotTabularSeaLevel.plot_lisiecki_data()\nPlotTabularSeaLevel.plot_result()","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"","category":"page"},{"location":"components/waterdepth/#Water-Depth","page":"Water Depth","title":"Water Depth","text":"","category":"section"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"350pt\" height=\"240pt\"\n viewBox=\"0.00 0.00 350.00 240.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 236)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-236 346,-236 346,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-232C150,-232 12,-232 12,-232 6,-232 0,-226 0,-220 0,-220 0,-165 0,-165 0,-159 6,-153 12,-153 12,-153 150,-153 150,-153 156,-153 162,-159 162,-165 162,-165 162,-220 162,-220 162,-226 156,-232 150,-232\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-201.5 155,-201.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-210.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-178.5 7,-201.5 54,-201.5 54,-178.5 7,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-178.5 54,-178.5 54,-201.5 7,-201.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-178.5 54,-201.5 108,-201.5 108,-178.5 54,-178.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-178.5 54,-201.5 108,-201.5 108,-178.5 54,-178.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-178.5 108,-201.5 155,-201.5 155,-178.5 108,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-201.5 108,-201.5 108,-178.5 155,-178.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-159.5 54,-178.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-159.5 108,-178.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node2\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-117C300,-117 42,-117 42,-117 36,-117 30,-111 30,-105 30,-105 30,-12 30,-12 30,-6 36,0 42,0 42,0 300,0 300,0 306,0 312,-6 312,-12 312,-12 312,-105 312,-105 312,-111 306,-117 300,-117\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-86.5 305,-86.5 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-95.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"37,-63.5 37,-86.5 154,-86.5 154,-63.5 37,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-63.5 154,-63.5 154,-86.5 37,-86.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-63.5 154,-86.5 208,-86.5 208,-63.5 154,-63.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-63.5 154,-86.5 208,-86.5 208,-63.5 154,-63.5\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-63.5 208,-86.5 305,-86.5 305,-63.5 208,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-86.5 208,-86.5 208,-63.5 305,-63.5 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-44.5 154,-63.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-44.5 208,-63.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-25.5 154,-44.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-25.5 208,-44.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-6.5 154,-25.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-6.5 208,-25.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M107.27,-152.97C113.07,-144.46 119.38,-135.21 125.69,-125.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"128.73,-127.7 131.48,-117.47 122.95,-123.76 128.73,-127.7\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node3\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-232C330,-232 192,-232 192,-232 186,-232 180,-226 180,-220 180,-220 180,-165 180,-165 180,-159 186,-153 192,-153 192,-153 330,-153 330,-153 336,-153 342,-159 342,-165 342,-165 342,-220 342,-220 342,-226 336,-232 330,-232\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-201.5 335,-201.5 \"/>\n<text text-anchor=\"start\" x=\"237.5\" y=\"-210.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-178.5 187,-201.5 234,-201.5 234,-178.5 187,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-178.5 234,-178.5 234,-201.5 187,-201.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-178.5 234,-201.5 288,-201.5 288,-178.5 234,-178.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-178.5 234,-201.5 288,-201.5 288,-178.5 234,-178.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-178.5 288,-201.5 335,-201.5 335,-178.5 288,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-201.5 288,-201.5 288,-178.5 335,-178.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-159.5 234,-178.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-159.5 288,-178.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M234.73,-152.97C228.93,-144.46 222.62,-135.21 216.31,-125.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"219.05,-123.76 210.52,-117.47 213.27,-127.7 219.05,-123.76\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"The WaterDepth module computes the water depth, given the bedrock elevation, sea level curve, subsidence rate and current sediment height.","category":"page"},{"location":"components/waterdepth/#Input","page":"Water Depth","title":"Input","text":"","category":"section"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"initial_topography(x, y) (a.k.a. initial depth) should be a function taking two coordinates in units of meters, returning an elevation also in meters.\nsea_level(t) should be a function taking a time in millions of years (Myr) returning the eustatic sealevel. This could also be an interpolated table.\nsubsidence_rate a constant rate of subsidence in m/Myr.","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"The signs of these quantities should be such that the following equation holds:","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"T + E = S + W","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"saying Tectonic subsidence plus Eustatic sea-level change equals Sedimentation plus change in Water depth.","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"<div class=\"noweb-label\">file:<i>src/Components/WaterDepth.jl</i></div>","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"@compose module WaterDepth\n@mixin TimeIntegration, Boxes\nusing ..Common\nusing HDF5\n\nexport water_depth\n\n@kwdef struct Input <: AbstractInput\n    sea_level          # function (t::Time) -> Length\n    initial_topography  # function (x::Location, y::Location) -> Length\n    subsidence_rate::Rate\nend\n\n@kwdef mutable struct State <: AbstractState\n    sediment_height::Matrix{Height}\nend\n\nfunction initial_state(input::AbstractInput)\n    return State(step=0, sediment_height=zeros(Height, input.box.grid_size...))\nend\n\nfunction initial_topography(input::AbstractInput)\n    if input.initial_topography isa AbstractMatrix\n        @assert size(input.initial_topography) == input.box.grid_size\n        return input.initial_topography\n    end\n\n    x, y = box_axes(input.box)\n    return input.initial_topography.(x, y')\nend\n\nfunction water_depth(input::AbstractInput)\n    x, y = box_axes(input.box)\n    eta0 = initial_topography(input)\n    sea_level = input.sea_level\n    subsidence_rate = input.subsidence_rate\n\n    return function (state::AbstractState)\n        t = TimeIntegration.time(input, state)\n        return sea_level(t) .- eta0 .+\n               (subsidence_rate * t) .- state.sediment_height\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    gid = fid[\"input\"]\n    attr = attributes(gid)\n    x, y = box_axes(input.box)\n    t = TimeIntegration.write_times(input)\n\n    gid[\"initial_topography\"] = initial_topography(input) |> in_units_of(u\"m\")\n    gid[\"sea_level\"] = input.sea_level.(t) .|> in_units_of(u\"m\")\n    attr[\"subsidence_rate\"] = input.subsidence_rate |> in_units_of(u\"m/Myr\")\nend\n\nfunction create_dataset(fid, input::AbstractInput)\n    return HDF5.create_dataset(fid, \"sediment_height\", datatype(Float64),\n        dataspace(input.box.grid_size..., input.time.steps),\n        chunk=(input.box.grid_size..., 1))\nend\n\nend","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"","category":"page"},{"location":"utility/#Utility-functions","page":"Utility","title":"Utility functions","text":"","category":"section"},{"location":"utility/#Select-Iterator","page":"Utility","title":"Select Iterator","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"In many cases our model is updating some state as an iterator. I want to be able to select arbitrary slices from that iterator. The Select object contains the main iterable and a selection iterable that should yield integers. When iterated upon, we repeatedly use Iterators.dropwhile to get to the next index.","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">file:<i>src/Utility.jl</i></div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"module Utility\n\nexport select, in_units_of\nusing Unitful\n\nstruct Select\n    iter\n    selection\nend\n\nfunction select(it, sel)\n    Select(enumerate(it), sel)\nend\n\nfunction Base.iterate(s::Select)\n    x = iterate(s.selection)\n    if x !== nothing\n        (idx, selstate) = x\n        ((_, value), rest) = Iterators.peel(Iterators.dropwhile(((i, y),) -> i != idx, s.iter))\n        return (value, (selstate, rest))\n    else\n        return nothing\n    end\nend\n\nfunction Base.iterate(s::Select, state)\n    (selstate, rest) = state\n    x = iterate(s.selection, selstate)\n    if x !== nothing\n        (idx, selstate) = x\n        ((_, value), rest) = Iterators.peel(Iterators.dropwhile(((i, y),) -> i != idx, s.iter))\n        return (value, (selstate, rest))\n    else\n        return nothing\n    end\nend\n\n<<utility>>\n\nend","category":"page"},{"location":"utility/#Range-finder","page":"Utility","title":"Range finder","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"The RangeFinder iterator is used in our algorithm to trace hiatus in the sediment history. This iterator consumes an iterator of booleans and yields values of type UnitRange, giving all ranges for which the input sequence is true consecutively.","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility-spec⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"a = [false, true, true, false, true]\n@test collect(find_ranges(a)) == [2:3, 5:5]","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"struct RangeFinder\n\tv::AbstractVector{Bool}\nend\n\nBase.iterate(r::RangeFinder) = iterate(r, 1)\n\nfunction Base.iterate(r::RangeFinder, i::Union{Int, Nothing})\n\tisnothing(i) && return nothing\n\ta = findnext(r.v, i)\n\tisnothing(a) && return nothing\n\tb = findnext(!, r.v, a)\n\tisnothing(b) && return (a:length(r.v)), nothing\n\treturn (a:b-1), b\nend\n\nBase.eltype(r::RangeFinder) = UnitRange{Int}\nBase.IteratorSize(::Type{RangeFinder}) = Base.SizeUnknown()\n\n\"\"\"\n    find_ranges(v::AbstractVector{Bool})\n\nTake a vector of bools, returns an iterator over all ranges for\nwhich the vector is `true`.\n\"\"\"\nfind_ranges(v::AbstractVector{Bool}) = RangeFinder(v)\n\nexport find_ranges","category":"page"},{"location":"utility/#Tagging-a-sequence-of-vectors","page":"Utility","title":"Tagging a sequence of vectors","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"The enumerate_seq iterator is also used in the algorithm to trace hiatus in sediment accumulation. Here the task is to enumerate a nested sequence while preserving the nested structure.","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility-spec⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"a = [[:a, :b], [:c]]\n@test collect(enumerate_seq(a)) == [[(1, :a), (2, :b)], [(3, :c)]]","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"struct TagVectors{T}\n\tvectors::T\nend\n\nfunction Base.iterate(tv::TagVectors{T}) where T\n\ttag = 1\n\tx = iterate(tv.vectors)\n\tisnothing(x) && return nothing\n\t(v_, nit) = x\n\tv = collect(v_)\n\tn = length(v)\n\treturn zip(tag:tag+n-1, v) |> collect, (tag+n, nit)\nend\n\nfunction Base.iterate(tv::TagVectors{T}, st::Tuple{Int,U}) where {T, U}\n\t(tag, it) = st\n\tisnothing(it) && return nothing\n\tx = iterate(tv.vectors, it)\n\tisnothing(x) && return nothing\n\t(v_, nit) = x\n\tv = collect(v_)\n\tn = length(v)\n\treturn zip(tag:tag+n-1, v) |> collect, (tag+n, nit)\nend\n\nBase.IteratorSize(::Type{TagVectors{T}}) where T = Base.IteratorSize(T)\nBase.size(r::TagVectors{T}) where T = size(r.vectors)\nBase.length(r::TagVectors{T}) where T = length(r.vectors)\nBase.eltype(::Type{TagVectors{T}}) where T = Any\n# This should be:\n# Iterators.Zip{Tuple{UnitRange{Int},Vector{eltype(eltype(T))}}}\n# But that doesn't work\n\n\"\"\"\n    enumerate_seq(s)\n\nEnumerates an iterator of sequences, such that the following equivalence\nholds:\n\n    enumerate(flatten(s)) == flatten(enumerate_seq(s))\n\"\"\"\nenumerate_seq(s::T) where T = TagVectors{T}(s)\n\nexport enumerate_seq","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">file:<i>test/UtilitySpec.jl</i></div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"@testset \"CarboKitten.Utility\" begin\n    using CarboKitten.Utility\n\n    <<utility-spec>>\nend","category":"page"},{"location":"utility/#Reading-data-files","page":"Utility","title":"Reading data files","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">file:<i>src/DataSets.jl</i></div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"module DataSets\n\nexport read_tsv, read_csv\n\nusing DelimitedFiles: readdlm\nusing DataFrames\nusing CategoricalArrays\nusing CSV\nusing Pkg.Artifacts\nusing Unitful\n\nfunction read_tsv(filename)\n    data, header = readdlm(filename, '\\t', header=true)\n    return DataFrame(data, vec(header))\nend\n\nfunction read_csv(filename)\n    return DataFrame(CSV.File(filename))\nend\n\nfunction artifact_dir()\n    subfolder = first(readdir(artifact\"data\"))\n    return joinpath(artifact\"data\", subfolder)\nend\n\nfunction bosscher_schlager_1992()\n    dir = artifact_dir()\n    filename = joinpath(dir, \"Bosscher1992\", \"bs92-sealevel-curve.csv\")\n    df = read_csv(filename)\n    return DataFrame(time=df.time * u\"yr\", sealevel=df.depth * u\"m\")\nend\n\nfunction miller_2020()\n    dir = artifact_dir()\n    filename = joinpath(dir, \"Miller2020\", \"Cenozoic_sea_level_reconstruction.tab\")\n    df = read_tsv(filename)\n    return DataFrame(\n        time=-df[!,4] * u\"kyr\",\n        sealevel=df[!,7] * u\"m\",\n        refkey=categorical(df[!,2]),\n        reference=categorical(df[!,3]))\nend\n\nend","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"","category":"page"},{"location":"denudation/empirical/#Emperical-denudation","page":"Empirical Denudation","title":"Emperical denudation","text":"","category":"section"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Chlorine (Cl) isotopes are an emerging tool to decipher the denudation rates (chemical dissolution + physical erosion) in carbonate-dominated areas.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Research based on the karst region and carbonate platform terrace suggested that the denudation rates are mainly controlled by precipitation and slopes, although the debates about which factor is more important is still ongoing ([7], [8]). In general, the precipitation mainly controls the chemical dissolution while the slope mainly controls the physical erosion. In addition, the type of carbonates may also play an important role ([9]), but given this feature is studied poorly so we will ditch it for now. We have checked and compiled the denudation rates (mm/kyr), and along with precipitation and slopes these serve as a starting point to create a function relating denudation rates (mm/kyr) to precipitation and slopes. The compiled data can be found in OSF database. This is an empirical relationship and has a relatively large uncertainty in terms of fitting.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"(Image: Precipitation and denudation)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Fig 1. The relationship between MAP (mean precipitation per year, mm/y) and denudation rates (mm/ky)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"(Image: Slope denudation data)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Fig 2. The relationship between the slope and the denudation rates (mm/ky)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"We can see that both the slope and precipitation increase the denudation rates, and that it reaches a 'steady state' after a certain point.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Therefore, we could use the function form of D = P * S, where D is the denudation rate, P parameterizes the effects of precipitation and S the effects of slope. By doing so, we can consider both effects. Such formula structure is similar to RUSLE (Revised Universal Soil Loss Equation) model, a widely used Landscape Evolution Model (LEM) (e.g., [10]). We use sigmoidal function to approximate the influence of P or S on D, by fitting the function with the observed data and rendering parameters a, b, c, d, e, f. These are impleted as empirical_denudation. ","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">⪡empirical-denudation⪢≣</div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"function empirical_denudation(precip::Float64, slope::Any)\n    local a = 9.1363\n    local b = -0.008519\n    local c = 580.51\n    local d = 9.0156\n    local e = -0.1245\n    local f = 4.91086\n    (a ./ (1 .+ exp.(b .* (precip .* 1000 .- c)))) .* (d ./ (1 .+ exp.(e .* (slope .- f)))) .* u\"m/Myr\"\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"This produces the following curve for denudation rate as a function of precipitation (Image: Empirical denudation as function of precipitation) Fig 3. An instance of the function showing denudation rates increases with precipitation.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">file:<i>examples/denudation/empirical-test.jl</i></div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"#| requires: examples/denudation/empirical-test.jl\n#| creates: docs/src/_fig/EmpiricalPrecipitation.png\n#| collect: figures\n\nmodule EmpiricalSpec\nusing CairoMakie\n\nusing CarboKitten\nusing Unitful\n\nusing CarboKitten.Denudation.EmpiricalDenudationMod: empirical_denudation, slope_kernel\n\nconst slope = 30\n\nfunction main()\n    precip = collect(0.4:0.01:2.0)\n\n    result = Vector{typeof(1.0u\"m/Myr\")}(undef,size(precip))\n\n    for i in eachindex(precip)\n        result[i] = empirical_denudation(precip[i],slope)\n    end\n\n    fig = Figure()\n    ax = Axis(fig[1,1],xlabel=\"Precipitation (m/yr)\", ylabel=\"Denudation rates (m/Myr)\")\n    lines!(ax,precip,result)\n    save(\"docs/src/_fig/EmpiricalPrecipitation.png\",fig)\nend\n\nend\n\nEmpiricalSpec.main()","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"</details>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"This function needs two inputs: precipitation and slope. The precipitation is defined as an input parameter in EmpiricalDenudation.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">⪡empirical-denudation⪢≣</div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"@kwdef struct EmpiricalDenudation <: DenudationType\n    precip::typeof(1.0u\"m\")\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"The slope for each cell is calculated by comparing the height (or water-depth) with the neighboring 8 cells, and is implemented in function slope_kernel . The slope is returned in degrees of inclination. This approach has been widely used in industry and ArcGis: how slope works is an example.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">⪡empirical-denudation⪢≣</div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"function slope_kernel(w::Any, cellsize::Float64)\n    dzdx = (-w[1, 1] - 2 * w[2, 1] - w[3, 1] + w[1, 3] + 2 * w[2, 3] + w[3, 3]) / (8 * cellsize)\n    dzdy = (-w[1, 1] - 2 * w[1, 2] - w[1, 3] + w[3, 1] + 2 * w[3, 2] + w[1, 1]) / (8 * cellsize)\n\n    if abs(w[2, 2]) <= min.(abs.(w)...)\n        return 0.0\n    else\n        atan(sqrt(dzdx^2 + dzdy^2)) * (180 / π)\n    end\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Note that this mode only considers the destruction of mass, and does not apply any redistribution of mass.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">file:<i>src/Denudation/EmpiricalDenudationMod.jl</i></div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"module EmpiricalDenudationMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...Boxes: Box\nusing Unitful\nexport slope_kernel\n<<empirical-denudation>>\n\nfunction denudation(::Box, p::EmpiricalDenudation, water_depth, slope, facies, state)\n    precip = p.precip ./ u\"m\"\n    denudation_rate = zeros(typeof(1.0u\"m/Myr\"), length(facies), size(slope)...)\n\n    for idx in CartesianIndices(state.ca)\n        f = state.ca[idx]\n        if f == 0\n            continue\n        end\n        if water_depth[idx] <= 0\n            denudation_rate[f,idx] = empirical_denudation.(precip, slope[idx])\n        end\n    end\n    return denudation_rate\nend\n\nfunction redistribution(::Box, p::EmpiricalDenudation, denudation_mass, water_depth)\n    return nothing\nend\n\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"","category":"page"},{"location":"api/#API-Documentation","page":"API Documentation","title":"API Documentation","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"run_model\nBox\nbox_axes\nTimeProperties\ntime_axis","category":"page"},{"location":"api/#CarboKitten.run_model","page":"API Documentation","title":"CarboKitten.run_model","text":"run_model(f, ::Type{Model{M}}, input::AbstractInput) where M\nrun_model(f, ::Type{Model{M}}, input::AbstractInput, state::AbstractState) where M\n\nRun a model and send Frames to callback f. The type parameter M should be a model, being a module with both initial_state! and step! defined.\n\nThe second version with explicit state is used by H5Writer so we can perform an additional action between creating the initial state and starting the model run (saving metadata to the HDF5 file).\n\n\n\n\n\nrun_model(::Type{Model{M}}, input::AbstractInput, filename::AbstractString) where M\n\nRun a model and write output to HDF5. Here M should be a model, i.e. a module with initial_state, step! and write_header defined. Example:\n\nrun_model(Model{ALCAP}, ALCAP.Example.INPUT, \"example.h5\")\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.Box","page":"API Documentation","title":"CarboKitten.Box","text":"Box{BoundaryType}(grid_size, phys_scale)\n\nStores the spatial properties of the simulation grid, where grid_size is a tuple of two integers and phys_scale is a Quantity of dimension Length.\n\n\n\n\n\n","category":"type"},{"location":"api/#CarboKitten.box_axes","page":"API Documentation","title":"CarboKitten.box_axes","text":"box_axes(box::Box)\n\nReturn the x and y components of the box grid in meters. The grid starts at 0.0u\"m\" and runs to (box.grid_size .- 1) .* box.phys_scale.\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.TimeProperties","page":"API Documentation","title":"CarboKitten.TimeProperties","text":"TimeProperties(t0, Δt, steps, write_interval)\n\nStores properties of the time integration. Here, t0 and Δt should be a Quantity, steps is the number of integration steps, and write_interval the number of steps between writing output.\n\n\n\n\n\n","category":"type"},{"location":"api/#CarboKitten.time_axis","page":"API Documentation","title":"CarboKitten.time_axis","text":"time_axis(time::TimeProperties)\n\nRetrieve the time values for which output was/will be written. Returns a range.\n\n\n\n\n\n","category":"function"},{"location":"api/#Components","page":"API Documentation","title":"Components","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Components.CellularAutomaton, CarboKitten.Components.ActiveLayer]","category":"page"},{"location":"api/#CarboKitten.Components.CellularAutomaton.step_ca-Union{Tuple{BT}, Tuple{Box{BT}, Any}} where BT<:Boundary{2}","page":"API Documentation","title":"CarboKitten.Components.CellularAutomaton.step_ca","text":"step_ca(box, facies)\n\nCreates a propagator for the state, updating the celullar automaton in place.\n\nContract: the state should have ca::Matrix{Int} and ca_priority::Vector{Int} members.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Components.ActiveLayer.disintegrator-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Components.ActiveLayer.disintegrator","text":"disintegrator(input) -> f!\n\nPrepares the disintegration step. Returns a function f!(state::State). The returned function modifies the state, popping sediment from the sediment_buffer and returns an array of Amount.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Components.ActiveLayer.transporter-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Components.ActiveLayer.transporter","text":"transporter(input::Input) -> f\n\nPrepares the transportation step. Returns a function f(state::State, active_layer), transporting the active layer, returning a transported Amount of sediment.\n\n\n\n\n\n","category":"method"},{"location":"api/#Utility","page":"API Documentation","title":"Utility","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Utility, CarboKitten.Skeleton, CarboKitten.Stencil]","category":"page"},{"location":"api/#CarboKitten.Utility.enumerate_seq-Tuple{T} where T","page":"API Documentation","title":"CarboKitten.Utility.enumerate_seq","text":"enumerate_seq(s)\n\nEnumerates an iterator of sequences, such that the following equivalence holds:\n\nenumerate(flatten(s)) == flatten(enumerate_seq(s))\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Utility.find_ranges-Tuple{AbstractVector{Bool}}","page":"API Documentation","title":"CarboKitten.Utility.find_ranges","text":"find_ranges(v::AbstractVector{Bool})\n\nTake a vector of bools, returns an iterator over all ranges for which the vector is true.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Skeleton.skeleton-Tuple{AbstractMatrix{Bool}}","page":"API Documentation","title":"CarboKitten.Skeleton.skeleton","text":"skeleton(bitmap::AbstractMatrix{Bool})\n\nComputes the skeleton of a bitmap, i.e. reduces features with some thickness to a set of line segments. This function is designed with stratigraphic application in mind: we scan each row in the bitmap for connected regions, then link neighbouring regions when they overlap. The result is a graph that represents hiatus in the sediment accumulation.\n\nReturns a tuple of vertices and edges, where vertices is a vector of 2-tuples and edges is a nx2 matrix of indices into the vertices.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Stencil.stencil!-Union{Tuple{BT}, Tuple{sz}, Tuple{dim}, Tuple{F}, Tuple{F, Type{BT}, StaticArraysCore.Size{sz}, Any, Vararg{Any}}} where {F, dim, sz, BT<:Boundary{dim}}","page":"API Documentation","title":"CarboKitten.Stencil.stencil!","text":"stencil!(f, Boundary, Size, out, inp...)\n\nPerforms stencil operation. The function f should take a number of abstract arrays (same as the number of inp values), and return a single value of the same type as elements in out. The Size parameter should be a type parameter size of the stencil, e.g. Size(3, 3) to get a 3 by 3 stencil.\n\nPrefer to use this version over the older implementations.\n\n\n\n\n\n","category":"method"},{"location":"api/#Export","page":"API Documentation","title":"Export","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Export]","category":"page"},{"location":"api/#CarboKitten.Export.age_depth_model-Union{Tuple{Vector{T}}, Tuple{T}} where T","page":"API Documentation","title":"CarboKitten.Export.age_depth_model","text":"age_depth_model(sediment_accumulation_curve::Vector)\nage_depth_model(sediment_accumulation_curve::DataFrame)\n\nCompute the ADM from the SAC. Implemented as:\n\nreverse ∘ accumulate(min) ∘ reverse\n\nThe DataFrame version selects SAC columns, transformed into ADM.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.extract_sac-Tuple{CarboKitten.Export.Header, CarboKitten.Export.Data, Vector{Tuple{Int64, Int64}}}","page":"API Documentation","title":"CarboKitten.Export.extract_sac","text":"extract_sac(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\nExtract Sediment Accumumlation Curve (SAC) from the data. The SAC is directly copied from data.sediment_elevation. Returns a DataFrame with time and sac<n> columns where <n> is in the range 1:length(grid_locations).\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.extract_sc-Tuple{CarboKitten.Export.Header, CarboKitten.Export.Data, Vector{Tuple{Int64, Int64}}}","page":"API Documentation","title":"CarboKitten.Export.extract_sc","text":"extract_sc(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\nExtract Stratigraphic Column (SC) from the data. Returns a DataFrame with time and sc<n> columns where <n> is in the range 1:length(grid_locations).\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.extract_wd-Tuple{CarboKitten.Export.Header, CarboKitten.Export.Data, Vector{Tuple{Int64, Int64}}}","page":"API Documentation","title":"CarboKitten.Export.extract_wd","text":"extract_wd(header::Header, data::Data, grid_locations::Vector{NTuple{2,Int}})\n\nExtract the water depth from the data. Returns a DataFrame with time and wd<n> columns where <n> is in the range 1:length(grid_locations).\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.stratigraphic_column-Tuple{CarboKitten.Export.Header, CarboKitten.Export.Data, Tuple{Int64, Int64}, Int64}","page":"API Documentation","title":"CarboKitten.Export.stratigraphic_column","text":"stratigraphic_column(header::Header, data::Data, loc::NTuple{2,Int}, facies::Int)\n\nCompute the Stratigraphic Column for a given grid position loc and facies index. Returns an Array{Quantity, 2} where the Quantity is in units of meters.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.unitful_headers-Tuple{DataFrames.DataFrame}","page":"API Documentation","title":"CarboKitten.Export.unitful_headers","text":"unitful_headers(df::DataFrame)\n\nGets a string representation for all column names including their unit. Returns a Vector{String}.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.write_unitful_csv-Tuple{Any, DataFrames.DataFrame}","page":"API Documentation","title":"CarboKitten.Export.write_unitful_csv","text":"write_unitful_csv(io::IO, df::DataFrame)\n\nWrite a CSV from a DataFrame with Unitful units. The units will be represented in the CSV header, and stripped from the individual values.\n\n\n\n\n\n","category":"method"},{"location":"api/#Unitful.ustrip-Tuple{DataFrames.DataFrame}","page":"API Documentation","title":"Unitful.ustrip","text":"ustrip(df::DataFrame)\n\nStrip units from a DataFrame. Returns a new DataFrame.\n\n\n\n\n\n","category":"method"},{"location":"api/#Transport","page":"API Documentation","title":"Transport","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Transport.Advection]","category":"page"},{"location":"api/#CarboKitten.Transport.Advection.transport!-Union{Tuple{BT}, Tuple{Box{BT}, Vararg{Any, 5}}} where BT","page":"API Documentation","title":"CarboKitten.Transport.Advection.transport!","text":"transport!(box, diffusivity, wave_velocity,\n           C, w, dC)\n\nComputes dC given a box, diffusivity constant in units of m/Myr, wave_velocity is a function of water depth, returning both velocity in units of m/Myr, and shear in units of 1/Myr, which should be the derivative of the velocity w.r.t. water depth. C is the concentration of entrained sediment, w the water depth, and dC the output derivative of C.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Transport.Advection.transport-Union{Tuple{T}, Tuple{BT}, Tuple{Box{BT}, Any, Any, AbstractArray{T}, Any}} where {BT, T}","page":"API Documentation","title":"CarboKitten.Transport.Advection.transport","text":"transport(box, diffusivity, wave_velocity, wave_shear,\n           C, w)\n\nNon-mutating version of transport!. Allocates and returns dC.\n\n\n\n\n\n","category":"method"},{"location":"api/#Submodules","page":"API Documentation","title":"Submodules","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [\n  CarboKitten.Denudation, CarboKitten.Denudation.Abstract,\n  CarboKitten.Denudation.NoDenudationMod\n  ]","category":"page"},{"location":"api/#CarboKitten.Denudation.Abstract.denudation-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Denudation.Abstract.denudation","text":"denudation(box, param, state)\n\nComputes the denudation for a single time-step, given denudation parameters param and a simulation state state. param should have a DenudationType type and state should contain the height property and sealevel.\n\nReturns denudation mass in units of meters.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Denudation.Abstract.denudation-Tuple{Box, CarboKitten.Denudation.Abstract.DenudationType, Vararg{Any, 4}}","page":"API Documentation","title":"CarboKitten.Denudation.Abstract.denudation","text":"denudation(box::Box, param::DenudationType, water_depth, slope, facies)\n\nComputes the amount of denudation. This function is called on a pixel by pixel basis, so all arguments can be assumed to be scalar. The param argument should be of a subtype of DenudationType containing all the input parameters for this specific denudation model.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Denudation.Abstract.redistribution-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Denudation.Abstract.redistribution","text":"redistribution()\n\nTakes state, water_depth in meters and denudation_mass as a 3D array (facies, x and y coordinates) in units of meters.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Denudation.NoDenudationMod","page":"API Documentation","title":"CarboKitten.Denudation.NoDenudationMod","text":"module NoDenudation\n\nDoesn't do any denudation: used for testing purposes.\n\n\n\n\n\n","category":"module"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"","category":"page"},{"location":"finite-difference-transport/#Finite-Difference-Methods-for-Transport","page":"Finite Difference","title":"Finite Difference Methods for Transport","text":"","category":"section"},{"location":"finite-difference-transport/#Spacial-Finite-Differences","page":"Finite Difference","title":"Spacial Finite Differences","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>src/Transport/DifferentialOperators.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module DifferentialOperators\n\n<<differential-operators>>\n\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"To solve the above equations we use three differential operators: central_difference, upwind and laplacian, defined in the context of a 2-d stencil operation.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Central differences approximates the derivative on a grid by,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"dy_i = fracy_i+1 - y_i-12Delta x","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"We define two variants for directions on the grid.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡differential-operators⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"central_difference(::Type{Val{1}}, a::AbstractMatrix, dx) =\n    (a[3, 2] - a[1, 2]) / (2dx)\n\ncentral_difference(::Type{Val{2}}, a::AbstractMatrix, dx) =\n    (a[2, 3] - a[2, 1]) / (2dx)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Upwind can be used when we know the derivative is being used in an advective context. If we are modeling flow, we better use the value in the direction where the flow is coming from,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"dy_i = begincases\nfracy_i+1 - y_iDelta x  textrmif v  0\nfracy_i - y_i-1Delta x  textrmif v  0\nendcases","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"In our implementation we also multiply with the velocity v to prevent code duplication when expressing advective terms.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡differential-operators⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"upwind(v::T, a1, a2, a3, dx) where {T} =\n    if v < zero(T)\n        v * (a3 - a2) / dx\n    else\n        v * (a2 - a1) / dx\n    end\n\nupwind(::Type{Val{1}}, v, a::AbstractMatrix, dx) =\n    upwind(v, a[:, 2]..., dx)\n\nupwind(::Type{Val{2}}, v, a::AbstractMatrix, dx) =\n    upwind(v, a[2, :]..., dx)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Laplacian is an approximation for the second derivative. Since we differentiate twice we no longer have the annoying situation that the derivative lives \"between\" our spatial discretization,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"nabla^2 y_i j = fracy_i-1j + y_ij-1 + y_i+1j + y_ij+1 - 4y_ijDelta x^2","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡differential-operators⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"laplacian(a::AbstractMatrix, dx) =\n    (a[1, 2] + a[2, 1] + a[3, 2] + a[2, 3] - 4 * a[2, 2]) / dx^2","category":"page"},{"location":"finite-difference-transport/#Solvers","page":"Finite Difference","title":"Solvers","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Since we're trying to prevent complications, we use only explicit solvers for our PDE. We have forward Euler and Runge-Kutta 4 methods in place.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"If you want better solvers, it should be possible (and relatively straight-forward) to implement this transport model using MethodOfLines.jl, but we haven't yet felt the need for that.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"These methods modify the given input y in-place.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>src/Transport/Solvers.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module Solvers\n\nusing Unitful\n\nfunction runge_kutta_4(::Type{T}, box) where {T}\n    U = typeof(1.0 * unit(T) / u\"Myr\")\n    k1 = Array{U}(undef, box.grid_size...)\n    k2 = Array{U}(undef, box.grid_size...)\n    k3 = Array{U}(undef, box.grid_size...)\n    k4 = Array{U}(undef, box.grid_size...)\n    function (df, y, t, dt)\n        k1 .= df(y, t)\n        k2 .= df(y .+ dt/2 .* k1, t + dt/2)\n        k3 .= df(y .+ dt/2 .* k2, t + dt/2)\n        k4 .= df(y .+ dt .* k3, t + dt)\n        y .+= (k1 .+ 2 .* k2 .+ 2 .* k3 .+ k4) .* (dt/6)\n    end\nend\n\nfunction forward_euler(df, y, t, dt)\n    y .+= dt .* df(y, t)\nend\n\nend","category":"page"},{"location":"finite-difference-transport/#Advection","page":"Finite Difference","title":"Advection","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"We are solving sediment transport using finite difference methods. Our active layer approach to transport can be written as an equation in terms of the sediment concentration,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = - d nabla (C nabla w)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"where C is the sediment concentration, d the diffusion coefficient and w the water depth. Similarly, we can set the transport equation when we enable wave transport,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = - d nabla (C nabla w) - v nabla C + s C nabla w","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"where v(w) is the wave transport velocity and s(w) the wave transport shear. This is now no longer a diffusion equation per se, rather an advective system. When we solve the equations, the first term is expanded, so we get,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = -d nabla^2 w C - d nabla w nabla C - v nabla C + s nabla w C","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"collecting terms:","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = - (d nabla w + v) nabla C + (s nabla w - d nabla^2 w) C","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Note that partial_t C is a component of partial_t eta, and nabla eta = - nabla w. So in that context this advection equation enacts diffusion.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-transport⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"d = diffusivity\nv, s = wave_velocity(w[2, 2])\n\ndw = (central_difference(Val{1}, w, dx), central_difference(Val{2}, w, dx))\nadv = upwind(Val{1}, d * dw[1] + v[1], C, dx) + \n      upwind(Val{2}, d * dw[2] + v[2], C, dx)\nrct = (s[1] * dw[1] + s[2] * dw[2] - d * laplacian(w, dx)) * C[2, 2]\nreturn rct - adv","category":"page"},{"location":"finite-difference-transport/#Adaptive-integration","page":"Finite Difference","title":"Adaptive integration","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"To get efficient time integration we need to work with adaptive time-stepping. On each iteration we pre-compute the advection coefficients, and then the maximum time-step. Using the same pre-computed coefficients we then loop n times such that dtn le dt_textrmmax.","category":"page"},{"location":"finite-difference-transport/#Computing-advection-coefficients","page":"Finite Difference","title":"Computing advection coefficients","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Although this is a stencil operation, it is easier to compute this step directly. This way, we can compute dw and ddw with a single look-up of neighbouring grid cells. We store dw in a Vec2, expecting the wave_velocity to do the same.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Here adv stands for advection term and rct for reaction term, given the generic case","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"dC = - textrmadv nabla C + textrmrct C","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-coef⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"function advection_coef!(box::Box{BT}, diffusivity, wave_velocity, w, adv, rct) where {BT}\n    d = diffusivity\n    dx = box.phys_scale\n    di = (CartesianIndex(1, 0), CartesianIndex(0, 1))\n    for i = eachindex(IndexCartesian(), w)\n        v, s = wave_velocity(w[i])\n\n        wx1 = get_bounded(BT, w, i - di[1])\n        wx2 = get_bounded(BT, w, i + di[1])\n        wy1 = get_bounded(BT, w, i - di[2])\n        wy2 = get_bounded(BT, w, i + di[2])\n\n        dw = Vec2((wx2 - wx1) / (2dx), (wy2 - wy1) / (2dx))\n        ddw = (wx1 + wx2 + wy1 + wy2 - 4*w[i]) / dx^2\n\n        adv[i] = d * dw + v\n        rct[i] = dot(s, dw) - d * ddw\n    end\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Given the advection coefficients we can figure out what the maximal timestep should be.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-coef⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"function max_dt(adv, dx, courant_max)\n    u(a) = abs(a[1]) + abs(a[2])\n    return courant_max / maximum(u.(adv) ./ dx)\nend","category":"page"},{"location":"finite-difference-transport/#Compute-dC","page":"Finite Difference","title":"Compute dC","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Once we know our time step, we can use the adv and rct coefficients to evaluate the sediment transport. We again can't use the stencil or finite difference functionalities, since that would do needless computations. ","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-coef⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"function transport_dC!(box::Box{BT}, adv, rct, C, dC) where {BT}\n    dx = box.phys_scale\n    di = (CartesianIndex(1, 0), CartesianIndex(0, 1))\n\n    @inline upwind(v::T, a, i, di) where {T} =\n        if v < zero(T)\n            v * (get_bounded(BT, a, i+di) - a[i]) / dx\n        else\n            v * (a[i] - get_bounded(BT, a, i-di)) / dx\n        end\n\n    for i = eachindex(IndexCartesian(), dC)\n        dC[i] = rct[i] *  C[i] - upwind(adv[i][1], C, i, di[1]) - upwind(adv[i][2], C, i, di[2]) \n    end\n\n    return dC\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>src/Transport/Advection.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module Advection\n\nusing ....CarboKitten: Box\nusing ...Stencil: stencil!, Size\nusing ...BoundaryTrait: get_bounded\nusing ..DifferentialOperators: central_difference, upwind, laplacian\nusing Unitful\nusing GeometryBasics\nusing LinearAlgebra: dot\n\n<<advection-coef>>\n\n\"\"\"\n    transport!(box, diffusivity, wave_velocity,\n               C, w, dC)\n\nComputes `dC` given a `box`, `diffusivity` constant in units of m/Myr,\n`wave_velocity` is a function of water depth, returning both velocity in units\nof m/Myr, and shear in units of 1/Myr, which should be the derivative of the\nvelocity w.r.t. water depth. `C` is the concentration of entrained sediment,\n`w` the water depth, and `dC` the output derivative of `C`.\n\"\"\"\nfunction transport!(box::Box{BT}, diffusivity, wave_velocity, C, w, dC) where {BT}\n    dx = box.phys_scale\n    stencil!(BT, Size(3, 3), dC, C, w) do C, w\n        <<advection-transport>>\n    end\nend\n\n\"\"\"\n    transport(box, diffusivity, wave_velocity, wave_shear,\n               C, w)\n\nNon-mutating version of [`transport!`](@ref). Allocates and returns `dC`.\n\"\"\"\nfunction transport(box::Box{BT}, diffusivity, wave_velocity, C::AbstractArray{T}, w) where {BT, T}\n\tdC = Array{typeof(1.0 * Unitful.unit(T) / u\"Myr\")}(undef, box.grid_size...)\n    transport!(box, diffusivity, wave_velocity, C, w, dC)\n    return dC\nend\n\nend","category":"page"},{"location":"finite-difference-transport/#Tests","page":"Finite Difference","title":"Tests","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"The following set of tests all involve mutilating a picture of a kitten. The default settings for TestModel have zero wave velocity and diffusivity. We'll enable them one by one. Note again, that what we call diffusivity, in the context of these tests doesn't necessarily behave like diffusion.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/runner.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module Runner\nusing CarboKitten\nusing ProgressLogging\n\nn_steps(input) = input.time.steps\n\nfunction run_model(f, ::Type{Model{M}}, input) where {M}\n    state = M.initial_state(input)\n    f(0, state)\n\n    @progress for i = 1:n_steps(input)\n        M.step!(input, state)\n        f(i, state)\n    end\n\n    return state\nend\n\ndo_nothing(_i, _s) = ()\n\nrun_model(::Type{Model{M}}, input) where {M} = run_model(do_nothing, Model{M}, input)\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/test_model.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module TestModel\n\nusing CarboKitten\nusing CarboKitten.Transport.Advection: transport\nusing Unitful\n\n@kwdef struct Input\n    box::Box\n    time::TimeProperties\n    initial_state::Array{Float64}\n    topography::Array{typeof(1.0u\"m\")}\n\n    diffusivity = 0.0u\"m/Myr\"\n    wave_velocity = _ -> ((0.0u\"m/Myr\", 0.0u\"m/Myr\"), (0.0u\"1/Myr\", 0.0u\"1/Myr\"))\n\n    solver\nend\n\n@kwdef mutable struct State\n    time::typeof(1.0u\"Myr\")\n    value::Array{Float64}\nend\n\ninitial_state(input) = State(\n    time = input.time.t0,\n    value = copy(input.initial_state))\n\nfunction step!(input, state)\n    input.solver(\n        (a, t) -> transport(\n            input.box, input.diffusivity, input.wave_velocity,\n            a, .-input.topography),\n        state.value, state.time, input.time.Δt)\n    state.time += input.time.Δt\nend\n\nend","category":"page"},{"location":"finite-difference-transport/#Wave-induced-advection","page":"Finite Difference","title":"Wave induced advection","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"With only wave induced advection enabled, we should see a clear translation of the picture of the kitten. The additional diffusion is so called false diffusion, a numerical artifact of the upwind differencing scheme.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"(Image: Flying Cat)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/flying_cat.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"#| creates: docs/src/_fig/flying_cat.png\n#| collect: figures\n\nmodule FlyingCat\n\ninclude(\"runner.jl\")\ninclude(\"test_model.jl\")\n\nusing CarboKitten\nusing FileIO\nusing GLMakie\n\nusing CarboKitten.Transport.Solvers: forward_euler, runge_kutta_4\n\nGLMakie.activate!()\n\nconst BOX = CarboKitten.Box{Periodic{2}}(\n    grid_size=(256, 256), phys_scale=0.05u\"km\")\n\nconst INPUT = TestModel.Input(\n    box = BOX,\n    time = TimeProperties(Δt=100u\"yr\", steps=50),\n    topography = zeros(typeof(1.0u\"m\"), BOX.grid_size),\n    initial_state = load(\"data/cat256.pgm\")'[:, end:-1:1] .|> Float64,\n    wave_velocity = _ -> ((0.4u\"m/yr\", -0.3u\"m/yr\"), (0.0u\"1/yr\", 0.0u\"1/yr\")),\n    solver = runge_kutta_4(Float64, BOX)\n)\n\nfunction run()\n    x, y = box_axes(INPUT.box)\n\n    fig = Figure(size=(800, 400))\n    ax1 = Axis(fig[1, 1], aspect=1)\n    hm1 = heatmap!(ax1, x, y, INPUT.initial_state, colorrange=(0.0,0.7))\n    Colorbar(fig[2, 1], hm1, vertical=false)\n\n    out = Runner.run_model(Model{TestModel}, INPUT)\n    ax2 = Axis(fig[1, 2], aspect=1)\n    hm2 = heatmap!(ax2, x, y, out.value, colorrange=(0.0,0.7))\n    Colorbar(fig[2, 2], hm2, vertical=false)\n\n    save(\"docs/src/_fig/flying_cat.png\", fig)\nend\n\nend\n\nFlyingCat.run()","category":"page"},{"location":"finite-difference-transport/#Diffusion","page":"Finite Difference","title":"Diffusion","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Next, we only enable the diffusivity term. We set a topography of a single Gaussian peak in the center of the box. Sediment is dispersed down slope.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"(Image: Exploding Kitten)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/exploding_kitten.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"#| creates: docs/src/_fig/exploding_kitten.png\n#| collect: figures\n\nmodule ExplodingKitten\n\ninclude(\"runner.jl\")\ninclude(\"test_model.jl\")\n\nusing CarboKitten\nusing FileIO\nusing GLMakie\n\nusing CarboKitten.Transport.Solvers: runge_kutta_4\n\nGLMakie.activate!()\n\nconst N = 288\n\nfunction load_cat()\n    b = div(N - 256, 2)\n    cat = zeros(Float64, N, N)\n    cat[b+1:256+b, b+1:256+b] .= (load(\"data/cat256.pgm\")'[:, end:-1:1] .|> Float64)\n    return cat\nend\n\nconst BOX = CarboKitten.Box{Reflected{2}}(grid_size=(N, N), phys_scale=0.05u\"km\")\nconst X, Y = box_axes(BOX)\nconst INPUT = TestModel.Input(\n    box = BOX, \n    time = TimeProperties(Δt=100u\"yr\", steps=100),\n    initial_state = load_cat(),\n    topography = ((x, y) -> 30.0u\"m\" * exp(-((x-7.2u\"km\")^2 + (y-7.2u\"km\")^2)/(2*(3.0u\"km\")^2)) - 30.0u\"m\").(X, Y'),\n    diffusivity = 30.0u\"m/yr\",\n    solver = runge_kutta_4(Float64, BOX)\n)\n\nfunction run()\n    x, y = box_axes(INPUT.box)\n\n    fig = Figure(size=(800, 400))\n    ax1 = Axis(fig[1, 1], aspect=1)\n    hm1 = heatmap!(ax1, x, y, INPUT.topography / u\"m\")\n    Colorbar(fig[2,1], hm1, vertical=false)\n\n    out = Runner.run_model(Model{TestModel}, INPUT)\n    ax2 = Axis(fig[1, 2], aspect=1)\n    hm2 = heatmap!(ax2, x, y, out.value, colorrange=(0.0,0.8))\n    Colorbar(fig[2,2], hm2, vertical=false)\n\n    save(\"docs/src/_fig/exploding_kitten.png\", fig)\nend\n\nend\n\nExplodingKitten.run()","category":"page"},{"location":"finite-difference-transport/#Scale-invariance","page":"Finite Difference","title":"Scale invariance","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"From the conception  of the transport model, it should be evident that the solution to the transport equations should be scale invariant, in the sense that  we can multiply C by any constant, solve the equations, then divide by the same constant and arrive at the same result.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>test/Transport/AdvectionSpec.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"@testset \"CarboKitten.Transport.Advection.scale-invariance\" begin\n\nusing CarboKitten\nusing CarboKitten.Transport.Solvers: runge_kutta_4\nusing CarboKitten.Transport.Advection: transport\nusing Unitful\n\nlet box = Box{Periodic{2}}(grid_size=(32, 32), phys_scale=1.0u\"m\")\n    solver = runge_kutta_4(Float64, box)\n    wave_velocity = _ -> ((0.5u\"m/s\", 0.0u\"m/s\"), (0.0u\"1/s\", 0.0u\"1/s\"))\n    diffusivity = 5.0u\"m/s\"\n    w = randn(box.grid_size...) * u\"m\"\n    C1 = randn(box.grid_size...)\n    C2 = C1 .* 10.0\n    dt = 1.0u\"s\"\n    df(C, _) = transport(box, diffusivity, wave_velocity, C, w)\n\n    for i = 1:10\n        solver(df, C1, 0.0u\"s\", dt)\n        solver(df, C2, 0.0u\"s\", dt)\n    end\n\n    @test isapprox(C1 .* 10.0, C2)\nend\n\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"","category":"page"},{"location":"input-methods/#Input-Methods","page":"Input Methods","title":"Input Methods","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Every model in CarboKitten has its own specific needs in terms of input. However, there are many common idioms used here.","category":"page"},{"location":"input-methods/#Sea-level","page":"Input Methods","title":"Sea level","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"The sea level curve is probably the input parameter that is most often of interest. CarboKitten expects the sea level to be passed on as a function of time. So time must also be defined. In the tutorial you find the following example:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"time = TimeProperties(\n\tΔt = 500u\"yr\",\n\tsteps = 2000\n)","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"To retrieve the range of times which will be written as the model output, one can use the time_axis() function.","category":"page"},{"location":"input-methods/#Sea-level-from-file","page":"Input Methods","title":"Sea level from file","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Reading a single vector of numbers from a example.txt file in the data folder (it will be similar for other formats):","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"dir = \"data\"\nfilename = joinpath(dir, \"example.txt\")\nsea_level = readdlm(filename, '\\t', header=false) * u\"m\"","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Remember that the topmost value in the file will be the first one to be read. In geological datasets this is often the youngest value, but because CarboKitten is a forward model, the first value in the vector of sea level values will be the one used first, so effectively the oldest. Sort your sea level values in the order of decreasing age, or oldest first, for CarboKitten to read them correctly.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Consider several situations involving the file with the values of sea level and the model run:","category":"page"},{"location":"input-methods/#1.-The-file-has-regularly-spaced-(equidistant)-observations","page":"Input Methods","title":"1. The file has regularly spaced (equidistant) observations","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Whether the temporal resolution is lower, the same or higher than the model step, we recommend using linear_interpolation from the package Interpolations.jl or an equivalent function. You will have to interpolate the values to the density determined by Δt. ","category":"page"},{"location":"input-methods/#Running-a-model-at-a-resolution-higher-than-the-resolution-of-the-sea-level-data","page":"Input Methods","title":"Running a model at a resolution higher than the resolution of the sea level data","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"The model may give nicer results at lower Δt than the resolution of the empirical sea level data. This will require \"making up\" data by interpolation. Keep in mind that scientifically you don't know what happened at the interpolated points, so the sea level curve and the carbonate platform generated will be smoother than they would have been if the sea level had been measured at this resolution. You may use the parameter write_times from the component TimeIntegration to model at a higher temporal resolution, but save the results only at a resolution of the input data.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"using Interpolations\n\nSL  = linear_interpolation(time_axis(time), sea_level)","category":"page"},{"location":"input-methods/#2.-The-file-has-irregularly-(not-equidistant)-observations","page":"Input Methods","title":"2. The file has irregularly (not equidistant) observations","text":"","category":"section"},{"location":"input-methods/#2.1.-Interpolation-on-irregular-grid","page":"Input Methods","title":"2.1. Interpolation on irregular grid","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Take the example from the tutorial:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"using CarboKitten.DataSets: miller_2020\nmiller_df = miller_2020()\n\nusing Interpolations\nsort!(miller_df, [:time])\nmiller_sea_level = linear_interpolation(miller_df.time, miller_df.sealevel)","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"This works even though miller_df.time is not equally spaced, which is why this function is very safe if you change your input data a lot. But what happens under the hood is that extrapolation according to the method that is default for linear_interpolation. It may not be the best method for your data, so we recommend checking that and reporting on the type of interpolation used.","category":"page"},{"location":"input-methods/#2.2.-Local-regression-(loess)","page":"Input Methods","title":"2.2. Local regression (loess)","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Loess, or \"Locally Estimated Scatterplot Smoothing\", is very popular among geoscientists. The Smoothers.jl package needs to be installed for this to work (Pkg.add(\"Smoothers\")). ","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"(Image: Loess smoothing of the sea level curve of Miller et al. (2020))","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"It should work as follows:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/loess.jl</i></div>","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"#| creates: docs/src/_fig/loess.png\n#| collect: figures\n\nmodule Script\n\nusing CarboKitten\n\nusing Unitful\nusing CarboKitten.Components\n\nusing CarboKitten.DataSets: miller_2020\nusing Smoothers\nusing GLMakie\n\nGLMakie.activate!()\n\nfunction main()\n\n    miller_df = miller_2020()\n    sort!(miller_df, [:time])\n\n    sl = miller_df.sealevel / u\"m\" .|> NoUnits\n    ti = miller_df.time / u\"kyr\" .|> NoUnits\n\n    fig = Figure()\n    ax = Axis(fig[1,1], xlabel=\"Time [kyr]\", ylabel=\"Sea level [m]\")\n    scatter!(ax, ti, sl)\n    lines!(ax, ti, Smoothers.loess(ti, sl, q = 1000)(ti); color = :tomato)\n    save(\"docs/src/_fig/loess.png\",fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Choosing the q parameter proves difficult. Although the package Smoothers.jl indicates the default value will be estimated, in practice it seems to often result in NaNs. So always plot the result of smoothing to check it has been done correctly.","category":"page"},{"location":"input-methods/#Inline-functions","page":"Input Methods","title":"Inline functions","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"If the function is very simple, you can enter it as an inline anonymous function (also known as a lambda). The following would generate a sinusoid with an amplitude of 10m and a period of 100,000 years.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"const INPUT = Input(\n    ...\n    sea_level = t -> 10.0u\"m\" * sin(2pi / 100.0u\"kyr\")\n    ...)","category":"page"},{"location":"input-methods/#Stochastic-functions","page":"Input Methods","title":"Stochastic functions","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Functions can capture pre-generated data, so you can generate a stochastic sea-level curve for use in CarboKitten. There are multiple stochastic processes available in DiffEqNoiseProcess.jl and some of them may be relevant for modeling sea level. This example uses OrnsteinUhlenbeckProcess, which is a continuous time equivalent of an AR(1), but here calculated for specific positions determined based on the temporal resolution of the model, set in TIME_PROPERTIES.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"The outcome looks like an AR(1) process:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"(Image: Sea-level modeled as Ornstein-Uhlenbeck process)","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/ornstein-uhlenbeck.jl</i></div>","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"#| creates: docs/src/_fig/OU.png\n#| collect: figures\n\nmodule Script\n\nusing CarboKitten\n\nusing Unitful\nusing CarboKitten.Components\nusing GLMakie\nusing Random\n\nGLMakie.activate!()\n\nconst TIME_PROPERTIES = TimeProperties(\n\tΔt = 500u\"yr\",\n\tsteps = 2000\n)\n\nfunction generate_ar1(mean, n, drift, variance)\n\"\"\"\nArguments\n- `mean`: Mean of the process\n- `length`: Length of the process (number of steps)\n- `drift`: Drift parameter\n- `variance`: Variance of the process \n\"\"\"\n    ar1 = Vector{Float64}(undef, n)\n    ar1[1] = mean  # start with the mean for simplicity\n\n    for i in 2:n\n        ar1[i] = drift * ar1[i-1] + (1 - drift) * mean + randn() * sqrt(variance)\n    end\n\n    return ar1\nend\n\nconst θ = 0.4 # drift\nconst μ = 2.0 # mean\nconst σ = 20 # variance\n\nfunction main()\n\nOU = generate_ar1(μ, length(time_axis(TIME_PROPERTIES)), θ, σ)\n\nfig, ax = lines(time_axis(TIME_PROPERTIES) |> in_units_of(u\"Myr\"), collect(OU) .* u\"m\")\n    ax.xlabel = \"time [Myr]\"\n\tax.ylabel = \"sea level [m]\"\n    save(\"docs/src/_fig/OU.png\",fig)\n\nend\n\nend\n\nScript.main()","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"","category":"page"},{"location":"components/components/#Model-Components","page":"Components","title":"Model Components","text":"","category":"section"},{"location":"components/components/","page":"Components","title":"Components","text":"Each model in CarboKitten is composed out of elementary parts. These form a hierarchy of modules that inherit from each other.","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"<!– FIXME: auto-generate this graph –>","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"graph TD;\n    classDef nyi fill:#888;\n\n    time[Time Integration]\n    facies[Facies Base]\n    box[Box]\n    water_depth[Water Depth]\n    uniform_production[Production]\n    cellular_automaton[Cellular Automaton]\n    ca_production[CA Production]\n    h5writer[HDF5 Writer]\n    tag[Tagged Output]\n\n    sediment_buffer[Sediment Buffer]\n    active_layer_transport[Active Layer Transport]\n    denudation[Denudation]\n    class denudation nyi;\n\n    time --> water_depth\n    box --> water_depth\n\n    water_depth --> uniform_production\n    facies --> uniform_production\n\n    box --> cellular_automaton\n    facies --> cellular_automaton\n\n    cellular_automaton --> ca_production\n    uniform_production --> ca_production\n\n    box --> sediment_buffer\n    sediment_buffer --> active_layer_transport\n    water_depth --> active_layer_transport\n    sediment_buffer --> denudation\n    water_depth --> denudation\n\n    box --> h5writer\n    facies --> h5writer\n    time --> h5writer\n    water_depth --> h5writer","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"Not all of these are equally important. The H5Writer implements the core simulation loop and writing a simulation to HDF5 files. For a Model to work with H5Writer it needs to have initial_state, step!, and write_header functions implemented. Each component can have its own write_header implementation. Those are joined together with a special @for_each(P->P.write_header(fid, input), PARENTS) call.","category":"page"},{"location":"components/components/#Contents","page":"Components","title":"Contents","text":"","category":"section"},{"location":"components/components/","page":"Components","title":"Components","text":"Pages = [\"tag.md\", \"boxes.md\", \"time.md\", \"facies.md\",\n         \"production.md\", \"cellular-automata.md\", \"waterdepth.md\", \"hdf5.md\",\n         \"sediment_buffer.md\"]\nDepth = 1","category":"page"},{"location":"components/components/#Common-Definitions","page":"Components","title":"Common Definitions","text":"","category":"section"},{"location":"components/components/","page":"Components","title":"Components","text":"<div class=\"noweb-label\">file:<i>src/Components/Common.jl</i></div>","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"module Common\nexport @u_str, Quantity, Amount, Time, Location, Rate, Intensity, Height\nexport AbstractFacies, AbstractInput, AbstractState, AbstractFrame\nexport Box, box_axes, Boundary, Coast, Periodic, Reflected, TimeProperties\nexport in_units_of\nexport Model\nexport @for_each\nexport Size\nexport Frame\n\nusing ModuleMixins\nusing Unitful\nusing StaticArrays\n\nusing ...CarboKitten: Model\nusing ...BoundaryTrait\nusing ...Config: TimeProperties\nusing ...Boxes: Box, box_axes\nusing ...Utility: in_units_of\n\nconst Amount = typeof(1.0u\"m\")\nconst Time = typeof(1.0u\"Myr\")\nconst Height = typeof(1.0u\"m\")\nconst Location = typeof(1.0u\"m\")\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Intensity = typeof(1.0u\"W/m^2\")\nconst Sediment = typeof(1.0u\"m\")\n\nabstract type AbstractFacies end\nabstract type AbstractInput end\nabstract type AbstractState end\nabstract type AbstractFrame end\n\n@kwdef struct Frame\n    disintegration::Union{Array{Sediment,3},Nothing} = nothing   # facies, x, y\n    production::Union{Array{Sediment,3},Nothing} = nothing\n    deposition::Union{Array{Sediment,3},Nothing} = nothing\nend\n\nend","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"<div class=\"noweb-label\">file:<i>src/Components.jl</i></div>","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"module Components\n\nexport Tag, TimeIntegration, Boxes, WaterDepth, FaciesBase, Production,\n       CAProduction, CellularAutomaton, H5Writer, ActiveLayer, SedimentBuffer,\n       ActiveLayerOnshore, Denudation\n\nusing ModuleMixins: @compose\n\ninclude(\"Components/Common.jl\")\ninclude(\"Components/Tag.jl\")\ninclude(\"Components/TimeIntegration.jl\")\ninclude(\"Components/Boxes.jl\")\ninclude(\"Components/WaterDepth.jl\")\ninclude(\"Components/FaciesBase.jl\")\ninclude(\"Components/Production.jl\")\ninclude(\"Components/CellularAutomaton.jl\")\ninclude(\"Components/CAProduction.jl\")\n\ninclude(\"Components/SedimentBuffer.jl\")\ninclude(\"Components/ActiveLayer.jl\")\ninclude(\"Components/Denudation.jl\")\n\ninclude(\"Components/Models.jl\")\ninclude(\"Components/H5Writer.jl\")\n\nlist_components() = filter(\n    c->:AST in names(c, all=true),\n    map(eval, names(Components)))\n\nend","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"","category":"page"},{"location":"denudation/chemical/#Chemical-dissolution","page":"Chemical Dissolution","title":"Chemical dissolution","text":"","category":"section"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The details could be found in paper by [11].","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Limestone is made of CaCO_3, easily dissolved. This depends mainly on precipitation (rainfall) and temperature. The paper used equation 1 to quantify this process.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"fracdhdt = 0001 kappa_c q_i over A_i","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Herein dhdt is the chemical weathering rate and the unit is in m/s. Other parameters are defined as: q_i is the discharge of water at a certain cell. A_i is the surface area of the cell. If we assume there would be no surface water on land, q_i reduces to precipitation – evaporation. Let’s set it to 400 mm/y for now. Therefore equation 1 could be reduced to Equation 2.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"fracdhdt = 0001 kappa_c  I","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Where I is runoff (mm/y?). The parameter kappa_c is dimensionless and should be described by equation 3:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"kappa_c = 40 1000 fracCa^2+_eqrho","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Parameter ρ is the density of calcite, and we choose 2700 kgm^3 here. Ca^2+_eq is defined in equation 4:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Ca^2+_eq = (PCO_2 (K_1 K_C K_H) over (4 K_2times gamma Ca (gamma HCO_3)^2))^(13)","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Mass balance coefficients K_1, K_2, K_C, K_H depend on temperature. _PCO_2 is assumed to be between 10^-15 ATM to 10^-35 ATM.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Other parameters can be found in the following table by [11].","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Parameter Description Unit Value\nT Absolute temperature [°K] Tc + 273.16\nI Ion activity [-] 0.1\nA^* Debye-Hückel coefficient [-] -04883 + 8074 times 10^-4T_c\nB^* Debye-Hückel coefficient [-] -03241 + 1600 times 10^-4T_c\nlog gamma Cadagger Activity coefficient [-] -4AsqrtI(1 + 50 x 10^-8BsqrtI)\nlog gamma HCO_3dagger Activity coefficient [-] -1AsqrtI(1 + 54 x 10^-8BsqrtI)\nlog K_1ddagger Mass balance coefficient [ mol L^-1 ] -3563094 - 006091964T + 2183437T + 1268339logT - 1684915T^2\nlog K_2ddagger Mass balance coefficient [ mol L^-1 ] -1078871 - 003252849T + 515179T + 3892561logT - 5637139T^2\nlog K_cddagger Mass balance coefficient [ mol^2 L^-2 ] -1719065 - 0077993T + 2839319T + 71595logT\nlog K_Hddagger Mass balance coefficient [ mol L^-1 atm^-1 ] 1083865 + 001985076T - 691953T - 4045154logT + 669365T^2","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"These parameters are calculated from temperature using the karst_denudation_parameters function:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">⪡karst-parameter-function⪢≣</div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"function karst_denudation_parameters(temp::Float64)\n    A = -0.4883 + 8.074 * 0.0001 * (temp - 273.0)\n    B = -0.3241 + 1.6 * 0.0001 * (temp - 273.0)\n    IA = 0.1 # ion activity\n\n    (K1=10^(-356.3094 - 0.06091964 * temp + 21834.37 / temp + 126.8339 * log10(temp) - 1684915 / (temp^2)),\n        K2=10^(-107.881 - 0.03252849 * temp + 5151.79 / temp + 38.92561 * log10(temp) - 563713.9 / (temp^2)),\n        KC=10^(-171.9065 - 0.077993 * temp + 2839.319 / temp + 71.595 * log10(temp)),\n        KH=10^(108.3865 + 0.01985076 * temp - 6919.53 / temp - 40.4515 * log10(temp) + 669365 / (temp^2)),\n        activity_Ca=10^(-4A * sqrt(IA) / (1 + 10^(-8) * B * sqrt(IA))),\n        activity_Alk=10^(-A * sqrt(IA) / (1 + 5.4 * 10^(-8) * B * sqrt(IA))))\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The output of this function for the K_H parameter is plotted below for a range of input temperatures","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"(Image: KH as function of temperature)","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">file:<i>examples/denudation/dissolution-test.jl</i></div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"#| requires: examples/denudation/dissolution-test.jl\n#| creates:\n#|   - docs/src/_fig/KHTemp.png\n#|   - docs/src/_fig/Equilibrium_Concs.png\n#|   - docs/src/_fig/DissolutionExample.png\n#| collect: figures\n\nmodule DissolutionSpec\nusing CairoMakie\nusing Unitful\nusing CarboKitten.Denudation.DissolutionMod: equilibrium, dissolution, karst_denudation_parameters\nusing CarboKitten: Box\nusing CarboKitten.Stencil: Periodic, Reflected, stencil\n\n\n@kwdef struct facies\n    infiltration_coefficient :: Float64\n    mass_density :: typeof(1.0u\"kg/m^3\")\n    reactive_surface :: typeof(1.0u\"m^2/m^3\")\nend\n\n\n@kwdef struct Dissolution\n    temp :: Any\n    precip :: Float64\n    pco2 :: Float64\n    reactionrate :: Float64\nend\n\n@kwdef struct state\n    ca::Matrix{Int}\nend\n\nconst BOX = Box{Periodic{2}}(grid_size=(5, 5), phys_scale=1.0u\"km\")\n\n\nconst Facies = facies(infiltration_coefficient = 0.5,\nmass_density = 2.73u\"kg/m^3\",\nreactive_surface = 1000u\"m^2/m^3\")\n\nconst DIS = Dissolution(temp = 285,\nprecip  = 1.0,\npco2 = 10^(-1.5),\nreactionrate = 0.1)\n\nconst STATE = state(ca = \n[ 0  0  1  0  0\n0  1  0  1  1\n0  0  1  0  1\n1  0  1  1  0\n1  1  1  1  0])\n\nconst WD = -10 .* [ 0.0663001  0.115606  0.646196\n0.601523   0.130196  0.390821\n0.864734   0.902935  0.670354]\n\nfunction main()\n    temp = collect(293:0.5:303)\n\n    Eq_result = Array{Any,1}(undef,length(temp))\n    Para_result = Array{Any,1}(undef,length(temp))\n    Dis_result = Array{Any,1}(undef,length(temp))\n    Dis_result_wd = Array{Any,1}(undef,length(WD))\n\n    for i in eachindex(temp)\n        Para_result[i] = karst_denudation_parameters(temp[i])\n    end\n    Para_result_KH = [x.KH for x in Para_result]\n\n    for i in eachindex(temp)\n       Eq_result[i] =  equilibrium(temp[i],DIS.pco2,DIS.precip,Facies)\n    end\n    Eq_result_concs = [x.concentration for x in Eq_result]\n    for i in eachindex(temp)\n        Dis_result[i] = dissolution(temp[i],DIS.precip,DIS.pco2,DIS.reactionrate,WD[1],Facies)\n    end\n    Dis_result\n    for i in eachindex(WD)\n        Dis_result_wd[i] = dissolution(temp[1],DIS.precip,DIS.pco2,DIS.reactionrate,WD[i],Facies)\n    end\n    Dis_result_wd\n\n    fig1 = Figure()\n    ax1 = Axis(fig1[1,1],xlabel=\"Temp (K)\", ylabel=\" concentration (mol/L)\")\n    lines!(ax1,temp,Eq_result_concs)\n    save(\"docs/src/_fig/Equilibrium_Concs.png\",fig1)\n\n    fig2 = Figure()\n    ax2 = Axis(fig2[1,1],xlabel=\"Temp (K)\", ylabel=\"KH\")\n    lines!(ax2,temp,Para_result_KH)\n    save(\"docs/src/_fig/KHTemp.png\",fig2)\n\n    fig3 = Figure()\n    ax3 = Axis(fig3[1,1],xlabel=\"Temp (K)\", ylabel=\"Denudation rates (m/Myr)\")\n    lines!(ax3,temp,Dis_result)\n\n    ax4 = Axis(fig3[1,2],xlabel=\"Water Depth (m)\", ylabel=\"Denudation rates (m/Myr)\")\n    scatter!(ax4,vec(WD),Dis_result_wd)\n    fig3\n    save(\"docs/src/_fig/DissolutionExample.png\",fig3)\nend\nend\n\nDissolutionSpec.main()","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"</details>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The Ca^2+_eq parameter is calculated from temperature using the equilibrium function:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">⪡karst-equilibrium-function⪢≣</div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"function equilibrium(temp::Float64, pco2::Float64, precip::Float64, facies)\n    p = karst_denudation_parameters(temp)\n    mass_density = facies.mass_density ./ u\"kg/m^3\"\n    eq_c = (pco2 .* (p.K1 * p.KC * p.KH) ./ (4 * p.K2 * p.activity_Ca .* (p.activity_Alk)^2)) .^ (1 / 3)\n    eq_d = 1e6 * precip .* facies.infiltration_coefficient * 40 * 1000 .* eq_c ./ mass_density\n    (concentration=eq_c, denudation=eq_d)\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The value of Ca^2+_eq calculated in equilibrium for a range of temperatures: (Image: KH as function of temperature)","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"However, the above discussion is true only if the percolated fluid is saturated (in terms of Ca) when leaving the platform. In some cases, when the fluid is not saturated, the dissolved amount is lower than the scenario described above.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The following articles describe this: [12] and [13]","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Ideally, a reactive transport model should be accurate, but that needs more computation resources. So herein, the author just suggested the dissolution rates of rocks depend on the depth. This makes sense, as the deeper the solution penetrates, the more concentrated it becomes. Also, this does not consider diffusion in this chapter.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The dissolution rate of carbonate follows linear rate laws of:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"F = alpha (c_eq-c(z))","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The rate law is a common expression way to describe the kinetics of certain chemical reactions see Rate Laws.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"F","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"is the dissolution rate, alpha is constant (kinetic co-efficient), c_eq is the concentration in fluid when equilibrium is reached (i.e., no more dissolution, which is Ca^2+_eq in Chapter 1), c(z) is the current concentrationion at depth z in the fluid. This equation then expands to","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"I rm dc = alpha (c_eq-c(z)) L rm dz","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"This equation indicates that the concentration increase in the infiltrated water equals the dissolution of rocks in the thickness of dz. L is the specific length of fractures/porosities (units: mm^2, we can try 100 at the first place). I.e., this term defines the relative reactive surface of the subsurface rocks, or how much surface is actually dissolving. This term is difficult to determine. I is infiltration, but slightly different as chapter 1: this I is the I in each rain event according to the paper. We certainly do not gonna know how this parameter works, so we just set it the same as in chapter 1?","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"However, to solve this equation we still need to know c(z).","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"If assuming the initial percolating water has c(0) = 0, then we could get the following equation (as c is related to depth):","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"c(z) = c_eq (1 - e^(-zlambda))","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Herein, $ \\lambda = {{I} \\over {\\alpha L}} $.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Therefore,","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"D_rm average = (Itimes fracc_eqrho) (1  (fraclambdaz_0) (1  e^(frac-z_0lambda)))","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"α used in this article is alpha = 210^6 or 3510^7 cm/s (for temp at 298K). This is indeed a controversial parameter TBH. We can try different values and see what happens.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"These equations are implemented as dissolution function:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">⪡karst-dissolution-function⪢≣</div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"function dissolution(temp, precip, pco2, alpha, water_depth, facies)\n    reactive_surface =  facies.reactive_surface ./u\"m^2/m^3\"\n    λ = precip * 100 .* facies.infiltration_coefficient ./ (alpha .* reactive_surface)\n    eq = equilibrium(temp, pco2, precip, facies) # pass ceq Deq from the last function\n    eq.denudation .* (1 - (λ ./ -water_depth) .* (1 - exp.(water_depth ./ λ))) * u\"m/Myr\"\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The dedudation rate calculated in this function for varying temperature and water depth is plotted here:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"(Image: Dissolution as function of temperature and water depth)","category":"page"},{"location":"denudation/chemical/#Implementation","page":"Chemical Dissolution","title":"Implementation","text":"","category":"section"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">file:<i>src/Denudation/DissolutionMod.jl</i></div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"module DissolutionMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...BoundaryTrait: Boundary\nusing ...Boxes: Box\nexport Dissolution\nusing Unitful\n\n@kwdef struct Dissolution <: DenudationType\n    temp::typeof(1.0u\"K\")\n    precip::typeof(1.0u\"m\")\n    pco2::typeof(1.0u\"atm\")\n    reactionrate::typeof(1.0u\"m/yr\")\nend\n\n<<karst-parameter-function>>\n\n#calculate ceq and Deq, Kaufman 2002\n<<karst-equilibrium-function>>\n\n<<karst-dissolution-function>>\n\n\nfunction denudation(::Box{BT}, p::Dissolution, water_depth, slope, facies, state) where {BT<:Boundary}\n    temp = p.temp ./ u\"K\"\n    precip = p.precip ./u\"m\"\n    pco2 = p.pco2 ./1.0u\"atm\"\n    reactionrate = p.reactionrate ./u\"m/yr\"\n    denudation_rate = zeros(typeof(1.0u\"m/Myr\"), length(facies), size(state.ca)...)\n\n    for idx in CartesianIndices(state.ca)\n        f = state.ca[idx]\n        if f == 0\n            continue\n        end\n        if water_depth[idx] <= 0\n            denudation_rate[f, idx] = dissolution(temp, precip, pco2, reactionrate, water_depth[idx], facies[f])\n        end\n    end\n    return denudation_rate\nend\n\nfunction redistribution(box::Box{BT}, p::Dissolution, denudation_mass, water_depth) where {BT<:Boundary}\n    return nothing\nend\n\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"","category":"page"},{"location":"stencils/#Stencil-operations","page":"Stencils","title":"Stencil operations","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"A stencil is the common term for computing many-to-one operations on grids. Examples of applications are:","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Finite difference schemes\nFinite Impulse Response (FIR) filters\nConvolutions (encompassing the previous two)\nCellular Automata","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Note that for larger convolution kernels, it is often more efficient to perform convolutions in the Fourier domain. On the matter of performance: stencil operations are the textbook example for computations that perform really well on GPUs.","category":"page"},{"location":"stencils/#Implementation","page":"Stencils","title":"Implementation","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Using these helper functions we can now define a stencil operation. Given the boundary trait, a stencil size and a response function, we can transform an array to a next generation.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">⪡stencil-operation⪢≣</div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"\"\"\"\n    stencil!(f, Boundary, Size, out, inp...)\n\nPerforms stencil operation. The function `f` should take a number of\nabstract arrays (same as the number of `inp` values),\nand return a single value of the same type as elements in `out`.\nThe `Size` parameter should be a type parameter size of the stencil,\ne.g. `Size(3, 3)` to get a 3 by 3 stencil.\n\nPrefer to use this version over the older implementations.\n\"\"\"\nfunction stencil!(f::F, ::Type{BT}, ::Size{sz}, out, inp...) where {F, dim, sz, BT <: Boundary{dim}}\n    stencil_multi!(f, BT, Size(sz), out, inp)\nend\n\nfunction stencil_multi!(f::F, ::Type{BT}, ::Size{sz}, out, inp) where {F, dim, sz, BT <: Boundary{dim}}\n    @assert(\n        all(size(a) == size(out) for a in inp),\n        \"inputs have wrong shape: $([size(a) for a in inp]), should be $(size(out))\")\n\n    center = CartesianIndex((div.(sz, 2) .+ 1)...)\n    for i in eachindex(IndexCartesian(), out)\n        nb = (SArray{Tuple{sz...}}(\n                get_bounded(BT, a, i + j - center)\n                for j in CartesianIndices(sz))\n              for a in inp)\n        out[i] = f(nb...)\n    end\n    return out\nend\n\n\nfunction stencil(::Type{TIn}, ::Type{TOut}, ::Type{BT}, n::NTuple{dim,Int}, f::Function) where {TIn, TOut, dim, BT <: Boundary{dim}}\n    m = n .÷ 2\n    stencil_shape = range.(.-m, m)\n    stencil = Array{TIn, dim}(undef, n...)\n\n    function(z_in::AbstractArray{TIn, dim}, z_out::AbstractArray{TOut, dim}, args...)\n        @assert (size(z_in) == size(z_out)) \"sizes of arrays need to be equal\"\n        shape = size(z_in)\n        for i in CartesianIndices(shape)\n            for (k, Δi) in enumerate(CartesianIndices(stencil_shape))\n                stencil[k] = offset_value(BT, z_in, i, Δi)\n            end\n            z_out[i] = f(stencil, args...)\n        end\n    end\nend\n\nstencil(::Type{T}, ::Type{BT}, n::NTuple{dim, Int}, f::Function) where {T, dim, BT <: Boundary{dim}} =\n    stencil(T, T, BT, n, f)\n\nconvolution(::Type{TIn}, ::Type{TOut}, ::Type{B}, kernel::AbstractArray{U, dim}) where { dim, TIn, TOut, U, B <: Boundary{dim} } =\n    stencil(TIn, TOut, B, size(kernel), s -> sum(s .* kernel))\n\nconvolution(::Type{B}, kernel::AbstractArray{T, dim}) where {dim, T, B <: Boundary{dim}} =\n    stencil(T, T, B, size(kernel), s -> sum(s .* kernel))","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"More efficient implementations are imaginable. For instance we could use normal unchecked indexing for most of the array, and only use the offset_value function when we really need it. Another optimisation could be to generate parts of the inner loop, and/or do the outer loop in parallel.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"We will now test this function first on an Elementary CA (ECA), Conway's Game of Life, and a convolution.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<details><summary>Stencil module</summary>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>src/Stencil.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"module Stencil\n\nusing StaticArrays\n\nusing ..Boxes: AbstractBox\nusing ..BoundaryTrait\n\nexport stencil, convolution\n\n<<stencil-operation>>\n\nend","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"</details>","category":"page"},{"location":"stencils/#Examples","page":"Stencils","title":"Examples","text":"","category":"section"},{"location":"stencils/#Elementary-Cellular-Automata","page":"Stencils","title":"Elementary Cellular Automata","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"An Elementary Cellular Automata is a one-dimensional CA with two states. Every next generation depends on the direct neighbourhood of three cells. Since there are 2^3 = 8 patterns and two outcomes for every pattern, there are 2^8 = 256 possible ECA.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>examples/ca/eca.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"#| creates: docs/src/_fig/eca.png\n#| requires: src/Stencil.jl\n#| collect: figures\n\nmodule ECA\n    using CarboKitten.BoundaryTrait\n    using CarboKitten.Stencil\n    using CairoMakie\n\n    rule(i::Int) = function (foo::AbstractVector{T}) where T <: Integer\n        d = foo[1]*4 + foo[2]*2 + foo[3]\n        i & (1 << d) == 0 ? 0 : 1\n    end\n\n    function eca(r::Int, n::Int, iter::Int)\n        y = Array{Int}(undef, n, iter)\n        y[:, 1] = zeros(Int, n)\n        y[div(n, 2), 1] = 1\n        stencil_op = stencil(Int, Periodic{1}, (3,), rule(r))\n        for i in 2:iter\n            stencil_op(view(y, :, i-1), view(y, :, i))\n        end\n        y\n    end\n\n    function plot()\n        fig = Figure(size=(1200,400))\n        for (idx, r) in enumerate([18, 30, 110])\n            ax = Axis(fig[1,idx]; title=\"rule $(r)\", yreversed=true, limits=((1, 256), (1, 128)))\n            heatmap!(ax, eca(r, 256, 128); colormap=:Blues)\n        end\n        save(\"docs/src/_fig/eca.png\", fig)\n    end\nend\n\nECA.plot()","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"(Image: )","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Even these one-dimensional CA show highly complex behaviour. For instance, it has been shown that rule 110 is Turing complete.","category":"page"},{"location":"stencils/#Game-of-Life","page":"Stencils","title":"Game of Life","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Perhaps the most famous CA is Conway's Game of Life. This is a two-dimensional two-state (dead/alive) CA, with the following rules: a cell is alive in the next generation if it is alive and has two neighbours or if it has three neighbours; in all other cases the cell is dead.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>examples/ca/life.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"#| creates: docs/src/_fig/life.gif\n#| requires: src/Stencil.jl\n#| collect: figures\n\nmodule Life\n    using CarboKitten.BoundaryTrait\n    using CarboKitten.Stencil\n    using CairoMakie\n    using .Iterators: take\n\n    \"x is a 3x3 region around the cell at x[2,2].\"\n    rules(x) = let c = x[2, 2], s = sum(x) - c\n        c && s == 2 || s == 3\n    end\n\n    function game_of_life(w, h)\n        y1 = rand(Bool, (w, h))\n        y2 = Array{Bool}(undef, w, h)\n\n        op = stencil(Bool, Periodic{2}, (3, 3), rules)\n        Channel() do ch\n            put!(ch, y1)\n            while true\n                op(y1, y2)\n                (y1, y2) = (y2, y1)\n                put!(ch, y1)\n            end\n        end\n    end\n\n    function plot()\n        life = take(game_of_life(50, 50), 150)\n        fig = Figure()\n        ax = Axis(fig[1,1], aspect=1)\n        record(fig, \"docs/src/_fig/life.gif\", life; framerate=10) do frame\n            heatmap!(ax, frame; colormap=:Blues)\n        end\n    end\nend\n\nLife.plot()","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"(Image: )","category":"page"},{"location":"stencils/#Testing-boundaries-with-a-convolution","page":"Stencils","title":"Testing boundaries with a convolution","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"To test the different boundary types, lets try the following setup. We take a 16x16 image with all zeros except the bottom left gets a value of 1 and the top right pixel gets a value of 2. Now convolve with a Gaussian and see what happens. For the constant boundary, I've set the value to 0.1, to see the effect.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"(Image: )","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Notice, that for the periodic boundaries, the bottom left and top right are neighbouring. So there the two pixels appear as a single peak. In the reflected case we see a clear distinction between the two corners.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"#| creates: docs/src/_fig/boundary_types.png\n#| requires: src/Stencil.jl\n#| collect: figures\n\nmodule Script\n\nusing CarboKitten.BoundaryTrait\nusing CarboKitten.Stencil\nusing CairoMakie\n\nfunction plot_boundary_types()\n    n = 16\n    y0 = zeros(Float64, n, n)\n    y0[1, 1] = 1\n    y0[n, n] = 2\n    x = collect(-2:0.25:2)\n    k = exp.(-(x.^2 .+ x'.^2))\n    k ./= sum(k)\n\n    y_periodic = Array{Float64}(undef, n, n)\n    convolution(Periodic{2}, k)(y0, y_periodic)\n    y_reflected = Array{Float64}(undef, n, n)\n    convolution(Reflected{2}, k)(y0, y_reflected)\n    y_constant = Array{Float64}(undef, n, n)\n    convolution(Constant{2, 0.1}, k)(y0, y_constant)\n\n    fig = Figure(size=(900, 300))\n    for (i, y) in enumerate([y_periodic, y_reflected, y_constant])\n        ax = Axis(fig[1,i]; aspect=1)\n        heatmap!(ax, y; colormap=:viridis)\n    end\n    save(\"docs/src/_fig/boundary_types.png\", fig)\nend\nend \n\nScript.plot_boundary_types()","category":"page"},{"location":"stencils/#Tests","page":"Stencils","title":"Tests","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>test/StencilSpec.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"@testset \"CarboKitten.Stencil\" begin\n\nusing StaticArrays\nusing CarboKitten\nusing CarboKitten.Stencil: stencil!\n\nlet a = ones(Float64, 10, 10),\n    b = zeros(Float64, 10, 10)\n\n    stencil!(Periodic{2}, Size(3, 3), b, a) do a\n        sum(a)\n    end\n\n    @test all(b .== 9)\nend\n\nend","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"","category":"page"},{"location":"boxes/#Generic-Parameters","page":"Boxes","title":"Generic Parameters","text":"","category":"section"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Config.jl</i></div>","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"module Config\n\nexport TimeProperties\n\nusing ..BoundaryTrait\nusing ..Vectors\n\nusing ..Boxes: Box, axes\nexport Box, axes\n\nusing Unitful\nusing Unitful.DefaultSymbols\nusing ..CarboKitten: TimeProperties\n\n<<config-types>>\n\nend","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"Physical parameters of CarboKitten all should have units, see our refresher on Unitful.jl.","category":"page"},{"location":"boxes/#Time-properties","page":"Boxes","title":"Time properties","text":"","category":"section"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"Time stepping is specified in TimeProperties. We'll have time_steps number of time steps, each of physical time Δt. However, only one in write_interval steps is written to disk.","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡config-types⪢≣</div>","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"","category":"page"},{"location":"boxes/#Vectors","page":"Boxes","title":"Vectors","text":"","category":"section"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"To trace the position of particles we define a NamedTuple with x and y members and define common vector operations on those.","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Vectors.jl</i></div>","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"module Vectors\n\nexport Vec2\n\nVec2 = @NamedTuple{x::Float64, y::Float64}\nBase.:+(a::Vec2, b::Vec2) = (x=a.x+b.x, y=a.y+b.y)\nBase.abs2(a::Vec2) = a.x^2 + a.y^2\nBase.abs(a::Vec2) = √(abs2(a))\nBase.:*(a::Vec2, b::Float64) = (x=a.x*b, y=a.y*b)\nBase.:/(a::Vec2, b::Float64) = (x=a.x/b, y=a.y/b)\nBase.:*(a::Float64, b::Vec2) = b*a\nBase.:-(a::Vec2, b::Vec2) = (x=a.x-b.x, y=a.y-b.y)\nBase.:-(a::Vec2) = (x=-a.x, y=-a.y)\nBase.zero(::Type{Vec2}) = (x=0.0, y=0.0)\n\nend","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"","category":"page"},{"location":"ca-with-production/#CA-with-production","page":"Model with CA and Production","title":"CA with production","text":"","category":"section"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"This model combines BS92 production with the B13 cellular automaton. This production model is implemented in the CAProduction component.","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"(Image: Stratigraphy, production and subsidence under oscillating sea level.)","category":"page"},{"location":"ca-with-production/#Complete-example","page":"Model with CA and Production","title":"Complete example","text":"","category":"section"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"This example is running for 10000 steps to 1Myr on a 100 times 50 grid, starting with a sloped height down to 50m. The sea_level, and initial_depth arguments are functions. The phys_scale argument translate pixels on the grid into physical metres. The write_interval indicates to write output every 10 iterations, summing the production over that range.","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"noweb-label\">file:<i>examples/model/cap/run.jl</i></div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"#| creates: data/output/cap1.h5\n#| requires: src/Models/CAP.jl\n\nmodule Script\n\nusing CarboKitten\n\nconst PERIOD = 200.0u\"kyr\"\nconst AMPLITUDE = 4.0u\"m\"\n\nconst FACIES = [\n\t    CAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate = 500u\"m/Myr\",\n        extinction_coefficient = 0.8u\"m^-1\",\n        saturation_intensity = 60u\"W/m^2\"),\n\n\t    CAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate = 400u\"m/Myr\",\n        extinction_coefficient = 0.1u\"m^-1\",\n        saturation_intensity = 60u\"W/m^2\"),\n\n\t    CAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate = 100u\"m/Myr\",\n        extinction_coefficient = 0.005u\"m^-1\",\n        saturation_intensity = 60u\"W/m^2\")\n\t]\n\n\tconst INPUT = CAP.Input(\n\t\ttag = \"cap1\",\n\t\tbox = Box{Coast}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n\t\ttime = TimeProperties(\n\t\t\tΔt = 200.0u\"yr\",\n\t\t\tsteps = 5000,\n\t\t\twrite_interval = 10),\n\t\tsea_level = t -> 4.0u\"m\" * sin(2π * t / 0.2u\"Myr\"),\n\t\tinitial_topography = (x, y) -> - x / 300.0,\n\t\tsubsidence_rate = 50.0u\"m/Myr\",\n\t\tinsolation = 400.0u\"W/m^2\",\n\t\tfacies = FACIES)\n\n\tmain() = run_model(Model{CAP}, INPUT, \"data/output/cap1.h5\")\nend\n\nScript.main()","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"This writes output to an HDF5 file that you may use for further analysis and visualization.","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"noweb-label\">file:<i>examples/model/cap/plot.jl</i></div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"#| creates: docs/src/_fig/cap1-summary.png\n#| requires: data/output/cap1.h5\n#| collect: figures\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/cap1-summary.png\", summary_plot(\"data/output/cap1.h5\"))","category":"page"},{"location":"ca-with-production/#Implementation","page":"Model with CA and Production","title":"Implementation","text":"","category":"section"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"781pt\" height=\"599pt\"\n viewBox=\"0.00 0.00 780.50 599.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 595)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-595 776.5,-595 776.5,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M541,-591C541,-591 403,-591 403,-591 397,-591 391,-585 391,-579 391,-579 391,-524 391,-524 391,-518 397,-512 403,-512 403,-512 541,-512 541,-512 547,-512 553,-518 553,-524 553,-524 553,-579 553,-579 553,-585 547,-591 541,-591\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-560.5 546,-560.5 \"/>\n<text text-anchor=\"start\" x=\"448.5\" y=\"-569.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"398,-537.5 398,-560.5 445,-560.5 445,-537.5 398,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-537.5 445,-537.5 445,-560.5 398,-560.5 \"/>\n<text text-anchor=\"start\" x=\"402\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"445,-537.5 445,-560.5 499,-560.5 499,-537.5 445,-537.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"445,-537.5 445,-560.5 499,-560.5 499,-537.5 445,-537.5\"/>\n<text text-anchor=\"start\" x=\"449\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"499,-537.5 499,-560.5 546,-560.5 546,-537.5 499,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"546,-560.5 499,-560.5 499,-537.5 546,-537.5 \"/>\n<text text-anchor=\"start\" x=\"503\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"445,-518.5 445,-537.5 \"/>\n<text text-anchor=\"start\" x=\"402\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"499,-518.5 499,-537.5 \"/>\n<text text-anchor=\"start\" x=\"449\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"502\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node7\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M337,-476C337,-476 79,-476 79,-476 73,-476 67,-470 67,-464 67,-464 67,-371 67,-371 67,-365 73,-359 79,-359 79,-359 337,-359 337,-359 343,-359 349,-365 349,-371 349,-371 349,-464 349,-464 349,-470 343,-476 337,-476\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"74,-445.5 342,-445.5 \"/>\n<text text-anchor=\"start\" x=\"160.5\" y=\"-454.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"74,-422.5 74,-445.5 191,-445.5 191,-422.5 74,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"74,-422.5 191,-422.5 191,-445.5 74,-445.5 \"/>\n<text text-anchor=\"start\" x=\"78\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"191,-422.5 191,-445.5 245,-445.5 245,-422.5 191,-422.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"191,-422.5 191,-445.5 245,-445.5 245,-422.5 191,-422.5\"/>\n<text text-anchor=\"start\" x=\"195\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"245,-422.5 245,-445.5 342,-445.5 342,-422.5 245,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"342,-445.5 245,-445.5 245,-422.5 342,-422.5 \"/>\n<text text-anchor=\"start\" x=\"249\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"191,-403.5 191,-422.5 \"/>\n<text text-anchor=\"start\" x=\"78\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"245,-403.5 245,-422.5 \"/>\n<text text-anchor=\"start\" x=\"195\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"248\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"191,-384.5 191,-403.5 \"/>\n<text text-anchor=\"start\" x=\"78\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"245,-384.5 245,-403.5 \"/>\n<text text-anchor=\"start\" x=\"195\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"248\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"191,-365.5 191,-384.5 \"/>\n<text text-anchor=\"start\" x=\"78\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"245,-365.5 245,-384.5 \"/>\n<text text-anchor=\"start\" x=\"195\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"248\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge5\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M394.93,-511.97C375.35,-502.18 353.82,-491.41 332.54,-480.77\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"333.95,-477.56 323.44,-476.22 330.82,-483.82 333.95,-477.56\"/>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node9\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M760.5,-304C760.5,-304 499.5,-304 499.5,-304 493.5,-304 487.5,-298 487.5,-292 487.5,-292 487.5,-218 487.5,-218 487.5,-212 493.5,-206 499.5,-206 499.5,-206 760.5,-206 760.5,-206 766.5,-206 772.5,-212 772.5,-218 772.5,-218 772.5,-292 772.5,-292 772.5,-298 766.5,-304 760.5,-304\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"495,-274 766,-274 \"/>\n<text text-anchor=\"start\" x=\"555\" y=\"-282.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"495,-251 495,-274 588,-274 588,-251 495,-251\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"495,-251 588,-251 588,-274 495,-274 \"/>\n<text text-anchor=\"start\" x=\"499\" y=\"-258.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"588,-251 588,-274 693,-274 693,-251 588,-251\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"588,-251 588,-274 693,-274 693,-251 588,-251\"/>\n<text text-anchor=\"start\" x=\"592\" y=\"-258.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"693,-251 693,-274 766,-274 766,-251 693,-251\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"766,-274 693,-274 693,-251 766,-251 \"/>\n<text text-anchor=\"start\" x=\"697\" y=\"-258.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"588,-232 588,-251 \"/>\n<text text-anchor=\"start\" x=\"499\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"693,-232 693,-251 \"/>\n<text text-anchor=\"start\" x=\"592\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"696\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"588,-213 588,-232 \"/>\n<text text-anchor=\"start\" x=\"499\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"693,-213 693,-232 \"/>\n<text text-anchor=\"start\" x=\"592\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"696\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge12\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M510.55,-511.84C520.29,-500.83 530.19,-488.44 538,-476 570.36,-424.44 595.9,-359.53 611.78,-313.62\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"615.1,-314.71 615.02,-304.12 608.48,-312.45 615.1,-314.71\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M277,-591C277,-591 139,-591 139,-591 133,-591 127,-585 127,-579 127,-579 127,-524 127,-524 127,-518 133,-512 139,-512 139,-512 277,-512 277,-512 283,-512 289,-518 289,-524 289,-524 289,-579 289,-579 289,-585 283,-591 277,-591\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"134,-560.5 282,-560.5 \"/>\n<text text-anchor=\"start\" x=\"142.5\" y=\"-569.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"134,-537.5 134,-560.5 181,-560.5 181,-537.5 134,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"134,-537.5 181,-537.5 181,-560.5 134,-560.5 \"/>\n<text text-anchor=\"start\" x=\"138\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"181,-537.5 181,-560.5 235,-560.5 235,-537.5 181,-537.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"181,-537.5 181,-560.5 235,-560.5 235,-537.5 181,-537.5\"/>\n<text text-anchor=\"start\" x=\"185\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"235,-537.5 235,-560.5 282,-560.5 282,-537.5 235,-537.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"282,-560.5 235,-560.5 235,-537.5 282,-537.5 \"/>\n<text text-anchor=\"start\" x=\"239\" y=\"-545.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"181,-518.5 181,-537.5 \"/>\n<text text-anchor=\"start\" x=\"138\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"235,-518.5 235,-537.5 \"/>\n<text text-anchor=\"start\" x=\"185\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"238\" y=\"-525.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge4\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M208,-511.97C208,-503.98 208,-495.34 208,-486.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"211.5,-486.47 208,-476.47 204.5,-486.47 211.5,-486.47\"/>\n</g>\n<!-- CAP -->\n<g id=\"node3\" class=\"node\">\n<title>CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M205,-36C205,-36 175,-36 175,-36 169,-36 163,-30 163,-24 163,-24 163,-12 163,-12 163,-6 169,0 175,0 175,0 205,0 205,0 211,0 217,-6 217,-12 217,-12 217,-24 217,-24 217,-30 211,-36 205,-36\"/>\n<text text-anchor=\"start\" x=\"173.5\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAP</text>\n</g>\n<!-- Tag -->\n<g id=\"node4\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-151C150,-151 12,-151 12,-151 6,-151 0,-145 0,-139 0,-139 0,-84 0,-84 0,-78 6,-72 12,-72 12,-72 150,-72 150,-72 156,-72 162,-78 162,-84 162,-84 162,-139 162,-139 162,-145 156,-151 150,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-120.5 155,-120.5 \"/>\n<text text-anchor=\"start\" x=\"67\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-97.5 7,-120.5 54,-120.5 54,-97.5 7,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-97.5 54,-97.5 54,-120.5 7,-120.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-97.5 108,-120.5 155,-120.5 155,-97.5 108,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-120.5 108,-120.5 108,-97.5 155,-97.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-78.5 54,-97.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-78.5 108,-97.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Tag&#45;&gt;CAP -->\n<g id=\"edge1\" class=\"edge\">\n<title>Tag&#45;&gt;CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M126.91,-71.96C138.78,-62 151.21,-51.57 161.86,-42.62\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"164.22,-45.21 169.63,-36.1 159.72,-39.85 164.22,-45.21\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node5\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M168.5,-273C168.5,-273 103.5,-273 103.5,-273 97.5,-273 91.5,-267 91.5,-261 91.5,-261 91.5,-249 91.5,-249 91.5,-243 97.5,-237 103.5,-237 103.5,-237 168.5,-237 168.5,-237 174.5,-237 180.5,-243 180.5,-249 180.5,-249 180.5,-261 180.5,-261 180.5,-267 174.5,-273 168.5,-273\"/>\n<text text-anchor=\"start\" x=\"98.5\" y=\"-252.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n</g>\n<!-- H5Writer&#45;&gt;CAP -->\n<g id=\"edge2\" class=\"edge\">\n<title>H5Writer&#45;&gt;CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M142.94,-236.79C150.84,-216.57 163.6,-181.85 171,-151 179.54,-115.38 184.78,-73.37 187.54,-46.48\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"191.05,-46.57 188.54,-36.28 184.08,-45.89 191.05,-46.57\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node6\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M517,-457C517,-457 379,-457 379,-457 373,-457 367,-451 367,-445 367,-445 367,-390 367,-390 367,-384 373,-378 379,-378 379,-378 517,-378 517,-378 523,-378 529,-384 529,-390 529,-390 529,-445 529,-445 529,-451 523,-457 517,-457\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"374,-426.5 522,-426.5 \"/>\n<text text-anchor=\"start\" x=\"404\" y=\"-435.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"374,-403.5 374,-426.5 421,-426.5 421,-403.5 374,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"374,-403.5 421,-403.5 421,-426.5 374,-426.5 \"/>\n<text text-anchor=\"start\" x=\"378\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"421,-403.5 421,-426.5 475,-426.5 475,-403.5 421,-403.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"421,-403.5 421,-426.5 475,-426.5 475,-403.5 421,-403.5\"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"475,-403.5 475,-426.5 522,-426.5 522,-403.5 475,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"522,-426.5 475,-426.5 475,-403.5 522,-403.5 \"/>\n<text text-anchor=\"start\" x=\"479\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"421,-384.5 421,-403.5 \"/>\n<text text-anchor=\"start\" x=\"378\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"475,-384.5 475,-403.5 \"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"478\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge6\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M394.5,-377.94C382.87,-370.83 370.35,-364.07 358,-359 286.95,-329.86 254.24,-363.51 189,-323 172.88,-312.99 159.63,-296.24 150.41,-282\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"153.16,-279.79 144.95,-273.1 147.19,-283.45 153.16,-279.79\"/>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge13\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M492.06,-377.65C514.75,-357.64 542.8,-332.9 567.67,-310.97\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"570.09,-313.5 575.28,-304.26 565.46,-308.25 570.09,-313.5\"/>\n</g>\n<!-- Production -->\n<g id=\"node10\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M457.5,-323C457.5,-323 210.5,-323 210.5,-323 204.5,-323 198.5,-317 198.5,-311 198.5,-311 198.5,-199 198.5,-199 198.5,-193 204.5,-187 210.5,-187 210.5,-187 457.5,-187 457.5,-187 463.5,-187 469.5,-193 469.5,-199 469.5,-199 469.5,-311 469.5,-311 469.5,-317 463.5,-323 457.5,-323\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"206,-293 463,-293 \"/>\n<text text-anchor=\"start\" x=\"290.5\" y=\"-301.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"206,-270 206,-293 275,-293 275,-270 206,-270\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"206,-270 275,-270 275,-293 206,-293 \"/>\n<text text-anchor=\"start\" x=\"210\" y=\"-277.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"275,-270 275,-293 416,-293 416,-270 275,-270\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"275,-270 275,-293 416,-293 416,-270 275,-270\"/>\n<text text-anchor=\"start\" x=\"279\" y=\"-277.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"416,-270 416,-293 463,-293 463,-270 416,-270\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"463,-293 416,-293 416,-270 463,-270 \"/>\n<text text-anchor=\"start\" x=\"420\" y=\"-277.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-251 275,-270 \"/>\n<text text-anchor=\"start\" x=\"210\" y=\"-258\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"416,-251 416,-270 \"/>\n<text text-anchor=\"start\" x=\"279\" y=\"-258\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"419\" y=\"-258\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-232 275,-251 \"/>\n<text text-anchor=\"start\" x=\"210\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"416,-232 416,-251 \"/>\n<text text-anchor=\"start\" x=\"279\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"419\" y=\"-239\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-213 275,-232 \"/>\n<text text-anchor=\"start\" x=\"210\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"416,-213 416,-232 \"/>\n<text text-anchor=\"start\" x=\"279\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"419\" y=\"-220\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-194 275,-213 \"/>\n<text text-anchor=\"start\" x=\"210\" y=\"-201\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"416,-194 416,-213 \"/>\n<text text-anchor=\"start\" x=\"279\" y=\"-201\" font-family=\"monospace\" font-size=\"10.00\">production_offset</text>\n<text text-anchor=\"start\" x=\"419\" y=\"-201\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge9\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M420.4,-377.65C410.53,-363.74 399.03,-347.56 387.71,-331.61\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"390.45,-329.44 381.81,-323.31 384.75,-333.49 390.45,-329.44\"/>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge7\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M182.01,-358.56C170.38,-332.63 157.23,-303.33 147.98,-282.7\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"151.06,-281.02 143.77,-273.33 144.67,-283.89 151.06,-281.02\"/>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge8\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M253.49,-358.56C260.47,-349.67 267.76,-340.38 274.98,-331.18\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"277.87,-333.16 281.29,-323.14 272.37,-328.84 277.87,-333.16\"/>\n</g>\n<!-- CAProduction -->\n<g id=\"node8\" class=\"node\">\n<title>CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M383.5,-129.5C383.5,-129.5 284.5,-129.5 284.5,-129.5 278.5,-129.5 272.5,-123.5 272.5,-117.5 272.5,-117.5 272.5,-105.5 272.5,-105.5 272.5,-99.5 278.5,-93.5 284.5,-93.5 284.5,-93.5 383.5,-93.5 383.5,-93.5 389.5,-93.5 395.5,-99.5 395.5,-105.5 395.5,-105.5 395.5,-117.5 395.5,-117.5 395.5,-123.5 389.5,-129.5 383.5,-129.5\"/>\n<text text-anchor=\"start\" x=\"279.5\" y=\"-108.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAProduction</text>\n</g>\n<!-- CAProduction&#45;&gt;CAP -->\n<g id=\"edge3\" class=\"edge\">\n<title>CAProduction&#45;&gt;CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M306.91,-93.29C283.89,-78.66 250.65,-57.54 225.49,-41.55\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"227.28,-38.54 216.96,-36.13 223.53,-44.45 227.28,-38.54\"/>\n</g>\n<!-- CellularAutomaton&#45;&gt;CAProduction -->\n<g id=\"edge10\" class=\"edge\">\n<title>CellularAutomaton&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M529.37,-205.9C478.33,-181.49 418.87,-153.07 379.08,-134.05\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"380.43,-130.82 369.9,-129.66 377.42,-137.13 380.43,-130.82\"/>\n</g>\n<!-- Production&#45;&gt;CAProduction -->\n<g id=\"edge11\" class=\"edge\">\n<title>Production&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M334,-186.98C334,-170.18 334,-153.11 334,-139.55\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"337.5,-139.5 334,-129.5 330.5,-139.5 337.5,-139.5\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"noweb-label\">file:<i>src/Models/CAP.jl</i></div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"@compose module CAP\n@mixin Tag, H5Writer, CAProduction\n\nusing ..Common\nusing ..CAProduction: production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    ca_state = CellularAutomaton.initial_state(input)\n    for _ in 1:20\n        CellularAutomaton.step!(input)(ca_state)\n    end\n\n    sediment_height = zeros(Height, input.box.grid_size...)\n    return State(\n        step=0, sediment_height=sediment_height,\n        ca=ca_state.ca, ca_priority=ca_state.ca_priority)\nend\n\nfunction step!(input::Input)\n    τ = production(input)\n    step_ca = CellularAutomaton.step!(input)\n\n    function (state::State)\n        if mod(state.step, input.ca_interval) == 0\n            step_ca(state)\n        end\n\n        prod = τ(state)\n        Δη = sum(prod; dims=1)[1, :, :]\n        state.sediment_height .+= Δη\n        state.step += 1\n\n        return Frame(\n            production = prod,\n            deposition = prod)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\nend","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"","category":"page"},{"location":"components/sediment_buffer/#Sediment-Buffers","page":"Sediment Buffers","title":"Sediment Buffers","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"320pt\" height=\"221pt\"\n viewBox=\"0.00 0.00 320.00 221.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 217)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-217 316,-217 316,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M225,-213C225,-213 87,-213 87,-213 81,-213 75,-207 75,-201 75,-201 75,-146 75,-146 75,-140 81,-134 87,-134 87,-134 225,-134 225,-134 231,-134 237,-140 237,-146 237,-146 237,-201 237,-201 237,-207 231,-213 225,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"82,-182.5 230,-182.5 \"/>\n<text text-anchor=\"start\" x=\"132.5\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"82,-159.5 82,-182.5 129,-182.5 129,-159.5 82,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"82,-159.5 129,-159.5 129,-182.5 82,-182.5 \"/>\n<text text-anchor=\"start\" x=\"86\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"129,-159.5 129,-182.5 183,-182.5 183,-159.5 129,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"129,-159.5 129,-182.5 183,-182.5 183,-159.5 129,-159.5\"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"183,-159.5 183,-182.5 230,-182.5 230,-159.5 183,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"230,-182.5 183,-182.5 183,-159.5 230,-159.5 \"/>\n<text text-anchor=\"start\" x=\"187\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"129,-140.5 129,-159.5 \"/>\n<text text-anchor=\"start\" x=\"86\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"183,-140.5 183,-159.5 \"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"186\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- SedimentBuffer -->\n<g id=\"node2\" class=\"node\">\n<title>SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-98C300,-98 12,-98 12,-98 6,-98 0,-92 0,-86 0,-86 0,-12 0,-12 0,-6 6,0 12,0 12,0 300,0 300,0 306,0 312,-6 312,-12 312,-12 312,-86 312,-86 312,-92 306,-98 300,-98\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-68 305,-68 \"/>\n<text text-anchor=\"start\" x=\"93\" y=\"-76.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">SedimentBuffer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-45 7,-68 154,-68 154,-45 7,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-45 154,-45 154,-68 7,-68 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-45 154,-68 208,-68 208,-45 154,-45\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-45 154,-68 208,-68 208,-45 154,-45\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-45 208,-68 305,-68 305,-45 208,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-68 208,-68 208,-45 305,-45 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-26 154,-45 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer_size</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-26 208,-45 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-7 154,-26 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">depositional_resolution</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-7 208,-26 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;SedimentBuffer -->\n<g id=\"edge1\" class=\"edge\">\n<title>Boxes&#45;&gt;SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M156,-133.74C156,-125.68 156,-117.01 156,-108.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"159.5,-108.42 156,-98.42 152.5,-108.42 159.5,-108.42\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"For our models of transport and denudation it is important to remember the facies of the sediment for some time into the past. One way to do this, is to remember all contributions of sediment in a stack. Every time we transport or erode sediment, we can pop parcels from this stack. In a three-dimensional model, we need a 2d grid of stacks. Each stack would have its own memory management (which is computationally expensive), and most resources are spent on areas with very little accretion. (In fact, this is what CarboCAT does. We believe this design choice is the main contributor to the difference in run-time between CarboCAT and CarboKitten).","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Instead, we choose a fixed size sediment buffer. Each cell in the buffer represents a parcel of sediment, where we store the relative fractions of each contributing facies. This buffer is only used to determine the facies of disintegrated sediment. The output of the overal model is still the amount of sediment for each iteration.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We can't stress this enough: any inaccuracy in using a fixed size buffer with a chosen granularity only impacts the precision of the composition of transported sediment. Even then, the schema is conservative: no sediment is lost unless erosion is so rampant that it eats through the entire sediment stack. In that case, a simulation should be run with a larger buffer.","category":"page"},{"location":"components/sediment_buffer/#Data-structure","page":"Sediment Buffers","title":"Data structure","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"While the sediment buffer is allocated as a single 4-dimensional array (depth, facies, x, y), it is best to explain its functioning from the perspective of a single cell in our model. We are left with two dimensions: depth (rows) and facies (columns).","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We choose to have the head of our sediment stack always be at the first row. When sediment out-grows the buffer, the deepenst layers are dropped from memory. The head can contain an incomplete amount of sediment, while all rows below the head are either full or empty. When sediment is pushed to the stack and the head row overflows, all rows are copied down one row and the surplus is assigned to the now empty head row. The inverse happens when removing (popping) material from the stack (in computer science stacks are pushed on and popped from). This process is illustrated below.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"(Image: sediment buffer diagram)","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Above we see a buffer. First we push a parcel of size 34, then we pop an amount of 12. This popped parcel will have different fractions from the pushed one, since it also draws from the half filled row that was in the stack before pushing. In this sense, a small amount of facies mixing will take place, depending on the depositional resolution chosen.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Our implementation is such that each cell in the buffer is contiguous in memory. Thus, copying rows of unstrided memory should be very efficient, although the performance remains to be tested.","category":"page"},{"location":"components/sediment_buffer/#Implementation","page":"Sediment Buffers","title":"Implementation","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We define two functions push_sediment! and pop_sediment!. Given a s times n matrix, where n is the number of facies types and s is the depth of the stack, we can grow and shrink sediment. These functions are unit-free, setting Delta z to be equal to 1.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">file:<i>test/SedimentStackSpec.jl</i></div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"@testset \"SedimentStack\" begin\n  using CarboKitten.SedimentStack: push_sediment!, pop_sediment!\n  stack = zeros(Float64, 10, 3)\n  @test pop_sediment!(stack, 0.0) == [0.0, 0.0, 0.0]\n  push_sediment!(stack, [5.0, 0, 0])\n  @test pop_sediment!(stack, 1.5) == [1.5, 0.0, 0.0]\n  push_sediment!(stack, [0.0, 2.0, 0.0])   # (0 0.5) (0 1) (0.5 0.5) (1 0) ...\n  @test pop_sediment!(stack, 2.0) == [0.25, 1.75, 0.0]\n  @test pop_sediment!(stack, 1.5) == [1.25, 0.25, 0.0]\n  @test pop_sediment!(stack, 0.0) == [0.0, 0.0, 0.0]\nend\n\n@testset \"SedimentArray\" begin\n  using CarboKitten.SedimentStack: push_sediment!, peek_sediment\n  sediment = zeros(Float64, 10, 3, 5, 5)\n  for x in 1:10\n    production = rand(3, 5, 5)\n    push_sediment!(sediment, production)\n  end\n  a = peek_sediment(sediment, 1.0)\n  @test all(sum(a; dims=1) .≈ 1.0)\nend","category":"page"},{"location":"components/sediment_buffer/#Pushing-sediment","page":"Sediment Buffers","title":"Pushing sediment","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"The single-cell version of push_sediment! takes as argument col a column (physically speaking a column of sediment) represented by a s times n-matrix and a parcel a n-vector.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡sediment-stack-impl⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"function push_sediment!(col::AbstractMatrix{F}, parcel::AbstractVector{F}) where F <: Real\n    <<push-sediment>>\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"First we determine the total sediment amount Delta, being the sum of the parcel, as well as the amount of sediment in our bucket, the head row.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"mass = sum(parcel)\nbucket = sum(col[1, :])\n@assert bucket >= 0.0 && bucket <= 1.0","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"If the bucket has enough space left for the parcel, we can just add the parcel to the bucket and return.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"if bucket + mass < 1.0\n    col[1,:] .+= parcel\n    return\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Otherwise, we compute the normalized fractions frac of facies in the parcel. We add as much sediment as we can to fill the bucket and copy rows down as far as needed.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"frac = parcel ./ mass\ncol[1,:] .+= frac .* (1.0 - bucket)\nmass -= (1.0 - bucket)\nn = floor(Int64, mass)\n\nif n > size(col)[1] ÷ 2\n    @warn \"pushing a too large parcel of sediment: Δ = $mass, reduce your timestep\"\nend\nif n > size(col)[1] - 2\n    @error \"pushing a way too large parcel of sediment: Δ = $mass, parcel = $parcel\"\n    error(\"fatal error, too much sediment for buffer\")\nend\ncol[n+2:end,:] .= col[1:end-n-1,:]","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"If the parcel has enough material left to fill more rows, those are all filled with the fractions in frac. The head row is assigned whatever is left.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"na = [CartesianIndex()]\ncol[2:n+1,:] .= frac[na,:]\nmass -= n\ncol[1,:] .= frac .* mass","category":"page"},{"location":"components/sediment_buffer/#Popping-sediment","page":"Sediment Buffers","title":"Popping sediment","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Similar to push_sediment! we have pop_sediment!. We give pop_sediment! the sedimentary column col and the total amount of sediment we require. There is a bit that we will reuse called pop_fraction, which only works if the amount of popped sediment is lower than the contents of the bucket.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡sediment-stack-impl⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"@inline function pop_fraction(col::AbstractMatrix{F}, mass::F) where F <: Real\n    bucket = sum(col[1,:])\n    if mass == 0 || bucket == 0\n        return zeros(F, size(col)[2])\n    end\n\n    @assert mass < bucket \"pop_fraction can only pop from the top cell: $(col), $(Δ)\"\n    parcel = (mass / bucket) .* col[1,:]\n    col[1,:] .-= parcel\n    return parcel\nend\n\nfunction pop_sediment!(col::AbstractMatrix{F}, Δ::F) where F <: Real  # -> Vector{F}\n    <<pop-sediment>>\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We start by computing the bucket size again. If it is greater than the required amount, we call pop_fraction.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡pop-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"bucket = sum(col[1,:])\n@assert bucket >= 0.0\n\nif Δ < bucket\n  return pop_fraction(col, Δ)\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Otherwise, we start a parcel with the contents of the bucket. Add to that the remaining material in rows below. Now we copy rows from below, setting the bottom n rows to 0. The last step is to call pop_fraction one more time with the remaining required amount.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡pop-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"parcel = copy(col[1,:])\nΔ -= bucket\nn = floor(Int64, Δ)\n\nif n > (size(col)[1] - 2)\n    @error \"too much material popped of the stack: Δ = $Δ\"\n    parcel .+= sum(col; dims=1)'\n    col .= 0.0\n    return parcel\nend\n\nparcel .+= sum(col[2:n+1,:]; dims=1)'\ncol[1:end-n-1, :] = col[n+2:end, :]\ncol[end-n-1:end, :] .= 0\nΔ -= n\n\nparcel .+= pop_fraction(col, Δ)\nreturn parcel","category":"page"},{"location":"components/sediment_buffer/#Peeking","page":"Sediment Buffers","title":"Peeking","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Instead of popping sediment, we can also peek at the stack with peek_sediment!, which is a non-destructive way to inspect what the returned parcel would be if we were to call pop_sediment! with the same arguments.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<details><summary>SedimentStack impl</summary>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">file:<i>src/SedimentStack.jl</i></div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"module SedimentStack\n\nexport push_sediment!, pop_sediment!, peek_sediment\n\n<<sediment-stack-impl>>\n\nfunction push_sediment!(sediment::AbstractArray{F, 4}, p::AbstractArray{F, 3}) where F <: Real\n  _, x, y = size(p)\n  @views for i in CartesianIndices((x, y))\n    push_sediment!(sediment[:, :, i[1], i[2]], p[:, i[1], i[2]])\n  end\nend\n\nfunction peek_sediment(col::AbstractMatrix{F}, Δ::F) where F <: Real  # -> Vector{F}\n  if Δ == 0\n      return zeros(F, size(col)[2])\n  end\n\n  bucket = sum(col[1,:])\n  if Δ < bucket\n    parcel = (Δ / bucket) .* col[1,:]\n    return parcel\n  end\n\n  parcel = copy(col[1,:])\n  Δ -= bucket\n  n = floor(Int64, Δ)\n\n  parcel .+= sum(col[2:n+1,:]; dims=1)'\n  Δ -= n\n\n  last_bit = (Δ / sum(col[n+2,:])) .* col[n+2,:]\n  parcel .+= last_bit\n\n  return parcel\nend\n\nfunction peek_sediment(sediment::AbstractArray{F,4}, Δ::F) where F <: Real\n  _, f, x, y = size(sediment)\n  out = Array{F, 3}(undef, f, x, y)\n  for i in CartesianIndices((x, y))\n    out[:, i[1], i[2]] = peek_sediment(@view(sediment[:, :, i[1], i[2]]), Δ)\n  end\n  return out\nend\n\nfunction pop_sediment!(cols::AbstractArray{F, 4}, amount::AbstractArray{F, 2}, out::AbstractArray{F, 3}) where F <: Real\n  @views for i in CartesianIndices(amount)\n      out[:, i[1], i[2]] = pop_sediment!(cols[:, :, i[1], i[2]], amount[i[1], i[2]])\n  end\nend\n\nend # module","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"</details>","category":"page"},{"location":"components/sediment_buffer/#Component","page":"Sediment Buffers","title":"Component","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">file:<i>src/Components/SedimentBuffer.jl</i></div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"@compose module SedimentBuffer\n@mixin Boxes\n\nusing ..Common\nusing CarboKitten.SedimentStack: pop_sediment!, push_sediment!, peek_sediment\n\nexport pop_sediment!, push_sediment!, peek_sediment\n\n@kwdef struct Input <: AbstractInput\n    sediment_buffer_size::Int = 50\n    depositional_resolution::Amount = 0.5u\"m\"\nend\n\n@kwdef mutable struct State <: AbstractState\n    sediment_buffer::Array{Float64,4}\nend\n\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"","category":"page"},{"location":"components/hdf5/#HDF5-Output","page":"HDF5 Writer","title":"HDF5 Output","text":"","category":"section"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"500pt\" height=\"312pt\"\n viewBox=\"0.00 0.00 500.00 312.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 308)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-308 496,-308 496,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-304C150,-304 12,-304 12,-304 6,-304 0,-298 0,-292 0,-292 0,-237 0,-237 0,-231 6,-225 12,-225 12,-225 150,-225 150,-225 156,-225 162,-231 162,-237 162,-237 162,-292 162,-292 162,-298 156,-304 150,-304\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-273.5 155,-273.5 \"/>\n<text text-anchor=\"start\" x=\"57.5\" y=\"-282.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-250.5 7,-273.5 54,-273.5 54,-250.5 7,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-250.5 54,-250.5 54,-273.5 7,-273.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-250.5 54,-273.5 108,-273.5 108,-250.5 54,-250.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-250.5 54,-273.5 108,-273.5 108,-250.5 54,-250.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-250.5 108,-273.5 155,-273.5 155,-250.5 108,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-273.5 108,-273.5 108,-250.5 155,-250.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-231.5 54,-250.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-231.5 108,-250.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-189C300,-189 42,-189 42,-189 36,-189 30,-183 30,-177 30,-177 30,-84 30,-84 30,-78 36,-72 42,-72 42,-72 300,-72 300,-72 306,-72 312,-78 312,-84 312,-84 312,-177 312,-177 312,-183 306,-189 300,-189\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-158.5 305,-158.5 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-167.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"37,-135.5 37,-158.5 154,-158.5 154,-135.5 37,-135.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-135.5 154,-135.5 154,-158.5 37,-158.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-135.5 154,-158.5 208,-158.5 208,-135.5 154,-135.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-135.5 154,-158.5 208,-158.5 208,-135.5 154,-135.5\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-135.5 208,-158.5 305,-158.5 305,-135.5 208,-135.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-158.5 208,-158.5 208,-135.5 305,-135.5 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-116.5 154,-135.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-116.5 208,-135.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-97.5 154,-116.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-97.5 208,-116.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-78.5 154,-97.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-78.5 208,-97.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M107.27,-224.97C113.07,-216.46 119.38,-207.21 125.69,-197.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"128.73,-199.7 131.48,-189.47 122.95,-195.76 128.73,-199.7\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-304C330,-304 192,-304 192,-304 186,-304 180,-298 180,-292 180,-292 180,-237 180,-237 180,-231 186,-225 192,-225 192,-225 330,-225 330,-225 336,-225 342,-231 342,-237 342,-237 342,-292 342,-292 342,-298 336,-304 330,-304\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-273.5 335,-273.5 \"/>\n<text text-anchor=\"start\" x=\"195.5\" y=\"-282.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-250.5 187,-273.5 234,-273.5 234,-250.5 187,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-250.5 234,-250.5 234,-273.5 187,-273.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-250.5 234,-273.5 288,-273.5 288,-250.5 234,-250.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-250.5 234,-273.5 288,-273.5 288,-250.5 234,-250.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-250.5 288,-273.5 335,-273.5 335,-250.5 288,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-273.5 288,-273.5 288,-250.5 335,-250.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-231.5 234,-250.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-231.5 288,-250.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M234.73,-224.97C228.93,-216.46 222.62,-207.21 216.31,-197.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"219.05,-195.76 210.52,-189.47 213.27,-199.7 219.05,-195.76\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node5\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M323.5,-36C323.5,-36 258.5,-36 258.5,-36 252.5,-36 246.5,-30 246.5,-24 246.5,-24 246.5,-12 246.5,-12 246.5,-6 252.5,0 258.5,0 258.5,0 323.5,0 323.5,0 329.5,0 335.5,-6 335.5,-12 335.5,-12 335.5,-24 335.5,-24 335.5,-30 329.5,-36 323.5,-36\"/>\n<text text-anchor=\"start\" x=\"253.5\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge4\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M233.46,-71.98C244.58,-61.74 255.59,-51.6 264.96,-42.98\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"267.42,-45.47 272.4,-36.12 262.68,-40.32 267.42,-45.47\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M480,-170C480,-170 342,-170 342,-170 336,-170 330,-164 330,-158 330,-158 330,-103 330,-103 330,-97 336,-91 342,-91 342,-91 480,-91 480,-91 486,-91 492,-97 492,-103 492,-103 492,-158 492,-158 492,-164 486,-170 480,-170\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-139.5 485,-139.5 \"/>\n<text text-anchor=\"start\" x=\"367\" y=\"-148.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"337,-116.5 337,-139.5 384,-139.5 384,-116.5 337,-116.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-116.5 384,-116.5 384,-139.5 337,-139.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"384,-116.5 384,-139.5 438,-139.5 438,-116.5 384,-116.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"384,-116.5 384,-139.5 438,-139.5 438,-116.5 384,-116.5\"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"438,-116.5 438,-139.5 485,-139.5 485,-116.5 438,-116.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"485,-139.5 438,-139.5 438,-116.5 485,-116.5 \"/>\n<text text-anchor=\"start\" x=\"442\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"384,-97.5 384,-116.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"438,-97.5 438,-116.5 \"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"441\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge3\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M369.03,-90.85C351.76,-74.95 332.3,-57.03 317.13,-43.06\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"319.35,-40.35 309.63,-36.15 314.61,-45.5 319.35,-40.35\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"We write output to HDF5.","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"<div class=\"noweb-label\">file:<i>src/Components/H5Writer.jl</i></div>","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"@compose module H5Writer\n    using ..Common\n    import ..Models: Frame\n\n    using HDF5\n\n    import ...CarboKitten: run_model, Model\n\n    @mixin Boxes, TimeIntegration, FaciesBase, WaterDepth\n\n    export run\n\n    function create_dataset(fid, input::AbstractInput)\n        nf = n_facies(input)\n        nw = n_writes(input)\n\n        HDF5.create_dataset(fid, \"production\", datatype(Float64),\n            dataspace(nf, input.box.grid_size..., nw),\n            chunk=(nf, input.box.grid_size..., 1), deflate=3)\n        HDF5.create_dataset(fid, \"disintegration\", datatype(Float64),\n            dataspace(nf, input.box.grid_size..., nw),\n            chunk=(nf, input.box.grid_size..., 1), deflate=3)\n        HDF5.create_dataset(fid, \"deposition\", datatype(Float64),\n            dataspace(nf, input.box.grid_size..., nw),\n            chunk=(nf, input.box.grid_size..., 1), deflate=3)\n        HDF5.create_dataset(fid, \"sediment_height\", datatype(Float64),\n            dataspace(input.box.grid_size..., nw + 1),\n            chunk=(input.box.grid_size..., 1), deflate=3)\n    end\n\n    function write_state(fid, idx::Int, state::AbstractState)\n        fid[\"sediment_height\"][:, :, idx] = state.sediment_height |> in_units_of(u\"m\")\n    end\n\n    function write_frame(fid, idx::Int, frame::Frame)\n        try_write(tgt, ::Nothing) = ()\n        try_write(tgt, src::AbstractArray) = tgt[:, :, :, idx] = (src |> in_units_of(u\"m\"))\n\n        try_write(fid[\"production\"],  frame.production)\n        try_write(fid[\"disintegration\"], frame.disintegration)\n        try_write(fid[\"deposition\"], frame.deposition)\n    end\n\n    \"\"\"\n        run_model(::Type{Model{M}}, input::AbstractInput, filename::AbstractString) where M\n\n    Run a model and write output to HDF5. Here `M` should be a model, i.e. a\n    module with `initial_state`, `step!` and `write_header` defined. Example:\n\n    ```julia\n    run_model(Model{ALCAP}, ALCAP.Example.INPUT, \"example.h5\")\n    ```\n    \"\"\"\n    function run_model(::Type{Model{M}}, input::AbstractInput, filename::AbstractString) where M        \n        state = M.initial_state(input)\n\n        h5open(filename, \"w\") do fid\n            create_group(fid, \"input\")\n            M.write_header(fid, input)\n\n            create_dataset(fid, input)\n            write_state(fid, 1, state)\n\n            run_model(Model{M}, input, state) do w, df \n                write_frame(fid, w, df)\n                write_state(fid, w+1, state)\n            end\n        end\n\n        return filename\n    end\nend","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"","category":"page"},{"location":"models/without-ca/#Model-without-CA","page":"Model without CA","title":"Model without CA","text":"","category":"section"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"The following model is similar to the ALCAP model, with the exception that production is not managed by the cellular automaton, rather each facies produces in all grid cells according to their own production curves.","category":"page"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"<div class=\"noweb-label\">file:<i>src/Models/WithoutCA.jl</i></div>","category":"page"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"@compose module WithoutCA\n@mixin Tag, H5Writer, Production, ActiveLayer\n\nusing ..Common\nusing ..Production: uniform_production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    sediment_height = zeros(Height, input.box.grid_size...)\n    sediment_buffer = zeros(Float64, input.sediment_buffer_size, n_facies(input), input.box.grid_size...)\n    return State(step=0, sediment_height=sediment_height, sediment_buffer=sediment_buffer)\nend\n\nfunction step!(input::Input)\n    disintegrate! = ActiveLayer.disintegrator(input)\n    transport! = ActiveLayer.transporter(input)\n    τ = uniform_production(input)\n    dt = input.time.Δt\n\n    function (state::State)\n        p = τ(state) .* dt\n        d = disintegrate!(state)\n\n        active_layer = p .+ d\n        transport!(state, active_layer)\n\n        push_sediment!(state.sediment_buffer, active_layer ./ input.depositional_resolution .|> NoUnits)\n        state.sediment_height .+= sum(active_layer; dims=1)[1,:,:]\n        state.step += 1\n\n        return Frame(\n            production = p,\n            disintegration = d,\n            deposition = active_layer)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\n\nend","category":"page"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"","category":"page"},{"location":"components/time/#Time","page":"Time","title":"Time","text":"","category":"section"},{"location":"components/time/","page":"Time","title":"Time","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"CarboKitten.Components.TimeIntegration.time","category":"page"},{"location":"components/time/#CarboKitten.Components.TimeIntegration.time","page":"Time","title":"CarboKitten.Components.TimeIntegration.time","text":"time(input, state)\n\nReturn the time given input and state.\n\n\n\n\n\n","category":"function"},{"location":"components/time/","page":"Time","title":"Time","text":"<div class=\"noweb-label\">file:<i>test/Components/TimeIntegrationSpec.jl</i></div>","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"module TimeIntegrationSpec\nusing Test\nusing CarboKitten.Components.Common\n\n@testset \"Components/TimeIntegration\" begin\n    using CarboKitten.Components.TimeIntegration: write_times, Input, State, time, n_writes\n\n    let input = Input(time=TimeProperties(\n        Δt = 0.2u\"Myr\", steps = 5))\n      @test write_times(input) |> collect == [0.0, 0.2, 0.4, 0.6, 0.8, 1.0] .* u\"Myr\"\n      @test time(input, State(4)) == 0.8u\"Myr\"\n      @test n_writes(input) == 5\n    end\n\n    let input = Input(time=TimeProperties(\n        Δt = 0.02u\"Myr\", steps = 50, write_interval = 10, t0 = -1.0u\"Myr\"))\n      @test write_times(input) |> collect == [-1.0, -0.8, -0.6, -0.4, -0.2, 0.0] .* u\"Myr\"\n      @test n_writes(input) == 5\n      @test time(input, State(25)) == -0.5u\"Myr\"\n    end\nend\nend","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"<div class=\"noweb-label\">file:<i>src/Components/TimeIntegration.jl</i></div>","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"@compose module TimeIntegration\nusing ..Common\nimport ...CarboKitten: time_axis, n_writes\n\nusing HDF5\nexport time, n_writes, time_axis\n\n@kwdef struct Input <: AbstractInput\n    time::TimeProperties\nend\n\n@kwdef mutable struct State <: AbstractState\n    step::Int\nend\n\nState(_::AbstractInput) = State(0)\n\n\"\"\"\n    time(input, state)\n\nReturn the time given input and state.\n\"\"\"\ntime(input::AbstractInput, state::AbstractState) = input.time.t0 + state.step * input.time.Δt\ntime(tprop::TimeProperties, state::AbstractState) = tprop.t0 + state.step * tprop.Δt\n\nwrite_times(input::AbstractInput) = write_times(input.time)\nwrite_times(time::TimeProperties) = (0:n_writes(time)) .* (time.Δt * time.write_interval) .+ time.t0\n\ntime_axis(input::AbstractInput) = time_axis(input.time)\nn_writes(input::AbstractInput) = n_writes(input.time)\n\nfunction write_header(fid, input::AbstractInput)\n    gid = fid[\"input\"]\n    attr = attributes(gid)\n\n    gid[\"t\"] = write_times(input) .|> in_units_of(u\"Myr\")\n    attr[\"t0\"] = input.time.t0 |> in_units_of(u\"Myr\")\n    attr[\"delta_t\"] = input.time.Δt |> in_units_of(u\"Myr\")\n    attr[\"write_interval\"] = input.time.write_interval\n    attr[\"time_steps\"] = input.time.steps\nend\n\nend","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"","category":"page"},{"location":"#CarboKitten.jl:-Modeling-Carbonate-Platforms-in-Julia","page":"Introduction","title":"CarboKitten.jl: Modeling Carbonate Platforms in Julia","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"(Image: Entangled badge)","category":"page"},{"location":"#About","page":"Introduction","title":"About","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"CarboKitten is a reimplementation of Peter Burgess' CarboCAT, a model for generating carbonate platform stratigraphies. CarboKitten is a three-dimensional model, having two spatial dimensions and one for stored stediment.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Features:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Cellular Automata to regulate facies type\nAdvection-diffusion based sediment transport","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"(Image: Sample output stratigraphy)","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"CarboKitten is written in Julia for performance and extensibility.","category":"page"},{"location":"#Julia-Quickstarter","page":"Introduction","title":"Julia Quickstarter","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"This code is written in Julia. You may want to check out the following references:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Julia Documentation\nTutorial on Julia for Science and Engineering","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"There are several ways to work with Julia that may be a bit different from what you're used to, if that is Matlab, Python or R.","category":"page"},{"location":"#Installing-Julia","page":"Introduction","title":"Installing Julia","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"The best way to install Julia is to use juliaup at github.com/JuliaLang/juliaup.","category":"page"},{"location":"#REPL","page":"Introduction","title":"REPL","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"The most basic way to work in Julia, is to start the REPL (Read Eval Print Loop).","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"$ julia\n               _\n   _       _ _(_)_     |  Documentation: https://docs.julialang.org\n  (_)     | (_) (_)    |\n   _ _   _| |_  __ _   |  Type \"?\" for help, \"]?\" for Pkg help.\n  | | | | | | |/ _` |  |\n  | | |_| | | | (_| |  |  Version 1.9.3 (2023-08-24)\n _/ |\\__'_|_|_|\\__'_|  |  Official https://julialang.org/ release\n|__/                   |\n\njulia>","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"From here you may use CarboKitten using CarboKitten and run any of the code inside. To work with CarboKitten efficiently, you may want to load Revise. Revise auto-detects changes to loaded code and makes it easy to rerun.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Running CarboKitten will require to load other dependencies, so please consult the documentation on Julia packages to learn how.","category":"page"},{"location":"#VS-Code","page":"Introduction","title":"VS Code","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"VSCode has very good support for working with Julia. Install the official Julia plugin and you should be good to go. Explore options by pressing Ctrl+Shift+P and type Julia to see what you can do. For example: start a REPL, run current script etc.","category":"page"},{"location":"#Jupyter","page":"Introduction","title":"Jupyter","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"You can run Julia code from Jupyter if you install the Julia kernel. Press ] in the REPL to get into Pkg-mode, the prompt will change","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"(CarboKitten) pkg>","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"You may install the IJulia kernel with add IJulia.","category":"page"},{"location":"#Pluto","page":"Introduction","title":"Pluto","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"An alternative (and in our opinion superior) notebook interface is called Pluto.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Pluto is reactive: changes to code cells automatically update downstream dependencies.\nPluto notebooks are written to regular Julia files and can (though maybe shouldn't) be run independent from Pluto.\nThe user interface of Pluto is slightly less mature than Jupyter","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"In Pkg-mode say add Pluto.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"julia> using Pluto\n\njulia> Pluto.run()\n[ Info: Loading...\n┌ Info:\n└ Opening http://localhost:1234/?secret=xyzxyzzy in your default browser... ~ have fun!\n┌ Info:\n│ Press Ctrl+C in this terminal to stop Pluto\n└","category":"page"},{"location":"#Plotting","page":"Introduction","title":"Plotting","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"CarboKitten ships with several routines for visualizing model output. These routines use the Makie.jl package. Makie has three back-ends: CairoMakie, GLMakie and WGLMakie. These are all written in Julia, but they focus on different kinds of results. CairoMakie is relatively slow but results in publication quality vector graphics: SVG or PDF. GLMakie is very fast, renders on your graphics card, but only produces raster images, say PNG. Then WGLMakie does a similar thing, but through the web-browser.","category":"page"},{"location":"#Design-style","page":"Introduction","title":"Design style","text":"","category":"section"},{"location":"#Input-structures","page":"Introduction","title":"Input structures","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Input datastructures are always @kwdef. This makes it easier to understand and modify simulation scripts.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Different components of CarboKitten can work a variety of input types, as long as their expected data members are present. TODO: systematically document type requirements for each component.","category":"page"},{"location":"#Output-data","page":"Introduction","title":"Output data","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"All output is written to HDF5 files. Optionally, you may export parts of the output data to CSV files for further analysis.","category":"page"},{"location":"#Partial-functions","page":"Introduction","title":"Partial functions","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Most of the model code is written in the following particular pattern:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"function component(input)\n    prepare(input)\n\n    return function(state)\n        iterate!(state)\n    end\nend","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"In this case the prepare() statement is run once at the beginning of a model run, while the iterate!(state) statement, possibly modifying the state variable, is being run every iteration.","category":"page"},{"location":"#Entangled","page":"Introduction","title":"Entangled","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"If you plan to make a contribution to the core of CarboKitten, you should be aware of Entangled.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"The documentation for CarboKitten is using Entangled for Literate Programming. This means that code blocks in the documentation contribute to the actual functioning code in the library. When you develop the library code, you should have the Entangled daemon running to keep the documentation synchronized. Included in the CarboKitten repository is a pyproject.toml that manages the Entangled installation for you through Poetry; alternatively, you may install Entangled through pip install entangled-cli.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"To install, run poetry install in the project root, then:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"poetry run entangled watch","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Entangled is still under development and it may occur that the daemon complains about not knowing wether to tangle or stitch, for example when you've accidentally written both markdown and source code. If this happens you may manually entangled tangle or entangled stitch with the --force argument to decide the issue. It may be worth saving your work in version control before doing so.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"A somewhat frequent occurence is that you forgot to run entangled watch while developing. In this case, commit the work you have done to git, then run entangled tangle or entangled stitch (whichever applies). Your files are now back in their old state, but you can git restore the edits you have made and run entangled sync again to propagate the changes. The project should be in a good state again.","category":"page"},{"location":"#Building-Documentation","page":"Introduction","title":"Building Documentation","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"To recreate the plots in the documentation run","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"poetry run brei figures","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"The documentation can be rendered with Documenter.jl.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"julia --workenv=docs docs/make.jl","category":"page"},{"location":"#Project-structure","page":"Introduction","title":"Project structure","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":".\n├── data                # data files\n├── docs                # documentation\n│   ├── make.jl         # docs build script\n│   ├── Manifest.toml   #\n│   ├── Project.toml    # dependencies for building docs\n│   └── src             # markdown source for docs\n├── entangled.toml      # entangled config\n├── examples            # example scripts\n├── Makefile            # command-line short hands\n├── Manifest.toml       #\n├── Project.toml        # project dependencies\n├── pyproject.toml      # dependencies for running Entangled\n├── README.md           #\n├── src                 # tangled library source\n└── test                # unit tests","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"The figures from the documentation in \"docs/src/fig\" are git tracked, but are often regenerated when you change some of their direct dependencies. This makes switching branches harder, it would require issuing \"git stash\" first. We have made sure that the regenerated figures appear in docs/src/_fig and are not git tracked. There is a task in pyproject.toml that takes care of copying from docs/src/_fig to docs/src/fig when this repo is cloned:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"poetry run brei copy_figures","category":"page"},{"location":"#Authors","page":"Introduction","title":"Authors","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Lead engineer: Johan Hidding Netherlands eScience Center email: j.hidding [at] esciencecenter.nl Web page: www.esciencecenter.nl/team/johan-hidding-msc/ ORCID: 0000-0002-7550-1796","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Denudation modelling: Xianyi Liu Utrecht University email: x.liu6 [at] uu.nl Web page: www.uu.nl/staff/XLiu6 ORCID:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Original CarboCAT author: Peter Burgess University of Liverpool Web page: www.liverpool.ac.uk/environmental-sciences/staff/peter-burgess","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Project lead: Emilia Jarochowska Utrecht University email: e.b.jarochowska [at] uu.nl Web page: www.uu.nl/staff/EBJarochowska ORCID: 0000-0001-8937-9405","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Other team members:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Niklas Hohmann Utrecht University email: n.h.hohmann [at] uu.nl Web page: www.uu.nl/staff/NHohmann ORCID: 0000-0003-1559-1838","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Hanno Spreeuw Netherlands eScience Center email: h.spreeuw [at] esciencecenter.nl Web page: www.esciencecenter.nl/team/dr-hanno-spreeuw/ ORCID: 0000-0002-5057-0322","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"David De Vleeschouwer Westfälische Wilhelms-Universität Münster Web page: www.uni-muenster.de/GeoPalaeontologie/erdsystemforschung/staff/DeVleeschouwer ORCID: 0000-0002-3323-807X","category":"page"},{"location":"#Copyright","page":"Introduction","title":"Copyright","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Copyright 2023 Netherlands eScience Center and Utrecht University","category":"page"},{"location":"#License","page":"Introduction","title":"License","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see https://www.gnu.org/licenses/.","category":"page"},{"location":"#Funding-information","page":"Introduction","title":"Funding information","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Funded by the European Union (ERC, MindTheGap, StG project no 101041077). Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or the European Research Council. Neither the European Union nor the granting authority can be held responsible for them.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"","category":"page"},{"location":"components/cellular-automata/#Cellular-Automata","page":"Cellular Automata","title":"Cellular Automata","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"350pt\" height=\"221pt\"\n viewBox=\"0.00 0.00 350.00 221.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 217)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-217 346,-217 346,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-213C150,-213 12,-213 12,-213 6,-213 0,-207 0,-201 0,-201 0,-146 0,-146 0,-140 6,-134 12,-134 12,-134 150,-134 150,-134 156,-134 162,-140 162,-146 162,-146 162,-201 162,-201 162,-207 156,-213 150,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-182.5 155,-182.5 \"/>\n<text text-anchor=\"start\" x=\"57.5\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-159.5 7,-182.5 54,-182.5 54,-159.5 7,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-159.5 54,-159.5 54,-182.5 7,-182.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-159.5 54,-182.5 108,-182.5 108,-159.5 54,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-159.5 54,-182.5 108,-182.5 108,-159.5 54,-159.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-159.5 108,-182.5 155,-182.5 155,-159.5 108,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-182.5 108,-182.5 108,-159.5 155,-159.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-140.5 54,-159.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-140.5 108,-159.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node3\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M301.5,-98C301.5,-98 40.5,-98 40.5,-98 34.5,-98 28.5,-92 28.5,-86 28.5,-86 28.5,-12 28.5,-12 28.5,-6 34.5,0 40.5,0 40.5,0 301.5,0 301.5,0 307.5,0 313.5,-6 313.5,-12 313.5,-12 313.5,-86 313.5,-86 313.5,-92 307.5,-98 301.5,-98\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"36,-68 307,-68 \"/>\n<text text-anchor=\"start\" x=\"96\" y=\"-76.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"36,-45 36,-68 129,-68 129,-45 36,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"36,-45 129,-45 129,-68 36,-68 \"/>\n<text text-anchor=\"start\" x=\"40\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"129,-45 129,-68 234,-68 234,-45 129,-45\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"129,-45 129,-68 234,-68 234,-45 129,-45\"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-45 234,-68 307,-68 307,-45 234,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-68 234,-68 234,-45 307,-45 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"129,-26 129,-45 \"/>\n<text text-anchor=\"start\" x=\"40\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-26 234,-45 \"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"237\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"129,-7 129,-26 \"/>\n<text text-anchor=\"start\" x=\"40\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-7 234,-26 \"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"237\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge1\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M109.48,-133.74C115.79,-125.15 122.6,-115.88 129.31,-106.75\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"132.33,-108.55 135.43,-98.42 126.69,-104.4 132.33,-108.55\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node2\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-213C330,-213 192,-213 192,-213 186,-213 180,-207 180,-201 180,-201 180,-146 180,-146 180,-140 186,-134 192,-134 192,-134 330,-134 330,-134 336,-134 342,-140 342,-146 342,-146 342,-201 342,-201 342,-207 336,-213 330,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-182.5 335,-182.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-159.5 187,-182.5 234,-182.5 234,-159.5 187,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-159.5 234,-159.5 234,-182.5 187,-182.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-159.5 234,-182.5 288,-182.5 288,-159.5 234,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-159.5 234,-182.5 288,-182.5 288,-159.5 234,-159.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-159.5 288,-182.5 335,-182.5 335,-159.5 288,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-182.5 288,-182.5 288,-159.5 335,-159.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-140.5 234,-159.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-140.5 288,-159.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge2\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M232.52,-133.74C226.21,-125.15 219.4,-115.88 212.69,-106.75\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"215.31,-104.4 206.57,-98.42 209.67,-108.55 215.31,-104.4\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"This component implements the cellular automaton as described by [3]. ","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"We depend on the box properties being defined. Each Facies should have a viability_range and activation_range defined. Two other parameters are the ca_interval setting how many time steps between every CA advancement, and the ca_random_seed setting the random seed for generating the initial noise.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-input⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"@kwdef struct Facies <: AbstractFacies\n    viability_range::Tuple{Int,Int} = (4, 10)\n    activation_range::Tuple{Int,Int} = (6, 10)\nend\n\n@kwdef struct Input <: AbstractInput\n    ca_interval::Int      = 1\n    ca_random_seed::Int   = 0\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"The state of the CA is stored in ca and ca_priority.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-state⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"@kwdef mutable struct State <: AbstractState\n    ca::Matrix{Int}\n    ca_priority::Vector{Int}\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"The rules function computes the next value of a cell, given the configured vector of facies, the current facies priority order, and a neighbourhood around the cell.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-step⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"function rules(facies, ca_priority, neighbourhood)\n    cell_facies = neighbourhood[3, 3]\n    neighbour_count(f) = sum(neighbourhood .== f)\n    if cell_facies == 0\n        for f in ca_priority\n            n = neighbour_count(f)\n            (a, b) = facies[f].activation_range\n            if a <= n && n <= b\n                return f\n            end\n        end\n        0\n    else\n        n = neighbour_count(cell_facies) - 1\n        (a, b) = facies[cell_facies].viability_range\n        (a <= n && n <= b ? cell_facies : 0)\n    end\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"The paper talks about cycling the order of preference for occupying an empty cell at each iteration. This means that the rules change slightly every iteration. We need this extra function so that we know the boundary type BT at compile time.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-step⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"\"\"\"\n    step_ca(box, facies)\n\nCreates a propagator for the state, updating the celullar automaton in place.\n\nContract: the `state` should have `ca::Matrix{Int}` and `ca_priority::Vector{Int}`\nmembers.\n\"\"\"\nfunction step_ca(box::Box{BT}, facies) where {BT<:Boundary{2}}\n    tmp = Matrix{Int}(undef, box.grid_size)\n    facies_ = facies\n\n    function (state)\n        p = state.ca_priority\n        stencil!(BT, Size(5, 5), tmp, state.ca) do nb\n            rules(facies_, p, nb)\n        end\n        state.ca, tmp = tmp, state.ca\n        state.ca_priority = circshift(state.ca_priority, 1)\n        return state\n    end\nend","category":"page"},{"location":"components/cellular-automata/#Plot","page":"Cellular Automata","title":"Plot","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">file:<i>examples/ca/burgess-2013.jl</i></div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"#| creates: [\"docs/src/_fig/ca-long-term.svg\"]\n#| collect: figures\nmodule Script\nusing CarboKitten\nusing CarboKitten.Components: CellularAutomaton as CA\nusing CairoMakie\n\nfunction main()\n  input = CA.Input(\n      box = CarboKitten.Box{Periodic{2}}(\n        grid_size=(50, 50), phys_scale=1.0u\"m\"),\n      facies = fill(CA.Facies(), 3)\n  )\n\n  state = CA.initial_state(input)\n  step! = CA.step!(input)\n\n  for _ in 1:1000\n    step!(state)\n  end\n\n  fig = Figure(size=(1000, 500))\n  axes_indices = Iterators.flatten(eachrow(CartesianIndices((2, 4))))\n  xaxis, yaxis = box_axes(input.box)\n  i = 1000\n  for row in 1:2\n    for col in 1:4\n      ax = Axis(fig[row, col], aspect=AxisAspect(1), title=\"step $(i)\")\n\n      if row == 2\n        ax.xlabel = \"x [m]\"\n      end\n      if col == 1\n        ax.ylabel = \"y [m]\"\n      end\n\n      heatmap!(ax, xaxis/u\"m\", yaxis/u\"m\", state.ca)\n      step!(state)\n      i += 1\n    end\n    for _ in 1:996\n      step!(state)\n      i += 1\n    end\n  end\n  save(\"docs/src/_fig/ca-long-term.svg\", fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"(Image: CA)","category":"page"},{"location":"components/cellular-automata/#Tests","page":"Cellular Automata","title":"Tests","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">file:<i>test/Components/CellularAutomatonSpec.jl</i></div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"module CellularAutomatonSpec\n\nusing Test\nusing CarboKitten.Components.Common\nusing CarboKitten.Components: CellularAutomaton as CA\n\n@testset \"Components/CellularAutomaton\" begin\n    let facies = fill(CA.Facies((4, 10), (6, 10)), 3),\n        input1 = CA.Input(\n            box=Box{Periodic{2}}(grid_size=(50, 50), phys_scale=1.0u\"m\"),\n            facies=facies),\n        input2 = CA.Input(\n            box=Box{Periodic{2}}(grid_size=(50, 50), phys_scale=1.0u\"m\"),\n            facies=facies,\n            ca_random_seed=1)\n\n        state1 = CA.initial_state(input1)\n        state2 = CA.initial_state(input2)\n        state3 = CA.initial_state(input2)\n\n        @test CA.initial_state(input1).ca == CA.initial_state(input1).ca\n        @test state1.ca != state2.ca\n\n        step! = CA.step!(input1)  # inputs have same rules\n        for i in 1:20\n            step!(state1)\n            step!(state2)\n            step!(state3)\n        end\n\n        @test state1.ca != state2.ca\n        @test state2.ca == state3.ca\n    end\nend\n\nend","category":"page"},{"location":"components/cellular-automata/#Component","page":"Cellular Automata","title":"Component","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">file:<i>src/Components/CellularAutomaton.jl</i></div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"@compose module CellularAutomaton\n    @mixin Boxes, FaciesBase\n    using ..Common\n    using ...Stencil: stencil!\n    using Random\n\n    <<ca-input>>\n    <<ca-state>>\n    <<ca-step>>\n\n    function initial_state(input::AbstractInput)\n        n_facies = length(input.facies)\n        ca = rand(MersenneTwister(input.ca_random_seed), 0:n_facies, input.box.grid_size...)\n        return State(ca, 1:n_facies |> collect)\n    end\n\n    function step!(input::AbstractInput)\n        return step_ca(input.box, input.facies)\n    end\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"","category":"page"}]
}
