var documenterSearchIndex = {"docs":
[{"location":"unitful/#Unitful","page":"Unitful","title":"Unitful","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Physical quantities in CarboKitten are always specified using the Unitful.jl framework.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">file:<i>test/Unitful.jl</i></div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@testset \"Unitful\" begin\n    using Unitful\n    using Unitful.DefaultSymbols\n    using CarboKitten.Utility\n\n    <<unitful-spec>>\nend","category":"page"},{"location":"unitful/#Variables-vs.-string-macros","page":"Unitful","title":"Variables vs. string macros","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Unitful package offers two basic ways to enter quantities: either using predefined symbols (polluting your namespace with one-letter variables), or using special string macros.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test 1.0m === 1.0u\"m\"\n@test 42J/s == 42u\"W\"","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"In many cases, your CarboKitten scripts will contain little else than the input specification. In such a case using Unitful.DefaultSymbols gives a bit cleaner, more readable look.","category":"page"},{"location":"unitful/#Reading-specs","page":"Unitful","title":"Reading specs","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Suppose we simulate a pendulum. We would have an input spec defined as follows:","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@kwdef struct Pendulum\n    length :: typeof(1.0m)\n    time_step :: typeof(1.0s)\n    phi0 :: typeof(1.0rad)\n    omega0 :: typeof(1.0rad/s)\nend","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Then input can be given as follows:","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"pendulum = Pendulum(\n    length = 2.0m,\n    time_step = 1ms,\n    phi0 = 30°,\n    omega0 = 0rad/s\n)","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Units are automatically converted to the types specified in the API.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test pendulum.time_step === 0.001s\n@test pendulum.phi0 === (π/6)rad","category":"page"},{"location":"unitful/#Dimensions","page":"Unitful","title":"Dimensions","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Unitful has dimensions of length 𝐋, mass 𝐌 and time 𝐓 as bold upper-case Unicode symbols. These can be entered in Julia with \\bfL, \\bfM etc. When you define a function that needs, say, an energy, which has SI units of rm J = (ms)^2 kg, we can construct the dimensions. Defining a few constants:","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"let 𝐄 = (𝐋/𝐓)^2 * 𝐌,\n    h = 6.62607015e-34u\"J*s\",\n    c = 299792458u\"m/s\"\n    <<unitful-photon-example>>\nend","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"We can abstract over the specific units by defining a generic method. Now we can compute the wavelength of a photon, given its energy in any unit of energy.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-photon-example⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"photon_wave_length(E::Quantity{Float64,𝐄,J}) where {J} =\n    uconvert(u\"Å\", h * c / E)\n\n@test photon_wave_length(2.38u\"eV\") ≈ 5209.4201u\"Å\"\n@test_throws MethodError photon_wave_length(1u\"m\")","category":"page"},{"location":"unitful/#Negating-Units","page":"Unitful","title":"Negating Units","text":"","category":"section"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"There is a handy way of negating units (getting back to raw scalars) using the NoUnits function object.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test 23u\"km\" / u\"m\" |> NoUnits == 23000","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"Now, suppose we have a Vector of which we don't know the exact units, but we want to save values in meters to HDF5. When we get a vector in meters, and divide by u\"m\", Unitful will simplify and return a plain Vector{Float64}. However, if the units were u\"km\", then we need to convert by multiplying by 1000. We could do vec .|> NoUnits, but this will always allocate a new vector, even when it is not needed. We have the short-hand in_units_of that solves this issue.","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡unitful-spec⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"@test 23u\"km\" |> in_units_of(u\"m\") == 23000\n@test [4, 5, 6]u\"m\" |> in_units_of(u\"m\") == [4, 5, 6]","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"<div class=\"noweb-label\">⪡utility⪢≣</div>","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"function in_units_of(unit)\n    function magnitude(a)\n        error(\"Units of $(a*unit) not compatible with $unit\")\n    end\n\n    function magnitude(a::AbstractArray{Quantity{RT, NoDims, U}, dim}) where {RT <: Real, U, dim}\n        return a .|> NoUnits\n    end\n\n    function magnitude(a::AbstractArray{RT, dim}) where {RT <: Real, dim}\n        return a\n    end\n\n    function magnitude(a::RT) where {RT <: Real}\n        return a\n    end\n\n    function magnitude(a::Quantity{RT, NoDims, U}) where {RT <: Real, U}\n        return a |> NoUnits\n    end\n\n    function (x)\n        x / unit |> magnitude\n    end\nend","category":"page"},{"location":"unitful/","page":"Unitful","title":"Unitful","text":"","category":"page"},{"location":"references/#References","page":"References","title":"References","text":"","category":"section"},{"location":"references/","page":"References","title":"References","text":"H. Bosscher and W. Schlager. Computer simulation of reef growth. Sedimentology 39, 503–512 (1992).\n\n\n\nK. G. Miller, J. V. Browning, W. J. Schmelz, R. E. Kopp, G. S. Mountain and J. D. Wright. Cenozoic sea-level relative to modern from deep-sea geochemical and continental margin records (2020).\n\n\n\nP. M. Burgess. CarboCAT: A cellular automata model of heterogeneous carbonate strata. Computers & geosciences 53, 129–140 (2013).\n\n\n\nC. Paola, P. L. Heller and C. L. Angevine. The large-scale dynamics of grain-size variation in alluvial basins, 1: Theory. Basin research 4, 73–90 (1992).\n\n\n\nS. C. James, C. A. Jones, M. D. Grace and J. D. Roberts. Advances in sediment transport modelling. Journal of Hydraulic Research 48, 754–763 (2010).\n\n\n\nK. G. Miller, M. A. Kominz, J. V. Browning, J. D. Wright, G. S. Mountain, M. E. Katz, P. J. Sugarman, B. S. Cramer, N. Christie-Blick and S. F. Pekar. The Phanerozoic Record of Global Sea-Level Change. Science 310, 1293–1298 (2005). Publisher: American Association for the Advancement of Science.\n\n\n\nY. Yang, Y.-C. Lang, S. Xu, C.-Q. Liu, L.-F. Cui, S. P. Freeman and K. M. Wilcken. Combined unsteady denudation and climatic gradient factors constrain carbonate landscape evolution: New insights from in situ cosmogenic 36Cl. Quaternary Geochronology 58, 101075 (2020). Accessed on Jul 24, 2024.\n\n\n\nF. Thomas, V. Godard, O. Bellier, L. Benedetti, V. Ollivier, M. Rizza, V. Guillou, F. Hollender, G. Aumaître, D. L. Bourlès and K. Keddadouche. Limited influence of climatic gradients on the denudation of a Mediterranean carbonate landscape. Geomorphology 316, 44–58 (2018).\n\n\n\nK. Krklec, R. Braucher, D. Perica and D. Domínguez-Villar. Long-term denudation rate of karstic North Dalmatian Plain (Croatia) calculated from 36Cl cosmogenic nuclides. Geomorphology 413, 108358 (2022). Accessed on Jul 24, 2024.\n\n\n\nP. Thapa. Spatial estimation of soil erosion using RUSLE modeling: a case study of Dolakha district, Nepal. Environmental Systems Research 9, 15 (2020).\n\n\n\nG. Kaufmann and J. Braun. Modelling karst denudation on a synthetic landscape. Terra Nova 13, 313–320 (2001).\n\n\n\nF. Gabrovšek. On concepts and methods for the estimation of dissolutional denudation rates in karst areas. Geomorphology 106, 9–14 (2009). Accessed on Jul 11, 2024.\n\n\n\nG. Kaufmann and W. Dreybrodt. Calcite dissolution kinetics in the system CaCO3–H2O–CO2 at high undersaturation. Geochimica et Cosmochimica Acta 71, 1398–1410 (2007). Accessed on Jul 11, 2024.\n\n\n\nG. Tucker, S. Lancaster, N. Gasparini and R. Bras. The Channel-Hillslope Integrated Landscape Development Model (CHILD). In: Landscape Erosion and Evolution Modeling, edited by R. S. Harmon and W. W. Doe (Springer US, 2001); pp. 349–388. Accessed on Jul 24, 2024.\n\n\n\nM. J. Van De Wiel, T. J. Coulthard, M. G. Macklin and J. Lewin. Embedding reach-scale fluvial dynamics within the CAESAR cellular automaton landscape evolution model. Geomorphology 90, 283–301 (2007). Accessed on Jul 24, 2024.\n\n\n\n","category":"page"},{"location":"references/","page":"References","title":"References","text":"","category":"page"},{"location":"components/boxes/#Box","page":"Boxes","title":"Box","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"57.5\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"This module makes sure we have access to box properties.","category":"page"},{"location":"components/boxes/#Box-topology","page":"Boxes","title":"Box topology","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"CarboKitten has a 3-dimensional state space, where two dimensions represent cartesian topographic coordinates, and the third dimension is a track record of sedimentation. The cartesian topographic coordinates are always on a regular grid, but depending on the scenario you may choose different map topologies.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"periodic boundaries To study sedimentation in a small isolated patch, periodic boundaries seem sufficient. The field is assumed to be infinite in all directions.\nVon Neumann boundaries In the case of an island it is nicer to have boundaries with constant derivatives. Produced sediment that flows out of the box is lost to the seas.\ncoastal boundaries Supposing we simulate a narrow cross section of a coast, we'll have one periodic boundary (in y-direction) and Von Neumann boundaries in the x-direction.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"We parametrize these boundaries as type-level constants in Julia. This way we can use the multiple dispatch mechanism in Julia to obtain specialized implementations for each boundary case, selected at compile time, resulting in efficient run-times.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡boundary-types⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"abstract type Boundary{dim} end\nstruct Reflected{dim} <: Boundary{dim} end\nstruct Periodic{dim} <: Boundary{dim} end\nstruct Constant{dim,value} <: Boundary{dim} end\nstruct Coast <: Boundary{2} end\n\nconst Shelf = Coast  # FIXME: Old name, should be removed\n\n@inline modflip(a, l) = let b = mod1(a, 2l)\n    b > l ? 2l - b + 1 : b\nend\n\n@inline get_bounded(::Type{Constant{dim, value}}, a, i) where {dim, value} =\n    checkbounds(Bool, a, i) ? a[i] : val\n\n@inline get_bounded(::Type{Periodic{dim}}, a, i) where {dim} =\n    checkbounds(Bool, a, i) ? a[i] : a[mod1.(Tuple(i), size(a))...]\n\n@inline get_bounded(::Type{Reflected{dim}}, a, i) where {dim} =\n    checkbounds(Bool, a, i) ? a[i] : a[modflip.(Tuple(i), size(a))...]\n\n@inline get_bounded(::Type{Coast}, a, i) =\n    checkbounds(Bool, a, i) ? a[i] : a[modflip(i[1], size(a)[1]), mod1(i[2], size(a)[2])]","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"The Boundary type is part of the generic Box dimension specification.","category":"page"},{"location":"components/boxes/#Offset-indexing","page":"Boxes","title":"Offset indexing","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"Now we can use these topology types to define three methods for indexing on an offset from some index that is assumed to be within bounds.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡spec⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"@testset \"offset_value\" begin\n    @test CartesianIndex(1, 1) == offset_index(Reflected{2}, (3, 3), CartesianIndex(1, 1), CartesianIndex(0, 0))\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡offset-indexing⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"function offset_index(::Type{BT}, shape::NTuple{dim,Int}, i::CartesianIndex, Δi::CartesianIndex) where {dim, BT <: Boundary{dim}}\n    canonical(BT, shape, i + Δi)\nend\n\nfunction offset_value(BT::Type{B}, z::AbstractArray, i::CartesianIndex, Δi::CartesianIndex) where {dim,B<:Boundary{dim}}\n    z[offset_index(BT, size(z), i, Δi)]\nend\n\nfunction offset_value(::Type{Constant{dim,value}}, z::AbstractArray, i::CartesianIndex, Δi::CartesianIndex) where {dim,value}\n    j = i + Δi\n    (checkbounds(Bool, z, j) ? z[j] : value)\nend","category":"page"},{"location":"components/boxes/#Canonical-coordinates","page":"Boxes","title":"Canonical coordinates","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"For both Periodic and Reflected boundaries it is also possible to write a function that makes any coordinate within bounds. This uses the fact that reflected boundaries are also periodic for a box twice the size.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡canonical-coordinates⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"function canonical(::Type{Periodic{dim}}, shape::NTuple{dim,Int}, i::CartesianIndex) where {dim}\n    CartesianIndex(mod1.(Tuple(i), shape)...)\nend\n\nfunction canonical(::Type{Reflected{dim}}, shape::NTuple{dim,Int}, i::CartesianIndex) where {dim}\n    modflip(a, l) = let b = mod1(a, 2l)\n        b > l ? 2l - b + 1 : b\n    end\n    CartesianIndex(modflip.(Tuple(i), shape)...) \nend\n\nfunction canonical(::Type{Constant{dim, value}}, shape::NTuple{dim,Int}, i::CartesianIndex) where {dim, value}\n    all(checkindex.(Bool, range.(1, shape), Tuple(i))) ? i : nothing\nend","category":"page"},{"location":"components/boxes/#Coast-boundary","page":"Boxes","title":"Coast boundary","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"The Coast boundary type is specially designed for the simulation of a transect perpendicular to the coast direction. We are periodic in the y-direction and have a Neumannesque constant boundary at the edges of the simulation area.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡offset-indexing⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"function canonical(::Type{Coast}, shape::NTuple{2, Int}, i::CartesianIndex)\n    if i[1] < 1 || i[1] > shape[1]\n        return nothing\n    end\n    return CartesianIndex(i[1], mod1(i[2], shape[2]))\nend\n\nfunction offset_value(::Type{Coast}, z::AbstractArray, i::CartesianIndex, Δi::CartesianIndex)\n    j = i + Δi\n    shape = size(z)\n    if j[1] < 1\n        return z[1, mod1(j[2], shape[2])]\n    elseif j[1] > shape[1]\n        return z[shape[1], mod1(j[2], shape[2])]\n    else\n        return z[j[1], mod1(j[2], shape[2])]\n    end\nend","category":"page"},{"location":"components/boxes/#BoundaryTrait-module","page":"Boxes","title":"BoundaryTrait module","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/BoundaryTrait.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"# FIXME: Rename this module\nmodule BoundaryTrait\n\nexport Boundary, Reflected, Periodic, Constant, Coast, Shelf, offset_index, offset_value, canonical, get_bounded\n\n<<boundary-types>>\n<<offset-indexing>>\n<<canonical-coordinates>>\n\nend","category":"page"},{"location":"components/boxes/#Box-properties","page":"Boxes","title":"Box properties","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡box-type⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"const axes = box_axes\n\nphys_size(grid_size, phys_scale) = (\n    x = grid_size[1] * (phys_scale / m |> NoUnits),\n    y = grid_size[2] * (phys_scale / m |> NoUnits))","category":"page"},{"location":"components/boxes/#Floating-point-vectors","page":"Boxes","title":"Floating-point vectors","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"We need to define how particles move past boundaries. Similar to the grid based offset_index method, we define the offset method for a Vec2.","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡vector-offset⪢≣</div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"Base.in(a::Vec2, box::Box) =\n    a.x >= 0.0 && a.x < box.phys_size.x && a.y >= 0.0 && a.y < box.phys_size.y\n\nfunction offset(box::AbstractBox{Reflected{2}}, a::Vec2, Δa::Vec2)\n    clip(i, a, b) = (i < a ? a + a - i : (i > b ? b + b - i : i))\n    (x=clip(a.x+Δa.x, 0.0, box.phys_size.x)\n    ,y=clip(a.y+Δa.y, 0.0, box.phys_size.y))\nend\n\nfunction offset(box::AbstractBox{Periodic{2}}, a::Vec2, Δa::Vec2)\n    (x=mod(a.x+Δa.x, box.phys_size.x)\n    ,y=mod(a.y+Δa.y, box.phys_size.y))\nend\n\nfunction offset(box::AbstractBox{Constant{2,Value}}, a::Vec2, Δa::Vec2) where Value\n    b = a + Δa\n    if b ∉ box\n        nothing\n    else\n        b\n    end\nend\n\nfunction offset(box::AbstractBox{Shelf}, a::Vec2, Δa::Vec2)\n    b = a + Δa\n    if b.x < 0.0 || b.x >= box.phys_size.x\n        nothing\n    else\n        (x=b.x, y=mod(b.y, box.phys_size.y))\n    end\nend","category":"page"},{"location":"components/boxes/#Modules","page":"Boxes","title":"Modules","text":"","category":"section"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Boxes.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"module Boxes\n\nusing ..BoundaryTrait\nusing ..CarboKitten: AbstractBox, Box, box_axes\nusing ..Vectors\n\nusing Unitful\nusing Unitful.DefaultSymbols\n\nexport AbstractBox, Box, box_axes\n\n<<box-type>>\n<<vector-offset>>\n\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>test/Components/BoxesSpec.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"module BoxesSpec\n    using Test\n    using CarboKitten.Components.Common\n    using CarboKitten.Components.Boxes\n\n    @testset \"Components/Boxes\" begin\n        let box = Box{Periodic{2}}(grid_size=(10, 10), phys_scale=2.0u\"m\"),\n            input = Boxes.Input(box=box)\n            @test input.box.grid_size == (10, 10)\n            @test input.box.phys_scale == 2.0u\"m\"\n        end\n    end\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Components/Boxes.jl</i></div>","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"@compose module Boxes\nusing ..Common\n\n@kwdef struct Input <: AbstractInput\n    box::Box\nend\n\nfunction write_header(fid, input::AbstractInput)\n    x, y = box_axes(input.box)\n\n    gid = fid[\"input\"]\n    gid[\"x\"] = collect(x) |> in_units_of(u\"m\")\n    gid[\"y\"] = collect(y) |> in_units_of(u\"m\")\nend\nend","category":"page"},{"location":"components/boxes/","page":"Boxes","title":"Boxes","text":"","category":"page"},{"location":"components/production/#Production","page":"Production","title":"Production","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"500pt\" height=\"393pt\"\n viewBox=\"0.00 0.00 500.00 393.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 389)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-389 496,-389 496,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-385C150,-385 12,-385 12,-385 6,-385 0,-379 0,-373 0,-373 0,-318 0,-318 0,-312 6,-306 12,-306 12,-306 150,-306 150,-306 156,-306 162,-312 162,-318 162,-318 162,-373 162,-373 162,-379 156,-385 150,-385\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-354.5 155,-354.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-363.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-331.5 7,-354.5 54,-354.5 54,-331.5 7,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-331.5 54,-331.5 54,-354.5 7,-354.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-331.5 54,-354.5 108,-354.5 108,-331.5 54,-331.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-331.5 54,-354.5 108,-354.5 108,-331.5 54,-331.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-331.5 108,-354.5 155,-354.5 155,-331.5 108,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-354.5 108,-354.5 108,-331.5 155,-331.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-312.5 54,-331.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-312.5 108,-331.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node2\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-270C300,-270 42,-270 42,-270 36,-270 30,-264 30,-258 30,-258 30,-165 30,-165 30,-159 36,-153 42,-153 42,-153 300,-153 300,-153 306,-153 312,-159 312,-165 312,-165 312,-258 312,-258 312,-264 306,-270 300,-270\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-239.5 305,-239.5 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-248.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"37,-216.5 37,-239.5 154,-239.5 154,-216.5 37,-216.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-216.5 154,-216.5 154,-239.5 37,-239.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-216.5 154,-239.5 208,-239.5 208,-216.5 154,-216.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-216.5 154,-239.5 208,-239.5 208,-216.5 154,-216.5\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-216.5 208,-239.5 305,-239.5 305,-216.5 208,-216.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-239.5 208,-239.5 208,-216.5 305,-216.5 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-224.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-197.5 154,-216.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-197.5 208,-216.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-178.5 154,-197.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-178.5 208,-197.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-159.5 154,-178.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-159.5 208,-178.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M107.27,-305.97C113.07,-297.46 119.38,-288.21 125.69,-278.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"128.73,-280.7 131.48,-270.47 122.95,-276.76 128.73,-280.7\"/>\n</g>\n<!-- Production -->\n<g id=\"node5\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M414.5,-117C414.5,-117 167.5,-117 167.5,-117 161.5,-117 155.5,-111 155.5,-105 155.5,-105 155.5,-12 155.5,-12 155.5,-6 161.5,0 167.5,0 167.5,0 414.5,0 414.5,0 420.5,0 426.5,-6 426.5,-12 426.5,-12 426.5,-105 426.5,-105 426.5,-111 420.5,-117 414.5,-117\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"163,-86.5 420,-86.5 \"/>\n<text text-anchor=\"start\" x=\"247.5\" y=\"-95.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"163,-63.5 163,-86.5 232,-86.5 232,-63.5 163,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"163,-63.5 232,-63.5 232,-86.5 163,-86.5 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"232,-63.5 232,-86.5 373,-86.5 373,-63.5 232,-63.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"232,-63.5 232,-86.5 373,-86.5 373,-63.5 232,-63.5\"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"373,-63.5 373,-86.5 420,-86.5 420,-63.5 373,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"420,-86.5 373,-86.5 373,-63.5 420,-63.5 \"/>\n<text text-anchor=\"start\" x=\"377\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-44.5 232,-63.5 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"373,-44.5 373,-63.5 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"376\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-25.5 232,-44.5 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"373,-25.5 373,-44.5 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"376\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"232,-6.5 232,-25.5 \"/>\n<text text-anchor=\"start\" x=\"167\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"373,-6.5 373,-25.5 \"/>\n<text text-anchor=\"start\" x=\"236\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"376\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge3\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M216.71,-152.98C223.93,-143.89 231.45,-134.44 238.81,-125.18\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"241.74,-127.11 245.22,-117.11 236.26,-122.76 241.74,-127.11\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node3\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-385C330,-385 192,-385 192,-385 186,-385 180,-379 180,-373 180,-373 180,-318 180,-318 180,-312 186,-306 192,-306 192,-306 330,-306 330,-306 336,-306 342,-312 342,-318 342,-318 342,-373 342,-373 342,-379 336,-385 330,-385\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-354.5 335,-354.5 \"/>\n<text text-anchor=\"start\" x=\"237.5\" y=\"-363.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-331.5 187,-354.5 234,-354.5 234,-331.5 187,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-331.5 234,-331.5 234,-354.5 187,-354.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-331.5 234,-354.5 288,-354.5 288,-331.5 234,-331.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-331.5 234,-354.5 288,-354.5 288,-331.5 234,-331.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-331.5 288,-354.5 335,-354.5 335,-331.5 288,-331.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-354.5 288,-354.5 288,-331.5 335,-331.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-339.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-312.5 234,-331.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-312.5 288,-331.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-319.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M234.73,-305.97C228.93,-297.46 222.62,-288.21 216.31,-278.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"219.05,-276.76 210.52,-270.47 213.27,-280.7 219.05,-276.76\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M480,-251C480,-251 342,-251 342,-251 336,-251 330,-245 330,-239 330,-239 330,-184 330,-184 330,-178 336,-172 342,-172 342,-172 480,-172 480,-172 486,-172 492,-178 492,-184 492,-184 492,-239 492,-239 492,-245 486,-251 480,-251\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-220.5 485,-220.5 \"/>\n<text text-anchor=\"start\" x=\"367\" y=\"-229.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"337,-197.5 337,-220.5 384,-220.5 384,-197.5 337,-197.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-197.5 384,-197.5 384,-220.5 337,-220.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-205.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"384,-197.5 384,-220.5 438,-220.5 438,-197.5 384,-197.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"384,-197.5 384,-220.5 438,-220.5 438,-197.5 384,-197.5\"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-205.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"438,-197.5 438,-220.5 485,-220.5 485,-197.5 438,-197.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"485,-220.5 438,-220.5 438,-197.5 485,-197.5 \"/>\n<text text-anchor=\"start\" x=\"442\" y=\"-205.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"384,-178.5 384,-197.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"438,-178.5 438,-197.5 \"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"441\" y=\"-185.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge4\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M380.1,-171.61C368.86,-157.48 355.83,-141.08 343.26,-125.26\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"345.7,-122.71 336.74,-117.05 340.22,-127.06 345.7,-122.71\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"The Production module specifies the production rate following the model by Bosscher & Schlager 1992 [1]. The growth rate is given as","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"g(w) = g_m tanhleft(I_0 e^-kw over I_kright)","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"This can be understood as a smooth transition between the maximum growth rate under saturated conditions, and exponential decay due to light intensity dropping with greater water depth.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">⪡component-production-rate⪢≣</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"function production_rate(insolation, facies, water_depth)\n    gₘ = facies.maximum_growth_rate\n    I = insolation / facies.saturation_intensity\n    x = water_depth * facies.extinction_coefficient\n    return x > 0.0 ? gₘ * tanh(I * exp(-x)) : 0.0u\"m/Myr\"\nend\n\nfunction capped_production(insolation, facies, water_depth, dt)\n    p = production_rate(insolation, facies, water_depth) * dt\n    return min(p, max(0.0u\"m\", water_depth))\nend","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"From just this equation we can define a uniform production process. This requires that we have a Facies that defines the maximum_growth_rate, extinction_coefficient and saturation_intensity.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"The insolation input may be given as a scalar quantity, say 400u\"W/m^2\", or as a function of time.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">file:<i>src/Components/Production.jl</i></div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@compose module Production\n@mixin TimeIntegration, WaterDepth, FaciesBase\nusing ..Common\nusing ..WaterDepth: water_depth\nusing ..TimeIntegration: time, write_times\nusing HDF5\nusing Logging\n\nexport production_rate, capped_production, uniform_production\n\n@kwdef struct Facies <: AbstractFacies\n    maximum_growth_rate::Rate\n    extinction_coefficient::typeof(1.0u\"m^-1\")\n    saturation_intensity::Intensity\nend\n\n@kwdef struct Input <: AbstractInput\n    insolation\nend\n\nfunction insolation(input::AbstractInput)\n    insolation = input.insolation\n    tprop = input.time\n    if insolation isa Quantity\n        return s -> insolation\n    end\n    if insolation isa AbstractVector\n        @info \"Reading insolation from a table\"\n        return s -> insolation[s.step+1]\n    end\n    @info \"Reading insolation from a function\"\n    function (s::AbstractState)\n        t = time(tprop, s)\n        return insolation(t)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    if input.insolation isa Quantity\n        fid[\"input\"][\"insolation\"] = fill(input.insolation |> in_units_of(u\"W/m^2\"), input.time.steps)\n    elseif input.insolation isa AbstractVector\n        fid[\"input\"][\"insolation\"] = input.insolation |> in_units_of(u\"W/m^2\")\n    else\n        t = write_times(input)[1:end-1]\n        fid[\"input\"][\"insolation\"] = input.insolation.(t) |> in_units_of(u\"W/m^2\")\n    end\n\n    # fid[\"input\"][\"insolation\"] = insolation(input) |> in_units_of(u\"W/m^2\")\n    for (i, f) in enumerate(input.facies)\n        attr = attributes(fid[\"input/facies$(i)\"])\n        attr[\"maximum_growth_rate\"] = f.maximum_growth_rate |> in_units_of(u\"m/Myr\")\n        attr[\"extinction_coefficient\"] = f.extinction_coefficient |> in_units_of(u\"m^-1\")\n        attr[\"saturation_intensity\"] = f.saturation_intensity |> in_units_of(u\"W/m^2\")\n    end\nend\n\n<<component-production-rate>>\n\nfunction uniform_production(input::AbstractInput)\n    w = water_depth(input)\n    na = [CartesianIndex()]\n    insolation_func = insolation(input)\n    facies = input.facies\n    dt = input.time.Δt\n\n    p(state::AbstractState, wd::AbstractMatrix) =\n        capped_production.(insolation_func(state), facies[:, na, na], wd[na, :, :], dt)\n\n    p(state::AbstractState) = p(state, w(state))\n\n    return p\nend\nend","category":"page"},{"location":"components/production/#CA-Production","page":"Production","title":"CA Production","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"614pt\" height=\"465pt\"\n viewBox=\"0.00 0.00 613.50 465.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 461)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-461 609.5,-461 609.5,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M210,-457C210,-457 72,-457 72,-457 66,-457 60,-451 60,-445 60,-445 60,-390 60,-390 60,-384 66,-378 72,-378 72,-378 210,-378 210,-378 216,-378 222,-384 222,-390 222,-390 222,-445 222,-445 222,-451 216,-457 210,-457\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-426.5 215,-426.5 \"/>\n<text text-anchor=\"start\" x=\"75.5\" y=\"-435.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"67,-403.5 67,-426.5 114,-426.5 114,-403.5 67,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-403.5 114,-403.5 114,-426.5 67,-426.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"114,-403.5 114,-426.5 168,-426.5 168,-403.5 114,-403.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"114,-403.5 114,-426.5 168,-426.5 168,-403.5 114,-403.5\"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"168,-403.5 168,-426.5 215,-426.5 215,-403.5 168,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"215,-426.5 168,-426.5 168,-403.5 215,-403.5 \"/>\n<text text-anchor=\"start\" x=\"172\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"114,-384.5 114,-403.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"168,-384.5 168,-403.5 \"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"171\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M270,-342C270,-342 12,-342 12,-342 6,-342 0,-336 0,-330 0,-330 0,-237 0,-237 0,-231 6,-225 12,-225 12,-225 270,-225 270,-225 276,-225 282,-231 282,-237 282,-237 282,-330 282,-330 282,-336 276,-342 270,-342\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-311.5 275,-311.5 \"/>\n<text text-anchor=\"start\" x=\"93.5\" y=\"-320.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-288.5 7,-311.5 124,-311.5 124,-288.5 7,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-288.5 124,-288.5 124,-311.5 7,-311.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"124,-288.5 124,-311.5 178,-311.5 178,-288.5 124,-288.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"124,-288.5 124,-311.5 178,-311.5 178,-288.5 124,-288.5\"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"178,-288.5 178,-311.5 275,-311.5 275,-288.5 178,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-311.5 178,-311.5 178,-288.5 275,-288.5 \"/>\n<text text-anchor=\"start\" x=\"182\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-269.5 124,-288.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-269.5 178,-288.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-250.5 124,-269.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-250.5 178,-269.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-231.5 124,-250.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-231.5 178,-250.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M141,-377.97C141,-369.98 141,-361.34 141,-352.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"144.5,-352.47 141,-342.47 137.5,-352.47 144.5,-352.47\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node2\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M474,-457C474,-457 336,-457 336,-457 330,-457 324,-451 324,-445 324,-445 324,-390 324,-390 324,-384 330,-378 336,-378 336,-378 474,-378 474,-378 480,-378 486,-384 486,-390 486,-390 486,-445 486,-445 486,-451 480,-457 474,-457\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"331,-426.5 479,-426.5 \"/>\n<text text-anchor=\"start\" x=\"381.5\" y=\"-435.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"331,-403.5 331,-426.5 378,-426.5 378,-403.5 331,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"331,-403.5 378,-403.5 378,-426.5 331,-426.5 \"/>\n<text text-anchor=\"start\" x=\"335\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"378,-403.5 378,-426.5 432,-426.5 432,-403.5 378,-403.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"378,-403.5 378,-426.5 432,-426.5 432,-403.5 378,-403.5\"/>\n<text text-anchor=\"start\" x=\"382\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"432,-403.5 432,-426.5 479,-426.5 479,-403.5 432,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"479,-426.5 432,-426.5 432,-403.5 479,-403.5 \"/>\n<text text-anchor=\"start\" x=\"436\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"378,-384.5 378,-403.5 \"/>\n<text text-anchor=\"start\" x=\"335\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"432,-384.5 432,-403.5 \"/>\n<text text-anchor=\"start\" x=\"382\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"435\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M327.93,-377.97C308.35,-368.18 286.82,-357.41 265.54,-346.77\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"266.95,-343.56 256.44,-342.22 263.82,-349.82 266.95,-343.56\"/>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node7\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M593.5,-179.5C593.5,-179.5 332.5,-179.5 332.5,-179.5 326.5,-179.5 320.5,-173.5 320.5,-167.5 320.5,-167.5 320.5,-93.5 320.5,-93.5 320.5,-87.5 326.5,-81.5 332.5,-81.5 332.5,-81.5 593.5,-81.5 593.5,-81.5 599.5,-81.5 605.5,-87.5 605.5,-93.5 605.5,-93.5 605.5,-167.5 605.5,-167.5 605.5,-173.5 599.5,-179.5 593.5,-179.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"328,-149.5 599,-149.5 \"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-158.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"328,-126.5 328,-149.5 421,-149.5 421,-126.5 328,-126.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"328,-126.5 421,-126.5 421,-149.5 328,-149.5 \"/>\n<text text-anchor=\"start\" x=\"332\" y=\"-134.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"421,-126.5 421,-149.5 526,-149.5 526,-126.5 421,-126.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"421,-126.5 421,-149.5 526,-149.5 526,-126.5 421,-126.5\"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-134.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"526,-126.5 526,-149.5 599,-149.5 599,-126.5 526,-126.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"599,-149.5 526,-149.5 526,-126.5 599,-126.5 \"/>\n<text text-anchor=\"start\" x=\"530\" y=\"-134.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"421,-107.5 421,-126.5 \"/>\n<text text-anchor=\"start\" x=\"332\" y=\"-114.5\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"526,-107.5 526,-126.5 \"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-114.5\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"529\" y=\"-114.5\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"421,-88.5 421,-107.5 \"/>\n<text text-anchor=\"start\" x=\"332\" y=\"-95.5\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"526,-88.5 526,-107.5 \"/>\n<text text-anchor=\"start\" x=\"425\" y=\"-95.5\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"529\" y=\"-95.5\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge7\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M448.74,-377.61C457.81,-367.05 466.1,-354.93 471,-342 489.59,-292.99 484.85,-232.87 477.09,-189.45\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"480.52,-188.79 475.22,-179.62 473.65,-190.09 480.52,-188.79\"/>\n</g>\n<!-- Production -->\n<g id=\"node5\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M290.5,-189C290.5,-189 43.5,-189 43.5,-189 37.5,-189 31.5,-183 31.5,-177 31.5,-177 31.5,-84 31.5,-84 31.5,-78 37.5,-72 43.5,-72 43.5,-72 290.5,-72 290.5,-72 296.5,-72 302.5,-78 302.5,-84 302.5,-84 302.5,-177 302.5,-177 302.5,-183 296.5,-189 290.5,-189\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"39,-158.5 296,-158.5 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-167.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"39,-135.5 39,-158.5 108,-158.5 108,-135.5 39,-135.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"39,-135.5 108,-135.5 108,-158.5 39,-158.5 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-135.5 108,-158.5 249,-158.5 249,-135.5 108,-135.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"108,-135.5 108,-158.5 249,-158.5 249,-135.5 108,-135.5\"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"249,-135.5 249,-158.5 296,-158.5 296,-135.5 249,-135.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"296,-158.5 249,-158.5 249,-135.5 296,-135.5 \"/>\n<text text-anchor=\"start\" x=\"253\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-116.5 108,-135.5 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"249,-116.5 249,-135.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"252\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-97.5 108,-116.5 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"249,-97.5 249,-116.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"252\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-78.5 108,-97.5 \"/>\n<text text-anchor=\"start\" x=\"43\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"249,-78.5 249,-97.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"252\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge3\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150.9,-224.98C152.36,-216.54 153.87,-207.77 155.35,-199.14\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"158.83,-199.56 157.08,-189.11 151.93,-198.37 158.83,-199.56\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M450,-323C450,-323 312,-323 312,-323 306,-323 300,-317 300,-311 300,-311 300,-256 300,-256 300,-250 306,-244 312,-244 312,-244 450,-244 450,-244 456,-244 462,-250 462,-256 462,-256 462,-311 462,-311 462,-317 456,-323 450,-323\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-292.5 455,-292.5 \"/>\n<text text-anchor=\"start\" x=\"337\" y=\"-301.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"307,-269.5 307,-292.5 354,-292.5 354,-269.5 307,-269.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-269.5 354,-269.5 354,-292.5 307,-292.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"354,-269.5 354,-292.5 408,-292.5 408,-269.5 354,-269.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"354,-269.5 354,-292.5 408,-292.5 408,-269.5 354,-269.5\"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"408,-269.5 408,-292.5 455,-292.5 455,-269.5 408,-269.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"455,-292.5 408,-292.5 408,-269.5 455,-269.5 \"/>\n<text text-anchor=\"start\" x=\"412\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"354,-250.5 354,-269.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"408,-250.5 408,-269.5 \"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"411\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge4\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M326.17,-243.81C305.12,-228.96 280.51,-211.59 257.01,-195.01\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"258.95,-192.1 248.76,-189.19 254.91,-197.82 258.95,-192.1\"/>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge8\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M402.12,-243.61C411.21,-226.87 422.03,-206.95 432,-188.58\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"435.12,-190.17 436.82,-179.71 428.97,-186.83 435.12,-190.17\"/>\n</g>\n<!-- CAProduction -->\n<g id=\"node6\" class=\"node\">\n<title>CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M364.5,-36C364.5,-36 265.5,-36 265.5,-36 259.5,-36 253.5,-30 253.5,-24 253.5,-24 253.5,-12 253.5,-12 253.5,-6 259.5,0 265.5,0 265.5,0 364.5,0 364.5,0 370.5,0 376.5,-6 376.5,-12 376.5,-12 376.5,-24 376.5,-24 376.5,-30 370.5,-36 364.5,-36\"/>\n<text text-anchor=\"start\" x=\"260.5\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAProduction</text>\n</g>\n<!-- Production&#45;&gt;CAProduction -->\n<g id=\"edge6\" class=\"edge\">\n<title>Production&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M244.03,-71.98C258.16,-61.43 272.15,-51 283.92,-42.21\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"286.14,-44.91 292.06,-36.12 281.96,-39.3 286.14,-44.91\"/>\n</g>\n<!-- CellularAutomaton&#45;&gt;CAProduction -->\n<g id=\"edge5\" class=\"edge\">\n<title>CellularAutomaton&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M398.52,-81.35C380.24,-67.71 361.19,-53.48 345.9,-42.07\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"347.93,-39.21 337.82,-36.04 343.74,-44.82 347.93,-39.21\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"The CAProduction component gives production that depends on the provided CA.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">file:<i>src/Components/CAProduction.jl</i></div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@compose module CAProduction\n    @mixin TimeIntegration, CellularAutomaton, Production\n    using ..Common\n    using ..Production: production_rate, insolation\n    using ..WaterDepth: water_depth\n    using Logging\n\n    function production(input::AbstractInput)\n        w = water_depth(input)\n        na = [CartesianIndex()]\n        output_ = Array{Amount, 3}(undef, n_facies(input), input.box.grid_size...)\n\n        w = water_depth(input)\n        s = insolation(input)\n        n_f = n_facies(input)\n        facies = input.facies\n        dt = input.time.Δt\n\n        function p(state::AbstractState, wd::AbstractMatrix)::Array{Amount,3}\n            output::Array{Amount, 3} = output_\n            insolation::typeof(1.0u\"W/m^2\") = s(state)\n            for i in eachindex(IndexCartesian(), wd)\n                for f in 1:n_f\n                    output[f, i[1], i[2]] = f != state.ca[i] ? 0.0u\"m\" :\n                    capped_production(insolation, facies[f], wd[i], dt)\n                end\n            end\n            return output\n        end\n\n        @inline p(state::AbstractState) = p(state, w(state))\n\n        return p\n    end\nend","category":"page"},{"location":"components/production/#Tests","page":"Production","title":"Tests","text":"","category":"section"},{"location":"components/production/#If-production-is-higher-in-shallower-water","page":"Production","title":"If production is higher in shallower water","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">⪡production-spec⪢≣</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@testset \"Components/Production\" begin\n    let facies = Facies(\n            maximum_growth_rate = 500u\"m/Myr\",\n            extinction_coefficient = 0.8u\"m^-1\",\n            saturation_intensity = 60u\"W/m^2\"),\n        input = Input(\n            box = Box{Periodic{2}}(grid_size=(10, 1), phys_scale=1.0u\"m\"),\n            time = TimeProperties(Δt=1.0u\"kyr\", steps=10),\n            sea_level = t -> 0.0u\"m\",\n            initial_topography = (x, y) -> -10u\"m\",\n            subsidence_rate = 0.0u\"m/Myr\",\n            facies = [facies],\n            insolation = 400.0u\"W/m^2\")\n\n        state = initial_state(input)\n        prod = uniform_production(input)(state)\n        @test all(prod[1:end-1,:] .>= prod[2:end,:])\n    end\nend","category":"page"},{"location":"components/production/#Variable-insolation","page":"Production","title":"Variable insolation","text":"","category":"section"},{"location":"components/production/","page":"Production","title":"Production","text":"If insolation increases linearly with time, production at t = 10 should be higher than at t = 1.","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">⪡production-spec⪢≣</div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"@testset \"Components/Production/variable_insolation\" begin\n    let facies = Facies(\n            maximum_growth_rate = 500u\"m/Myr\",\n            extinction_coefficient = 0.8u\"m^-1\",\n            saturation_intensity = 60u\"W/m^2\"),\n        input = Input(\n            box = Box{Periodic{2}}(grid_size=(10, 1), phys_scale=1.0u\"m\"),\n            time = TimeProperties(Δt=1.0u\"kyr\", steps=10),\n            sea_level = t -> 0.0u\"m\",\n            initial_topography = (x, y) -> -10u\"m\",\n            subsidence_rate = 0.0u\"m/Myr\",\n            facies = [facies],\n            insolation = t -> 40.0u\"W/m^2/kyr\" * t)\n\n        state = initial_state(input)\n        state.step = 1\n        prod1 = copy(uniform_production(input)(state))\n        state.step = 10\n        prod2 = copy(uniform_production(input)(state))\n        @test all(prod2 .> prod1)\n    end\nend","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"<div class=\"noweb-label\">file:<i>test/Components/ProductionSpec.jl</i></div>","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"module ProductionSpec\n    using Test\n    using CarboKitten.Components.Common\n    using CarboKitten.Components.Production: Facies, Input, uniform_production\n    using CarboKitten.Components.WaterDepth: initial_state\n\n    <<production-spec>>\nend","category":"page"},{"location":"components/production/","page":"Production","title":"Production","text":"","category":"page"},{"location":"active-layer-transport/#Active-Layer-Transport","page":"Active Layer Transport","title":"Active Layer Transport","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The following is inspired on well-known active layer approaches in river bed sediment transport [4] [5] [1]. All quantities with subscript f are facies dependent. Sediment is measured in meters of deposited material. P_f is the production of sediment per facies in ms. Further unit calculations would be more readable if we consider the unit of sediment as separate, so for instance it doesn't cancel against m^2 in the units of sediment flux. In the implementation, nu has the units of rm m which is totaly weird. TBC","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"[1]: Literature on active (or mixing) layer transport modeling is vast. Most of which is concerned with much smaller time scales, and more complicated physics than we are mostly dealing with.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"In a model without transport, we could write","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"sigma + sum_f partial eta_f over partial t = sum_f P_f","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"where sigma is the subsidence rate in ms. We consider the mass balance for each facies separately.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"We suppose that loose sediment, either fresh production or disintegrated older sediment, is being transported in a layer on top of the sea bed. The flux in this layer is assumed to be directly proportional to the local slope of the sea bed  nabla_x eta_* , where eta_* = sum_f eta_f, the sum over all facies contributions, including eta_0, the initial bedrock eleveation.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Schematic of Active Layer approach)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The active layer now contains a concentration C_f particles of different grain size (for each facies f). If needed, C_f = alpha_f P_f where alpha_f is some facies parameter determining the fraction of production that is available for transport. The sediment flux is given as,","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"bf q_f = -nu_f C_f bf nabla_x eta_*","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The following is the mass balance:","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"sigma + partial eta_* over partial t = -sum_f bf nabla_x cdot bf q_f + sum_f P_f","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"In our modelling we keep track of individual contributions per facies over time [2].","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"[2]: Note that in other approaches to active layer transport, like Paola 1992, there would be a factor 1C_f. Here we have a different interpretation to what the concentration means: the sediment settles down after transport, such that the concentration has no impact on the change in sediment surface elevation.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Combining these equations, and ignoring subsidence for the moment (which is a global effect and can't be expressed on a per-facies basis), we get a component-wise diffusion equation","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"partial eta_f(x)overpartial t = bf nabla_x cdot big nu_f alpha_f P_f(x) bf nabla_x eta_*(x) big + P_f(x)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"In our model we need to solve this equation one time-step each iteration. If we solve this using forward methods, we should be reminded of the CFL limit for diffusion equations (depending on the diffusion constants and grid size we shouldn't pick the time steps too large). Alternatively, for these two-dimensional situations, an implicit approach is feasible. Also we should take care that somehow nabla(nualpha P nabla eta) + P  0. The interpretation being that we can't transport more than we produce, even if there is capacity to do so.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"To solve this equation, it is nicer to expand the transport-diffusion term using the product rule, in short notation:","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"partial_t eta_f = nu nabla P_f(x) cdot nabla eta(x) + nu P_f(x) nabla^2 eta(x) + P_f(x)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"where nu = nu_f alpha_f","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"So we have a advection component with velocity nu nabla P_f and a diffusion component with a coefficient nu P_f.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"As part of the production P_f we disintegrate older sediment at a fixed rate.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Schema of active layer processes)","category":"page"},{"location":"active-layer-transport/#Test-1:-production-transport","page":"Active Layer Transport","title":"Test 1: production transport","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Suppose we have an incline in one direction, as per usual on a coastal slice. Production is happening in a circular patch in our box, with constant rate. In addition, we'll release the top 1m of sediment for further transport.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<details><summary>Test model</summary>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/active-layer.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"module ActiveLayer\n\nusing Unitful\nusing CarboKitten.Config: Box, axes\nusing CarboKitten.BoundaryTrait: Shelf\nusing CarboKitten.Utility: in_units_of\nusing CarboKitten.Transport.ActiveLayer: pde_stencil, Amount, Rate\n\n<<example-active-layer>>\n\nend","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"</details>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Our input structure facilitates a single facies, specifying an initial bedrock elevation, sediment layer and a function for a location dependent constant production rate. The transport is parametrized by a disintegration rate and a diffusion coefficient.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡example-active-layer⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"@kwdef struct Input\n    box\n    Δt::typeof(1.0u\"Myr\")\n    t_end::typeof(1.0u\"Myr\")\n    initial_topography   # function (x::u\"m\", y::u\"m\") -> u\"m\"\n    initial_sediment    # function (x::u\"m\", y::u\"m\") -> u\"m\"\n    production          # function (x::u\"m\", y::u\"m\") -> u\"m/s\"\n    disintegration_rate::typeof(1.0u\"m/Myr\")\n    subsidence_rate::typeof(1.0u\"m/Myr\")\n    diffusion_coefficient::typeof(1.0u\"m/yr\")\nend","category":"page"},{"location":"active-layer-transport/#Production-patch","page":"Active Layer Transport","title":"Production patch","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Establish a grid of 100x50, 15km on each side, dropping from 0 to 50m depth. Keeping the disintegration rate to a similar value as the production rate seems a sensible choice.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡example-active-layer⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"production_patch(center, radius, rate) = function(x, y)\n    (pcx, pcy) = center\n    (x - pcx)^2 + (y - pcy)^2 < radius^2 ?\n        rate :\n        0.0u\"m/Myr\"\nend\n\nconst input = Input(\n    box=Box{Shelf}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n    Δt=0.001u\"Myr\",\n    t_end=1.0u\"Myr\",\n\n    initial_topography = (x, y) -> -x / 300.0,\n    initial_sediment = (x, y) -> 0.0u\"m\",\n\n    production = production_patch(\n        (5000.0u\"m\", 3750.0u\"m\"),\n        2.0u\"km\",\n        50.0u\"m/Myr\"),\n\n    disintegration_rate = 50.0u\"m/Myr\",\n    subsidence_rate = 50.0u\"m/Myr\",\n\n    diffusion_coefficient = 10.0u\"m/yr\"\n)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Production patch on an inclining bedrock)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/active-layer-plot-production.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| requires: examples/transport/active-layer.jl\n#| creates: docs/src/_fig/active-layer-production-patch.png\n#| collect: figures\n\ninclude(\"active-layer.jl\")\nusing Unitful\nusing CarboKitten.Config: axes\nusing CarboKitten.Utility: in_units_of\nusing CairoMakie\nusing .ActiveLayer: input\n\nfunction main()\n  (x, y) = axes(input.box)\n  η = input.initial_topography.(x, y')\n  p = input.production.(x, y')\n\n  fig = Figure()\n  ax = Axis3(fig[1,1], xlabel=\"x (km)\", ylabel=\"y (km)\", zlabel=\"η (m)\", azimuth=5π/3)\n  surface!(ax, x |> in_units_of(u\"km\"), y |> in_units_of(u\"km\"), η |> in_units_of(u\"m\"), color = p |> in_units_of(u\"m/Myr\"))\n  save(\"docs/src/_fig/active-layer-production-patch.png\", fig)\nend\n\nmain()","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"</details>","category":"page"},{"location":"active-layer-transport/#Solving-the-PDE","page":"Active Layer Transport","title":"Solving the PDE","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Just as a reminder:","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"partial_t eta_f = nu nabla P_f(x) cdot nabla eta(x) + nu P_f(x) nabla^2 eta(x) + P_f(x)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Below is the kernel encoding a central differencing scheme i.e. [-1, 0, 1]/(2Δx) for first derivative and [0 -1 0; -1 4 -1; 0 -1 0]/Δx^2 for the laplacian.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>src/Transport/ActiveLayer.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"module ActiveLayer\n\nusing Unitful\nusing StaticArrays\nusing ...BoundaryTrait\nusing ...Boxes: Box\nusing ...Stencil: stencil!\n\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Amount = typeof(1.0u\"m\")\n\nfunction pde_stencil(box::Box{BT}, Δt, ν, out, η, C) where {BT<:Boundary{2}}\n    Δx = box.phys_scale\n    d = ν * Δt\n\n    stencil!(BT, Size(3, 3), out, η, C) do η, C\n        adv = d * ((η[3, 2] - η[1, 2]) * (C[3, 2] - C[1, 2]) +\n                   (η[2, 3] - η[2, 1]) * (C[2, 3] - C[2, 1])) /\n              (2Δx)^2\n\n        dif = d * C[2, 2] * (η[3, 2] + η[2, 3] + η[1, 2] +\n                             η[2, 1] - 4 * η[2, 2]) / (Δx)^2\n\n        prd = C[2, 2]\n\n        max(0.0u\"m\", adv + dif + prd)\n    end\nend\n\nend","category":"page"},{"location":"active-layer-transport/#Model-loop","page":"Active Layer Transport","title":"Model loop","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Every iteration we determine the maximum disintegrated sediment. If the total amount of sediment is smaller than the maximum, then that amount is disintegrated instead. We compute the concentrations in the active layer in terms of amounts of sediment, so P Delta t. Since P appears in every term of the PDE, we're free to do so.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡example-active-layer⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"mutable struct State\n    time::typeof(1.0u\"Myr\")\n    sediment::Matrix{typeof(1.0u\"m\")}\nend\n\nfunction initial_state(input)\n    x, y = axes(input.box)\n    State(0.0u\"Myr\", input.initial_sediment.(x, y'))\nend\n\nstruct Frame\n    t::typeof(1.0u\"Myr\")\n    δ::Matrix{Amount}\nend\n\nfunction propagator(input)\n    δ = Matrix{Amount}(undef, input.box.grid_size...)\n    x, y = axes(input.box)\n    μ0 = input.initial_topography.(x, y')\n    box = input.box\n    Δt = input.Δt\n    disintegration_rate = input.disintegration_rate\n    production = input.production\n    d = input.diffusion_coefficient\n\n    function active_layer(state)\n        max_amount = disintegration_rate * Δt\n        amount = min.(max_amount, state.sediment)\n        state.sediment .-= amount\n\n        production.(x, y') * Δt .+ amount\n    end\n\n    function (state)\n        p = active_layer(state)\n        pde_stencil(box, Δt, d, δ, state.sediment .+ μ0, p)\n        return Frame(state.time, δ)\n    end\nend\n\nfunction run_model(input)\n    state = initial_state(input)\n    prop = propagator(input)\n\n    Channel{State}() do ch\n        while state.time < input.t_end\n            Δ = prop(state)\n            state.sediment .+= Δ.δ\n            state.time += input.Δt\n            put!(ch, state)\n        end\n    end\nend","category":"page"},{"location":"active-layer-transport/#Running-the-model","page":"Active Layer Transport","title":"Running the model","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"We run the model with 1000 time steps but only inspect one in every 100.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Active layer test)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/active-layer-plot-result.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| requires: examples/transport/active-layer.jl\n#| creates: docs/src/_fig/active-layer-test.png\n#| collect: figures\n\nmodule ActiveLayerPlot\n\ninclude(\"active-layer.jl\")\nusing CairoMakie\nusing Unitful\nusing CarboKitten.Config: axes\nusing CarboKitten.Utility: in_units_of\nusing .ActiveLayer: input, run_model\n\nfunction main()\n  result = Iterators.map(deepcopy,\n      Iterators.filter(x -> mod(x[1], 100) == 0, enumerate(run_model(input)))) |> collect\n\n    (x, y) = axes(input.box)\n    η = input.initial_topography.(x, y') .+ result[10][2].sediment .- input.subsidence_rate * result[10][2].time\n    # p = input.production.(x, y')\n\n    fig = Figure(size=(800, 1000))\n    ax = Axis3(fig[1:2,1], xlabel=\"x (km)\", ylabel=\"y (km)\", zlabel=\"η (m)\", azimuth=5π/3)\n    surface!(ax, x |> in_units_of(u\"km\"), y |> in_units_of(u\"km\"), η |> in_units_of(u\"m\"))\n\n    ax2 = Axis(fig[3,1], xlabel=\"x (km)\", ylabel=\"η (m)\")\n\n    for i in 1:10\n        η = input.initial_topography.(x, y') .+ result[i][2].sediment .- input.subsidence_rate * result[i][2].time\n\n        lines!(ax2, x |> in_units_of(u\"km\"), η[:, 25] |> in_units_of(u\"m\"))\n    end\n\n    save(\"docs/src/_fig/active-layer-test.png\", fig)\nend\n\nend\n\nActiveLayerPlot.main()","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"</details>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"Note in the bottom figure, due to sedimentation not keeping up with subsidence, the lines go down in time. We see the sediment transport being favoured to downslope areas, which is what we want. This effect could be made more extreme by increasing the disintegration rate.","category":"page"},{"location":"active-layer-transport/#One-dimensional-tests","page":"Active Layer Transport","title":"One-dimensional tests","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/plot-1d-evolution.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<<plot-1d-evolution>>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">⪡plot-1d-evolution⪢≣</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"using Printf: @sprintf\nusing Unitful: ustrip\n\nfunction plot_1d_evolution!(ax::Axis, input, every=100)\n\ty_idx = 1\n\t(x, y) = box_axes(input.box)\n\tstate = ALCAP.initial_state(input)\n\n\tplot_state() = begin\n\t\tt = state.step * input.time.Δt\n\t\tη = input.initial_topography.(x, y') .+ \n            state.sediment_height .-\n            input.subsidence_rate * t\n\t\tlines!(ax, x |> in_units_of(u\"km\"), η[:, y_idx] |> in_units_of(u\"m\"),\n               label=@sprintf(\"%.3f Myr\", ustrip(t)))\n\tend\n\n\tplot_state()\n\trun_model(Model{ALCAP}, input, state) do i, _\n\t\tif mod(i, every) == 0\n\t\t\tplot_state()\n\t\tend\n\tend\nend\n\nfunction plot_1d_evolution(input, every=100)\n\tfig = Figure()\n\tax = Axis(fig[1, 1], xlabel=\"x (km)\", ylabel=\"η (m)\")\n\n    plot_1d_evolution!(ax, input, every)\n\n\tLegend(fig[1, 2], ax)\n\n\tfig\nend","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>src/Testing.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"module Testing\n\nusing ..CarboKitten\nusing ..Models.ALCAP\nusing Unitful\nusing GeometryBasics\n\ntransport_test_input(;\n\tinitial_topography = (x, y) -> 0.0u\"m\",\n\tinitial_sediment = (x, y) -> 0.0u\"m\",\n\tdisintegration_rate = 50.0u\"m/Myr\",\n\tsubsidence_rate = 0.0u\"m/Myr\",\n\tdiffusion_coefficient = 0.0u\"m/yr\",\n\twave_velocity = _ -> (Vec2(0.0, 0.0)u\"m/yr\", Vec2(0.0, 0.0)u\"1/yr\"),\n    intertidal_zone = 0.0u\"m\") =\n\n\tALCAP.Input(\n\t\tbox = CarboKitten.Box{Coast}(grid_size=(120, 1), phys_scale=125.0u\"m\"),\n\t\ttime = TimeProperties(\n\t\t\tΔt = 0.001u\"Myr\",\n\t\t\tsteps = 1000),\n\t\tfacies = [ALCAP.Facies(\n\t\t\tinitial_sediment = initial_sediment,\n\t\t\tdiffusion_coefficient = diffusion_coefficient,\n\t\t\twave_velocity = wave_velocity,\n\t\t\tmaximum_growth_rate = 0.0u\"m/Myr\",\n\t\t\textinction_coefficient = 0.8u\"m^-1\",\n\t\t\tsaturation_intensity = 60u\"W/m^2\"\n\t\t)],\n\t\tdisintegration_rate = disintegration_rate,\n\t\tinitial_topography = initial_topography,\n\t\tinsolation = 400.0u\"W/m^2\",\n\t\tsediment_buffer_size = 5,\n\t\tdepositional_resolution = 1000.0u\"m\",\n\t\ttransport_solver = Val{:forward_euler},\n        subsidence_rate = subsidence_rate,\n        intertidal_zone = intertidal_zone)\n\nend","category":"page"},{"location":"active-layer-transport/#Erosion","page":"Active Layer Transport","title":"Erosion","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The erosion scenario tests that sharp sediment profiles erode under diffusive transport.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: Erosion)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/1d-erosion.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| creates: docs/src/_fig/1d-erosion.svg\n#| collect: figures\n\nmodule Script\n    using CarboKitten\n    using CarboKitten.Testing: transport_test_input\n    using CairoMakie\n\n    include(\"plot-1d-evolution.jl\")\n\n\tfunction initial_sediment(x, y)\n\t  if x < 5.0u\"km\"\n\t    return 30.0u\"m\"\n\t  end\n\n\t  if x > 10.0u\"km\" && x < 11.0u\"km\"\n\t    return 20.0u\"m\"\n\t  end\n\n\t  return 5.0u\"m\"\n\tend\n\n    function main()\n        CairoMakie.activate!()\n        input = transport_test_input(\n            initial_topography = (x, y) -> -30.0u\"m\",\n            initial_sediment = initial_sediment,\n            diffusion_coefficient = 10.0u\"m/yr\")\n\n        fig = plot_1d_evolution(input, 250)\n        save(\"docs/src/_fig/1d-erosion.svg\", fig)\n    end\nend\n\nScript.main()","category":"page"},{"location":"active-layer-transport/#Advection","page":"Active Layer Transport","title":"Advection","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"To test advective properties, we set disintegration rate to infinity, This way, surface gradients are zero and we get pure advection.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: advection)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/1d-advection.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| creates: docs/src/_fig/1d-advection.svg\n#| collect: figures\n\nmodule Script\n    using CarboKitten\n    using CarboKitten.Testing: transport_test_input\n    using CairoMakie\n\n    include(\"plot-1d-evolution.jl\")\n\n    function gaussian_initial_sediment(x, y)\n        exp(-(x-10u\"km\")^2 / (2 * (0.5u\"km\")^2)) * 30.0u\"m\"\n    end\n\n    v_const(v_max) = _ -> (Vec2(v_max, 0.0u\"m/yr\"), Vec2(0.0u\"1/yr\", 0.0u\"1/yr\"))\n\n    function main()\n        CairoMakie.activate!()\n        input = transport_test_input(\n            initial_topography = (x, y)  -> -30.0u\"m\",\n            initial_sediment = gaussian_initial_sediment,\n            disintegration_rate = 50000.0u\"m/Myr\",\n            wave_velocity = v_const(-5u\"km/Myr\")\n        )\n\n        fig = plot_1d_evolution(input, 250)\n        save(\"docs/src/_fig/1d-advection.svg\", fig)\n    end\nend\n\nScript.main()","category":"page"},{"location":"active-layer-transport/#Onshore-transport","page":"Active Layer Transport","title":"Onshore transport","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"This test shows the difference between having a velocity profile without and with shear.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: onshore)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/1d-onshore.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| creates: docs/src/_fig/1d-onshore.svg\n#| collect: figures\n\nmodule Script\n    using CarboKitten\n    using CarboKitten.Testing: transport_test_input\n    using CairoMakie\n\n    include(\"plot-1d-evolution.jl\")\n\n    v_prof(v_max, max_depth, w) = \n        let k = sqrt(0.5) / max_depth,\n            A = 3.331 * v_max,\n            α = tanh(k * w),\n            β = exp(-k * w)\n            (A * α * β, -A * k * β * (1 - α - α^2))\n        end\n\n    v_const(v_max) = _ -> (Vec2(v_max, 0.0u\"m/yr\"), Vec2(0.0u\"1/yr\", 0.0u\"1/yr\"))\n\n    v_prof_par(v_max, max_depth) = w -> let (v, s) = v_prof(v_max, max_depth, w)\n        (Vec2(v, 0.0u\"m/yr\"), Vec2(s, 0.0u\"1/yr\"))\n    end\n\n    function main()\n        CairoMakie.activate!()\n\n        fig = Figure(size=(1000, 500))\n        ax1 = Axis(fig[1, 1], xlabel=\"x (km)\", ylabel=\"η (m)\")\n        input1 = transport_test_input(\n            initial_topography = (x, y) -> -x / 375.0 - 10u\"m\",\n            initial_sediment = 10.0u\"m\",\n            disintegration_rate = 50.0u\"m/Myr\",\n            diffusion_coefficient = 5.0u\"m/yr\",\n            wave_velocity = v_const(-0.5u\"m/yr\")\n        )\n        plot_1d_evolution!(ax1, input1, 250)\n\n        ax2 = Axis(fig[1, 2], xlabel=\"x (km)\", ylabel=\"η (m)\")\n        input2 = transport_test_input(\n            initial_topography = (x, y) -> -x / 375.0 - 10u\"m\",\n            initial_sediment = 10.0u\"m\",\n            disintegration_rate = 50.0u\"m/Myr\",\n            diffusion_coefficient = 5.0u\"m/yr\",\n            wave_velocity = v_prof_par(-0.5u\"m/yr\", 20u\"m\")\n        )\n        plot_1d_evolution!(ax2, input2, 250)\n\n        Legend(fig[1, 3], ax2)\n        save(\"docs/src/_fig/1d-onshore.svg\", fig)\n    end\nend\n\nScript.main()","category":"page"},{"location":"active-layer-transport/#Active-Layer-Component","page":"Active Layer Transport","title":"Active Layer Component","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"800pt\" height=\"431pt\"\n viewBox=\"0.00 0.00 800.00 431.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 427)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-427 796,-427 796,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M210,-423C210,-423 72,-423 72,-423 66,-423 60,-417 60,-411 60,-411 60,-356 60,-356 60,-350 66,-344 72,-344 72,-344 210,-344 210,-344 216,-344 222,-350 222,-356 222,-356 222,-411 222,-411 222,-417 216,-423 210,-423\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-392.5 215,-392.5 \"/>\n<text text-anchor=\"start\" x=\"75.5\" y=\"-401.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"67,-369.5 67,-392.5 114,-392.5 114,-369.5 67,-369.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-369.5 114,-369.5 114,-392.5 67,-392.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-377.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"114,-369.5 114,-392.5 168,-392.5 168,-369.5 114,-369.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"114,-369.5 114,-392.5 168,-392.5 168,-369.5 114,-369.5\"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-377.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"168,-369.5 168,-392.5 215,-392.5 215,-369.5 168,-369.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"215,-392.5 168,-392.5 168,-369.5 215,-369.5 \"/>\n<text text-anchor=\"start\" x=\"172\" y=\"-377.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"114,-350.5 114,-369.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-357.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"168,-350.5 168,-369.5 \"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-357.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"171\" y=\"-357.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node2\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M270,-308C270,-308 12,-308 12,-308 6,-308 0,-302 0,-296 0,-296 0,-203 0,-203 0,-197 6,-191 12,-191 12,-191 270,-191 270,-191 276,-191 282,-197 282,-203 282,-203 282,-296 282,-296 282,-302 276,-308 270,-308\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-277.5 275,-277.5 \"/>\n<text text-anchor=\"start\" x=\"93.5\" y=\"-286.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-254.5 7,-277.5 124,-277.5 124,-254.5 7,-254.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-254.5 124,-254.5 124,-277.5 7,-277.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-262.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"124,-254.5 124,-277.5 178,-277.5 178,-254.5 124,-254.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"124,-254.5 124,-277.5 178,-277.5 178,-254.5 124,-254.5\"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-262.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"178,-254.5 178,-277.5 275,-277.5 275,-254.5 178,-254.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-277.5 178,-277.5 178,-254.5 275,-254.5 \"/>\n<text text-anchor=\"start\" x=\"182\" y=\"-262.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-235.5 124,-254.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-242.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-235.5 178,-254.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-242.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-242.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-216.5 124,-235.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-216.5 178,-235.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-197.5 124,-216.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-197.5 178,-216.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-204.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M141,-343.97C141,-335.98 141,-327.34 141,-318.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"144.5,-318.47 141,-308.47 137.5,-318.47 144.5,-318.47\"/>\n</g>\n<!-- ActiveLayer -->\n<g id=\"node6\" class=\"node\">\n<title>ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M544.5,-155C544.5,-155 217.5,-155 217.5,-155 211.5,-155 205.5,-149 205.5,-143 205.5,-143 205.5,-12 205.5,-12 205.5,-6 211.5,0 217.5,0 217.5,0 544.5,0 544.5,0 550.5,0 556.5,-6 556.5,-12 556.5,-12 556.5,-143 556.5,-143 556.5,-149 550.5,-155 544.5,-155\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"213,-124.5 550,-124.5 \"/>\n<text text-anchor=\"start\" x=\"335.5\" y=\"-133.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">ActiveLayer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"213,-101.5 213,-124.5 336,-124.5 336,-101.5 213,-101.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"213,-101.5 336,-101.5 336,-124.5 213,-124.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-109.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"336,-101.5 336,-124.5 471,-124.5 471,-101.5 336,-101.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"336,-101.5 336,-124.5 471,-124.5 471,-101.5 336,-101.5\"/>\n<text text-anchor=\"start\" x=\"340\" y=\"-109.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"471,-101.5 471,-124.5 550,-124.5 550,-101.5 471,-101.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"550,-124.5 471,-124.5 471,-101.5 550,-101.5 \"/>\n<text text-anchor=\"start\" x=\"475\" y=\"-109.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"336,-82.5 336,-101.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-89.5\" font-family=\"monospace\" font-size=\"10.00\">intertidal_zone</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"471,-82.5 471,-101.5 \"/>\n<text text-anchor=\"start\" x=\"340\" y=\"-89.5\" font-family=\"monospace\" font-size=\"10.00\">diffusion_coefficient</text>\n<text text-anchor=\"start\" x=\"474\" y=\"-89.5\" font-family=\"monospace\" font-size=\"10.00\">active_layer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"336,-63.5 336,-82.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-70.5\" font-family=\"monospace\" font-size=\"10.00\">disintegration_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"471,-63.5 471,-82.5 \"/>\n<text text-anchor=\"start\" x=\"340\" y=\"-70.5\" font-family=\"monospace\" font-size=\"10.00\">wave_velocity</text>\n<text text-anchor=\"start\" x=\"474\" y=\"-70.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"336,-44.5 336,-63.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">cementation_time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"471,-44.5 471,-63.5 \"/>\n<text text-anchor=\"start\" x=\"340\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"474\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"336,-25.5 336,-44.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\">transport_solver</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"471,-25.5 471,-44.5 \"/>\n<text text-anchor=\"start\" x=\"340\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"474\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"336,-6.5 336,-25.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">transport_substeps</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"471,-6.5 471,-25.5 \"/>\n<text text-anchor=\"start\" x=\"340\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"474\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;ActiveLayer -->\n<g id=\"edge4\" class=\"edge\">\n<title>WaterDepth&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M222.25,-190.95C235.78,-181.36 250.04,-171.26 264.25,-161.2\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"266.46,-163.92 272.6,-155.29 262.41,-158.21 266.46,-163.92\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node3\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M547,-423C547,-423 409,-423 409,-423 403,-423 397,-417 397,-411 397,-411 397,-356 397,-356 397,-350 403,-344 409,-344 409,-344 547,-344 547,-344 553,-344 559,-350 559,-356 559,-356 559,-411 559,-411 559,-417 553,-423 547,-423\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"404,-392.5 552,-392.5 \"/>\n<text text-anchor=\"start\" x=\"454.5\" y=\"-401.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"404,-369.5 404,-392.5 451,-392.5 451,-369.5 404,-369.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"404,-369.5 451,-369.5 451,-392.5 404,-392.5 \"/>\n<text text-anchor=\"start\" x=\"408\" y=\"-377.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"451,-369.5 451,-392.5 505,-392.5 505,-369.5 451,-369.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"451,-369.5 451,-392.5 505,-392.5 505,-369.5 451,-369.5\"/>\n<text text-anchor=\"start\" x=\"455\" y=\"-377.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"505,-369.5 505,-392.5 552,-392.5 552,-369.5 505,-369.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"552,-392.5 505,-392.5 505,-369.5 552,-369.5 \"/>\n<text text-anchor=\"start\" x=\"509\" y=\"-377.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"451,-350.5 451,-369.5 \"/>\n<text text-anchor=\"start\" x=\"408\" y=\"-357.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"505,-350.5 505,-369.5 \"/>\n<text text-anchor=\"start\" x=\"455\" y=\"-357.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"508\" y=\"-357.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M396.85,-350.71C365.3,-338.35 328.09,-323.78 291.97,-309.63\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"292.91,-306.24 282.32,-305.85 290.35,-312.76 292.91,-306.24\"/>\n</g>\n<!-- SedimentBuffer -->\n<g id=\"node5\" class=\"node\">\n<title>SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M780,-298.5C780,-298.5 492,-298.5 492,-298.5 486,-298.5 480,-292.5 480,-286.5 480,-286.5 480,-212.5 480,-212.5 480,-206.5 486,-200.5 492,-200.5 492,-200.5 780,-200.5 780,-200.5 786,-200.5 792,-206.5 792,-212.5 792,-212.5 792,-286.5 792,-286.5 792,-292.5 786,-298.5 780,-298.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-268.5 785,-268.5 \"/>\n<text text-anchor=\"start\" x=\"573\" y=\"-277.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">SedimentBuffer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"487,-245.5 487,-268.5 634,-268.5 634,-245.5 487,-245.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-245.5 634,-245.5 634,-268.5 487,-268.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-253.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"634,-245.5 634,-268.5 688,-268.5 688,-245.5 634,-245.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"634,-245.5 634,-268.5 688,-268.5 688,-245.5 634,-245.5\"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-253.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"688,-245.5 688,-268.5 785,-268.5 785,-245.5 688,-245.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"785,-268.5 688,-268.5 688,-245.5 785,-245.5 \"/>\n<text text-anchor=\"start\" x=\"692\" y=\"-253.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"634,-226.5 634,-245.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-233.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer_size</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"688,-226.5 688,-245.5 \"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-233.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"691\" y=\"-233.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"634,-207.5 634,-226.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-214.5\" font-family=\"monospace\" font-size=\"10.00\">depositional_resolution</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"688,-207.5 688,-226.5 \"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-214.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"691\" y=\"-214.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;SedimentBuffer -->\n<g id=\"edge3\" class=\"edge\">\n<title>Boxes&#45;&gt;SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M524.12,-343.97C538.55,-331.91 554.76,-318.37 570.27,-305.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"572.87,-307.81 578.3,-298.71 568.38,-302.43 572.87,-307.81\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M450,-289C450,-289 312,-289 312,-289 306,-289 300,-283 300,-277 300,-277 300,-222 300,-222 300,-216 306,-210 312,-210 312,-210 450,-210 450,-210 456,-210 462,-216 462,-222 462,-222 462,-277 462,-277 462,-283 456,-289 450,-289\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-258.5 455,-258.5 \"/>\n<text text-anchor=\"start\" x=\"337\" y=\"-267.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"307,-235.5 307,-258.5 354,-258.5 354,-235.5 307,-235.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-235.5 354,-235.5 354,-258.5 307,-258.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-243.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"354,-235.5 354,-258.5 408,-258.5 408,-235.5 354,-235.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"354,-235.5 354,-258.5 408,-258.5 408,-235.5 354,-235.5\"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-243.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"408,-235.5 408,-258.5 455,-258.5 455,-235.5 408,-235.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"455,-258.5 408,-258.5 408,-235.5 455,-235.5 \"/>\n<text text-anchor=\"start\" x=\"412\" y=\"-243.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"354,-216.5 354,-235.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"408,-216.5 408,-235.5 \"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"411\" y=\"-223.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;ActiveLayer -->\n<g id=\"edge5\" class=\"edge\">\n<title>FaciesBase&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M381,-209.92C381,-196.58 381,-181.04 381,-165.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"384.5,-165.16 381,-155.16 377.5,-165.16 384.5,-165.16\"/>\n</g>\n<!-- SedimentBuffer&#45;&gt;ActiveLayer -->\n<g id=\"edge6\" class=\"edge\">\n<title>SedimentBuffer&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M563.95,-200.47C545.31,-188.04 524.71,-174.3 504.25,-160.67\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"506.07,-157.67 495.81,-155.04 502.19,-163.5 506.07,-157.67\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>src/Components/ActiveLayer.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"@compose module ActiveLayer\n@mixin WaterDepth, FaciesBase, SedimentBuffer\n\nexport disintegrator, transporter, cementation_factor\n\nusing ..Common\nusing CarboKitten.Transport.Advection: transport, advection_coef!, transport_dC!, max_dt\nusing CarboKitten.Transport.Solvers: runge_kutta_4, forward_euler\nusing Unitful\nusing GeometryBasics\n\n@kwdef struct Facies <: AbstractFacies\n    diffusion_coefficient::typeof(1.0u\"m/yr\") = 0.0u\"m/Myr\"\n    wave_velocity = _ -> (Vec2(0.0u\"m/Myr\", 0.0u\"m/Myr\"), Vec2(0.0u\"1/Myr\", 0.0u\"1/Myr\"))\nend\n\n@kwdef mutable struct State <: AbstractState\n    active_layer::Array{Amount, 3}\nend\n\n@kwdef struct Input <: AbstractInput\n    intertidal_zone::Height = 0.0u\"m\"\n    disintegration_rate::Rate = 50.0u\"m/Myr\"\n    cementation_time::Union{typeof(1.0u\"Myr\"), Nothing} = nothing\n    transport_solver = Val{:RK4}\n    transport_substeps = :adaptive \nend\n\ncourant_max(::Type{Val{:RK4}}) = 2.0\ncourant_max(::Type{Val{:forward_euler}}) = 1.0\n\ntransport_solver(f, _) = f\ntransport_solver(::Type{Val{:RK4}}, box) = runge_kutta_4(typeof(1.0u\"m\"), box)\ntransport_solver(::Type{Val{:forward_euler}}, _) = forward_euler\n\nfunction cementation_factor(input::AbstractInput)\n    if input.cementation_time === nothing\n        return 1.0\n    else\n        return 1.0 - exp(input.time.Δt * log(1/2) / input.cementation_time)\n    end\nend\n\nfunction adaptive_transporter(input)\n    solver = transport_solver(input.transport_solver, input.box)\n\n    w = water_depth(input)\n    box = input.box\n    Δt = input.time.Δt  # / input.transport_substeps\n    fs = input.facies\n    adv = Matrix{Vec2{Rate}}(undef, box.grid_size...)\n    rct = Matrix{typeof(1.0u\"1/Myr\")}(undef, box.grid_size...)\n    dC = Matrix{Rate}(undef, box.grid_size...)\n    cm = courant_max(input.transport_solver)\n    iz = input.intertidal_zone\n\n    return function (state)\n        wd = w(state)\n        wd .+= iz\n\n        C = state.active_layer\n        for (i, f) in pairs(fs)\n            advection_coef!(box, f.diffusion_coefficient, f.wave_velocity, wd, adv, rct)\n            m = max_dt(adv, box.phys_scale, cm)\n            steps = ceil(Int, Δt / m)\n\n            # @debug \"step $(state.step) - transport substeps $(steps)\"\n            subdt = Δt / steps\n            for j in 1:steps\n                solver(\n                    (C, _) -> transport_dC!(input.box, adv, rct, C, dC),\n                    view(C, i, :, :), TimeIntegration.time(input, state), subdt)\n            end\n        end\n\n        for i in eachindex(C)\n            if C[i] < zero(Amount)\n                C[i] = zero(Amount)\n            end\n        end\n    end\nend\n\n\"\"\"\n    disintegrator(input) -> f!\n\nPrepares the disintegration step. Returns a function `f!(state::State)`. The returned function\nmodifies the state, popping sediment from the `sediment_buffer` and returns an array of `Amount`.\n\"\"\"\nfunction disintegrator(input)\n    max_h = input.disintegration_rate * input.time.Δt\n    w = water_depth(input)\n    output = Array{Float64,3}(undef, n_facies(input), input.box.grid_size...)\n    depositional_resolution = input.depositional_resolution\n    iz = input.intertidal_zone\n\n    return function (state)\n        wn = w(state)\n        wn .+= iz\n        h = min.(max_h, state.sediment_height)\n        h[wn.<=0.0u\"m\"] .= 0.0u\"m\"\n\n        @assert all(h .<= max_h)\n        state.sediment_height .-= h\n        pop_sediment!(state.sediment_buffer, h ./ depositional_resolution .|> NoUnits, output)\n        return output .* depositional_resolution\n    end\nend\n\n\"\"\"\n    transporter(input::Input) -> f\n\nPrepares the transportation step. Returns a function `f(state::State, active_layer)`,\ntransporting the active layer, returning a transported `Amount` of sediment.\n\"\"\"\nfunction transporter(input)\n    if input.transport_substeps == :adaptive\n        return adaptive_transporter(input)\n    end\n\n    solver = transport_solver(input.transport_solver, input.box)\n\n    w = water_depth(input)\n    box = input.box\n    Δt = input.time.Δt / input.transport_substeps\n    steps = input.transport_substeps\n    fs = input.facies\n    iz = input.intertidal_zone\n\n    return function (state)\n        wd = w(state)\n        wd .+= iz\n\n        C = state.active_layer\n        for (i, f) in pairs(fs)\n            for j in 1:steps\n                solver(\n                    (C, _) -> transport(\n                        input.box, f.diffusion_coefficient, f.wave_velocity,\nC, wd),\n                    view(C, i, :, :), TimeIntegration.time(input, state), Δt)\n            end\n        end\n\n        for i in eachindex(C)\n            if C[i] < zero(Amount)\n                C[i] = zero(Amount)\n            end\n        end\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    gid = fid[\"input\"]\n    attr = attributes(gid)\n\n    attr[\"intertidal_zone\"] = input.intertidal_zone |> in_units_of(u\"m\")\n    attr[\"disintegration_rate\"] = input.disintegration_rate |> in_units_of(u\"m/Myr\")\n    if input.cementation_time !== nothing\n        attr[\"cementation_time\"] = input.cementation_time |> in_units_of(u\"Myr\")\n    end\nend\n\nend","category":"page"},{"location":"active-layer-transport/#Intertidal-zone","page":"Active Layer Transport","title":"Intertidal zone","text":"","category":"section"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"You may pass the intertidal_zone argument to define a height above sea-level where sediment is still transported.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The following test has three sediment peaks, one below sea-level, one in the intertidal zone and one above the intertidal zone. In the latter two cases, sediment is transported.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The transport_test_input has a box of 120 times 1 with a resolution of 125m (15km total). We divide the domain into three sections: dry (h  10m), intertidal (10m  h  0m) and wet zones (0m  h). The dry zone never has transport, the wet zone always has transport, but the intertidal zone only has transport enabled when we set intertidal_zone to 10u\"m\".","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"(Image: intertidal zone test)","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>examples/transport/1d-intertidal-zone.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"#| creates: docs/src/_fig/1d-intertidal.svg\n#| collect: figures\n\nmodule Script\n    using CarboKitten\n    using CarboKitten.Testing: transport_test_input\n    using CairoMakie\n\n    include(\"plot-1d-evolution.jl\")\n\n    function three_peaks(x, y)\n        sum(exp(-(x-μ)^2 / (2 * (0.5u\"km\")^2)) * 9.0u\"m\"\n            for μ in [2.5u\"km\", 7.5u\"km\", 12.5u\"km\"])\n    end\n\n    function staircase(dx, dy, y0)\n        return function (x, _)\n            floor(x / dx) * dy + y0\n        end\n    end\n\n    v_const(v_max) = _ -> (Vec2(v_max, 0.0u\"m/yr\"), Vec2(0.0u\"1/yr\", 0.0u\"1/yr\"))\n\n    function main()\n        CairoMakie.activate!()\n\n        input = transport_test_input(\n            initial_topography = staircase(5.0u\"km\", -10.0u\"m\", 10.0u\"m\"),\n            initial_sediment = three_peaks,\n            disintegration_rate = 50000.0u\"m/Myr\",\n            wave_velocity = v_const(-1u\"km/Myr\"),\n            intertidal_zone = 10u\"m\"\n        )\n\n        fig = plot_1d_evolution(input, 500)\n        save(\"docs/src/_fig/1d-intertidal.svg\", fig)\n    end\nend\n\nScript.main()","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"The following tests that we see the expected behaviours both without an intertidal zone (input1) and with (input1). The regions split at grid locations 40 and 80, so we test slices 10:30, 50:70 and 90:110. This ommits the boundaries where numeric artifacts could be encountered.","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"<div class=\"noweb-label\">file:<i>test/Transport/IntertidalZoneSpec.jl</i></div>","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"@testset \"CarboKitten.Transport.IntertidalZone\" begin\n    using CarboKitten\n    using CarboKitten.Testing: transport_test_input\n\n    function end_sediment_height(input)\n        state = ALCAP.initial_state(input)\n        run_model((_, _) -> (), Model{ALCAP}, input, state)\n        return state.sediment_height\n    end\n\n    function three_peaks(x, y)\n        sum(exp(-(x-μ)^2 / (2 * (0.5u\"km\")^2)) * 9.0u\"m\"\n            for μ in [2.5u\"km\", 7.5u\"km\", 12.5u\"km\"])\n    end\n\n    function staircase(dx, dy, y0)\n        return function (x, _)\n            floor(x / dx) * dy + y0\n        end\n    end\n\n    v_const(v_max) = _ -> (Vec2(v_max, 0.0u\"m/yr\"), Vec2(0.0u\"1/yr\", 0.0u\"1/yr\"))\n\n    input1 = transport_test_input(\n        initial_topography = staircase(5.0u\"km\", -10.0u\"m\", 10.0u\"m\"),\n        initial_sediment = three_peaks,\n        disintegration_rate = 50000.0u\"m/Myr\",\n        wave_velocity = v_const(-1u\"km/Myr\"),\n        intertidal_zone = 0u\"m\"\n    )\n\n    output1 = end_sediment_height(input1)[:, 1]\n\n    input2 = transport_test_input(\n        initial_topography = staircase(5.0u\"km\", -10.0u\"m\", 10.0u\"m\"),\n        initial_sediment = three_peaks,\n        disintegration_rate = 50000.0u\"m/Myr\",\n        wave_velocity = v_const(-1u\"km/Myr\"),\n        intertidal_zone = 10u\"m\"\n    )\n\n    output2 = end_sediment_height(input2)[:, 1]\n\n    @test output1[10:30] ≈ output1[50:70] atol=0.01u\"m\"\n    @test !isapprox(output1[50:70], output1[90:110], atol=1.0u\"m\")\n\n    @test !isapprox(output2[10:30], output2[50:70], atol=1.0u\"m\")\n    @test output2[50:70] ≈ output2[90:110] atol=0.01u\"m\"\nend","category":"page"},{"location":"active-layer-transport/","page":"Active Layer Transport","title":"Active Layer Transport","text":"","category":"page"},{"location":"components/run_model/#Running-a-Model","page":"Model Runner","title":"Running a Model","text":"","category":"section"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"350pt\" height=\"159pt\"\n viewBox=\"0.00 0.00 350.00 159.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 155)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-155 346,-155 346,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-151C150,-151 12,-151 12,-151 6,-151 0,-145 0,-139 0,-139 0,-84 0,-84 0,-78 6,-72 12,-72 12,-72 150,-72 150,-72 156,-72 162,-78 162,-84 162,-84 162,-139 162,-139 162,-145 156,-151 150,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-120.5 155,-120.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-97.5 7,-120.5 54,-120.5 54,-97.5 7,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-97.5 54,-97.5 54,-120.5 7,-120.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-97.5 108,-120.5 155,-120.5 155,-97.5 108,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-120.5 108,-120.5 108,-97.5 155,-97.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-78.5 54,-97.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-78.5 108,-97.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- Models -->\n<g id=\"node3\" class=\"node\">\n<title>Models</title>\n<path fill=\"none\" stroke=\"black\" d=\"M195,-36C195,-36 147,-36 147,-36 141,-36 135,-30 135,-24 135,-24 135,-12 135,-12 135,-6 141,0 147,0 147,0 195,0 195,0 201,0 207,-6 207,-12 207,-12 207,-24 207,-24 207,-30 201,-36 195,-36\"/>\n<text text-anchor=\"start\" x=\"142\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Models</text>\n</g>\n<!-- TimeIntegration&#45;&gt;Models -->\n<g id=\"edge2\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;Models</title>\n<path fill=\"none\" stroke=\"black\" d=\"M118.91,-71.96C128.42,-62.29 138.36,-52.18 146.99,-43.41\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"149.66,-45.69 154.18,-36.1 144.67,-40.78 149.66,-45.69\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node2\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-151C330,-151 192,-151 192,-151 186,-151 180,-145 180,-139 180,-139 180,-84 180,-84 180,-78 186,-72 192,-72 192,-72 330,-72 330,-72 336,-72 342,-78 342,-84 342,-84 342,-139 342,-139 342,-145 336,-151 330,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-120.5 335,-120.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-97.5 187,-120.5 234,-120.5 234,-97.5 187,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-97.5 234,-97.5 234,-120.5 187,-120.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-97.5 234,-120.5 288,-120.5 288,-97.5 234,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-97.5 234,-120.5 288,-120.5 288,-97.5 234,-97.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-97.5 288,-120.5 335,-120.5 335,-97.5 288,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-120.5 288,-120.5 288,-97.5 335,-97.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-78.5 234,-97.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-78.5 288,-97.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Models -->\n<g id=\"edge1\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Models</title>\n<path fill=\"none\" stroke=\"black\" d=\"M223.09,-71.96C213.58,-62.29 203.64,-52.18 195.01,-43.41\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"197.33,-40.78 187.82,-36.1 192.34,-45.69 197.33,-40.78\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"Running a model, we store the changes in each time step. The Frame type stores the production, disintegration and deposited material after transport.","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"<div class=\"noweb-label\">file:<i>src/Components/Models.jl</i></div>","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"@compose module Models\n    @mixin FaciesBase, TimeIntegration\n    using ..Common\n    using ..FaciesBase: n_facies\n    using ..TimeIntegration: n_writes\n\n    import ...CarboKitten: run_model\n    using ...OutputData\n\n    using Unitful\n    using ProgressLogging\n\n    Base.zeros(::Type{Frame}, input::AbstractInput) = Frame(\n        disintegration=zeros(Sediment, n_facies(input), input.box.grid_size...),\n        production=zeros(Sediment, n_facies(input), input.box.grid_size...),\n        deposition=zeros(Sediment, n_facies(input), input.box.grid_size...))\n\n    function increment!(a::Frame, b::Frame)\n        if !isnothing(b.disintegration)\n            a.disintegration .+= b.disintegration\n        end\n        if !isnothing(b.production)\n            a.production .+= b.production\n        end\n        if !isnothing(b.deposition)\n            a.deposition .+= b.deposition\n        end\n    end\n\n    \"\"\"\n        run_model(f, ::Type{Model{M}}, input::AbstractInput) where M\n        run_model(f, ::Type{Model{M}}, input::AbstractInput, state::AbstractState) where M\n\n    Run a model and send `Frame`s to callback `f`. The type parameter `M` should be a model,\n    being a module with both `initial_state!` and `step!` defined.\n\n    The second version with explicit state is used by `H5Writer` so we can perform an additional\n    action between creating the initial state and starting the model run (saving metadata to the\n    HDF5 file).\n    \"\"\"\n    run_model(f, ::Type{Model{M}}, input::AbstractInput) where M =\n        run_model(f, Model{M}, input, M.initial_state(input))\n\n    function run_model(f, ::Type{Model{M}}, input::AbstractInput, state::AbstractState) where M\n        step! = M.step!(input)\n\n        @progress for w = 1:n_writes(input)\n            df = zeros(Frame, input)\n            increment!(df, step!(state))\n            f(w, df)\n        end\n    end\n\n    \"\"\"\n        run_model(::Type{Model{M}}, input::AbstractInput, output::AbstractOutput) where M\n\n    Run a model and save the output to `output`.\n    \"\"\"\n    function run_model(::Type{Model{M}}, input::AbstractInput, output::AbstractOutput) where M\n        state = M.initial_state(input)\n        write_state = state_writer(input, output)\n        write_frame = frame_writer(input, output)\n\n        # create a group for every output item\n        for (k, v) in input.output\n            add_data_set(output, k, v)\n        end\n        write_state(1, state)\n\n        run_model(Model{M}, input, state) do w, df\n            # write_frame chooses to advance in a dataset\n            # or just to increment on the current frame\n            write_frame(w, df)\n            # write_state only writes one in every write_interval\n            # and does no accumulation\n            write_state(w+1, state)\n        end\n\n        return output\n    end\nend","category":"page"},{"location":"components/run_model/","page":"Model Runner","title":"Model Runner","text":"","category":"page"},{"location":"denudation/physical_erosion/#Physical-erosion-and-sediment-redistribution","page":"Physical Erosion","title":"Physical erosion and sediment redistribution","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"This method not only considers the amount of materials that have been removed, but also how the eroded materials are being distributed to the neighboring regions depending on slopes on each direction.","category":"page"},{"location":"denudation/physical_erosion/#Physical-erosion","page":"Physical Erosion","title":"Physical erosion","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"The equations used to estimate how much material could one cell provide to the lower cells is described underneath. The equation is found in [14]. We choose this equation mainly because it specifically deals with bedrock substrates instead of loose sediments. In the equation, k_v is erodibility, and the default value is 0.0023 according to the paper. (1 - I_f) indicates run-off generated in one cell and slope is the slope calculated based on ArcGis: how slope works. Note that the algorithms to calculate slope does not work on depressions.","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"D_phys = -k_v * (1 - I_f)^13 nabla h^23","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"This equation for the physical dedundation rate, D_phys is implemented in  code as follows:","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<div class=\"noweb-label\">⪡physical-erosion⪢≣</div>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"function physical_erosion(slope::Float64, inf::Float64, erodibility::Any)\n    -1 * -erodibility .* (1 - inf) .^ (1 / 3) .* slope .^ (2 / 3)\nend","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"and the output of this function for a range of slope angles is plotted here:","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"(Image: Erodability as function of slope)","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<div class=\"noweb-label\">file:<i>examples/denudation/physical-test.jl</i></div>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"#| requires: examples/denudation/physical-test.jl\n#| creates: docs/src/_fig/PhysicalSlope.png\n#| collect: figures\nmodule PhysicalSpec\n\nusing CairoMakie\nusing CarboKitten.Denudation.EmpiricalDenudationMod: slope_kernel\nusing CarboKitten.Denudation.PhysicalErosionMod: physical_erosion, redistribution_kernel\nusing CarboKitten.Stencil: Boundary, Periodic, offset_value, offset_index, stencil\nusing CarboKitten.BoundaryTrait\nimport CarboKitten.Config: Box\n\nconst inf = 0.5\nconst erodibility = 0.0025\n\nfunction main()\n    SLOPE = collect(1:0.2:30)\n    DEN_MASS = Vector{Float64}(undef,size(SLOPE))\n\n    for i in eachindex(SLOPE)\n        DEN_MASS[i] = physical_erosion(SLOPE[i],inf,erodibility)\n    end\n\n    w = 10 .* [ 0.0663001  0.115606  0.646196\n    0.601523   0.130196  0.390821\n    0.864734   0.902935  0.670354]\n\n    fig = Figure()\n    ax = Axis(fig[1,1],xlabel=\"Slope (degrees)\", ylabel=\"Denudation rates (m/Myr)\")\n    lines!(ax,SLOPE,DEN_MASS)\n    save(\"docs/src/_fig/PhysicalSlope.png\",fig)\nend\n\nend\n\nPhysicalSpec.main()","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"</details>","category":"page"},{"location":"denudation/physical_erosion/#Redistribution-of-sediments","page":"Physical Erosion","title":"Redistribution of sediments","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"The redistribution of sediments after physical erosion is based on [15]: the eroded sediments calculated from the above equation are distributed to the neighboring 8 cells according to the slopes (defined as elevation differences/horizontal differences) towards each direction. The amount of sediments of one cell received is calculated by following steps:","category":"page"},{"location":"denudation/physical_erosion/#Current-implementation","page":"Physical Erosion","title":"Current implementation","text":"","category":"section"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"<div class=\"noweb-label\">file:<i>src/Denudation/PhysicalErosionMod.jl</i></div>","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"module PhysicalErosionMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...Stencil: Boundary, Periodic, offset_value, offset_index, stencil\nusing ...BoundaryTrait\nusing ...Boxes: Box\n\nusing Unitful\n\n@kwdef struct PhysicalErosion <: DenudationType end\n\nconst Amount = typeof(1.0u\"m\")\n\n<<physical-erosion>>\n\nfunction redistribution_kernel(w::Array{Float64}, cellsize::Float64)\n    s = zeros(Float64, (3, 3))\n    s[1, 1] = (w[1, 1] - w[2, 2]) / cellsize\n    s[1, 2] = (w[1, 2] - w[2, 2]) / cellsize / sqrt(2)\n    s[1, 3] = (w[1, 3] - w[2, 2]) / cellsize\n    s[2, 1] = (w[2, 1] - w[2, 2]) / cellsize / sqrt(2)\n    s[2, 2] = (w[2, 2] - w[2, 2]) / cellsize\n    s[2, 3] = (w[2, 3] - w[2, 2]) / cellsize / sqrt(2)\n    s[3, 1] = (w[3, 1] - w[2, 2]) / cellsize\n    s[3, 2] = (w[3, 2] - w[2, 2]) / cellsize / sqrt(2)\n    s[3, 3] = (w[3, 3] - w[2, 2]) / cellsize\n\n    s[s.<0.0] .= 0.0\n    sumslope = sum(s)\n\n    if sumslope == 0.0\n        return zeros(Float64, (3, 3))\n    else\n        return s ./ sumslope\n    end\nend\n\nfunction mass_erosion(box::Box{BT}, denudation_mass, water_depth::Array{Float64}, i::CartesianIndex) where {BT<:Boundary{2}}\n    wd = zeros(Float64, 3, 3)\n    for (k, Δi) in enumerate(CartesianIndices((-1:1, -1:1)))\n        wd[k] = offset_value(BT, water_depth, i, Δi)\n    end\n    cell_size = box.phys_scale ./ u\"m\"\n\n    return (redistribution_kernel(wd, cell_size) .* denudation_mass[i])\nend\n\nfunction total_mass_redistribution(box::Box{BT}, denudation_mass, water_depth, mass) where {BT<:Boundary{2}}\n        for i in CartesianIndices(mass)\n            redis = mass_erosion(box, denudation_mass, water_depth, i)\n\n            for subidx in CartesianIndices((-1:1, -1:1))\n                target = offset_index(BT, size(water_depth), i, subidx)\n                if target === nothing\n                    continue\n                end\n                mass[target] += redis[2+subidx[1], 2+subidx[2]]\n            end\n        end\n    return mass\n\nend\n\nfunction total_mass_redistribution(box::Box{BT}, denudation_mass, water_depth) where {BT<:Boundary{2}}\n    mass = zeros(Amount, length(denudation_mass[:,1,1]), box.grid_size...)\n    @views for f in 1:length(denudation_mass[:,1,1])\n        total_mass_redistribution(box, denudation_mass[f,:,:], water_depth, mass[f,:,:])\n    end\n    return mass\n\nend\n\nfunction denudation(::Box, p::PhysicalErosion, water_depth::Any, slope, facies, state)\n    denudation_rate = zeros(typeof(1.0u\"m/Myr\"), length(facies), size(slope)...)\n\n    for idx in CartesianIndices(state.ca)\n        f = state.ca[idx]\n        if f == 0\n            continue\n        end\n        if water_depth[idx] <= 0\n            denudation_rate[f, idx[1], idx[2]] = physical_erosion.(slope[idx], facies[f].infiltration_coefficient, facies[f].erodibility)\n        end\n    end\n\n    return denudation_rate\nend\n\nfunction redistribution(box::Box{BT}, p::PhysicalErosion, denudation_mass, water_depth) where {BT<:Boundary}\n    return total_mass_redistribution(box, denudation_mass, water_depth)\nend\n\nend","category":"page"},{"location":"denudation/physical_erosion/","page":"Physical Erosion","title":"Physical Erosion","text":"","category":"page"},{"location":"carbocat/#About","page":"Summary","title":"About","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"CarboCAT is primarily based on a very simple cellular automaton (CA). We may explore this CA as a first step in implementing the model in Julia.","category":"page"},{"location":"carbocat/#Overview","page":"Summary","title":"Overview","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"The CarboCAT model [3] consists of several components, many of which are optional or contain optional levels of complexity.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Species habitation: an algorithm is in place to evolve the locality of a number of factory species.\nSediment production: each species will produce sediment according to some model.\nTransport: sediment may be transported from a production site to elsewhere due to gravity, waves or other types of mixing.\nErosion: sediment may erode depending on local circumstances or sediment type.\nCompactification: different types of sediment may respond to compression forces differently.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"These processes describe the intrinsic properties of the model. Any parameters that change these processes will be referred to as model parameters. Next to that, there are some extrinsic parameters that change the specific output of a model: the initial depth of the sea bed (also known as bathymetry) and variation in sea level (including subsidence). These we call input parameters.","category":"page"},{"location":"carbocat/#Carbonate-production","page":"Summary","title":"Carbonate production","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"By itself, a sediment production model is enough to model a cross-section of a carbonate platform [BS92: @Bosscher1992]. As a first step, we have reproduced some results of BS92. Using a reasonably simple approximation of a growth rate as","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"[partial_t h = - g_m tanh leftfracI_0I_k exp(-k * (h - s(t))right]{#eq:growth-rate-eqn}","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"where h is the depth of the sea floor, g_m is the maximum growth rate, I_0 the surface light intensity, I_k the saturating light intensity, k the extinction coefficient, and s the (extrinsic) sea-level. In one example given by BS92, we arrived at the following profile.","category":"page"},{"location":"carbocat/#Species-habitation","page":"Summary","title":"Species habitation","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"These species can be anything, just remember that they are the progenitor of some (limestone) facies type. In the original 2013 model, this stage is implemented by a celullar automaton (or CA). The CA has the nice property of giving pseudo-random output with at least some degree of coherence. There is no physical basis to the CA model, but neither is there very much data to test a physical model against.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"We have implemented the CA used in Burgess 2013. Using three species with identical 4-6-10-10 rules (survival between 4 to 10 neighbours, birth between 6-10 live neighbours).","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"(Image: )","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"An interesting question is under what rules is this CA stable (i.e. keeps evolving)?","category":"page"},{"location":"carbocat/#Combination","page":"Summary","title":"Combination","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"The minimal Carbocat model would consist of only species habitation and production.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":":::details","category":"page"},{"location":"carbocat/#Crowding","page":"Summary","title":"Crowding","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"In crowded areas carbonate production rates are reduced. For cells where","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"n_min le n le n_opt","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"and","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"n_opt le n le n_max","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"(n_min and n_max for living cells are 4 and 10)","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"we have a linear increase and linear decrease of production rate (i.e. a triangle function).","category":"page"},{"location":"carbocat/#Subsidence","page":"Summary","title":"Subsidence","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Subsidence refers to gradual lowering or lifting of the underlying floor bed. This could be either sea level rise due to climate change, but also tectonic activity. Sea level also changes according to a given recipe with say three sinusoidals (e.g. Milankovich cycles). When a cell gets \"subaerial exposure\", i.e. the water level drops below the cell elevation (stupid jargon), accumulation stops and the cell becomes dormant. On reflooding, the cell resumes activity. From the text it is not entirely clear, but I think deactivated cells don't take part in the CA, so they count as dead neighbours.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"reference on accommodation, also links to a model called SedFlux.","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"T + E = S + W","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Saying Tectonic subsidence plus Eustatic sea-level change equals Sedimentation plus change in Water depth.","category":"page"},{"location":"carbocat/#Steps","page":"Summary","title":"Steps","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Update waterdepth, given subsidence\nUpdate sea level elevation, given eustatics\nRun CA\nCompute thickness of carbonate production\nCompute sediment transport","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"We need to keep a state with the following components:","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"height map\nspecies\nglobal time, implying:\nsea level and subsidence","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"Every cycle we may export a layer of sediment to archive.","category":"page"},{"location":"carbocat/#References","page":"Summary","title":"References","text":"","category":"section"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"","category":"page"},{"location":"carbocat/","page":"Summary","title":"Summary","text":"","category":"page"},{"location":"visualization/#Visualization","page":"Visualizations","title":"Visualization","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"The visualization of CarboKitten output is implemented in a Julia package extension. This is done so that CarboKitten.jl itself doesn't have to depend on Makie.jl (our main visualization tool), which has a large transient dependency stack. To make the Visualization extension of CarboKitten available, make sure to activate a Julia project where Makie is installed.","category":"page"},{"location":"visualization/#Makie-primer","page":"Visualizations","title":"Makie primer","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"Makie.jl is a visualization package that creates exceptionally good looking (publication quality) plots in both 2D and 3D. There are three back-ends for Makie:","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"CairoMakie for publication quality vector graphics, writing to SVG, PDF or PNG.\nGLMakie has better run-time performance than CairoMakie, especially when dealing with larger datasets and/or 3D visualizations. However, GLMakie can only produce rasterized images, so PNG, JPEG or directly to screen for interactive use.\nWGLMakie for online publication using WebGL. If you want interactive plots, like 3D plots that you can rotate in the browser, this is the one to use. Fair warning: this is also the least stable back-end for Makie.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"To work with Makie, you need to import one of the three back-end packages. In general, every plot available in Makie has two variants. One is a direct function for plotting:","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"using CairoMakie\n\nx = randn(10)\ny = randn(10)\n\nscatter(x, y)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"The other requires a bit more prep, but gives you more control.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"fig = Figure()\nax = Axis(fig[1,1])\nscatter!(ax, x, y)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"Here, we create a figure explicitly, then create a new set of axes somewhere on the grid in the figure, and then plot on that set of axes. The plotting functions accepting an Axis argument actually modify an existing context, which is why these functions always end with an exclamation mark, in this case scatter!.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"If you like to know more about Makie, their \"Getting started\" is a good place to start.","category":"page"},{"location":"visualization/#Colours","page":"Visualizations","title":"Colours","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"We like to use colorblind safe pallete of colours as described on Paul Tol's website: '#4477AA', '#EE6677', '#228833', '#CCBB44', '#66CCEE', '#AA3377', '#BBBBBB'.","category":"page"},{"location":"visualization/#Project-Extension","page":"Visualizations","title":"Project Extension","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"The Project Extension requires a front-end where the available methods are exposed.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>src/Visualization.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module Visualization\nexport sediment_profile!, sediment_profile, wheeler_diagram!, wheeler_diagram, production_curve!,\n       production_curve, glamour_view!, summary_plot\n\nfunction print_instructions(func_name, args)\n    println(\"Called `$(func_name)` with args `$(typeof.(args))`\")\n    println(\"This is an extension and only becomes available when you import {Cairo,GL,WGL}Makie before using this.\")\nend\n\nfunction profile_plot! end\n\n# profile_plot!(args...; kwargs...) = print_instructions(\"profile_plot!\", args)\nsediment_profile!(args...) = print_instructions(\"sediment_profile!\", args)\nsediment_profile(args...) = print_instructions(\"sediment_profile\", args)\nwheeler_diagram!(args...) = print_instructions(\"wheeler_diagram!\", args)\nwheeler_diagram(args...) = print_instructions(\"wheeler_diagram\", args)\nproduction_curve(args...) = print_instructions(\"production_curve\", args)\nproduction_curve!(args...) = print_instructions(\"production_curve!\", args)\nstratigraphic_column!(args...) = print_instructions(\"production_curve!\", args)\nglamour_view!(args...) = print_instructions(\"glamour_view!\", args)\nsummary_plot(args...) = print_instructions(\"summary_plot\", args)\n\nend  # module","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/VisualizationExt.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module VisualizationExt\n\ninclude(\"WheelerDiagram.jl\")\ninclude(\"ProductionCurve.jl\")\ninclude(\"StratigraphicColumn.jl\")\ninclude(\"SedimentProfile.jl\")\ninclude(\"GlamourView.jl\")\ninclude(\"SummaryPlot.jl\")\n\nend","category":"page"},{"location":"visualization/#Summary-collage","page":"Visualizations","title":"Summary collage","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Collage)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/SummaryPlot.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module SummaryPlot\n\nusing CarboKitten.Visualization\nimport CarboKitten.Visualization: summary_plot\nusing CarboKitten.Export: read_header, read_volume, read_slice, group_datasets\nusing CarboKitten.Utility: in_units_of\nusing HDF5\nusing Unitful\nusing Makie\n\nsummary_plot(filename::AbstractString; kwargs...) = h5open(fid->summary_plot(fid; kwargs...), filename, \"r\")\n\nfunction summary_plot(fid::HDF5.File; wheeler_smooth=(1, 1), show_unconformities=true)\n    header = read_header(fid)\n    data_groups = group_datasets(fid)\n\n    if length(data_groups[:slice]) == 0 && length(data_groups[:volume]) == 0\n        @warn \"No volume data or slice data stored. Cannot produce summary view.\"\n        return nothing\n    end\n\n    fig = Figure(size=(1200, 1000), backgroundcolor=:gray80)\n\n    volume_data = if length(data_groups[:volume]) == 0\n        @warn \"No volume data stored, skipping topographic plots.\"\n        nothing\n    else\n        if length(data_groups[:volume]) > 1\n            @warn \"Multiple volume data sets, picking first one.\"\n        end\n\n        volume_data = read_volume(fid[data_groups[:volume][1]])\n        ax = Axis3(fig[1, 3]; title=\"topography\", zlabel=\"depth [m]\", xlabel=\"x [km]\", ylabel=\"y [km]\")\n        glamour_view!(ax, header, volume_data)\n        volume_data\n    end\n\n    section_data = if length(data_groups[:slice]) == 0\n        @warn \"No profile data slice stored, taking section of volume data along x-axis.\"\n\n        y_slice = div(size(volume_data.sediment_thickness)[2], 2) + 1\n        volume_data[:, y_slice]\n    else\n        read_slice(fid[data_groups[:slice][1]])\n    end\n\n    n_facies = size(section_data.production)[1]\n\n    ax1 = Axis(fig[1:2,1:2])\n    sediment_profile!(ax1, header, section_data; show_unconformities = show_unconformities)\n    axislegend(ax1; merge=true, backgroundcolor=:gray80)\n\n    ax2 = Axis(fig[4,1])\n    ax3 = Axis(fig[4,2])\n    sm, df = wheeler_diagram!(ax2, ax3, header, section_data; smooth_size=wheeler_smooth)\n    Colorbar(fig[3,1], sm; vertical=false, label=\"sedimentation rate [m/Myr]\")\n    Colorbar(fig[3,2], df; vertical=false, label=\"dominant facies\", ticks=1:n_facies)\n\n    ax4 = Axis(fig[4,3], title=\"sealevel curve\", xlabel=\"sealevel [m]\",\n               limits=(nothing, (header.axes.t[1] |> in_units_of(u\"Myr\"),\n                                 header.axes.t[end] |> in_units_of(u\"Myr\"))))\n    lines!(ax4, header.sea_level |> in_units_of(u\"m\"), header.axes.t |> in_units_of(u\"Myr\"))\n\n    ax5 = Axis(fig[2,3])\n    max_depth = minimum(header.initial_topography)\n    production_curve!(ax5, fid[\"input\"], max_depth=max_depth)\n\n    linkyaxes!(ax2, ax3, ax4)\n\n    fig\nend\n\nend","category":"page"},{"location":"visualization/#Wheeler-diagram","page":"Visualizations","title":"Wheeler diagram","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Wheeler diagram)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/wheeler_diagram.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/wheeler_diagram.png\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nmodule Script\n\nusing CairoMakie\nusing CarboKitten.Export: read_slice\nusing CarboKitten.Visualization: wheeler_diagram\n\nfunction main()\n  header, data = read_slice(\"data/output/alcap-example.h5\", :, 25)\n  fig = wheeler_diagram(header, data)\n  save(\"docs/src/_fig/wheeler_diagram.png\", fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/WheelerDiagram.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module WheelerDiagram\n\nimport CarboKitten.Visualization: wheeler_diagram, wheeler_diagram!\nusing CarboKitten.Export: Header, Data, DataSlice, read_data, read_slice\nusing CarboKitten.Utility: in_units_of\nusing Makie\nusing Unitful\nusing CarboKitten.BoundaryTrait\nusing CarboKitten.Stencil: convolution\n\n\nconst na = [CartesianIndex()]\n\nelevation(h::Header, d::DataSlice) =\n    let bl = h.initial_topography[d.slice..., na],\n        sr = h.axes.t[end] * h.subsidence_rate\n\n        bl .+ d.sediment_thickness .- sr\n    end\n\nwater_depth(header::Header, data::DataSlice) =\n    let h = elevation(header, data),\n        wi = data.write_interval,\n        s = header.subsidence_rate .* (header.axes.t[1:wi:end] .- header.axes.t[end]),\n        l = header.sea_level[1:wi:end]\n\n        h .- (s.+l)[na, :]\n    end\n\nconst Rate = typeof(1.0u\"m/Myr\")\n\nfunction sediment_accumulation!(ax::Axis, header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    colormap=Reverse(:curl),\n    range::NTuple{2,Rate}=(-100.0u\"m/Myr\", 100.0u\"m/Myr\"))\n    wi = data.write_interval\n    magnitude = sum(data.deposition .- data.disintegration; dims=1)[1, :, :] ./ (header.Δt * wi)\n    blur = convolution(Shelf, ones(Float64, smooth_size...) ./ *(smooth_size...))\n    wd = zeros(Float64, length(header.axes.x), length(header.axes.t[1:wi:end]))\n    blur(water_depth(header, data) / u\"m\", wd)\n    mag = zeros(Float64, length(header.axes.x), length(header.axes.t[1:wi:end]) - 1)\n    blur(magnitude / u\"m/Myr\", mag)\n\n    ax.ylabel = \"time [Myr]\"\n    ax.xlabel = \"position [km]\"\n    xkm = header.axes.x |> in_units_of(u\"km\")\n    tmyr = header.axes.t[1:wi:end] |> in_units_of(u\"Myr\")\n\n    sa = heatmap!(ax, xkm, tmyr, mag;\n        colormap=colormap, colorrange=range ./ u\"m/Myr\")\n    #contour!(ax, xkm, tmyr, wd;\n    #    levels=[0], color=:red, linewidth=2, linestyle=:dash)\n    return sa\nend\n\nfunction dominant_facies!(ax::Axis, header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    colors=Makie.wong_colors())\n    n_facies = size(data.production)[1]\n    colormax(d) = getindex.(argmax(d; dims=1)[1, :, :], 1)\n\n    wi = data.write_interval\n    dominant_facies = colormax(data.deposition)\n    blur = convolution(Shelf, ones(Float64, smooth_size...) ./ *(smooth_size...))\n    wd = zeros(Float64, length(header.axes.x), length(header.axes.t[1:wi:end]))\n    blur(water_depth(header, data) / u\"m\", wd)\n\n    ax.ylabel = \"time [Myr]\"\n    ax.xlabel = \"position [km]\"\n\n    xkm = header.axes.x |> in_units_of(u\"km\")\n    tmyr = header.axes.t[1:wi:end] |> in_units_of(u\"Myr\")\n    ft = heatmap!(ax, xkm, tmyr, dominant_facies;\n        colormap=cgrad(colors[1:n_facies], n_facies, categorical=true),\n        colorrange=(0.5, n_facies + 0.5))\n    contourf!(ax, xkm, tmyr, wd;\n        levels=[0.0, 10000.0], colormap=Reverse(:grays))\n    #contour!(ax, xkm, tmyr, wd;\n    #    levels=[0], color=:black, linewidth=2)\n    return ft\nend\n\nfunction wheeler_diagram!(ax1::Axis, ax2::Axis, header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    range::NTuple{2,Rate}=(-100.0u\"m/Myr\", 100.0u\"m/Myr\"))\n\n    linkyaxes!(ax1, ax2)\n    sa = sediment_accumulation!(ax1, header, data; smooth_size=smooth_size, range=range)\n    ft = dominant_facies!(ax2, header, data; smooth_size=smooth_size)\n    ax2.ylabel = \"\"\n\n    return sa, ft\nend\n\nfunction wheeler_diagram(header::Header, data::DataSlice;\n    smooth_size::NTuple{2,Int}=(3, 11),\n    range::NTuple{2,Rate}=(-100.0u\"m/Myr\", 100.0u\"m/Myr\"))\n\n    fig = Figure(size=(1000, 600))\n    ax1 = Axis(fig[2, 1])\n    ax2 = Axis(fig[2, 2])\n\n    sa, ft = wheeler_diagram!(ax1, ax2, header, data; smooth_size=smooth_size, range=range)\n\n    Colorbar(fig[1, 1], sa; vertical=false, label=\"sediment accumulation [m/Myr]\")\n    Colorbar(fig[1, 2], ft; vertical=false, ticks=1:3, label=\"dominant facies\")\n    fig\nend\n\nend","category":"page"},{"location":"visualization/#Production-curve","page":"Visualizations","title":"Production curve","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Production curve)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/production_curve.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/production_curve.svg\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nusing CairoMakie\nusing CarboKitten.Visualization: production_curve\n\nsave(\"docs/src/_fig/production_curve.svg\", production_curve(\"data/output/alcap-example.h5\"))","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/ProductionCurve.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module ProductionCurve\n\nusing Makie\nusing Unitful\nusing HDF5\n\nimport CarboKitten.Components.Common: AbstractInput\nimport CarboKitten.Visualization: production_curve!, production_curve\nusing CarboKitten.Components.Production: Facies, production_rate\n\nfunction production_curve!(ax, input::I) where I <: AbstractInput\n    ax.title = \"production at $(sprint(show, input.insolation; context=:fancy_exponent=>true))\"\n    ax.xlabel = \"production [m/Myr]\"\n    ax.ylabel = \"depth [m]\"\n    ax.yreversed = true\n\n    for f in input.facies\n        depth = (0.1:0.1:50.0)u\"m\"\n        prod = [production_rate(input.insolation, f, d) for d in depth]\n        lines!(ax, prod / u\"m/Myr\", depth / u\"m\")\n    end\nend\n\nfunction production_curve(input::I) where I <: AbstractInput\n    fig = Figure()\n    ax = Axis(fig[1, 1])\n    production_curve!(ax, input)\n    fig\nend\n\nfunction production_curve(filename::AbstractString)\n    h5open(filename, \"r\") do fid\n        fig = Figure()\n        ax = Axis(fig[1, 1])\n        production_curve!(ax, fid[\"input\"])\n        fig\n    end\nend\n\nfunction production_curve!(ax, g::HDF5.Group; max_depth=-50.0u\"m\")\n    a = HDF5.attributes(g)\n    insolation = 400.0u\"W/m^2\"  # a[\"insolation\"][] * u\"W/m^2\"\n\n    ax.title = \"production at $(sprint(show, insolation; context=:fancy_exponent=>true))\"\n    ax.xlabel = \"production [m/Myr]\"\n    ax.ylabel = \"depth [m]\"\n\n    for i in 1:a[\"n_facies\"][]\n        fa = HDF5.attributes(g[\"facies$(i)\"])\n        f = Facies(\n            maximum_growth_rate = fa[\"maximum_growth_rate\"][] * u\"m/Myr\",\n            extinction_coefficient = fa[\"extinction_coefficient\"][] * u\"m^-1\",\n            saturation_intensity = fa[\"saturation_intensity\"][] * u\"W/m^2\")\n        depth = (0.1u\"m\":0.1u\"m\":-max_depth)\n        prod = [production_rate(insolation, f, d) for d in depth]\n        lines!(ax, prod / u\"m/Myr\", - depth / u\"m\")\n    end\nend\n\nend","category":"page"},{"location":"visualization/#Sediment-profile","page":"Visualizations","title":"Sediment profile","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Sediment profile)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"The sediment profile is probably the most important visualization that we provide. By default it allows us to study the sediment composition of a section, by plotting the argmax of the deposition. In cases where significant amounts of sediment is eroded, all deposition is plotted, and it is assumed that newest depositions are shown on top of possible older ones.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/sediment_profile.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/sediment_profile.png\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nmodule Script\nusing CairoMakie\nusing CarboKitten.Export: read_slice\nusing CarboKitten.Visualization: sediment_profile\n\nfunction main()\n    save(\"docs/src/_fig/sediment_profile.png\",\n        sediment_profile(read_slice(\"data/output/alcap-example.h5\", :slice)...))\nend\nend\n\nScript.main()","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"If you want to visualize something other than the argmax of the deposition, you may use the profile_plot! function. For example, we can plot the fraction of second facies over total.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: )","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/profile_fraction.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/profile_fraction.png\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nmodule Script\nusing GLMakie\nusing CarboKitten.Export: read_slice\nusing CarboKitten.Visualization: profile_plot!\n\nfunction main()\n    (header, slice) = read_slice(\"data/output/alcap-example.h5\", :profile)\n\tfig = Figure()\n\tax = Axis(fig[1, 1])\n\n\tx = header.axes.x\n\tt = header.axes.t\n\n    plot = profile_plot!(x -> x[2]/sum(x), ax, header, slice; colorrange=(0, 1))\n    Colorbar(fig[1, 2], plot; label=L\"f_2 / f_{total}\")\n\n\tsave(\"docs/src/_fig/profile_fraction.png\", fig)\n\tfig\nend\nend\n\nScript.main()","category":"page"},{"location":"visualization/#Implementation","page":"Visualizations","title":"Implementation","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/SedimentProfile.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module SedimentProfile\n\nimport CarboKitten.Visualization: sediment_profile, sediment_profile!, profile_plot!\n\nusing CarboKitten.Visualization\nusing CarboKitten.Utility: in_units_of\nusing CarboKitten.Export: Header, Data, DataSlice, read_data, read_slice\nusing CarboKitten.Skeleton: skeleton\n\nusing Makie\nusing GeometryBasics\nusing Unitful\n\nusing Statistics: mean\n\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Amount = typeof(1.0u\"m\")\nconst Length = typeof(1.0u\"m\")\nconst Time = typeof(1.0u\"Myr\")\n\nconst na = [CartesianIndex()]\n\nelevation(h::Header, d::Data) =\n    let bl = h.initial_topography[:, :, na],\n        sr = (h.axes.t[end]-h.axes.t[1]) * h.subsidence_rate\n\n        bl .+ d.sediment_thickness .- sr\n    end\n\nelevation(h::Header, d::DataSlice) =\n    let bl = h.initial_topography[d.slice..., na],\n        sr = (h.axes.t[end]-h.axes.t[1]) * h.subsidence_rate\n\n        bl .+ d.sediment_thickness .- sr\n    end\n\n\"\"\"\n    explode_quad_vertices(v)\n\nTakes a three dimensional array representing a grid of vertices. This function duplicates these\nvertices in the vertical direction, so that an amount of sediment can be given a single color.\n\nReturns a tuple of vertices and faces (triangles), suitable for plotting with Makie's `mesh`\nfunction.\n\"\"\"\nfunction explode_quad_vertices(v::Array{Float64,3})\n    w, h, d = size(v)\n    points = zeros(Float64, w, h - 1, 2, d)\n    n_vertices = 2 * w * (h - 1)\n    n_quads = (w - 1) * (h - 1)\n    @views points[:, :, 1, :] = v[1:end, 1:end-1, :]\n    @views points[:, :, 2, :] = v[1:end, 2:end, :]\n    idx = reshape(1:n_vertices, w, (h - 1), 2)\n    vtx1 = reshape(idx[1:end-1, :, 1], n_quads)\n    vtx2 = reshape(idx[2:end, :, 1], n_quads)\n    vtx3 = reshape(idx[2:end, :, 2], n_quads)\n    vtx4 = reshape(idx[1:end-1, :, 2], n_quads)\n    return reshape(points, n_vertices, d),\n    vcat(hcat(vtx1, vtx2, vtx3), hcat(vtx1, vtx3, vtx4))\nend\n\n\"\"\"\n    plot_unconformities(ax, header, data_slice, minwidth; kwargs...)\n    plot_unconformities(ax, header, data_slice, minwidth::Bool; kwargs...)\n    plot_unconformities(ax, header, data_slice, minwidth::Int; kwargs...)\n\nScans the given `data_slice` for unconformities, and plots those using\nMakie `linesegments`. The `minwidth` argument controls for how many time\nsteps the platform needs to be exposed before we plot it. For `minwidth = true`\nthe default width of 10 time steps is taken.\n\nAdditional keyword arguments are forwarded to the `linesegments!` call.\n\"\"\"\nfunction plot_unconformities(ax::Axis, header::Header, data::DataSlice, minwidth::Nothing; kwargs...)\n    @info \"Not plotting unconformities, got minwidth: $(minwidth)\"\nend\n\nfunction plot_unconformities(ax::Axis, header::Header, data::DataSlice, minwidth::Bool; kwargs...)\n    if minwidth\n        plot_unconformities(ax, header, data, 10; kwargs...)\n    end\nend\n\nfunction plot_unconformities(ax::Axis, header::Header, data::DataSlice, minwidth::Int; kwargs...)\n    x = header.axes.x |> in_units_of(u\"km\")\n    wi = data.write_interval\n    ξ = elevation(header, data)  # |> in_units_of(u\"m\")\n    water_depth = ξ .- (header.subsidence_rate .* (header.axes.t[1:wi:end] .- header.axes.t[end]) .+ header.sea_level[1:wi:end])[na, :]\n    hiatus = skeleton(water_depth .> 0.0u\"m\", minwidth=minwidth)\n\n    if !isempty(hiatus[1])\n        verts = [(x[pt[1]], ξ[pt...] |> in_units_of(u\"m\")) for pt in hiatus[1]]\n        linesegments!(ax, vec(permutedims(verts[hiatus[2]])); kwargs...)\n    end\nend\n\n\"\"\"\n    profile_plot!(ax, header, data_slice; mesh_args...)\n\nGeneric profile plot. This sets up a mesh for plotting with the Makie `mesh!`\nfunction, plots the initial topography and the mesh by passing `mesh_args...`.\n\nThe `color` array should have the same size as a single facies for `data.production`.\n\"\"\"\nfunction profile_plot!(ax::Axis, header::Header, data::DataSlice; color::AbstractArray, mesh_args...)\n    x = header.axes.x |> in_units_of(u\"km\")\n    t = header.axes.t |> in_units_of(u\"Myr\")\n\n    n_facies, n_x, n_t = size(data.production)\n    ξ = elevation(header, data)  # |> in_units_of(u\"m\")\n\n    verts = zeros(Float64, n_x, n_t+1, 2)\n    @views verts[:, :, 1] .= x\n    @views verts[:, :, 2] .= ξ |> in_units_of(u\"m\")\n    v, f = explode_quad_vertices(verts)\n\n    total_subsidence = header.subsidence_rate * (header.axes.t[end] - header.axes.t[1])\n    bedrock = (header.initial_topography[data.slice...] .- total_subsidence) |> in_units_of(u\"m\")\n    lower_limit = minimum(bedrock) - 20\n    band!(ax, x, lower_limit, bedrock; color=:gray, label=\"initial topography\")\n    lines!(ax, x, bedrock; color=:black, label=\"initial topography\")\n    ylims!(ax, lower_limit + 10, nothing)\n    xlims!(ax, x[1], x[end])\n    ax.xlabel = \"position [km]\"\n    ax.ylabel = \"depth [m]\"\n\n    c = reshape(color, n_x * n_t)\n    mesh!(ax, v, f; color=vcat(c, c), mesh_args...)\nend\n\n\"\"\"\n    profile_plot!(f, ax, header, data_slice; mesh_args...)\n\nInstead of explicitely passing the color data as an array, this generates the\ncolors from a function `f` over the deposition data. So `f` should have signature\n`AbstractVector -> Float` or possibly `AbstractVector -> RGB` (whatever Makie accepts).\nHere the vector input has size of the number of facies.\n\"\"\"\nfunction profile_plot!(f::F, ax::Axis, header::Header, data::DataSlice; mesh_args...) where {F}\n    color = f.(eachslice(data.deposition, dims=(2, 3)))\n    profile_plot!(ax, header, data; color=color, mesh_args...)\nend\n\n\"\"\"\n    sediment_profile!(ax, header, data; show_unconformities)\n\nPlot the sediment profile, choosing colour by dominant facies type (argmax). Unconformaties\nare shown when the sediment is subaerially exposed (even if sediment is still deposited\ndue to a set intertidal zone).\n\"\"\"\nfunction sediment_profile!(ax::Axis, header::Header, data::DataSlice; show_unconformities::Union{Nothing,Bool,Int} = true)\n    x = header.axes.x |> in_units_of(u\"km\")\n    t = header.axes.t |> in_units_of(u\"Myr\")\n    n_facies = size(data.production)[1]\n\n    plot = profile_plot!(argmax, ax, header, data; alpha=1.0,\n        colormap=cgrad(Makie.wong_colors()[1:n_facies], n_facies, categorical=true))\n\n    minwidth = show_unconformities\n    plot_unconformities(ax, header, data, minwidth; label = \"unconformities\",\n                        color=:white, linestyle=:dash, linewidth=1)\n\n    ax.title = \"sediment profile\"\n    return plot\nend\n\n\"\"\"\n    sediment_profile(header, data_slice; show_unconformities=true)\n\nPlot the sediment profile from `data_slice`. This takes the deposited sediments and\nfind the dominant facies at every point. By default unconformities are shown using\ndashed white lines. If this generates too much visual noise, you can increase the\ntreshold (default 10).\n\"\"\"\nfunction sediment_profile(header::Header, data_slice::DataSlice; show_unconformities::Union{Bool,Int,Nothing} = true)\n    fig = Figure(size=(1000, 600))\n    ax = Axis(fig[1, 1])\n    sediment_profile!(ax, header, data_slice; show_unconformities = show_unconformities)\n    return fig\nend\n\nend  # module","category":"page"},{"location":"visualization/#Stratigraphic-Column","page":"Visualizations","title":"Stratigraphic Column","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/StratigraphicColumn.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module StratigraphicColumn\n\nusing Makie\nusing Unitful\n\nimport CarboKitten.Visualization: stratigraphic_column!\nusing CarboKitten.Export: Header, DataColumn, stratigraphic_column, age_depth_model\n\n\nfunction scdata(header::Header, data::DataColumn)\n    n_facies = size(data.production)[1]\n    n_times = length(header.axes.t) - 1\n    sc = zeros(Float64, n_facies, n_times)\n    for f = 1:n_facies\n        sc[f, :] = stratigraphic_column(header, data, f) / u\"m\"\n    end\n\n    colormax(d) = getindex.(argmax(d; dims=1)[1, :], 1)\n    adm = age_depth_model(data.sediment_thickness)\n\n    return (ys_low=adm[1:end-1] / u\"m\", ys_high=adm[2:end] / u\"m\", facies=colormax(sc)[1:end])\nend\n\n\nfunction stratigraphic_column!(ax::Axis, header::Header, data::DataColumn; color=Makie.wong_colors())\n    (ys_low, ys_high, facies) = scdata(header, data)\n    hspan!(ax, ys_low, ys_high; color=color[facies])\nend\n\nfunction stratigraphic_column!(ax::Axis, header::Header, data::Observable{DataColumn}; color=Makie.wong_colors())\n    _scdata = lift(d -> scdata(header, d), data)\n    _ys_low = lift(d -> d.ys_low, _scdata)\n    _ys_high = lift(d -> d.ys_high, _scdata)\n    _color = lift(d -> color[d.facies], _scdata)\n    hspan!(ax, _ys_low, _ys_high; color=_color)\nend\n\nend","category":"page"},{"location":"visualization/#Skeleton","page":"Visualizations","title":"Skeleton","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>src/Skeleton.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module Skeleton\n\nusing .Iterators: filter, map as imap, product, flatten, drop\nusing ..Utility: enumerate_seq, find_ranges\n\nconst Vertex = Tuple{Int, UnitRange{Int}}\n\npairs(it) = zip(it, drop(it, 1))\nedge(a::Vertex, b::Vertex) = isempty(a[2] ∩ b[2]) ? nothing : (a[1], b[1])\nedges_between(a, b) = filter(!isnothing, imap(splat(edge), product(a, b)))\nmiddle(a::UnitRange{Int}) = (a.start + a.stop) ÷ 2\n\n\"\"\"\n    skeleton(bitmap::AbstractMatrix{Bool})\n\nComputes the skeleton of a bitmap, i.e. reduces features with some thickness to\na set of line segments. This function is designed with stratigraphic application\nin mind: we scan each row in the bitmap for connected regions, then link neighbouring\nregions when they overlap. The result is a graph that represents hiatus in the sediment\naccumulation.\n\nReturns a tuple of `vertices` and `edges`, where `vertices` is a vector of 2-tuples and\n`edges` is a nx2 matrix of indices into the `vertices`.\n\"\"\"\nfunction skeleton(bitmap::AbstractMatrix{Bool}; minwidth=10)\n    vertex_rows = (filter(r->length(r)>=minwidth, find_ranges(row)) for row in eachrow(bitmap))\n    edges::Vector{Tuple{Int,Int}} = collect(flatten(map(splat(edges_between), pairs(enumerate_seq(vertex_rows)))))\n    vertices::Vector{Tuple{Int,Int}} = collect(flatten(((i, middle(v)) for v in vs) for (i, vs) in enumerate(vertex_rows)))\n    return vertices, reshape(reinterpret(Int, edges), (2,:))'\nend\n\nend","category":"page"},{"location":"visualization/#Glamour-View-(3D)","page":"Visualizations","title":"Glamour View (3D)","text":"","category":"section"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"Not very useful but highly glamourous.","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"(Image: Glamour view)","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>examples/visualization/glamour_view.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"#| creates: docs/src/_fig/glamour_view.png\n#| requires: data/output/cap1.h5\n#| collect: figures\n\nmodule Script\n\nusing CairoMakie\nusing CarboKitten.Visualization: glamour_view!\nusing HDF5\n\nfunction main()\n    fig = Figure()\n    ax = Axis3(fig[1,1])\n    h5open(\"data/output/cap1.h5\", \"r\") do fid\n        glamour_view!(ax, fid)\n    end\n    save(\"docs/src/_fig/glamour_view.png\", fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"<div class=\"noweb-label\">file:<i>ext/GlamourView.jl</i></div>","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"module GlamourView\n\nimport CarboKitten.Visualization: glamour_view!\nusing CarboKitten.Utility: in_units_of\nusing CarboKitten.Export: Header, DataVolume\nusing Makie\nusing HDF5\nusing Unitful\n\nfunction glamour_view!(ax::Makie.Axis3, header::Header, data::DataVolume; colormap=Reverse(:speed))\n    x = header.axes.x[data.slice[1]] |> in_units_of(u\"km\")\n    y = header.axes.y[data.slice[2]] |> in_units_of(u\"km\")\n\txy_aspect = x[end] / y[end]\n\n\tax.aspect = (xy_aspect, 1, 1)\n\tax.azimuth = -π/3\n\n    n_steps = size(data.sediment_thickness)[3]\n\tgrid_size = (length(x), length(y))\n\tsteps_between = 2\n\tselected_steps = [1, ((1:steps_between) .* n_steps .÷ (steps_between + 1))..., n_steps]\n\tbedrock = header.initial_topography .- header.axes.t[end] * header.subsidence_rate\n\n\tresult = Array{Float64, 3}(undef, grid_size..., length(selected_steps))\n\tfor (i, j) in enumerate(selected_steps)\n        result[:, :, i] = (data.sediment_thickness[:,:,j] .+ bedrock) |> in_units_of(u\"m\")\n\tend\n\n\tsurface!(ax, x, y, result[:,:,1];\n\t\tcolor=ones(grid_size),\n\t\tcolormap=:grays)\n\n\tfor s in eachslice(result[:,:,2:end-1], dims=3)\n\t\tsurface!(ax, x, y, s;\n\t\t\tcolormap=(colormap, 0.7))\n\tend\n\n\tsurface!(ax, x, y, result[:,:,end];\n\t\tcolormap=colormap)\n\tlines!(ax, x, zeros(grid_size[1]), result[:, 1, end]; color=(:white, 0.5), linewidth=1)\n\tlines!(ax, fill(x[end], grid_size[2]), y, result[end, :, end]; color=(:white, 0.5), linewidth=1)\nend\n\nfunction glamour_view(header::Header, data::DataVolume; colormap=Reverse(:speed))\n    fig = Figure()\n    ax = Axis3(fig[1, 1])\n    glamour_view!(ax, header, data, colormap=colormap)\n    return fig, ax\nend\n\nend","category":"page"},{"location":"visualization/","page":"Visualizations","title":"Visualizations","text":"","category":"page"},{"location":"denudation/denudation/#Denudation","page":"Denudation","title":"Denudation","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Denudation can be applied in three ways: modelling physical erosion, modelling chemical dissolution and estimating total denudation rates based on chlorine (Cl) isotope data.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Physical Erosion\nChemical Dissolution\nEmpirical Denudation","category":"page"},{"location":"denudation/denudation/#How-to-use?","page":"Denudation","title":"How to use?","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"In CarboKitten, you could choose which type of the three you would like to apply. To do this you could simply change the erosion_type in the input.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Example: in examples, you find caps_miller_diss.jl, caps_miller_emp.jl, caps_miller_phys.jl, for chemical dissolution, empirical denudation or physical denudation, respectively. This file uses the [6] cure as sea level curve input. You could try different erosion types by changing the erosion_type:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"NoDenudation means no erosion, and is used for debugging only.\nDissolution means chemical dissolution. The default input parameters are: Temperature = 273K, precipitation = 1000mm/yr, atmospheric CO2 partial pressure = 10^(-1.5)* ATM, and reaction rate = 0.002 m/yr.\nPhysicalErosion means physical erosion and sediments redistribution. The default parameters is erodability = 0.001 m/yr.\nEmpericalDenudation means total denudation calculated based on emperical relationship by Cl isotope observations. The default input parameter is: precipitation = 1000mm/yr.","category":"page"},{"location":"denudation/denudation/#Tests-for-three-modes-of-denudation","page":"Denudation","title":"Tests for three modes of denudation","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"In this module, 7 tests are implemented.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Tests 1:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_LOW_T) < sum(denudation_mass_HIGH_T)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means that higher temperature would dissolve faster than the colder scenario. It tests the Dissolution mode.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test2:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_LOW_P) < sum(denudation_mass_HIGH_P)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means more humid scenario has higher denudation rates than the arid scenario. This tests emperical denudation mode.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test3:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_phys) > sum(denudation_mass_phys_flat)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means more topography has higher denudation rates than the flatter topography. This tests physical erosion.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test4:","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"@test sum(denudation_mass_phys) ≈ sum(redistribution_mass)","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"This means in physical erosion mode, the total amount of eroded material = the total amount of redistributed material. In this case, boundary condition of 'Periodic has been used.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"Test 5 to 7 are regression tests: the outputs from the module is similar to the values calculated by calculator.","category":"page"},{"location":"denudation/denudation/#API","page":"Denudation","title":"API","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"The different denudation models all follow the same API.","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"<div class=\"noweb-label\">file:<i>src/Denudation/Abstract.jl</i></div>","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"module Abstract\n\nusing ...BoundaryTrait: Boundary\nusing ...Boxes: Box\n\nusing Unitful\n\nabstract type DenudationType end\n\n\"\"\"\n    denudation(box, param, state)\n\n\nComputes the denudation for a single time-step, given denudation parameters `param` and a simulation state `state`. `param` should have a `DenudationType` type and `state` should contain the `height` property and `sealevel`.\n\nReturns denudation mass in units of meters.\n\"\"\"\nfunction denudation(input)\n\n    function (state, water_depth, slope)\n        if denudation(input.box, input.denudation, water_depth, slope, input.facies,state) !== nothing\n        return denudation(input.box, input.denudation, water_depth, slope, input.facies,state) .* input.time.Δt\n        else\n        return nothing\n        end\n    end\nend\n\n\"\"\"\n    denudation(box::Box, param::DenudationType, water_depth, slope, facies)\n\nComputes the amount of denudation. This function is called on a pixel by pixel basis, so all arguments can be assumed to be scalar. The `param` argument should be of a subtype of `DenudationType` containing all the input parameters for this specific denudation model.\n\"\"\"\nfunction denudation(box::Box, param::DenudationType, water_depth, slope, facies, state)\n    error(\"Abstract `denudation` function called.\")\nend\n\n\"\"\"\n    redistribution()\n\nTakes `state`, `water_depth` in meters and `denudation_mass` as a 3D array (facies, x and y coordinates) in units of meters.\n\"\"\"\nfunction redistribution(input)\n    function (state, water_depth, denudation_mass)\n        return redistribution(input.box, input.denudation, denudation_mass, water_depth)\n    end\nend\n\nfunction redistribution(box::Box, param::DenudationType, denudation_mass, water_depth)\n    error(\"Abstract `redistribution` function called.\")\nend\n\nend  # module","category":"page"},{"location":"denudation/denudation/#No-Denudation","page":"Denudation","title":"No Denudation","text":"","category":"section"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"<div class=\"noweb-label\">file:<i>src/Denudation/NoDenudationMod.jl</i></div>","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"\"\"\"\n    module NoDenudation\n\nDoesn't do any denudation: used for testing purposes.\n\"\"\"\nmodule NoDenudationMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...Boxes: Box\nusing Unitful\n\nstruct NoDenudation <: DenudationType end\n\nfunction denudation(box::Box, p::NoDenudation, water_depth::Any, slope, facies, state)\n    return nothing\nend\n\nfunction redistribution(box::Box, p::NoDenudation, denudation_mass, water_depth)\n    return nothing\nend\n\nend","category":"page"},{"location":"denudation/denudation/","page":"Denudation","title":"Denudation","text":"","category":"page"},{"location":"onshore-transport/#Onshore-transport","page":"Onshore Transport","title":"Onshore transport","text":"","category":"section"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"In the Active Layer approach, we derived a diffusion equation for our transport model starting with a proposition for the sediment flux as,","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"q_f = -nu_f P_f nabla eta","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"where nu_f is the diffusion coefficient, P_f the production and eta the sediment height. Then inserting that into the mass balance equation,","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"partial_t eta_f = -nabla cdot q_f + P_f","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Now we'll add a vector component P_f w_f(eta) to the flux:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"q_f = -nu_f P_f nabla eta + P_f w_f(eta)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"This leads to the modified advection-diffusion equation:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"partial_t eta_f = nu_f (P_f nabla^2 eta + nabla P_f cdot nabla eta) - nabla cdot (P_f w_f(eta)) + P_f","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Using the chain-rule nabla cdot (P_f w_f(eta)) = P_f (w_f cdot nabla eta) + nabla P_f cdot w_f, we arrive at:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"partial_t eta_f = nu_f P_f nabla^2 eta + (nu_f nabla P_f - P_f w_f) cdot nabla eta - nabla P_f cdot w_f + P_f","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"So we modify the advection component in the active layer approach with P_f w_f, the derivative of the wave induced flux with respect to water depth and add a new term nabla P_f cdot w_f.","category":"page"},{"location":"onshore-transport/#Xi-and-Burgess-2022","page":"Onshore Transport","title":"Xi & Burgess 2022","text":"","category":"section"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Xi & Burgess use the following equation for the phase velocity of waves as a function of depth:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v(w) = sqrtfraclambda gk rm tanh (k w)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"where k = 2pilambda and g is the gravitational acceleration. It could be that the square root should be extended over the rm tanh function, following the derivation on Airy wave theory on Wikipedia. It should be noted that this velocity is the phase-velocity of surface waves, given the total depth of the water. To evaluate the transport velocity at deeper levels, we need to look at the Stokes drift. This will effectively multiply the phase velocity with a factor exp(-kw). We'll leave the proportionality as an input parameter.","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v(w) propto tanhk w exp-kw","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"Derivative of tanh is 1 - tanh^2, so:","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v(w) = A tanh(k w) exp(- k w)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"beginaligned\nv(w) = A k (1 - tanh^2(k w)) exp(- k w) - tanh(k w) exp(-k w)\n      = A k exp(-k w) 1 - tanh^2(k w) - tanh(k w)\nendaligned","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"<div class=\"noweb-label\">⪡wave-transport-magnitude⪢≣</div>","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"v_prof(v_max, max_depth, w) = \n  \tlet k = sqrt(0.5) / max_depth,\n\t\t    A = 3.331 * v_max,\n\t\t    α = tanh(k * w),\n\t\t    β = exp(-k * w)\n\t\t    (A * α * β, -A * k * β * (1 - α - α^2))\n\t  end","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"(Image: Plot of wave transport magnitude with a maximum velocity of 10 m/yr at a depth of 20 m.)","category":"page"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"#| creates: docs/src/_fig/wave-transport-magnitude.svg\n#| collect: figures\nmodule PlotWaveTransportMagnitude\nusing CairoMakie\nusing Unitful\n\n<<wave-transport-magnitude>>\n\nfunction main()\n  w = LinRange(0, 100.0, 1000)u\"m\"\n\tf = v_prof.(10.0u\"m/yr\", 20.0u\"m\", w)\n\n\tv = first.(f)\n\ts = last.(f)\n\t\n\tfig = Figure()\n\tax1 = Axis(fig[1, 1], title=\"transport velocity\", yreversed=true, xlabel=\"velocity [m/yr]\", ylabel=\"depth [m]\")\n\tax2 = Axis(fig[1, 2], title=\"transport shear\", yreversed=true, xlabel=\"shear [1/yr]\", ylabel=\"depth [m]\")\n\tlines!(ax1, v / u\"m/yr\", w / u\"m\")\n\tlines!(ax2, s / u\"1/yr\", w / u\"m\")\n\tsave(\"docs/src/_fig/wave-transport-magnitude.svg\", fig)\nend\n\nend\n\nPlotWaveTransportMagnitude.main()","category":"page"},{"location":"onshore-transport/#","page":"Onshore Transport","title":"","text":"","category":"section"},{"location":"onshore-transport/","page":"Onshore Transport","title":"Onshore Transport","text":"","category":"page"},{"location":"components/initial_sediment/#Initial-Sediment","page":"Initial Sediment","title":"Initial Sediment","text":"","category":"section"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"800pt\" height=\"355pt\"\n viewBox=\"0.00 0.00 800.00 355.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 351)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-351 796,-351 796,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M210,-347C210,-347 72,-347 72,-347 66,-347 60,-341 60,-335 60,-335 60,-280 60,-280 60,-274 66,-268 72,-268 72,-268 210,-268 210,-268 216,-268 222,-274 222,-280 222,-280 222,-335 222,-335 222,-341 216,-347 210,-347\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-316.5 215,-316.5 \"/>\n<text text-anchor=\"start\" x=\"75.5\" y=\"-325.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"67,-293.5 67,-316.5 114,-316.5 114,-293.5 67,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"67,-293.5 114,-293.5 114,-316.5 67,-316.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"114,-293.5 114,-316.5 168,-316.5 168,-293.5 114,-293.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"114,-293.5 114,-316.5 168,-316.5 168,-293.5 114,-293.5\"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"168,-293.5 168,-316.5 215,-316.5 215,-293.5 168,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"215,-316.5 168,-316.5 168,-293.5 215,-293.5 \"/>\n<text text-anchor=\"start\" x=\"172\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"114,-274.5 114,-293.5 \"/>\n<text text-anchor=\"start\" x=\"71\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"168,-274.5 168,-293.5 \"/>\n<text text-anchor=\"start\" x=\"118\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"171\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node2\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M270,-232C270,-232 12,-232 12,-232 6,-232 0,-226 0,-220 0,-220 0,-127 0,-127 0,-121 6,-115 12,-115 12,-115 270,-115 270,-115 276,-115 282,-121 282,-127 282,-127 282,-220 282,-220 282,-226 276,-232 270,-232\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-201.5 275,-201.5 \"/>\n<text text-anchor=\"start\" x=\"93.5\" y=\"-210.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-178.5 7,-201.5 124,-201.5 124,-178.5 7,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-178.5 124,-178.5 124,-201.5 7,-201.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"124,-178.5 124,-201.5 178,-201.5 178,-178.5 124,-178.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"124,-178.5 124,-201.5 178,-201.5 178,-178.5 124,-178.5\"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"178,-178.5 178,-201.5 275,-201.5 275,-178.5 178,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"275,-201.5 178,-201.5 178,-178.5 275,-178.5 \"/>\n<text text-anchor=\"start\" x=\"182\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-159.5 124,-178.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-159.5 178,-178.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-140.5 124,-159.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-140.5 178,-159.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"124,-121.5 124,-140.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-128.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"178,-121.5 178,-140.5 \"/>\n<text text-anchor=\"start\" x=\"128\" y=\"-128.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"181\" y=\"-128.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M141,-267.97C141,-259.98 141,-251.34 141,-242.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"144.5,-242.47 141,-232.47 137.5,-242.47 144.5,-242.47\"/>\n</g>\n<!-- InitialSediment -->\n<g id=\"node6\" class=\"node\">\n<title>InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M475.5,-79C475.5,-79 286.5,-79 286.5,-79 280.5,-79 274.5,-73 274.5,-67 274.5,-67 274.5,-12 274.5,-12 274.5,-6 280.5,0 286.5,0 286.5,0 475.5,0 475.5,0 481.5,0 487.5,-6 487.5,-12 487.5,-12 487.5,-67 487.5,-67 487.5,-73 481.5,-79 475.5,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"282,-48.5 481,-48.5 \"/>\n<text text-anchor=\"start\" x=\"319.5\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">InitialSediment</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"282,-25.5 282,-48.5 329,-48.5 329,-25.5 282,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"282,-25.5 329,-25.5 329,-48.5 282,-48.5 \"/>\n<text text-anchor=\"start\" x=\"286\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"329,-25.5 329,-48.5 434,-48.5 434,-25.5 329,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"329,-25.5 329,-48.5 434,-48.5 434,-25.5 329,-25.5\"/>\n<text text-anchor=\"start\" x=\"333\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"434,-25.5 434,-48.5 481,-48.5 481,-25.5 434,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"481,-48.5 434,-48.5 434,-25.5 481,-25.5 \"/>\n<text text-anchor=\"start\" x=\"438\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"329,-6.5 329,-25.5 \"/>\n<text text-anchor=\"start\" x=\"286\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"434,-6.5 434,-25.5 \"/>\n<text text-anchor=\"start\" x=\"333\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">initial_sediment</text>\n<text text-anchor=\"start\" x=\"437\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;InitialSediment -->\n<g id=\"edge5\" class=\"edge\">\n<title>WaterDepth&#45;&gt;InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M245.57,-114.99C264.57,-104.54 284.09,-93.8 302.19,-83.85\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"303.87,-86.91 310.95,-79.03 300.5,-80.78 303.87,-86.91\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node3\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M547,-347C547,-347 409,-347 409,-347 403,-347 397,-341 397,-335 397,-335 397,-280 397,-280 397,-274 403,-268 409,-268 409,-268 547,-268 547,-268 553,-268 559,-274 559,-280 559,-280 559,-335 559,-335 559,-341 553,-347 547,-347\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"404,-316.5 552,-316.5 \"/>\n<text text-anchor=\"start\" x=\"454.5\" y=\"-325.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"404,-293.5 404,-316.5 451,-316.5 451,-293.5 404,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"404,-293.5 451,-293.5 451,-316.5 404,-316.5 \"/>\n<text text-anchor=\"start\" x=\"408\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"451,-293.5 451,-316.5 505,-316.5 505,-293.5 451,-293.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"451,-293.5 451,-316.5 505,-316.5 505,-293.5 451,-293.5\"/>\n<text text-anchor=\"start\" x=\"455\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"505,-293.5 505,-316.5 552,-316.5 552,-293.5 505,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"552,-316.5 505,-316.5 505,-293.5 552,-293.5 \"/>\n<text text-anchor=\"start\" x=\"509\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"451,-274.5 451,-293.5 \"/>\n<text text-anchor=\"start\" x=\"408\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"505,-274.5 505,-293.5 \"/>\n<text text-anchor=\"start\" x=\"455\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"508\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M396.85,-274.71C365.3,-262.35 328.09,-247.78 291.97,-233.63\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"292.91,-230.24 282.32,-229.85 290.35,-236.76 292.91,-230.24\"/>\n</g>\n<!-- SedimentBuffer -->\n<g id=\"node5\" class=\"node\">\n<title>SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M780,-222.5C780,-222.5 492,-222.5 492,-222.5 486,-222.5 480,-216.5 480,-210.5 480,-210.5 480,-136.5 480,-136.5 480,-130.5 486,-124.5 492,-124.5 492,-124.5 780,-124.5 780,-124.5 786,-124.5 792,-130.5 792,-136.5 792,-136.5 792,-210.5 792,-210.5 792,-216.5 786,-222.5 780,-222.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-192.5 785,-192.5 \"/>\n<text text-anchor=\"start\" x=\"573\" y=\"-201.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">SedimentBuffer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"487,-169.5 487,-192.5 634,-192.5 634,-169.5 487,-169.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"487,-169.5 634,-169.5 634,-192.5 487,-192.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-177.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"634,-169.5 634,-192.5 688,-192.5 688,-169.5 634,-169.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"634,-169.5 634,-192.5 688,-192.5 688,-169.5 634,-169.5\"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-177.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"688,-169.5 688,-192.5 785,-192.5 785,-169.5 688,-169.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"785,-192.5 688,-192.5 688,-169.5 785,-169.5 \"/>\n<text text-anchor=\"start\" x=\"692\" y=\"-177.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"634,-150.5 634,-169.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-157.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer_size</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"688,-150.5 688,-169.5 \"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-157.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"691\" y=\"-157.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"634,-131.5 634,-150.5 \"/>\n<text text-anchor=\"start\" x=\"491\" y=\"-138.5\" font-family=\"monospace\" font-size=\"10.00\">depositional_resolution</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"688,-131.5 688,-150.5 \"/>\n<text text-anchor=\"start\" x=\"638\" y=\"-138.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"691\" y=\"-138.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;SedimentBuffer -->\n<g id=\"edge3\" class=\"edge\">\n<title>Boxes&#45;&gt;SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M524.12,-267.97C538.55,-255.91 554.76,-242.37 570.27,-229.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"572.87,-231.81 578.3,-222.71 568.38,-226.43 572.87,-231.81\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M450,-213C450,-213 312,-213 312,-213 306,-213 300,-207 300,-201 300,-201 300,-146 300,-146 300,-140 306,-134 312,-134 312,-134 450,-134 450,-134 456,-134 462,-140 462,-146 462,-146 462,-201 462,-201 462,-207 456,-213 450,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-182.5 455,-182.5 \"/>\n<text text-anchor=\"start\" x=\"337\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"307,-159.5 307,-182.5 354,-182.5 354,-159.5 307,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-159.5 354,-159.5 354,-182.5 307,-182.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"354,-159.5 354,-182.5 408,-182.5 408,-159.5 354,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"354,-159.5 354,-182.5 408,-182.5 408,-159.5 354,-159.5\"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"408,-159.5 408,-182.5 455,-182.5 455,-159.5 408,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"455,-182.5 408,-182.5 408,-159.5 455,-159.5 \"/>\n<text text-anchor=\"start\" x=\"412\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"354,-140.5 354,-159.5 \"/>\n<text text-anchor=\"start\" x=\"311\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"408,-140.5 408,-159.5 \"/>\n<text text-anchor=\"start\" x=\"358\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"411\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;InitialSediment -->\n<g id=\"edge4\" class=\"edge\">\n<title>FaciesBase&#45;&gt;InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M381,-133.97C381,-120.13 381,-104.33 381,-89.7\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"384.5,-89.31 381,-79.31 377.5,-89.31 384.5,-89.31\"/>\n</g>\n<!-- SedimentBuffer&#45;&gt;InitialSediment -->\n<g id=\"edge6\" class=\"edge\">\n<title>SedimentBuffer&#45;&gt;InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M543.22,-124.47C517.6,-111.21 489.95,-96.9 464.87,-83.92\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"466.25,-80.69 455.76,-79.2 463.03,-86.9 466.25,-80.69\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"<div class=\"noweb-label\">file:<i>src/Components/InitialSediment.jl</i></div>","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"@compose module InitialSediment\n    @mixin FaciesBase, WaterDepth, SedimentBuffer\n    using Unitful: dimension, NoUnits\n\n    <<initial-sediment>>\nend","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"Mostly for debugging and testing purposes it can be convenient to specify an initial layer of sediment. This component adds the initial_sediment parameter to the facies definition.","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"<div class=\"noweb-label\">⪡initial-sediment⪢≣</div>","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"@kwdef struct Facies <: AbstractFacies\n    initial_sediment = 0.0u\"m\"\nend","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"If there are multiple facies that define an initial sediment, those are all added to the sediment buffer in one go. The sediment buffer will be filled with a uniform ratio of facies.","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"<div class=\"noweb-label\">⪡initial-sediment⪢≣</div>","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"function initial_sediment(box::Box, facies::AbstractFacies)\n    s = facies.initial_sediment\n    if s isa AbstractMatrix\n        @assert size(s) == box.grid_size\n        @assert dimension(eltype(s)) == dimension(u\"m\")\n        return s\n    end\n    if s isa Quantity\n        @assert dimension(s) == dimension(u\"m\")\n        return fill(s, box.grid_size...)\n    end\n\n    # s should be callable\n    x, y = box_axes(box)\n    return s.(x, y')\nend\n\nfunction push_initial_sediment!(input::AbstractInput, state::AbstractState)\n    s = stack(initial_sediment(input.box, f) for f in input.facies; dims=1)\n    push_sediment!(state.sediment_buffer, s ./ input.depositional_resolution .|> NoUnits)\n    state.sediment_height .+= sum(s; dims=1)[1,:,:]\nend","category":"page"},{"location":"components/initial_sediment/#Tests","page":"Initial Sediment","title":"Tests","text":"","category":"section"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"<div class=\"noweb-label\">file:<i>test/Components/InitialSedimentSpec.jl</i></div>","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"@testset \"Components/InitialSediment\" begin\n\nusing Unitful\nusing CarboKitten.Components.Common\nusing CarboKitten.Components: InitialSediment as IS\n\nfunction initial_state(input::AbstractInput)\n    sediment_buffer = zeros(Float64, input.sediment_buffer_size, IS.n_facies(input), input.box.grid_size...)\n    state = IS.State(\n        step = 0,\n        sediment_height = zeros(IS.Sediment, input.box.grid_size...),\n        sediment_buffer = sediment_buffer)\n    IS.push_initial_sediment!(input, state)\n    return state\nend\n\nlet box = Box{Periodic}(grid_size=(50, 50), phys_scale=100.0u\"m\"),\n    input = IS.Input(\n        time = TimeProperties(steps=0, Δt=1.0u\"yr\"),\n        box = box,\n        facies = [ IS.Facies(initial_sediment=30u\"m\") ] ),\n    state = initial_state(input)\n\n    @test all(isapprox.(state.sediment_height, 30.0u\"m\"))\n    @test all(isapprox.(state.sediment_buffer, 1.0))\nend\n\nend","category":"page"},{"location":"components/initial_sediment/","page":"Initial Sediment","title":"Initial Sediment","text":"","category":"page"},{"location":"bosscher-1992/#Carbonate-Production","page":"Bosscher and Schlager 1992","title":"Carbonate Production","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The paper by Bosscher and Schlager (1992) [1] is an early computer model for simulating reef growth. This paper contains some of the essential ingredients that we find back in CarboKitten. We reproduce their results within the framework of CarboKitten's larger design.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The BS92 model assumes a direct relation between water depth and sediment accumulation rate. That way we can model reef growth by integrating an Ordinary Differential Equation (ODE). The Production component provides this model for the rest of CarboKitten.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: summary plot)","category":"page"},{"location":"bosscher-1992/#Parameters","page":"Bosscher and Schlager 1992","title":"Parameters","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Maximum growth rate G_m. The maximum rate of reef growth is in the range of 10-15 rm mm yr^-1 (Macintyre etal., 1977; Adey, 1978; Davies, 1983).\nExtinction coefficient k. This is a measure of the extinction of photosynthetically active radiation (PAR), i.e. light with a wavelength of 400-700 nm.  The value of k for oceanic waters ranges from 004 to 016 rm m^-1 (Jerlov, 1976); reported values for reef waters also lie within this range (Brakel, 1979; Van den Hoek et al., 1975; Weinberg, 1976; Chalker, 1981; Porter, 1985).\nSurface light intensity I_0. The light intensity at the water surface at midday in the tropics lies in the range of 2000-2250 rm mu E m^-2s^-1.\nSaturating light intensity I_k. Light saturating intensities are in the range 50-450 rm mu E m^-2s^-1, depending on species and water depth (Chalker, 1981; Wyman et al., 1987). Photoadaptation of reef-building corals has not been taken into account. More generally, light does not become a limiting factor for coral growth until it reaches roughly 10% of its surface value (B. E. Chalker, in Done, 1983).","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"from BS92","category":"page"},{"location":"bosscher-1992/#Growth-Rate","page":"Bosscher and Schlager 1992","title":"Growth Rate","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The growth rate is given as","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"g(w) = g_m tanhleft(I_0 e^-kw over I_kright)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">⪡carbonate-production⪢≣</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"g(gₘ, I₀, Iₖ, k, w) = gₘ * tanh(I₀/Iₖ * exp(-w * k))","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">⪡b92-model⪢≣</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<<carbonate-production>>\n\nstruct Parameters\n     I₀::Float64\n     Iₖ::Float64\n     k::Float64\n     gₘ::Float64\nend\n\ng(p::Parameters, w) = g(p.gₘ, p.I₀, p.Iₖ, p.k, w)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"where w is the water depth in meters, g_m is the maximum growth rate in rm m rm My^-1, I_0 is surface light intensity, I_k is saturation light intensity, and k is the extinction coefficient. We have exponential decay of light intensity as we get to deeper water, and the carbonate factories respond to light intensity through a tanh (hyperbolic tangent function). This is by no means an exact relation, rather the tanh function interpolates smoothly between one and zero. We specify a maximum growth rate and a typical intensity at which the species is no longer productive.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The shape of tanh circ exp look like this:","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: Tangens hyperbolicus)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Notice that the numbers inside the exponential need to be unit-free, so does the output. The value of tanh circ exp at a depth of 0 is 07615dots. This does not make much sense, as I believe we should start at a value of 1 at the surface. By setting I_0  I_k to some value 1 this can be alleviated, but it changes the interpretation of the constants a little. The idea is that above a certain insolation, light is not the limiting factor to the rate of photosynthesis.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"To reproduce Figure 2 in B13, I had to change the values for g_m to 500, 250, and 125 respectively, the other values from Table 2 remained the same. I guess this was done for illustration purposes.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: Production curves)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/plot-tanh.gnuplot</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"set term svg size 700, 300 font \"sans serif, 14\" linewidth 1.5\nset xrange [-5:10]\nset yrange [-0.1:1.1]\nset grid\nset key outside\nset xlabel \"x\"\nset ylabel \"y\"\nplot tanh(exp(-x)) lc rgb 'black', tanh(exp(4)*exp(-x)), tanh(exp(-0.5*x))","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/burgess2013-fig2.gnuplot</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"set term svg size 500, 600 font \"sans serif,14\" linewidth 1.5\nset trange [0:100]\nset yrange [100:0]\nset xrange [-20:520]\nset parametric\nset key right bottom\nset grid\nset ylabel \"Water depth (m)\"\nset xlabel \"Production rates\"\nplot 500*tanh(6.7 * exp(-0.8 * t)), t title 'Carbonate factory 1', \\\n     250*tanh(6.7 * exp(-0.1 * t)), t title 'Carbonate factory 2', \\\n     125*tanh(6.7 * exp(-0.005 * t)), t title 'Carbonate factory 3'","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"</details>","category":"page"},{"location":"bosscher-1992/#Depth-Evolution","page":"Bosscher and Schlager 1992","title":"Depth Evolution","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The use of water depth in both BS92 and B13 can be a bit confusing. Plots are shown up-side-down and little is done to disambiguate depth with sea level rising or lowering, or sediment accreting. Growth in deposition should give shallower sea bed. BS92 write w = (h_0 + h(t)) - (s_0 + s(t)). Actually s_0 is best set to 0, or simply included into s(t) and h_0 can be replaced with setting h(t=0) = h_0. Then, as we have the growth rate as a function of water depth g(w), we can say","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"partial_t h = -g_m rm tanhleftfracI_0I_k exp(-k (h - s(t)))right","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">⪡b92-model⪢≣</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"function model(p::Parameters, s, t_end::Float64, h₀::Float64)\n     ∂h(h::Float64, t::Float64) = let w = h - s(t)\n          w >= 0.0 ? -g(p, h - s(t)) : 0.0\n     end\n\n     dt = 1000.0\n     times = 0.0:dt:t_end\n     result = zeros(Float64, length(times))\n     result[1] = h₀\n     for (i, t) in enumerate(times[1:end-1])\n          h = result[i]\n          for j = 0:99\n               h += ∂h(h, t + j * dt/100) * (dt/100)\n          end\n          result[i+1] = h\n     end\n     return result\nend","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"It seems Eq. 5 in BS92 (the most important equation in the paper mind you!) is missing both a minus sign and a set of parentheses. Also, we should remark that at negative depth (subareal exposure) we should halt all growth.","category":"page"},{"location":"bosscher-1992/#Crosssection","page":"Bosscher and Schlager 1992","title":"Crosssection","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"The most impressive result in BS92 is the last figure. They show an input curve for s(t) but give no functional description. The curve starts with a linear drop from 0 to 120m depth over a time of 20000 years, then slowly rises with s(t) = a +  bt + A sin(2pi t  P), with a period P = sim 15-20 rm kyr, amplitude A = sim 40 rm m. It might be easiest to take a screenshot of the PDF and convert the graph into a table.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Using DifferentialEquations.jl we can integrate Equation @eq:growth-eqn. Interestingly, the only integrator that gave me noise free results is Euler. This may be due to the sudden shut-down of production at w = 0.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/using_ode.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"module BS92\n\nusing CarboKitten.DataSets: bosscher_schlager_1992\nusing Interpolations\nusing Unitful\n\n<<b92-model>>\n\nfunction sealevel_curve()\n     data = bosscher_schlager_1992()\n     linear_interpolation(data.time / u\"yr\", data.sealevel / u\"m\")\nend\n\nstruct Scenario\n     param::Parameters\n     sealevel\n     t_end::Float64\nend\n\nmodel(s::Scenario, h₀::Float64) = model(s.param, s.sealevel, s.t_end, h₀)\n\nSCENARIO_A = Scenario(\n     Parameters(2000.0, 250.0, 0.05, 0.005),\n     sealevel_curve(),\n     80_000.0)\n\nend","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Finally, we can try to reproduce figure 8 in BS92.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: stratigraphy following fig. 8 in BS92)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Note the simplicity of this result: there is no dependency on space, only on the initial depth h_0.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/fig8.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: docs/src/_fig/bs92-fig8.svg\n#| requires: examples/model/bs92/using_ode.jl\n#| collect: figures\n\nmodule Script\n     include(\"using_ode.jl\")\n     using CairoMakie\n\n     function main()\n          h0 = LinRange(0, 200, 101)\n          result = hcat([BS92.model(BS92.SCENARIO_A, h) for h in h0]...)\n          t = LinRange(0, 80_000, 81)\n\n          fig = Figure(resolution=(600,900))\n          ax = Axis(fig[1,1], xlabel=\"initial depth (m)\", ylabel=\"depth (m)\", yreversed=true)\n          for l in eachrow(result)\n               lines!(ax, h0, vec(l); color=:steelblue4, linewidth=0.5)\n          end\n          ax = Axis(fig[2,1], xlabel=\"time (years)\", ylabel=\"depth (m)\", yreversed=true)\n          lines!(ax, t, BS92.SCENARIO_A.sealevel(t); color=:steelblue4)\n\n          save(\"docs/src/_fig/bs92-fig8.svg\", fig)\n     end\nend\n\nScript.main()","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"</details>","category":"page"},{"location":"bosscher-1992/#BS92-in-CarboKitten-stack","page":"Bosscher and Schlager 1992","title":"BS92 in CarboKitten stack","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"643pt\" height=\"465pt\"\n viewBox=\"0.00 0.00 643.00 465.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 461)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-461 639,-461 639,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M293,-457C293,-457 155,-457 155,-457 149,-457 143,-451 143,-445 143,-445 143,-390 143,-390 143,-384 149,-378 155,-378 155,-378 293,-378 293,-378 299,-378 305,-384 305,-390 305,-390 305,-445 305,-445 305,-451 299,-457 293,-457\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"150,-426.5 298,-426.5 \"/>\n<text text-anchor=\"start\" x=\"200.5\" y=\"-435.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"150,-403.5 150,-426.5 197,-426.5 197,-403.5 150,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"150,-403.5 197,-403.5 197,-426.5 150,-426.5 \"/>\n<text text-anchor=\"start\" x=\"154\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"197,-403.5 197,-426.5 251,-426.5 251,-403.5 197,-403.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"197,-403.5 197,-426.5 251,-426.5 251,-403.5 197,-403.5\"/>\n<text text-anchor=\"start\" x=\"201\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"251,-403.5 251,-426.5 298,-426.5 298,-403.5 251,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"298,-426.5 251,-426.5 251,-403.5 298,-403.5 \"/>\n<text text-anchor=\"start\" x=\"255\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"197,-384.5 197,-403.5 \"/>\n<text text-anchor=\"start\" x=\"154\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"251,-384.5 251,-403.5 \"/>\n<text text-anchor=\"start\" x=\"201\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"254\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M443,-342C443,-342 185,-342 185,-342 179,-342 173,-336 173,-330 173,-330 173,-237 173,-237 173,-231 179,-225 185,-225 185,-225 443,-225 443,-225 449,-225 455,-231 455,-237 455,-237 455,-330 455,-330 455,-336 449,-342 443,-342\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"180,-311.5 448,-311.5 \"/>\n<text text-anchor=\"start\" x=\"266.5\" y=\"-320.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"180,-288.5 180,-311.5 297,-311.5 297,-288.5 180,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"180,-288.5 297,-288.5 297,-311.5 180,-311.5 \"/>\n<text text-anchor=\"start\" x=\"184\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"297,-288.5 297,-311.5 351,-311.5 351,-288.5 297,-288.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"297,-288.5 297,-311.5 351,-311.5 351,-288.5 297,-288.5\"/>\n<text text-anchor=\"start\" x=\"301\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"351,-288.5 351,-311.5 448,-311.5 448,-288.5 351,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"448,-311.5 351,-311.5 351,-288.5 448,-288.5 \"/>\n<text text-anchor=\"start\" x=\"355\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"297,-269.5 297,-288.5 \"/>\n<text text-anchor=\"start\" x=\"184\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"351,-269.5 351,-288.5 \"/>\n<text text-anchor=\"start\" x=\"301\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"354\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"297,-250.5 297,-269.5 \"/>\n<text text-anchor=\"start\" x=\"184\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"351,-250.5 351,-269.5 \"/>\n<text text-anchor=\"start\" x=\"301\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"354\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"297,-231.5 297,-250.5 \"/>\n<text text-anchor=\"start\" x=\"184\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"351,-231.5 351,-250.5 \"/>\n<text text-anchor=\"start\" x=\"301\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"354\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M250.27,-377.97C256.07,-369.46 262.38,-360.21 268.69,-350.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"271.73,-352.7 274.48,-342.47 265.95,-348.76 271.73,-352.7\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M473,-457C473,-457 335,-457 335,-457 329,-457 323,-451 323,-445 323,-445 323,-390 323,-390 323,-384 329,-378 335,-378 335,-378 473,-378 473,-378 479,-378 485,-384 485,-390 485,-390 485,-445 485,-445 485,-451 479,-457 473,-457\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"330,-426.5 478,-426.5 \"/>\n<text text-anchor=\"start\" x=\"338.5\" y=\"-435.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"330,-403.5 330,-426.5 377,-426.5 377,-403.5 330,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"330,-403.5 377,-403.5 377,-426.5 330,-426.5 \"/>\n<text text-anchor=\"start\" x=\"334\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"377,-403.5 377,-426.5 431,-426.5 431,-403.5 377,-403.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"377,-403.5 377,-426.5 431,-426.5 431,-403.5 377,-403.5\"/>\n<text text-anchor=\"start\" x=\"381\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"431,-403.5 431,-426.5 478,-426.5 478,-403.5 431,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"478,-426.5 431,-426.5 431,-403.5 478,-403.5 \"/>\n<text text-anchor=\"start\" x=\"435\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"377,-384.5 377,-403.5 \"/>\n<text text-anchor=\"start\" x=\"334\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"431,-384.5 431,-403.5 \"/>\n<text text-anchor=\"start\" x=\"381\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"434\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M377.73,-377.97C371.93,-369.46 365.62,-360.21 359.31,-350.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"362.05,-348.76 353.52,-342.47 356.27,-352.7 362.05,-348.76\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node7\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M620,-170C620,-170 482,-170 482,-170 476,-170 470,-164 470,-158 470,-158 470,-103 470,-103 470,-97 476,-91 482,-91 482,-91 620,-91 620,-91 626,-91 632,-97 632,-103 632,-103 632,-158 632,-158 632,-164 626,-170 620,-170\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"477,-139.5 625,-139.5 \"/>\n<text text-anchor=\"start\" x=\"513.5\" y=\"-148.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"477,-116.5 477,-139.5 524,-139.5 524,-116.5 477,-116.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"477,-116.5 524,-116.5 524,-139.5 477,-139.5 \"/>\n<text text-anchor=\"start\" x=\"481\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"524,-116.5 524,-139.5 578,-139.5 578,-116.5 524,-116.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"524,-116.5 524,-139.5 578,-139.5 578,-116.5 524,-116.5\"/>\n<text text-anchor=\"start\" x=\"528\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"578,-116.5 578,-139.5 625,-139.5 625,-116.5 578,-116.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"625,-139.5 578,-139.5 578,-116.5 625,-116.5 \"/>\n<text text-anchor=\"start\" x=\"582\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"524,-97.5 524,-116.5 \"/>\n<text text-anchor=\"start\" x=\"481\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\">output</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"578,-97.5 578,-116.5 \"/>\n<text text-anchor=\"start\" x=\"528\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"581\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge7\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M404.59,-224.92C423.25,-213.05 442.76,-200.62 461,-189 467.71,-184.73 474.69,-180.27 481.67,-175.81\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"483.95,-178.51 490.5,-170.18 480.18,-172.61 483.95,-178.51\"/>\n</g>\n<!-- Production -->\n<g id=\"node8\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M439.5,-189C439.5,-189 192.5,-189 192.5,-189 186.5,-189 180.5,-183 180.5,-177 180.5,-177 180.5,-84 180.5,-84 180.5,-78 186.5,-72 192.5,-72 192.5,-72 439.5,-72 439.5,-72 445.5,-72 451.5,-78 451.5,-84 451.5,-84 451.5,-177 451.5,-177 451.5,-183 445.5,-189 439.5,-189\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"188,-158.5 445,-158.5 \"/>\n<text text-anchor=\"start\" x=\"272.5\" y=\"-167.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"188,-135.5 188,-158.5 257,-158.5 257,-135.5 188,-135.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"188,-135.5 257,-135.5 257,-158.5 188,-158.5 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"257,-135.5 257,-158.5 398,-158.5 398,-135.5 257,-135.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"257,-135.5 257,-158.5 398,-158.5 398,-135.5 257,-135.5\"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"398,-135.5 398,-158.5 445,-158.5 445,-135.5 398,-135.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"445,-158.5 398,-158.5 398,-135.5 445,-135.5 \"/>\n<text text-anchor=\"start\" x=\"402\" y=\"-143.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"257,-116.5 257,-135.5 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-116.5 398,-135.5 \"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"401\" y=\"-123.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"257,-97.5 257,-116.5 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-97.5 398,-116.5 \"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"401\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"257,-78.5 257,-97.5 \"/>\n<text text-anchor=\"start\" x=\"192\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"398,-78.5 398,-97.5 \"/>\n<text text-anchor=\"start\" x=\"261\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"401\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge8\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M314.76,-224.98C314.87,-216.54 314.99,-207.77 315.1,-199.14\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"318.6,-199.15 315.24,-189.11 311.6,-199.06 318.6,-199.15\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M623,-323C623,-323 485,-323 485,-323 479,-323 473,-317 473,-311 473,-311 473,-256 473,-256 473,-250 479,-244 485,-244 485,-244 623,-244 623,-244 629,-244 635,-250 635,-256 635,-256 635,-311 635,-311 635,-317 629,-323 623,-323\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"480,-292.5 628,-292.5 \"/>\n<text text-anchor=\"start\" x=\"510\" y=\"-301.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"480,-269.5 480,-292.5 527,-292.5 527,-269.5 480,-269.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"480,-269.5 527,-269.5 527,-292.5 480,-292.5 \"/>\n<text text-anchor=\"start\" x=\"484\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"527,-269.5 527,-292.5 581,-292.5 581,-269.5 527,-269.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"527,-269.5 527,-292.5 581,-292.5 581,-269.5 527,-269.5\"/>\n<text text-anchor=\"start\" x=\"531\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"581,-269.5 581,-292.5 628,-292.5 628,-269.5 581,-269.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"628,-292.5 581,-292.5 581,-269.5 628,-269.5 \"/>\n<text text-anchor=\"start\" x=\"585\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"527,-250.5 527,-269.5 \"/>\n<text text-anchor=\"start\" x=\"484\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"581,-250.5 581,-269.5 \"/>\n<text text-anchor=\"start\" x=\"531\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"584\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge6\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M553.23,-243.61C552.84,-224.33 552.38,-200.83 551.97,-180.35\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"555.47,-180.18 551.77,-170.25 548.47,-180.32 555.47,-180.18\"/>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge9\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M493.51,-243.8C483.65,-237.5 473.55,-231.07 464,-225 448.52,-215.17 432.12,-204.78 416.09,-194.64\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"417.56,-191.42 407.23,-189.04 413.81,-197.34 417.56,-191.42\"/>\n</g>\n<!-- BS92 -->\n<g id=\"node5\" class=\"node\">\n<title>BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M332,-36C332,-36 300,-36 300,-36 294,-36 288,-30 288,-24 288,-24 288,-12 288,-12 288,-6 294,0 300,0 300,0 332,0 332,0 338,0 344,-6 344,-12 344,-12 344,-24 344,-24 344,-30 338,-36 332,-36\"/>\n<text text-anchor=\"start\" x=\"295\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">BS92</text>\n</g>\n<!-- Tag -->\n<g id=\"node6\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-170C150,-170 12,-170 12,-170 6,-170 0,-164 0,-158 0,-158 0,-103 0,-103 0,-97 6,-91 12,-91 12,-91 150,-91 150,-91 156,-91 162,-97 162,-103 162,-103 162,-158 162,-158 162,-164 156,-170 150,-170\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-139.5 155,-139.5 \"/>\n<text text-anchor=\"start\" x=\"67\" y=\"-148.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-116.5 7,-139.5 54,-139.5 54,-116.5 7,-116.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-116.5 54,-116.5 54,-139.5 7,-139.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-116.5 54,-139.5 108,-139.5 108,-116.5 54,-116.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-116.5 54,-139.5 108,-139.5 108,-116.5 54,-116.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-116.5 108,-139.5 155,-139.5 155,-116.5 108,-116.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-139.5 108,-139.5 108,-116.5 155,-116.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-124.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-97.5 54,-116.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-97.5 108,-116.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-104.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Tag&#45;&gt;BS92 -->\n<g id=\"edge3\" class=\"edge\">\n<title>Tag&#45;&gt;BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M137.53,-90.76C148.39,-84.07 159.87,-77.51 171,-72 206.18,-54.59 248.56,-39.76 278.39,-30.25\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"279.51,-33.57 288,-27.23 277.41,-26.89 279.51,-33.57\"/>\n</g>\n<!-- H5Writer&#45;&gt;BS92 -->\n<g id=\"edge4\" class=\"edge\">\n<title>H5Writer&#45;&gt;BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M494.47,-90.76C483.61,-84.07 472.13,-77.51 461,-72 425.82,-54.59 383.44,-39.76 353.61,-30.25\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"354.59,-26.89 344,-27.23 352.49,-33.57 354.59,-26.89\"/>\n</g>\n<!-- Production&#45;&gt;BS92 -->\n<g id=\"edge5\" class=\"edge\">\n<title>Production&#45;&gt;BS92</title>\n<path fill=\"none\" stroke=\"black\" d=\"M316,-71.98C316,-63.14 316,-54.38 316,-46.61\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"319.5,-46.36 316,-36.36 312.5,-46.36 319.5,-46.36\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Within the CarboKitten design, we can express the BS92 model a bit more succinctly. The following produces output that is fully compatible with other CarboKitten models and the included post processing and visualization stack. The H5Writer module provides a run method that expects the initial_state, step! and write_header methods to be available.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>src/Models/BS92.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"@compose module BS92\n@mixin Tag, H5Writer, Production\n\nusing ..Common\nusing ..Production: uniform_production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    sediment_height = zeros(Height, input.box.grid_size...)\n    return State(0, sediment_height)\nend\n\nfunction step!(input::Input)\n    τ = uniform_production(input)\n    function (state::State)\n        prod = τ(state)\n        Δη = sum(prod; dims=1)[1, :, :]\n        state.sediment_height .+= Δη\n        state.step += 1\n        return Frame(\n            production = prod,\n            deposition = prod)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\n\nend","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/run.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: data/output/bs92.h5\n\nmodule Script\n\nusing CarboKitten\nusing CarboKitten.DataSets: bosscher_schlager_1992\n\nusing Interpolations\nusing Unitful\n\nfunction sealevel_curve()\n    data = bosscher_schlager_1992()\n    linear_interpolation(data.time, data.sealevel)\nend\n\nconst INPUT = BS92.Input(\n    tag = \"example model BS92\",\n    box = Box{Coast}(grid_size=(100, 1), phys_scale=600.0u\"m\"),\n    time = TimeProperties(\n      Δt = 10.0u\"yr\",\n      steps = 8000),\n    output = Dict(:full => OutputSpec(write_interval=100)),\n    sea_level = let sc = sealevel_curve()\n      t -> -sc(t)\n    end,\n    initial_topography = (x, y) -> - x / 300.0,\n    subsidence_rate = 0.0u\"m/yr\",\n    insolation = 400.0u\"W/m^2\",\n    facies = [BS92.Facies(\n      maximum_growth_rate = 0.005u\"m/yr\",\n      saturation_intensity = 50.0u\"W/m^2\",\n      extinction_coefficient = 0.05u\"m^-1\"\n    )])\n\nfunction main()\n    run_model(Model{BS92}, INPUT, \"data/output/bs92.h5\")\nend\n\nend\n\nScript.main()","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/plot.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: docs/src/_fig/bs92-summary.png\n#| requires: data/output/bs92.h5\n#| collect: figures\n\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/bs92-summary.png\", summary_plot(\"data/output/bs92.h5\"))","category":"page"},{"location":"bosscher-1992/#Multiple-facies","page":"Bosscher and Schlager 1992","title":"Multiple facies","text":"","category":"section"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"Using the above implementation of the model by Bosscher and Schlager, we can run the same model with multiple facies. We use the same parameters as Burgess2013, but divide the maximum_growth_rate by four, since we have no CA running and all facies produce at the same time.","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/multi-facies-run.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: data/output/bs92-multi-facies.h5\n\nmodule Script\n\nusing CarboKitten\n\nconst FACIES = [\n    BS92.Facies(\n         maximum_growth_rate=500u\"m/Myr\"/4,\n         extinction_coefficient=0.8u\"m^-1\",\n         saturation_intensity=60u\"W/m^2\"),\n    BS92.Facies(\n         maximum_growth_rate=400u\"m/Myr\"/4,\n         extinction_coefficient=0.1u\"m^-1\",\n         saturation_intensity=60u\"W/m^2\"),\n    BS92.Facies(\n         maximum_growth_rate=100u\"m/Myr\"/4,\n         extinction_coefficient=0.005u\"m^-1\",\n         saturation_intensity=60u\"W/m^2\")]\n\nconst INPUT = BS92.Input(\n    tag = \"example model BS92\",\n    box = Box{Coast}(grid_size=(100, 1), phys_scale=150.0u\"m\"),\n    time = TimeProperties(\n        Δt = 200.0u\"yr\",\n        steps = 5000),\n    sea_level = t -> 4.0u\"m\" * sin(2π * t / 0.2u\"Myr\"),\n    initial_topography = (x, y) -> - x / 300.0,\n    subsidence_rate = 50.0u\"m/Myr\",\n    insolation = 400.0u\"W/m^2\",\n    facies = FACIES)\n\nfunction main()\n    run_model(Model{BS92}, INPUT, \"data/output/bs92-multi-facies.h5\")\nend\n\nend\n\nScript.main()","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"<div class=\"noweb-label\">file:<i>examples/model/bs92/multi-facies-plot.jl</i></div>","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"#| creates: docs/src/_fig/bs92-multi-facies.png\n#| requires: data/output/bs92-multi-facies.h5\n#| collect: figures\n\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/bs92-multi-facies.png\", summary_plot(\"data/output/bs92-multi-facies.h5\", wheeler_smooth=(3, 5)))","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"(Image: BS92 with multiple facies)","category":"page"},{"location":"bosscher-1992/","page":"Bosscher and Schlager 1992","title":"Bosscher and Schlager 1992","text":"","category":"page"},{"location":"memory-writer/#Output","page":"Output","title":"Output","text":"","category":"section"},{"location":"memory-writer/","page":"Output","title":"Output","text":"There are two options for writing output: to HDF5 and memory. To write to an HDF5 file, you may run:","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"run_model(Model{M}, input, \"my_hdf5_output.h5\")","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"In cases where you don't want to write output immediately, you can output to memory:","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"result = run_model(Model{M}, input, new_output(MemoryOutput))","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"The result is of type MemoryOutput and contains a header field as well as data_volumes, data_slices and data_columns, containing data sets for each OutputSpec that you configured in input.output. Assuming the default, there will be a DataVolume with name :full.","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"header, data = (result.header, result.data_volumes[:full])","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"Or, in case you write to HDF5:","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"header, data = read_volume(\"my_hdf5_output.h5\", :full)","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"You can always subscript a DataVolume into DataSlice or DataColumn.","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"data[:, 25] isa DataSlice\ndata[40, 25] isa DataColumn","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"These can be used for subsequent visualization or CSV export.","category":"page"},{"location":"memory-writer/#Full-example","page":"Output","title":"Full example","text":"","category":"section"},{"location":"memory-writer/","page":"Output","title":"Output","text":"<div class=\"noweb-label\">file:<i>examples/autocycles.jl</i></div>","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"module AutoCycles\n\nusing CarboKitten\nusing CarboKitten.Models: WithoutCA as M\nusing CarboKitten.Visualization: profile_plot!\n\nusing Makie\nusing CarboKitten: Box\n\nv_const(v_max) = _ -> (Vec2(v_max, 0.0u\"m/yr\"), Vec2(0.0u\"1/yr\", 0.0u\"1/yr\"))\n\nfunction run()\n    CarboKitten.init()\n\n    facies = [\n        M.Facies(\n            maximum_growth_rate=100.0u\"m/Myr\",\n            extinction_coefficient=0.8u\"m^-1\",\n            saturation_intensity=60u\"W/m^2\",\n            diffusion_coefficient=100.0u\"m/yr\",\n            wave_velocity=v_const(-5.0u\"m/yr\")),\n        M.Facies(\n            maximum_growth_rate=20.0u\"m/Myr\",\n            extinction_coefficient=0.8u\"m^-1\",\n            saturation_intensity=60u\"W/m^2\",\n            diffusion_coefficient=10.0u\"m/yr\",\n            wave_velocity=v_const(0.0u\"m/yr\"))]\n\n\n    input = M.Input(\n        box=CarboKitten.Box{Coast}(grid_size=(500, 1), phys_scale=50.0u\"m\"),\n        time=TimeProperties(\n            Δt=20u\"yr\",\n            steps=40000),\n\n        output=Dict(\n            :profile => OutputSpec(slice = (:, 1), write_interval = 40),\n            :col1 => OutputSpec(slice = (100, 1)),\n            :col2 => OutputSpec(slice = (200, 1)),\n            :col3 => OutputSpec(slice = (300, 1)),\n            :col4 => OutputSpec(slice = (400, 1))),\n\n        initial_topography=(x, y) -> (15u\"km\" - x) / 300.0,\n        sea_level=t -> 0.0u\"m\",\n\n        subsidence_rate=50.0u\"m/Myr\",\n        disintegration_rate=100.0u\"m/Myr\",\n        cementation_time=50.0u\"yr\",\n\n        insolation=400.0u\"W/m^2\",\n        sediment_buffer_size=50,\n        depositional_resolution=0.5u\"m\",\n        facies=facies,\n\n        transport_solver=Val{:forward_euler},\n        intertidal_zone=0.0u\"m\")\n\n    result = run_model(Model{M}, input, MemoryOutput(input))\nend\n\nfunction plot(result::MemoryOutput)\n    header = result.header\n    slice = result.data_slices[:profile]\n    n_cols = length(result.data_columns)\n\n\tfig = Figure()\n    ax1 = Axis(fig[1, 1:n_cols])\n\n\tx = header.axes.x\n\tt = header.axes.t\n\n\tplot = profile_plot!(ax1, header, slice; colorrange=(0.2, 1.0)) do x; x[1] / sum(x) end \n    col_positions = [x[col.slice[1]] |> in_units_of(u\"km\") for col in values(result.data_columns)]\n    vlines!(ax1, col_positions; color=:red)\n\n    Colorbar(fig[1, n_cols+1], plot; label=L\"f_1 / f_{\\textrm{total}}\")\n\n    col_names = sort!(collect(keys(result.data_columns)))\n    for (i, k) in enumerate(col_names)\n        f1 = result.data_columns[k].deposition[1,:]\n        f2 = result.data_columns[k].deposition[2,:]\n        f_total = f1 .+ f2\n        ax = Axis(fig[2, i], title=string(k) * \" amount\")\n        lines!(ax, f1 |> in_units_of(u\"m\"), t[1:end-1] |> in_units_of(u\"Myr\"); label=\"facies 1\")\n        lines!(ax, f2 |> in_units_of(u\"m\"), t[1:end-1] |> in_units_of(u\"Myr\"); label=\"facies 2\")\n        lines!(ax, f_total |> in_units_of(u\"m\"), t[1:end-1] |> in_units_of(u\"Myr\"); label=\"total\", color=:black, linewidth=2)\n        axislegend(ax)\n    end\n\n\tfig\nend\n\nend","category":"page"},{"location":"memory-writer/#Data-Structures","page":"Output","title":"Data Structures","text":"","category":"section"},{"location":"memory-writer/","page":"Output","title":"Output","text":"<div class=\"noweb-label\">file:<i>src/OutputData.jl</i></div>","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"module OutputData\n\nexport Data, DataColumn, DataSlice, DataVolume, Slice2, Header, DataHeader, Axes, AbstractOutput, Frame\nexport parse_multi_slice, data_kind, new_output, add_data_set, set_attribute, state_writer, frame_writer\n\nusing Unitful\n\nconst Length = typeof(1.0u\"m\")\nconst Time = typeof(1.0u\"Myr\")\nconst Slice2 = NTuple{2, Union{Int, Colon, UnitRange{Int}}}\nconst Amount = typeof(1.0u\"m\")\nconst Sediment = typeof(1.0u\"m\")\nconst Rate = typeof(1.0u\"m/Myr\")\n\nabstract type AbstractOutputSpec end\nabstract type AbstractInput end\nabstract type AbstractOutput end\nabstract type AbstractState end\n\n@kwdef struct OutputSpec <: AbstractOutputSpec\n    slice::Slice2 = (:, :)\n    write_interval::Int = 1\nend\n\n@kwdef struct Axes\n    x::Vector{Length}\n    y::Vector{Length}\n    t::Vector{Time}\nend\n\n@kwdef struct DataHeader\n    kind::Symbol\n    slice::Slice2\n    write_interval::Int\nend\n\n@kwdef struct Header\n    tag::String\n    axes::Axes\n\n    Δt::Time\n    time_steps::Int\n    grid_size::NTuple{2,Int}\n    n_facies::Int\n\n    initial_topography::Matrix{Amount}\n    sea_level::Vector{Length}\n    subsidence_rate::Rate\n    data_sets::Dict{Symbol, DataHeader}\n    attributes::Dict{Symbol, Any} = Dict()\nend\n\n@kwdef struct Data{F, D}\n\tslice::Slice2\n\twrite_interval::Int\n\t# Julia doesn't allow to say Array{Amount,D+1} here\n    disintegration::Array{Amount,F}\n\tproduction::Array{Amount,F}\n    deposition::Array{Amount,F}\n    sediment_thickness::Array{Amount,D}\nend\n\nconst DataVolume = Data{4, 3}\nconst DataSlice = Data{3, 2}\nconst DataColumn = Data{2, 1}\n\n@kwdef struct Frame\n    disintegration::Union{Array{Sediment,3},Nothing} = nothing   # facies, x, y\n    production::Union{Array{Sediment,3},Nothing} = nothing\n    deposition::Union{Array{Sediment,3},Nothing} = nothing\nend\n\ncount_ints(::Int, args...) = 1 + count_ints(args...)\ncount_ints(_, args...) = count_ints(args...)\ncount_ints() = 0\n\nreduce_slice(s::Tuple{Colon, Colon}, x, y) = (x, y)\nreduce_slice(s::Tuple{Int, Colon}, y::Int) = (s[1], y)\nreduce_slice(s::Tuple{Colon, Int}, x::Int) = (x, s[2])\n\nBase.getindex(v::Data{F,D}, args...) where {F, D} = let k = count_ints(args...)\n\tData{F-k, D-k}(\n\t\treduce_slice(v.slice, args...),\n\t\tv.write_interval,\n\t\tv.disintegration[:, args..., :],\n\t\tv.production[:, args..., :],\n\t\tv.deposition[:, args..., :],\n\t\tv.sediment_thickness[args..., :])\nend\n\nfunction parse_slice(s::AbstractString)\n\tif s == \":\"\n\t\treturn (:)\n\tend\n\n\telements =  split(s, \":\")\n\tif length(elements) == 1\n\t\treturn parse(Int, s)\n\tend\n\n\ta, b = elements\n\treturn parse(Int, a):parse(Int, b)\nend\n\nparse_multi_slice(s::AbstractString) = Slice2(parse_slice.(split(s, \",\")))\n\ndata_kind(::Int, ::Int) = :column\ndata_kind(::Int, _) = :slice\ndata_kind(_, ::Int) = :slice\ndata_kind(_, _) = :volume\ndata_kind(spec::OutputSpec) = data_kind(spec.slice...)\n\n\"\"\"\n    new_output(::Type{T}, input)\n\nCreate a new output object of type `T`, given `input`.\n\"\"\"\nfunction new_output end\n\n\"\"\"\n    add_data_set(out::T, name::Symbol, spec::OutputSpec)\n\nAdd a data set to the output object.\n\"\"\"\nfunction add_data_set end\n\n\"\"\"\n    set_attribute(out::T, name::Symbol, value::Any)\n\nSet an attribute in the output object.\n\"\"\"\nfunction set_attribute end\n\n\"\"\"\n    write_sediment_thickness(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nWrite the sediment thickness to the output object. The `idx` should be corrected for write\ninterval. That is, `idx` should range from `1` to `n_writes` for the named data set. This\nfunction should be implemented for 0, 1, and 2 dimensional arrays, corresponding to writing\ncolumn, slice or volume data.\n\nIf your output object type doesn't conform to the standard CarboKitten data layout, you may\nchoose to not implement this function and implement `state_writer` and `frame_writer` instead.\nThe same goes for `write_production`, `write_disintegration` and `write_deposition`.\n\"\"\"\nfunction write_sediment_thickness end\n\n\"\"\"\n    write_production(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nSee `write_sediment_thickness`. Should accept 1, 2, and 3 dimensional arrays, corresponding to\nwriting column, slice or volume data. (first axis is facies, then x and y)\n\"\"\"\nfunction write_production end\n\n\"\"\"\n    write_disintegration(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nSee `write_sediment_thickness`. Should accept 1, 2, and 3 dimensional arrays, corresponding to\nwriting column, slice or volume data. (first axis is facies, then x and y)\n\"\"\"\nfunction write_disintegration end\n\n\"\"\"\n    write_deposition(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nSee `write_sediment_thickness`. Should accept 1, 2, and 3 dimensional arrays, corresponding to\nwriting column, slice or volume data. (first axis is facies, then x and y)\n\"\"\"\nfunction write_deposition end\n\n\"\"\"\n    state_writer(input::AbstractInput, out::T)\n\nReturns a `function (idx::Int, state::AbstractState)`.\n\nWrite the state of the simulation to the output object. It is the responsibility\nof the implementation to choose to write or not based on the set write interval.\n\nThe default implementation writes the state for all output data sets, and calls\n`write_sediment_thickness`.\n\"\"\"\nfunction state_writer(input::AbstractInput, out)\n    output_sets = input.output\n    grid_size = input.box.grid_size\n\n    return function(idx::Int, state::AbstractState)\n        for (k, v) in output_sets\n            if mod(idx-1, v.write_interval) == 0\n                write_sediment_thickness(\n                    out, k, div(idx-1, v.write_interval)+1,\n                    view(state.sediment_height, v.slice...)) \n            end\n        end\n    end\nend\n\n\"\"\"\n    frame_writer(input::AbstractInput, out::T)\n\nReturns a `function (idx::Int, state::AbstractState)`.\n\nWrite the state of the simulation to the output object. It is the responsibility\nof the implementation to choose to write or not based on the set write interval.\n\nThe default implementation writes the state for all output data sets, and calls\n`write_sediment_thickness`.\n\"\"\"\nfunction frame_writer(input::AbstractInput, out)\n    n_f = length(input.facies)\n    grid_size = input.box.grid_size\n\n    return function(idx::Int, frame::Frame)\n        try_write(tgt, ::Nothing, k, v) = ()\n        function try_write(write::F, src, k, v) where {F}\n            write(out, k, div(idx-1, v.write_interval) + 1,\n                  view(src, :, v.slice...))\n        end\n\n        for (k, v) in input.output\n            try_write(write_production, frame.production, k, v)\n            try_write(write_disintegration, frame.disintegration, k, v)\n            try_write(write_deposition, frame.deposition, k, v)\n        end\n    end\nend\n\nend","category":"page"},{"location":"memory-writer/#Memory-Writer","page":"Output","title":"Memory Writer","text":"","category":"section"},{"location":"memory-writer/","page":"Output","title":"Output","text":"Sometimes we don't want to write to HDF5, but just get a DataVolume directly.","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"<div class=\"noweb-label\">file:<i>src/MemoryWriter.jl</i></div>","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"module MemoryWriter\n\nusing ..OutputData\nimport ..OutputData:\n    new_output, add_data_set, set_attribute, write_sediment_thickness,\n    write_production, write_disintegration, write_deposition, AbstractOutputSpec\n\nusing ..Components.Common\nusing ..Components.WaterDepth: initial_topography\nusing ..CarboKitten: time_axis, box_axes\n\nstruct MemoryOutput <: AbstractOutput\n    header::Header\n    data_volumes::Dict{Symbol, DataVolume}\n    data_slices::Dict{Symbol, DataSlice}\n    data_columns::Dict{Symbol, DataColumn}\nend\n\nMemoryOutput(input::AbstractInput) = new_output(MemoryOutput, input)\n\nfunction new_output(::Type{MemoryOutput}, input::AbstractInput)\n    t_axis = time_axis(input.time)\n    x_axis, y_axis = box_axes(input.box)\n    axes = Axes(x = x_axis, y = y_axis, t = t_axis)\n    h0 = initial_topography(input)\n    sl = input.sea_level.(t_axis)\n\n    header = Header(\n        tag = input.tag,\n        axes = axes,\n        Δt = input.time.Δt,\n        time_steps = input.time.steps,\n        grid_size = input.box.grid_size,\n        n_facies = length(input.facies),\n        initial_topography = h0,\n        sea_level = sl,\n        subsidence_rate = input.subsidence_rate,\n        data_sets = Dict(),\n        attributes = Dict())\n\n    return MemoryOutput(header, Dict(), Dict(), Dict())\nend\n\naxis_size(::Colon, a::Int) = a\naxis_size(::Int, _) = 1\naxis_size(r::AbstractRange{Int}, _) = length(r)\n\nfunction add_data_set(out::MemoryOutput, label::Symbol, spec::AbstractOutputSpec)\n    h = DataHeader(data_kind(spec), spec.slice, spec.write_interval)\n    out.header.data_sets[label] = h\n\n    slice = spec.slice\n    write_interval = spec.write_interval\n\n    full_size = out.header.grid_size\n    n_steps = div(out.header.time_steps, write_interval)\n    n_facies = out.header.n_facies\n\n    if h.kind == :volume\n        size = axis_size.(slice, full_size)\n        out.data_volumes[label] = DataVolume(\n            slice, write_interval,\n            zeros(Amount, n_facies, size..., n_steps),\n            zeros(Amount, n_facies, size..., n_steps),\n            zeros(Amount, n_facies, size..., n_steps),\n            zeros(Amount, size..., n_steps + 1))\n    elseif h.kind == :slice\n        size = axis_size.(slice, full_size)\n        slice_size = size[1] == 1 ? size[2] : size[1]\n        out.data_slices[label] = DataSlice(\n            slice, write_interval,\n            zeros(Amount, n_facies, slice_size, n_steps),\n            zeros(Amount, n_facies, slice_size, n_steps),\n            zeros(Amount, n_facies, slice_size, n_steps),\n            zeros(Amount, slice_size, n_steps + 1)) \n    elseif h.kind == :column\n        out.data_columns[label] = DataColumn(\n            slice, write_interval,\n            zeros(Amount, n_facies, n_steps),\n            zeros(Amount, n_facies, n_steps),\n            zeros(Amount, n_facies, n_steps),\n            zeros(Amount, n_steps + 1))\n    end\nend\n\nfunction set_attribute(out::MemoryOutput, name::Symbol, value::Any)\n    out.header.attributes[name] = value\nend\n\nwrite_sediment_thickness(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 0}) =\n    out.data_columns[label].sediment_thickness[idx] = data[]\nwrite_sediment_thickness(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 1}) =\n    out.data_slices[label].sediment_thickness[:, idx] .= data\nwrite_sediment_thickness(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 2}) =\n    out.data_volumes[label].sediment_thickness[:, :, idx] .= data\n\nwrite_production(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 1}) =\n    out.data_columns[label].production[:, idx] .+= data\nwrite_production(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 2}) =\n    out.data_slices[label].production[:, :, idx] .+= data\nwrite_production(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 3}) =\n    out.data_volumes[label].production[:, :, :, idx] .+= data\n\nwrite_disintegration(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 1}) =\n    out.data_columns[label].disintegration[:, idx] .+= data\nwrite_disintegration(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 2}) =\n    out.data_slices[label].disintegration[:, :, idx] .+= data\nwrite_disintegration(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 3}) =\n    out.data_volumes[label].disintegration[:, :, :, idx] .+= data\n\nwrite_deposition(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 1}) =\n    out.data_columns[label].deposition[:, idx] .+= data\nwrite_deposition(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 2}) =\n    out.data_slices[label].deposition[:, :, idx] .+= data\nwrite_deposition(out::MemoryOutput, label::Symbol, idx::Int, data::AbstractArray{Amount, 3}) =\n    out.data_volumes[label].deposition[:, :, :, idx] .+= data\n\nend","category":"page"},{"location":"memory-writer/","page":"Output","title":"Output","text":"","category":"page"},{"location":"first_tutorial/","page":"Tutorial (Pluto notebook)","title":"Tutorial (Pluto notebook)","text":"","category":"page"},{"location":"getting-started/#Getting-Started","page":"Getting Started","title":"Getting Started","text":"","category":"section"},{"location":"getting-started/#TODO","page":"Getting Started","title":"TODO","text":"","category":"section"},{"location":"getting-started/","page":"Getting Started","title":"Getting Started","text":"[ ] Xianhi: outline a user story\n[ ] Johan: implement","category":"page"},{"location":"getting-started/","page":"Getting Started","title":"Getting Started","text":"","category":"page"},{"location":"model-alcap/#Model-with-CA,-Production-and-Active-Layer-transport-(ALCAP)","page":"ALCAPS","title":"Model with CA, Production and Active Layer transport (ALCAP)","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"The following Sedimentation model includes the Burgess 2013 Cellular Automaton, Bosscher & Schlager 1992 Production curves and an Active Layer transport model, based on Paola 1992, henceforth ALCAP.","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"(Image: Result from alternative input)","category":"page"},{"location":"model-alcap/#Example-Input","page":"ALCAPS","title":"Example Input","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"The following is a complete example input.","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">⪡alcap-example-input⪢≣</div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"const TAG = \"alcap-example\"\n\nconst FACIES = [\n    ALCAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate=500u\"m/Myr\",\n        extinction_coefficient=0.8u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=50.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate=400u\"m/Myr\",\n        extinction_coefficient=0.1u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=25.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate=100u\"m/Myr\",\n        extinction_coefficient=0.005u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=12.5u\"m/yr\")\n]\n\nconst PERIOD = 0.2u\"Myr\"\nconst AMPLITUDE = 4.0u\"m\"\n\nconst INPUT = ALCAP.Input(\n    tag=\"$TAG\",\n    box=Box{Coast}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n    time=TimeProperties(\n        Δt=0.0002u\"Myr\",\n        steps=5000),\n    output=Dict(\n        :topography => OutputSpec(slice=(:,:), write_interval=10),\n        :profile => OutputSpec(slice=(:, 25), write_interval=1)),\n    ca_interval=1,\n    initial_topography=(x, y) -> -x / 300.0,\n    sea_level=t -> AMPLITUDE * sin(2π * t / PERIOD),\n    subsidence_rate=50.0u\"m/Myr\",\n    disintegration_rate=50.0u\"m/Myr\",\n    insolation=400.0u\"W/m^2\",\n    sediment_buffer_size=50,\n    depositional_resolution=0.5u\"m\",\n    facies=FACIES)","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>examples/model/alcap/run.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"#| requires: src/Models/ALCAP.jl\n#| creates: data/output/alcap-example.h5\n\nmodule Script\n\nusing Unitful\nusing CarboKitten\nusing CarboKitten.Export: read_slice, data_export, CSV\n\nconst PATH = \"data/output\"\n\n<<alcap-example-input>>\n\nfunction main()\n    run_model(Model{ALCAP}, INPUT, \"$(PATH)/$(TAG).h5\")\n    header, profile = read_slice(\"$(PATH)/$(TAG).h5\", :profile)\n    columns = [profile[i] for i in 10:20:70]\n    data_export(\n        CSV(:sediment_accumulation_curve => \"$(PATH)/$(TAG)_sac.csv\",\n            :age_depth_model => \"$(PATH)/$(TAG)_adm.csv\",\n            :stratigraphic_column => \"$(PATH)/$(TAG)_sc.csv\",\n            :water_depth => \"$(PATH)/$(TAG)_wd.csv\",\n            :metadata => \"$(PATH)/$(TAG).toml\"),\n         header,\n         columns)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>examples/model/alcap/plot.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"#| creates: docs/src/_fig/alcaps-alternative.png\n#| requires: data/output/alcap-example.h5\n#| collect: figures\n\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/alcaps-alternative.png\", summary_plot(\"data/output/alcap-example.h5\"))","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"</details>","category":"page"},{"location":"model-alcap/#Modular-Implementation","page":"ALCAPS","title":"Modular Implementation","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"1363pt\" height=\"618pt\"\n viewBox=\"0.00 0.00 1363.00 618.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 614)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-614 1359,-614 1359,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M705.5,-610C705.5,-610 567.5,-610 567.5,-610 561.5,-610 555.5,-604 555.5,-598 555.5,-598 555.5,-543 555.5,-543 555.5,-537 561.5,-531 567.5,-531 567.5,-531 705.5,-531 705.5,-531 711.5,-531 717.5,-537 717.5,-543 717.5,-543 717.5,-598 717.5,-598 717.5,-604 711.5,-610 705.5,-610\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"562.5,-579.5 710.5,-579.5 \"/>\n<text text-anchor=\"start\" x=\"613\" y=\"-588.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"562.5,-556.5 562.5,-579.5 609.5,-579.5 609.5,-556.5 562.5,-556.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"562.5,-556.5 609.5,-556.5 609.5,-579.5 562.5,-579.5 \"/>\n<text text-anchor=\"start\" x=\"566.5\" y=\"-564.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"609.5,-556.5 609.5,-579.5 663.5,-579.5 663.5,-556.5 609.5,-556.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"609.5,-556.5 609.5,-579.5 663.5,-579.5 663.5,-556.5 609.5,-556.5\"/>\n<text text-anchor=\"start\" x=\"613.5\" y=\"-564.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"663.5,-556.5 663.5,-579.5 710.5,-579.5 710.5,-556.5 663.5,-556.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"710.5,-579.5 663.5,-579.5 663.5,-556.5 710.5,-556.5 \"/>\n<text text-anchor=\"start\" x=\"667.5\" y=\"-564.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"609.5,-537.5 609.5,-556.5 \"/>\n<text text-anchor=\"start\" x=\"566.5\" y=\"-544.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"663.5,-537.5 663.5,-556.5 \"/>\n<text text-anchor=\"start\" x=\"613.5\" y=\"-544.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"666.5\" y=\"-544.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M675.5,-495C675.5,-495 417.5,-495 417.5,-495 411.5,-495 405.5,-489 405.5,-483 405.5,-483 405.5,-390 405.5,-390 405.5,-384 411.5,-378 417.5,-378 417.5,-378 675.5,-378 675.5,-378 681.5,-378 687.5,-384 687.5,-390 687.5,-390 687.5,-483 687.5,-483 687.5,-489 681.5,-495 675.5,-495\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"412.5,-464.5 680.5,-464.5 \"/>\n<text text-anchor=\"start\" x=\"499\" y=\"-473.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"412.5,-441.5 412.5,-464.5 529.5,-464.5 529.5,-441.5 412.5,-441.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"412.5,-441.5 529.5,-441.5 529.5,-464.5 412.5,-464.5 \"/>\n<text text-anchor=\"start\" x=\"416.5\" y=\"-449.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"529.5,-441.5 529.5,-464.5 583.5,-464.5 583.5,-441.5 529.5,-441.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"529.5,-441.5 529.5,-464.5 583.5,-464.5 583.5,-441.5 529.5,-441.5\"/>\n<text text-anchor=\"start\" x=\"533.5\" y=\"-449.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"583.5,-441.5 583.5,-464.5 680.5,-464.5 680.5,-441.5 583.5,-441.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"680.5,-464.5 583.5,-464.5 583.5,-441.5 680.5,-441.5 \"/>\n<text text-anchor=\"start\" x=\"587.5\" y=\"-449.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"529.5,-422.5 529.5,-441.5 \"/>\n<text text-anchor=\"start\" x=\"416.5\" y=\"-429.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"583.5,-422.5 583.5,-441.5 \"/>\n<text text-anchor=\"start\" x=\"533.5\" y=\"-429.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"586.5\" y=\"-429.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"529.5,-403.5 529.5,-422.5 \"/>\n<text text-anchor=\"start\" x=\"416.5\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"583.5,-403.5 583.5,-422.5 \"/>\n<text text-anchor=\"start\" x=\"533.5\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"586.5\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"529.5,-384.5 529.5,-403.5 \"/>\n<text text-anchor=\"start\" x=\"416.5\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"583.5,-384.5 583.5,-403.5 \"/>\n<text text-anchor=\"start\" x=\"533.5\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"586.5\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M610.23,-530.97C604.43,-522.46 598.12,-513.21 591.81,-503.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"594.55,-501.76 586.02,-495.47 588.77,-505.7 594.55,-501.76\"/>\n</g>\n<!-- SedimentBuffer -->\n<g id=\"node6\" class=\"node\">\n<title>SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M375.5,-485.5C375.5,-485.5 87.5,-485.5 87.5,-485.5 81.5,-485.5 75.5,-479.5 75.5,-473.5 75.5,-473.5 75.5,-399.5 75.5,-399.5 75.5,-393.5 81.5,-387.5 87.5,-387.5 87.5,-387.5 375.5,-387.5 375.5,-387.5 381.5,-387.5 387.5,-393.5 387.5,-399.5 387.5,-399.5 387.5,-473.5 387.5,-473.5 387.5,-479.5 381.5,-485.5 375.5,-485.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"82.5,-455.5 380.5,-455.5 \"/>\n<text text-anchor=\"start\" x=\"168.5\" y=\"-464.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">SedimentBuffer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"82.5,-432.5 82.5,-455.5 229.5,-455.5 229.5,-432.5 82.5,-432.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"82.5,-432.5 229.5,-432.5 229.5,-455.5 82.5,-455.5 \"/>\n<text text-anchor=\"start\" x=\"86.5\" y=\"-440.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"229.5,-432.5 229.5,-455.5 283.5,-455.5 283.5,-432.5 229.5,-432.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"229.5,-432.5 229.5,-455.5 283.5,-455.5 283.5,-432.5 229.5,-432.5\"/>\n<text text-anchor=\"start\" x=\"233.5\" y=\"-440.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"283.5,-432.5 283.5,-455.5 380.5,-455.5 380.5,-432.5 283.5,-432.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"380.5,-455.5 283.5,-455.5 283.5,-432.5 380.5,-432.5 \"/>\n<text text-anchor=\"start\" x=\"287.5\" y=\"-440.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"229.5,-413.5 229.5,-432.5 \"/>\n<text text-anchor=\"start\" x=\"86.5\" y=\"-420.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer_size</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"283.5,-413.5 283.5,-432.5 \"/>\n<text text-anchor=\"start\" x=\"233.5\" y=\"-420.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"286.5\" y=\"-420.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"229.5,-394.5 229.5,-413.5 \"/>\n<text text-anchor=\"start\" x=\"86.5\" y=\"-401.5\" font-family=\"monospace\" font-size=\"10.00\">depositional_resolution</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"283.5,-394.5 283.5,-413.5 \"/>\n<text text-anchor=\"start\" x=\"233.5\" y=\"-401.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"286.5\" y=\"-401.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;SedimentBuffer -->\n<g id=\"edge13\" class=\"edge\">\n<title>Boxes&#45;&gt;SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M555.3,-534.04C552.34,-532.98 549.4,-531.96 546.5,-531 481.42,-509.44 462.29,-514.3 396.5,-495 389.6,-492.97 382.55,-490.83 375.46,-488.61\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"376.35,-485.22 365.76,-485.53 374.24,-491.89 376.35,-485.22\"/>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node11\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M1343,-313.5C1343,-313.5 1082,-313.5 1082,-313.5 1076,-313.5 1070,-307.5 1070,-301.5 1070,-301.5 1070,-227.5 1070,-227.5 1070,-221.5 1076,-215.5 1082,-215.5 1082,-215.5 1343,-215.5 1343,-215.5 1349,-215.5 1355,-221.5 1355,-227.5 1355,-227.5 1355,-301.5 1355,-301.5 1355,-307.5 1349,-313.5 1343,-313.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"1077.5,-283.5 1348.5,-283.5 \"/>\n<text text-anchor=\"start\" x=\"1137.5\" y=\"-292.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"1077.5,-260.5 1077.5,-283.5 1170.5,-283.5 1170.5,-260.5 1077.5,-260.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"1077.5,-260.5 1170.5,-260.5 1170.5,-283.5 1077.5,-283.5 \"/>\n<text text-anchor=\"start\" x=\"1081.5\" y=\"-268.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"1170.5,-260.5 1170.5,-283.5 1275.5,-283.5 1275.5,-260.5 1170.5,-260.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"1170.5,-260.5 1170.5,-283.5 1275.5,-283.5 1275.5,-260.5 1170.5,-260.5\"/>\n<text text-anchor=\"start\" x=\"1174.5\" y=\"-268.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"1275.5,-260.5 1275.5,-283.5 1348.5,-283.5 1348.5,-260.5 1275.5,-260.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"1348.5,-283.5 1275.5,-283.5 1275.5,-260.5 1348.5,-260.5 \"/>\n<text text-anchor=\"start\" x=\"1279.5\" y=\"-268.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"1170.5,-241.5 1170.5,-260.5 \"/>\n<text text-anchor=\"start\" x=\"1081.5\" y=\"-248.5\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"1275.5,-241.5 1275.5,-260.5 \"/>\n<text text-anchor=\"start\" x=\"1174.5\" y=\"-248.5\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"1278.5\" y=\"-248.5\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"1170.5,-222.5 1170.5,-241.5 \"/>\n<text text-anchor=\"start\" x=\"1081.5\" y=\"-229.5\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"1275.5,-222.5 1275.5,-241.5 \"/>\n<text text-anchor=\"start\" x=\"1174.5\" y=\"-229.5\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"1278.5\" y=\"-229.5\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge21\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M717.68,-550.77C765.28,-538.21 825.83,-519.49 876.5,-495 976.54,-446.66 1080.47,-371.1 1145.76,-320\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"1148.23,-322.52 1153.92,-313.59 1143.9,-317.02 1148.23,-322.52\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M525.5,-610C525.5,-610 387.5,-610 387.5,-610 381.5,-610 375.5,-604 375.5,-598 375.5,-598 375.5,-543 375.5,-543 375.5,-537 381.5,-531 387.5,-531 387.5,-531 525.5,-531 525.5,-531 531.5,-531 537.5,-537 537.5,-543 537.5,-543 537.5,-598 537.5,-598 537.5,-604 531.5,-610 525.5,-610\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"382.5,-579.5 530.5,-579.5 \"/>\n<text text-anchor=\"start\" x=\"391\" y=\"-588.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"382.5,-556.5 382.5,-579.5 429.5,-579.5 429.5,-556.5 382.5,-556.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"382.5,-556.5 429.5,-556.5 429.5,-579.5 382.5,-579.5 \"/>\n<text text-anchor=\"start\" x=\"386.5\" y=\"-564.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"429.5,-556.5 429.5,-579.5 483.5,-579.5 483.5,-556.5 429.5,-556.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"429.5,-556.5 429.5,-579.5 483.5,-579.5 483.5,-556.5 429.5,-556.5\"/>\n<text text-anchor=\"start\" x=\"433.5\" y=\"-564.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"483.5,-556.5 483.5,-579.5 530.5,-579.5 530.5,-556.5 483.5,-556.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"530.5,-579.5 483.5,-579.5 483.5,-556.5 530.5,-556.5 \"/>\n<text text-anchor=\"start\" x=\"487.5\" y=\"-564.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"429.5,-537.5 429.5,-556.5 \"/>\n<text text-anchor=\"start\" x=\"386.5\" y=\"-544.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"483.5,-537.5 483.5,-556.5 \"/>\n<text text-anchor=\"start\" x=\"433.5\" y=\"-544.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"486.5\" y=\"-544.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M482.77,-530.97C488.57,-522.46 494.88,-513.21 501.19,-503.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"504.23,-505.7 506.98,-495.47 498.45,-501.76 504.23,-505.7\"/>\n</g>\n<!-- ActiveLayer -->\n<g id=\"node4\" class=\"node\">\n<title>ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M570,-342C570,-342 243,-342 243,-342 237,-342 231,-336 231,-330 231,-330 231,-199 231,-199 231,-193 237,-187 243,-187 243,-187 570,-187 570,-187 576,-187 582,-193 582,-199 582,-199 582,-330 582,-330 582,-336 576,-342 570,-342\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"238.5,-311.5 575.5,-311.5 \"/>\n<text text-anchor=\"start\" x=\"361\" y=\"-320.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">ActiveLayer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"238.5,-288.5 238.5,-311.5 361.5,-311.5 361.5,-288.5 238.5,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"238.5,-288.5 361.5,-288.5 361.5,-311.5 238.5,-311.5 \"/>\n<text text-anchor=\"start\" x=\"242.5\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"361.5,-288.5 361.5,-311.5 496.5,-311.5 496.5,-288.5 361.5,-288.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"361.5,-288.5 361.5,-311.5 496.5,-311.5 496.5,-288.5 361.5,-288.5\"/>\n<text text-anchor=\"start\" x=\"365.5\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"496.5,-288.5 496.5,-311.5 575.5,-311.5 575.5,-288.5 496.5,-288.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"575.5,-311.5 496.5,-311.5 496.5,-288.5 575.5,-288.5 \"/>\n<text text-anchor=\"start\" x=\"500.5\" y=\"-296.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"361.5,-269.5 361.5,-288.5 \"/>\n<text text-anchor=\"start\" x=\"242.5\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">intertidal_zone</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"496.5,-269.5 496.5,-288.5 \"/>\n<text text-anchor=\"start\" x=\"365.5\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">diffusion_coefficient</text>\n<text text-anchor=\"start\" x=\"499.5\" y=\"-276.5\" font-family=\"monospace\" font-size=\"10.00\">active_layer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"361.5,-250.5 361.5,-269.5 \"/>\n<text text-anchor=\"start\" x=\"242.5\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">disintegration_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"496.5,-250.5 496.5,-269.5 \"/>\n<text text-anchor=\"start\" x=\"365.5\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">wave_velocity</text>\n<text text-anchor=\"start\" x=\"499.5\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"361.5,-231.5 361.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"242.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">cementation_time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"496.5,-231.5 496.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"365.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"499.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"361.5,-212.5 361.5,-231.5 \"/>\n<text text-anchor=\"start\" x=\"242.5\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\">transport_solver</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"496.5,-212.5 496.5,-231.5 \"/>\n<text text-anchor=\"start\" x=\"365.5\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"499.5\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"361.5,-193.5 361.5,-212.5 \"/>\n<text text-anchor=\"start\" x=\"242.5\" y=\"-200.5\" font-family=\"monospace\" font-size=\"10.00\">transport_substeps</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"496.5,-193.5 496.5,-212.5 \"/>\n<text text-anchor=\"start\" x=\"365.5\" y=\"-200.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"499.5\" y=\"-200.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;ActiveLayer -->\n<g id=\"edge3\" class=\"edge\">\n<title>WaterDepth&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M499.1,-377.95C491.73,-368.99 483.98,-359.58 476.23,-350.17\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"478.79,-347.78 469.74,-342.29 473.39,-352.23 478.79,-347.78\"/>\n</g>\n<!-- InitialSediment -->\n<g id=\"node7\" class=\"node\">\n<title>InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M201,-304C201,-304 12,-304 12,-304 6,-304 0,-298 0,-292 0,-292 0,-237 0,-237 0,-231 6,-225 12,-225 12,-225 201,-225 201,-225 207,-225 213,-231 213,-237 213,-237 213,-292 213,-292 213,-298 207,-304 201,-304\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7.5,-273.5 206.5,-273.5 \"/>\n<text text-anchor=\"start\" x=\"45\" y=\"-282.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">InitialSediment</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7.5,-250.5 7.5,-273.5 54.5,-273.5 54.5,-250.5 7.5,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7.5,-250.5 54.5,-250.5 54.5,-273.5 7.5,-273.5 \"/>\n<text text-anchor=\"start\" x=\"11.5\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54.5,-250.5 54.5,-273.5 159.5,-273.5 159.5,-250.5 54.5,-250.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54.5,-250.5 54.5,-273.5 159.5,-273.5 159.5,-250.5 54.5,-250.5\"/>\n<text text-anchor=\"start\" x=\"58.5\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"159.5,-250.5 159.5,-273.5 206.5,-273.5 206.5,-250.5 159.5,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"206.5,-273.5 159.5,-273.5 159.5,-250.5 206.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"163.5\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54.5,-231.5 54.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"11.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"159.5,-231.5 159.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"58.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">initial_sediment</text>\n<text text-anchor=\"start\" x=\"162.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;InitialSediment -->\n<g id=\"edge7\" class=\"edge\">\n<title>WaterDepth&#45;&gt;InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M405.4,-380.68C402.41,-379.75 399.44,-378.86 396.5,-378 320.28,-355.71 294.79,-372.55 221.5,-342 201.62,-333.71 181.54,-321.83 163.84,-309.89\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"165.58,-306.83 155.36,-304.04 161.6,-312.59 165.58,-306.83\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node8\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M750.5,-304C750.5,-304 612.5,-304 612.5,-304 606.5,-304 600.5,-298 600.5,-292 600.5,-292 600.5,-237 600.5,-237 600.5,-231 606.5,-225 612.5,-225 612.5,-225 750.5,-225 750.5,-225 756.5,-225 762.5,-231 762.5,-237 762.5,-237 762.5,-292 762.5,-292 762.5,-298 756.5,-304 750.5,-304\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"607.5,-273.5 755.5,-273.5 \"/>\n<text text-anchor=\"start\" x=\"644\" y=\"-282.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"607.5,-250.5 607.5,-273.5 654.5,-273.5 654.5,-250.5 607.5,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"607.5,-250.5 654.5,-250.5 654.5,-273.5 607.5,-273.5 \"/>\n<text text-anchor=\"start\" x=\"611.5\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"654.5,-250.5 654.5,-273.5 708.5,-273.5 708.5,-250.5 654.5,-250.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"654.5,-250.5 654.5,-273.5 708.5,-273.5 708.5,-250.5 654.5,-250.5\"/>\n<text text-anchor=\"start\" x=\"658.5\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"708.5,-250.5 708.5,-273.5 755.5,-273.5 755.5,-250.5 708.5,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"755.5,-273.5 708.5,-273.5 708.5,-250.5 755.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"712.5\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"654.5,-231.5 654.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"611.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">output</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"708.5,-231.5 708.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"658.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"711.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge10\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M592.2,-377.95C609.29,-356.43 628.46,-332.29 644.65,-311.91\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"647.45,-314.01 650.92,-304 641.96,-309.66 647.45,-314.01\"/>\n</g>\n<!-- Production -->\n<g id=\"node9\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M1040,-323C1040,-323 793,-323 793,-323 787,-323 781,-317 781,-311 781,-311 781,-218 781,-218 781,-212 787,-206 793,-206 793,-206 1040,-206 1040,-206 1046,-206 1052,-212 1052,-218 1052,-218 1052,-311 1052,-311 1052,-317 1046,-323 1040,-323\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"788.5,-292.5 1045.5,-292.5 \"/>\n<text text-anchor=\"start\" x=\"873\" y=\"-301.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"788.5,-269.5 788.5,-292.5 857.5,-292.5 857.5,-269.5 788.5,-269.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"788.5,-269.5 857.5,-269.5 857.5,-292.5 788.5,-292.5 \"/>\n<text text-anchor=\"start\" x=\"792.5\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"857.5,-269.5 857.5,-292.5 998.5,-292.5 998.5,-269.5 857.5,-269.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"857.5,-269.5 857.5,-292.5 998.5,-292.5 998.5,-269.5 857.5,-269.5\"/>\n<text text-anchor=\"start\" x=\"861.5\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"998.5,-269.5 998.5,-292.5 1045.5,-292.5 1045.5,-269.5 998.5,-269.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"1045.5,-292.5 998.5,-292.5 998.5,-269.5 1045.5,-269.5 \"/>\n<text text-anchor=\"start\" x=\"1002.5\" y=\"-277.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"857.5,-250.5 857.5,-269.5 \"/>\n<text text-anchor=\"start\" x=\"792.5\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"998.5,-250.5 998.5,-269.5 \"/>\n<text text-anchor=\"start\" x=\"861.5\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"1001.5\" y=\"-257.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"857.5,-231.5 857.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"792.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"998.5,-231.5 998.5,-250.5 \"/>\n<text text-anchor=\"start\" x=\"861.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"1001.5\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"857.5,-212.5 857.5,-231.5 \"/>\n<text text-anchor=\"start\" x=\"792.5\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"998.5,-212.5 998.5,-231.5 \"/>\n<text text-anchor=\"start\" x=\"861.5\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"1001.5\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge11\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M687.8,-379.11C715.74,-367.3 744.71,-354.6 771.5,-342 781.16,-337.46 791.11,-332.6 801.04,-327.62\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"802.81,-330.65 810.16,-323.02 799.65,-324.4 802.81,-330.65\"/>\n</g>\n<!-- ALCAP -->\n<g id=\"node13\" class=\"node\">\n<title>ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M703,-36C703,-36 660,-36 660,-36 654,-36 648,-30 648,-24 648,-24 648,-12 648,-12 648,-6 654,0 660,0 660,0 703,0 703,0 709,0 715,-6 715,-12 715,-12 715,-24 715,-24 715,-30 709,-36 703,-36\"/>\n<text text-anchor=\"start\" x=\"655\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">ALCAP</text>\n</g>\n<!-- ActiveLayer&#45;&gt;ALCAP -->\n<g id=\"edge19\" class=\"edge\">\n<title>ActiveLayer&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M492.76,-186.81C548.4,-137.33 617.12,-76.24 654.37,-43.12\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"657.12,-45.36 662.27,-36.1 652.47,-40.13 657.12,-45.36\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node5\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M855.5,-476C855.5,-476 717.5,-476 717.5,-476 711.5,-476 705.5,-470 705.5,-464 705.5,-464 705.5,-409 705.5,-409 705.5,-403 711.5,-397 717.5,-397 717.5,-397 855.5,-397 855.5,-397 861.5,-397 867.5,-403 867.5,-409 867.5,-409 867.5,-464 867.5,-464 867.5,-470 861.5,-476 855.5,-476\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"712.5,-445.5 860.5,-445.5 \"/>\n<text text-anchor=\"start\" x=\"742.5\" y=\"-454.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"712.5,-422.5 712.5,-445.5 759.5,-445.5 759.5,-422.5 712.5,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"712.5,-422.5 759.5,-422.5 759.5,-445.5 712.5,-445.5 \"/>\n<text text-anchor=\"start\" x=\"716.5\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"759.5,-422.5 759.5,-445.5 813.5,-445.5 813.5,-422.5 759.5,-422.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"759.5,-422.5 759.5,-445.5 813.5,-445.5 813.5,-422.5 759.5,-422.5\"/>\n<text text-anchor=\"start\" x=\"763.5\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"813.5,-422.5 813.5,-445.5 860.5,-445.5 860.5,-422.5 813.5,-422.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"860.5,-445.5 813.5,-445.5 813.5,-422.5 860.5,-422.5 \"/>\n<text text-anchor=\"start\" x=\"817.5\" y=\"-430.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"759.5,-403.5 759.5,-422.5 \"/>\n<text text-anchor=\"start\" x=\"716.5\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"813.5,-403.5 813.5,-422.5 \"/>\n<text text-anchor=\"start\" x=\"763.5\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"816.5\" y=\"-410.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;ActiveLayer -->\n<g id=\"edge4\" class=\"edge\">\n<title>FaciesBase&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M730.55,-396.88C719.53,-390.1 707.86,-383.48 696.5,-378 654.76,-357.87 639.51,-359.18 591.81,-342.01\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"592.76,-338.63 582.16,-338.45 590.33,-345.19 592.76,-338.63\"/>\n</g>\n<!-- FaciesBase&#45;&gt;InitialSediment -->\n<g id=\"edge6\" class=\"edge\">\n<title>FaciesBase&#45;&gt;InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M735.41,-396.81C723.23,-389.34 709.87,-382.46 696.5,-378 495.67,-310.98 421.7,-410.87 221.5,-342 200.45,-334.76 179.55,-322.71 161.46,-310.3\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"163,-307.1 152.81,-304.19 158.96,-312.82 163,-307.1\"/>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge9\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M762.67,-396.92C747.29,-372.02 727.17,-339.44 710.81,-312.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"713.65,-310.89 705.41,-304.22 707.69,-314.56 713.65,-310.89\"/>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge12\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M816,-396.92C830.81,-377.56 849.17,-353.55 866.13,-331.37\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"869.01,-333.36 872.3,-323.3 863.45,-329.11 869.01,-333.36\"/>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge22\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M867.64,-411.23C923,-393.87 997.59,-368.89 1061.5,-342 1078.53,-334.83 1096.3,-326.58 1113.42,-318.19\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"1115.44,-321.1 1122.85,-313.53 1112.34,-314.82 1115.44,-321.1\"/>\n</g>\n<!-- SedimentBuffer&#45;&gt;ActiveLayer -->\n<g id=\"edge5\" class=\"edge\">\n<title>SedimentBuffer&#45;&gt;ActiveLayer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M281.18,-387.24C293.37,-375.4 306.78,-362.37 320.15,-349.39\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"322.83,-351.66 327.56,-342.18 317.95,-346.64 322.83,-351.66\"/>\n</g>\n<!-- SedimentBuffer&#45;&gt;InitialSediment -->\n<g id=\"edge8\" class=\"edge\">\n<title>SedimentBuffer&#45;&gt;InitialSediment</title>\n<path fill=\"none\" stroke=\"black\" d=\"M196.01,-387.24C178.79,-363.81 158.17,-335.77 141.06,-312.51\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"143.68,-310.15 134.93,-304.17 138.04,-314.3 143.68,-310.15\"/>\n</g>\n<!-- InitialSediment&#45;&gt;ALCAP -->\n<g id=\"edge20\" class=\"edge\">\n<title>InitialSediment&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M159.05,-224.83C178.13,-211.8 200.24,-197.83 221.5,-187 367.64,-112.56 554.74,-54.91 638.08,-31.02\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"639.06,-34.38 647.72,-28.27 637.15,-27.65 639.06,-34.38\"/>\n</g>\n<!-- H5Writer&#45;&gt;ALCAP -->\n<g id=\"edge17\" class=\"edge\">\n<title>H5Writer&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M681.5,-224.76C681.5,-174.98 681.5,-89.82 681.5,-46.32\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"685,-46.21 681.5,-36.21 678,-46.21 685,-46.21\"/>\n</g>\n<!-- CAProduction -->\n<g id=\"node10\" class=\"node\">\n<title>CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M893,-129.5C893,-129.5 794,-129.5 794,-129.5 788,-129.5 782,-123.5 782,-117.5 782,-117.5 782,-105.5 782,-105.5 782,-99.5 788,-93.5 794,-93.5 794,-93.5 893,-93.5 893,-93.5 899,-93.5 905,-99.5 905,-105.5 905,-105.5 905,-117.5 905,-117.5 905,-123.5 899,-129.5 893,-129.5\"/>\n<text text-anchor=\"start\" x=\"789\" y=\"-108.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAProduction</text>\n</g>\n<!-- Production&#45;&gt;CAProduction -->\n<g id=\"edge15\" class=\"edge\">\n<title>Production&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M888.69,-205.98C877.56,-182.95 865.28,-157.55 856.33,-139.05\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"859.36,-137.27 851.86,-129.79 853.06,-140.32 859.36,-137.27\"/>\n</g>\n<!-- CAProduction&#45;&gt;ALCAP -->\n<g id=\"edge18\" class=\"edge\">\n<title>CAProduction&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M813.03,-93.29C786.89,-78.53 749.08,-57.17 720.69,-41.14\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"722.26,-38 711.83,-36.13 718.82,-44.1 722.26,-38\"/>\n</g>\n<!-- CellularAutomaton&#45;&gt;CAProduction -->\n<g id=\"edge14\" class=\"edge\">\n<title>CellularAutomaton&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M1125.79,-215.32C1105.12,-205.04 1082.86,-194.91 1061.5,-187 998.42,-163.65 977.25,-175.23 914.5,-151 902.85,-146.5 890.71,-140.47 879.84,-134.52\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"881.47,-131.43 871.04,-129.58 878.04,-137.53 881.47,-131.43\"/>\n</g>\n<!-- Tag -->\n<g id=\"node12\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M1073.5,-151C1073.5,-151 935.5,-151 935.5,-151 929.5,-151 923.5,-145 923.5,-139 923.5,-139 923.5,-84 923.5,-84 923.5,-78 929.5,-72 935.5,-72 935.5,-72 1073.5,-72 1073.5,-72 1079.5,-72 1085.5,-78 1085.5,-84 1085.5,-84 1085.5,-139 1085.5,-139 1085.5,-145 1079.5,-151 1073.5,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"930.5,-120.5 1078.5,-120.5 \"/>\n<text text-anchor=\"start\" x=\"990.5\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"930.5,-97.5 930.5,-120.5 977.5,-120.5 977.5,-97.5 930.5,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"930.5,-97.5 977.5,-97.5 977.5,-120.5 930.5,-120.5 \"/>\n<text text-anchor=\"start\" x=\"934.5\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"977.5,-97.5 977.5,-120.5 1031.5,-120.5 1031.5,-97.5 977.5,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"977.5,-97.5 977.5,-120.5 1031.5,-120.5 1031.5,-97.5 977.5,-97.5\"/>\n<text text-anchor=\"start\" x=\"981.5\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"1031.5,-97.5 1031.5,-120.5 1078.5,-120.5 1078.5,-97.5 1031.5,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"1078.5,-120.5 1031.5,-120.5 1031.5,-97.5 1078.5,-97.5 \"/>\n<text text-anchor=\"start\" x=\"1035.5\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"977.5,-78.5 977.5,-97.5 \"/>\n<text text-anchor=\"start\" x=\"934.5\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"1031.5,-78.5 1031.5,-97.5 \"/>\n<text text-anchor=\"start\" x=\"981.5\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"1034.5\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Tag&#45;&gt;ALCAP -->\n<g id=\"edge16\" class=\"edge\">\n<title>Tag&#45;&gt;ALCAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M923.32,-74.99C920.35,-73.95 917.41,-72.94 914.5,-72 849.8,-50.99 772.4,-35.15 725.1,-26.48\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"725.66,-23.02 715.2,-24.69 724.41,-29.91 725.66,-23.02\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>src/Models/ALCAP/Example.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"module Example\n\nusing Unitful\nusing ..ALCAP: ALCAP\nusing CarboKitten.Boxes: Box, Coast\nusing CarboKitten.Config: TimeProperties\nusing CarboKitten.OutputData: OutputSpec\n\n<<alcap-example-input>>\n\nend","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"<div class=\"noweb-label\">file:<i>src/Models/ALCAP.jl</i></div>","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"@compose module ALCAP\n@mixin Tag, H5Writer, CAProduction, ActiveLayer, InitialSediment\n\nusing ..Common\nusing ..CAProduction: production\nusing ..TimeIntegration\nusing ..WaterDepth: water_depth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::AbstractInput)\n    ca_state = CellularAutomaton.initial_state(input)\n    for _ in 1:20\n        CellularAutomaton.step!(input)(ca_state)\n    end\n\n    sediment_height = zeros(Height, input.box.grid_size...)\n    sediment_buffer = zeros(Float64, input.sediment_buffer_size, n_facies(input), input.box.grid_size...)\n    active_layer = zeros(Amount, n_facies(input), input.box.grid_size...)\n\n    state = State(\n        step=0, sediment_height=sediment_height,\n        sediment_buffer=sediment_buffer,\n        active_layer = active_layer,\n        ca=ca_state.ca, ca_priority=ca_state.ca_priority)\n\n    InitialSediment.push_initial_sediment!(input, state)\n    return state\nend\n\nfunction step!(input::Input)\n    step_ca! = CellularAutomaton.step!(input)\n    disintegrate! = ActiveLayer.disintegrator(input)\n    produce = production(input)\n    transport! = ActiveLayer.transporter(input)\n    local_water_depth = water_depth(input)\n    na = [CartesianIndex()]\n    pf = cementation_factor(input)\n\n    function (state::State)\n        if mod(state.step, input.ca_interval) == 0\n            step_ca!(state)\n        end\n\n        wd = local_water_depth(state)\n        p = produce(state, wd)\n        d = disintegrate!(state)\n\n        state.active_layer .+= p\n        state.active_layer .+= d\n        transport!(state)\n\n        deposit = pf .* state.active_layer\n        push_sediment!(state.sediment_buffer, deposit ./ input.depositional_resolution .|> NoUnits)\n        state.active_layer .-= deposit\n        state.sediment_height .+= sum(deposit; dims=1)[1,:,:]\n        state.step += 1\n\n        return Frame(\n            production = p,\n            disintegration = d,\n            deposition = deposit)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\n\ninclude(\"ALCAP/Example.jl\")\n\nend","category":"page"},{"location":"model-alcap/#API","page":"ALCAPS","title":"API","text":"","category":"section"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"Modules = [CarboKitten.Models.ALCAP]","category":"page"},{"location":"model-alcap/","page":"ALCAPS","title":"ALCAPS","text":"","category":"page"},{"location":"components/denudation/#Denudation-component","page":"Denudation component","title":"Denudation component","text":"","category":"section"},{"location":"components/denudation/","page":"Denudation component","title":"Denudation component","text":"<div class=\"noweb-label\">file:<i>src/Components/Denudation.jl</i></div>","category":"page"},{"location":"components/denudation/","page":"Denudation component","title":"Denudation component","text":"@compose module Denudation\n    @mixin Boxes, WaterDepth, SedimentBuffer, FaciesBase\n    using ..Common\n    using CarboKitten.Denudation: DenudationType\n    using CarboKitten.BoundaryTrait\n    using CarboKitten.Stencil: stencil\n    using CarboKitten.Denudation: Dissolution, EmpiricalDenudation, PhysicalErosion, NoDenudation, denudation, redistribution, slope_kernel\n\n    export slope_function\n    export Dissolution, EmpiricalDenudation, PhysicalErosion, NoDenudation, denudation, redistribution, slope_kernel\n\n\n    @kwdef struct Facies <: AbstractFacies\n        reactive_surface::typeof(1.0u\"m^2/m^3\") #reactive surface\n        mass_density::typeof(1.0u\"kg/m^3\") #density of different carb factory\n        infiltration_coefficient::Float64 #infiltration coeff\n        erodibility::typeof(1.0u\"m/yr\")\n    end\n\n    @kwdef struct Input <: AbstractInput\n        denudation::DenudationType\n    end\n\n    function slope_function(input,box::Box{BT}) where {BT<:Boundary}\n        return stencil(Float64, BT, (3, 3), slope_kernel) \n    end\nend","category":"page"},{"location":"components/denudation/","page":"Denudation component","title":"Denudation component","text":"","category":"page"},{"location":"components/facies/#Facies-Base","page":"Facies","title":"Facies Base","text":"","category":"section"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- FaciesBase -->\n<g id=\"node1\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"37\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"Base module for including facies.","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"<div class=\"noweb-label\">file:<i>test/Components/FaciesBaseSpec.jl</i></div>","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"module FaciesBaseSpec\n    using Test\n    using CarboKitten.Components.Common\n    using CarboKitten.Components.FaciesBase: Facies, Input, n_facies\n\n    @testset \"Components/FaciesBase\" begin\n        let input = Input(facies=fill(Facies(), 23))\n            @test n_facies(input) == 23\n        end\n    end\nend","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"<div class=\"noweb-label\">file:<i>src/Components/FaciesBase.jl</i></div>","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"@compose module FaciesBase\nusing ..Common\n\nusing HDF5\nexport n_facies\n\n@kwdef struct Facies <: AbstractFacies\nend\n\n@kwdef struct Input <: AbstractInput\n    facies::Vector{Facies} = []\nend\n\nn_facies(input::AbstractInput) = length(input.facies)\n\nfunction write_header(fid, input::AbstractInput)\n    attr = attributes(fid[\"input\"])\n    attr[\"n_facies\"] = n_facies(input)\n    for i in 1:n_facies(input)\n        create_group(fid[\"input\"], \"facies$(i)\")\n    end\nend\nend","category":"page"},{"location":"components/facies/","page":"Facies","title":"Facies","text":"","category":"page"},{"location":"components/tag/#Tags","page":"Tags","title":"Tags","text":"","category":"section"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- Tag -->\n<g id=\"node1\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"67\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"This module allows simulations to be tagged with a string.","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"<div class=\"noweb-label\">file:<i>src/Components/Tag.jl</i></div>","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"@compose module Tag\nusing ..Common\nusing HDF5\n\n@kwdef struct Input <: AbstractInput\n    tag::String = \"untagged run\"\nend\n\nfunction write_header(fid, input::AbstractInput)\n    attr = attributes(fid[\"input\"])\n    attr[\"tag\"] = input.tag\nend\nend","category":"page"},{"location":"components/tag/","page":"Tags","title":"Tags","text":"","category":"page"},{"location":"models/with-denudation/#Model-including-denudation","page":"Model including denudation","title":"Model including denudation","text":"","category":"section"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"This is largely identical to the ALCAP model.","category":"page"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"<div class=\"noweb-label\">file:<i>src/Models/WithDenudation.jl</i></div>","category":"page"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"@compose module WithDenudation\n@mixin Tag, H5Writer, CAProduction, ActiveLayer, Denudation\n\nusing ..Common\nusing ..CAProduction: production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\nusing ...Stencil\nusing ...BoundaryTrait\nusing ...Denudation.EmpiricalDenudationMod: slope_kernel\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    ca_state = CellularAutomaton.initial_state(input)\n    for _ in 1:20\n        CellularAutomaton.step!(input)(ca_state)\n    end\n\n    sediment_height = zeros(Height, input.box.grid_size...)\n    sediment_buffer = zeros(Float64, input.sediment_buffer_size, n_facies(input), input.box.grid_size...)\n\n    return State(\n        step=0, sediment_height=sediment_height,\n        sediment_buffer=sediment_buffer,\n        ca=ca_state.ca, ca_priority=ca_state.ca_priority)\nend\n\nfunction step!(input::Input)\n    step_ca! = CellularAutomaton.step!(input)\n    disintegrate! = disintegration(input)\n    produce = production(input)\n    transport = transportation(input)\n    denudate = denudation(input)\n    redistribute = redistribution(input)\n    water_depth_fn = water_depth(input)\n    slopefn = slope_function(input,input.box)\n    # Somehow deal with the units here\n\n    slope = Array{Float64}(undef, input.box.grid_size...)\n    denuded_sediment = Array{Float64}(undef, n_facies(input), input.box.grid_size...)\n\n    function (state::State)\n        if mod(state.step, input.ca_interval) == 0\n            step_ca!(state)\n        end\n\n        w = water_depth_fn(state) ./u\"m\"\n        slopefn(w, slope, input.box.phys_scale ./ u\"m\")\n\n        # submarine: production and transport\n        p = produce(state)\n        d = disintegrate!(state)\n\n        active_layer = p .+ d\n        sediment = transport(state, active_layer)\n\n\n        # subaerial: denudation and redistribution\n        # this code should go into the Denudation component\n        denudation_mass = denudate(state,w,slope)\n        if denudation_mass !== nothing\n            denudation_mass = denudate(state,w,slope) |> x -> sum(x,dims=1) |> x -> dropdims(x,dims=1) |> x -> min.(x, state.sediment_height)\n\n            state.sediment_height -= denudation_mass\n            pop_sediment!(state.sediment_buffer, denudation_mass ./ input.depositional_resolution .|> NoUnits, denuded_sediment)\n\n            d += denuded_sediment .* input.depositional_resolution\n\n            redistribution_mass = redistribute(state, w, denuded_sediment .* input.depositional_resolution)\n            if redistribution_mass !== nothing\n                sediment .+= redistribution_mass\n            end\n        end\n\n        push_sediment!(state.sediment_buffer, sediment ./ input.depositional_resolution .|> NoUnits)\n\n        state.sediment_height .+= sum(sediment; dims=1)[1,:,:]\n        state.step += 1\n\n        return Frame(\n            production = p,\n            disintegration = d,\n            deposition = sediment)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\nend","category":"page"},{"location":"models/with-denudation/","page":"Model including denudation","title":"Model including denudation","text":"","category":"page"},{"location":"architecture/#Architecture","page":"Architecture","title":"Architecture","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"CarboKitten is modular in design. This gives us the advantage of few repetitions in the code, but it also means a little study getting in to developing CarboKitten.","category":"page"},{"location":"architecture/#Models","page":"Architecture","title":"Models","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"A model is a module that must have certain data structures and methods implemented.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"struct Input <: AbstractInput: contains all input parameters\nstruct State <: AbstractState: contains all run-time state\nfunction initial_state(input): creates an initial State from an Input\nfunction step!(input)(state): curried function to advance state and return a Frame\nfunction write_header(fid, input): writes meta-data to an open HDF5 file","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"For most models the Input and State structures are generated from a hierarchy of components, which is explained below.","category":"page"},{"location":"architecture/#step!","page":"Architecture","title":"step!","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"The step! method deserves some extra attention: this is where the high-level logic of a model goes. Running a model is nothing but a repeated application of step!(input) on the state. Note that the step! function is curried: the input and state parameters are given on separate occasions. This allows the model to prepare later execution on state in a more efficient manner. For example, we may allocate memory or prepare quantities derived from input variables.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"The step! function should modify the state and return a Frame, which is defined as follows:","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"@kwdef struct Frame\n    disintegration::Union{Array{Sediment,3},Nothing} = nothing   # facies, x, y\n    production::Union{Array{Sediment,3},Nothing} = nothing\n    deposition::Union{Array{Sediment,3},Nothing} = nothing\nend","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"Here disintegration is the amount of sediment that was disintegrated, production the amount of sediment produced in situ, and deposition the amount of sediment deposited from the active layer. The only reason why this Frame is passed on, is for later storage. So the only routine that needs to understand the Frame structure is the write_frame method belonging to your output writer (currently H5Writer or MemoryOutput).","category":"page"},{"location":"architecture/#Components","page":"Architecture","title":"Components","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"A model in CarboKitten is composed of components. Each component extends the Input and/or State data structures with members and can also provide functions that work on those elements. Components can inherit from each other. For instance, the WaterDepth component inherits from Boxes component to have a notion of the grid size, and the TimeIntegration component to obtain a time coordinate from the state.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"A component has the following syntax:","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"@compose module MyComponent\n    @mixin DependencyA, DependencyB\n    using ..Common\n\n    @kwdef struct Input <: AbstractInput\n        ...\n    end\n\n    @kwdef struct State <: AbstractState\n        ...\n    end\n\n    ...\nend","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"Here the Common module is a normal Julia module living in the same scope as the component. This Common module contains common definitions used throughout the CarboKitten code base.","category":"page"},{"location":"architecture/#Module-Mixins","page":"Architecture","title":"Module Mixins","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"CarboKitten uses a non-idiomatic method of abstraction to structure the components. The @compose macro is rather special. It takes care of a form of inheritance that is normally absent in the Julia language. All the modules that are mentioned in a @mixin clause will be merged into a single module, where all the structs that were defined in those modules are combined. This allows us to layer our code, separating concerns.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"The problem is that this abstraction is neither idiomatic for those used to Julia nor those used to traditional object oriented languages. These layers together build two major important structures: Input and State. This includes any nested data structures (mainly Facies for the input data).","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"Component Input Facies State\nBoxes box  \nFaciesBase facies label = Nothing \nTime time  step\nWaterDepth sea_level  sediment_height\n initial_topography  \n subsidence_rate  \netc.   ","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"The Julia language allows us to work with abstract interfaces by using dispatch, but it has no built-in method to compose fully formed concrete structures like this. Note that the WaterDepth component defines subsidence_rate, but to compute water depth from that, we need to know the time. This is why the WaterDepth component depends/inherits/mixins the Time component.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"Each component is automatically documented with a graph that shows the components it inherits from and which members it adds to the structs.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"Because this mechanism is highly idiosyncratic, we're still exploring other ways to modularize CarboKitten.","category":"page"},{"location":"architecture/#Model-run","page":"Architecture","title":"Model run","text":"","category":"section"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"If you want to understand how a model run is abstracted, please study the Model Component code.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"FIXME: Explain it all here.","category":"page"},{"location":"architecture/","page":"Architecture","title":"Architecture","text":"","category":"page"},{"location":"data-export/#Data-export","page":"CSV Export","title":"Data export","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We provide several ways to export reduced data from CarboKitten to CSV files that are easier to read, visualize and post-process for most people.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-specification⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"abstract type ExportSpecification end\n\n@kwdef struct CSV <: ExportSpecification\n    output_files::IdDict{Symbol,String}\nend\n\nCSV(kwargs...) = CSV(IdDict(kwargs...))","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"using CarboKitten.Export: CSV\n\nCSV(:sediment_accumulation_curve => \"run_06_sac.csv\",\n    :age_depth_model             => \"run_06_adm.csv\",\n    :stratigraphic_column        => \"run_06_sc.csv\",\n    :water_depth                 => \"run_06_wd.csv\",\n    :metadata                    => \"run_06.toml\")","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"There is a data_export function that can be overloaded with any ExportSpcification. When given a CSV specification, files are written as given.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":":sediment_accumulation_curve  (SAC) is another term for sediment_height elsewhere in the code.\n:age_depth_model (ADM) is a monotonic version of the SAC, relating depth to age.\n:stratigraphic_column amount of deposited material per facies per time step, corrected for disintegrated material. The cumulative sum of the SC should add up to the ADM.\n:water_depth the water depth as a function of time.\n:metadata some metadata, written as a TOML file.","category":"page"},{"location":"data-export/#Tests","page":"CSV Export","title":"Tests","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We have a test case with just three pixels.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"Uniform production\nUniform production, top-hat disintegration, making the sediment accumulation non-monotonic\nLinearly increasing production (not sure what this adds)","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test-case⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"const AXES1 = Axes(\n    x=[0.0, 1.0, 2.0] * u\"m\",\n    y=[1.0] * u\"m\",\n    t=(0.0:0.1:1.0) * u\"Myr\")\n\nconst HEADER1 = Header(\n    tag=\"test\",\n    axes=AXES1,\n    Δt=0.1u\"Myr\",\n    time_steps=10,\n    grid_size=(3, 1),\n    n_facies=1,\n    initial_topography=zeros(typeof(1.0u\"m\"), 3, 3),\n    sea_level=zeros(typeof(1.0u\"m\"), 11),\n    subsidence_rate=10u\"m/Myr\",\n    data_sets=Dict())\n\nconst PRODUCTION1 = reshape(\n    hcat(ones(Amount, 10),\n        ones(Amount, 10),\n        cumsum(ones(Amount, 10)) / 5.5)',\n    1, 3, 1, 10)\n\nconst DISINTEGRATION1 = reshape(\n    hcat(zeros(Amount, 10),\n        1:10 .|> (x -> x < 4 || x > 6 ? 0.0u\"m\" : 2.0u\"m\"),\n        zeros(Amount, 10))',\n    1, 3, 1, 10)\n\nconst ELEVATION1 = cat(\n    [0.0, 0.0, 0.0]u\"m\",\n    cumsum(PRODUCTION1 .- DISINTEGRATION1; dims=4)[1, :, :, :];\n    dims=3)\n\nconst DATA1 = DataVolume(\n    slice=(:,:),\n    write_interval=1,\n    disintegration=DISINTEGRATION1,\n    production=PRODUCTION1,\n    deposition=PRODUCTION1,\n    sediment_thickness=ELEVATION1)\n\nconst GRID_LOCATIONS1 = [(1, 1), (2, 1), (3, 1)]\n\nconst COLUMNS1 = [DATA1[loc...] for loc in GRID_LOCATIONS1]","category":"page"},{"location":"data-export/#Sediment-Accumulation","page":"CSV Export","title":"Sediment Accumulation","text":"","category":"section"},{"location":"data-export/#Writing-CSV-files","page":"CSV Export","title":"Writing CSV files","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"The CSV.jl module lets us write a DataFrame to CSV, but doesn't work so well in combination with Units.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"\"\"\"\n    unitful_headers(df::DataFrame)\n\nGets a string representation for all column names including their unit.\nReturns a `Vector{String}`.\n\"\"\"\nunitful_headers(df::DataFrame) =\n    [\"$(e.variable) [$(unit(e.eltype))]\" for e in eachrow(describe(df))]\n\n\"\"\"\n    ustrip(df::DataFrame)\n\nStrip units from a `DataFrame`. Returns a new `DataFrame`.\n\"\"\"\nUnitful.ustrip(df::DataFrame) =\n    DataFrame((e.variable => df[!, e.variable] / unit(e.eltype)\n               for e in eachrow(describe(df)))...)\n\n\"\"\"\n    write_unitful_csv(io::IO, df::DataFrame)\n\nWrite a CSV from a `DataFrame` with `Unitful` units. The units will be\nrepresented in the CSV header, and stripped from the individual values.\n\"\"\"\nwrite_unitful_csv(io, df::DataFrame) =\n    write_csv(io, ustrip(df), header=unitful_headers(df))","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We may test that writing and reading the CSV back, gives the same result:","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"@testset \"Hither and Dither\" begin\n    @test sac.sac_1 ≈ ELEVATION1[1, 1, :]\n    @test sac.sac_2 ≈ ELEVATION1[2, 1, :]\n    @test sac.sac_3 ≈ ELEVATION1[3, 1, :]\nend","category":"page"},{"location":"data-export/#Age-depth-model","page":"CSV Export","title":"Age-depth model","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"Base.accumulate(f) = (args...; kwargs...) -> accumulate(f, args...; kwargs...)\n\n\"\"\"\n    age_depth_model(sediment_accumulation_curve::Vector)\n    age_depth_model(sediment_accumulation_curve::DataFrame)\n\nCompute the ADM from the SAC. Implemented as:\n\n    reverse ∘ accumulate(min) ∘ reverse\n\nThe `DataFrame` version `select`s SAC columns, transformed into ADM.\n\"\"\"\nage_depth_model(sac::Vector{T}) where {T} = sac |> reverse |> accumulate(min) |> reverse\nage_depth_model(sac_df::DataFrame) =\n    let sac_cols = filter(contains(\"sac\"), names(sac_df)),\n        adm_cols = replace.(sac_cols, \"sac\" => \"adm\")\n\n        select(sac_df, \"timestep\",\n               (sac => age_depth_model => adm\n                for (sac, adm) in zip(sac_cols, adm_cols))...)\n    end","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"We test that the constructed ADM is monotonic increasing in time:","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"@testset \"ADM Monotonicity\" begin\n    @test sac.sac_1 == adm.adm_1\n    @test sac.sac_3 == adm.adm_3\n    @test sac.sac_2 != adm.adm_2\n\n    @test all(adm.adm_2[2:end] .- adm.adm_2[1:end-1] .>= 0.0u\"m\")\nend","category":"page"},{"location":"data-export/#Stratigraphic-Column","page":"CSV Export","title":"Stratigraphic Column","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"\"\"\"\n    stratigraphic_column(header::Header, column::DataColumn, facies::Int)\n\nCompute the Stratigraphic Column for a given grid position `loc` and `facies` index.\nReturns an `Array{Quantity, 2}` where the `Quantity` is in units of meters.\n\"\"\"\nfunction stratigraphic_column(header::Header, column::DataColumn, facies::Int)\n\tn_steps = size(column.production, 2)\t\n    delta = column.deposition[facies,:] .- column.disintegration[facies,:]\n\n\tfor step in 1:n_steps\n        debt = 0.0u\"m\"\n        for pos in (step:-1:2)\n            if delta[pos] > 0.0u\"m\"\n                break\n            end\n\n            delta[pos-1] += delta[pos]\n            delta[pos] = 0.0u\"m\"\n        end\n\tend\n\n\treturn delta\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"The stratigraphic column should sum to the age-depth model.","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-test⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"@testset \"SC sum equals ADM\" begin\n    @test [0.0u\"m\"; cumsum(sc.sc_1_f1)] ≈ adm.adm_1\n    @test [0.0u\"m\"; cumsum(sc.sc_2_f1)] ≈ adm.adm_2\n    @test [0.0u\"m\"; cumsum(sc.sc_3_f1)] ≈ adm.adm_3\nend","category":"page"},{"location":"data-export/#Dispatch","page":"CSV Export","title":"Dispatch","text":"","category":"section"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">⪡export-function⪢≣</div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"struct CSVExportTrait{S} end\n\n\"\"\"\n\tdata_export(spec::CSV, header::Header, data)\n\nExports `data` to CSV. Here, `data` should be a collection or iterable\nof `DataColumn`.\n\"\"\"\nfunction data_export(spec::CSV, header::Header, data)\n    for (key, filename) in spec.output_files\n        if key == :metadata\n            md = Dict(\n                \"global\" => Dict(\n                    \"tag\" => header.tag,\n                    \"subsidence_rate\" => header.subsidence_rate,\n                    \"time_steps\" => header.time_steps,\n                    \"delta_t\" => header.Δt),\n                \"locations\" => [Dict(\n                    \"label\" => string(label),\n                    \"x\" => header.axes.x[col.slice[1]],\n                    \"y\" => header.axes.y[col.slice[2]],\n                    \"initial_topography\" => header.initial_topography[col.slice...])\n                    for (label, col) in pairs(data)],\n                \"files\" => spec.output_files)\n            open(filename, \"w\") do io\n                TOML.print(io, md) do obj\n                    if obj isa Quantity\n                        [ustrip(obj), string(unit(obj))]\n                    else\n                        obj\n                    end\n                end\n            end\n            continue\n        end\n        open(filename, \"w\") do io\n            time_df = DataFrame(\n                :timestep => 0:header.time_steps,\n                :time => header.axes.t)\n            df = innerjoin(\n                time_df,\n                (data_export(CSVExportTrait{key}, header, column, label)\n                 for (label, column) in pairs(data))...,\n                on=:timestep)\n            write_unitful_csv(io, df)\n        end\n    end\nend\n\nfunction data_export(::Type{CSVExportTrait{S}}, header::Header, data::DataColumn, label) where {S}\n    error(\"Unknown CSV data export: `$(S)`\")\nend\n\nfunction data_export(E::Type{CSVExportTrait{S}}, header::Header, columns) where {S}\n    return innerjoin(\n        (data_export(E, header, column, label)\n         for (label, column) in pairs(columns))...,\n        on=:timestep)\nend\n\ndata_export(::Type{CSVExportTrait{:sediment_accumulation_curve}}, header::Header, data::DataColumn, label) =\n    extract_sac(header, data, label)\ndata_export(::Type{CSVExportTrait{:stratigraphic_column}}, header::Header, data::DataColumn, label) =\n    extract_sc(header, data, label)\ndata_export(::Type{CSVExportTrait{:water_depth}}, header::Header, data::DataColumn, label) =\n    extract_wd(header, data, label)\ndata_export(::Type{CSVExportTrait{:age_depth_model}}, header::Header, data::DataColumn, label) =\n    extract_sac(header, data, label) |> age_depth_model\n\n\"\"\"\n    extract_sac(header::Header, data::DataColumn)\n\nExtract Sediment Accumumlation Curve (SAC) from the data. The SAC is directly\ncopied from `data.sediment_thickness`. Returns a `DataFrame` with `time` and\n`sac_<n>` columns where `<n>` is in the range `1:length(grid_locations)`.\n\"\"\"\nfunction extract_sac(header::Header, data::DataColumn, label)\n    DataFrame(\n        \"timestep\" => 0:data.write_interval:header.time_steps, \n        \"sac_$(label)\" => data.sediment_thickness)\nend\n\n\"\"\"\n    extract_sc(header::Header, data::DataColumn)\n\nExtract Stratigraphic Column (SC) from the data. Returns a `DataFrame` with\n`time` and `sc<n>` columns where `<n>` is in the range `1:length(grid_locations)`.\n\"\"\"\nfunction extract_sc(header::Header, data::DataColumn, label)\n    n_facies = size(data.production)[1]\n    DataFrame(\n        \"timestep\" => data.write_interval:data.write_interval:header.time_steps, \n        (\"sc_$(label)_f$(f)\" => stratigraphic_column(header, data, f)\n         for f in 1:n_facies)...)\nend\n\n\"\"\"\n    extract_wd(header::Header, data::DataColumn)\n\nExtract the water depth from the data. Returns a `DataFrame` with `time` and\n`wd<n>` columns where `<n>` is in the range `1:length(grid_locations)`.\n\"\"\"\nfunction extract_wd(header::Header, data::DataColumn, label)\n    na = [CartesianIndex()]\n    t = header.axes.t[1:data.write_interval:end]\n    sea_level = header.sea_level[1:data.write_interval:end]\n    wd = header.subsidence_rate .* t .- \n        header.initial_topography[data.slice...] .- \n        data.sediment_thickness .+\n        sea_level\n    return DataFrame(\n        \"timestep\" => 0:data.write_interval:header.time_steps, \n        \"wd_$(label)\" => wd)\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">file:<i>src/Export.jl</i></div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"module Export\n\nexport Data, DataSlice, DataColumn, Header, CSV, read_data, read_slice, read_column, data_export\n\nusing HDF5\nimport CSV: write as write_csv\nusing TOML\n\nusing Unitful\nusing DataFrames\nusing .Iterators: flatten\n\nusing ..OutputData\nimport ..OutputData: data_kind\n\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Amount = typeof(1.0u\"m\")\nconst Length = typeof(1.0u\"m\")\nconst Time = typeof(1.0u\"Myr\")\n\nconst na = [CartesianIndex()]\n\n<<export-specification>>\n\nfunction data_kind(gid::HDF5.Group)\n\tslice = parse_multi_slice(attrs(gid)[\"slice\"])\n\treturn data_kind(slice...)\nend\n\nfunction data_kind(fid::HDF5.File, group)\n\tgroup_name = string(group)\n\tif group_name == \"input\"\n\t\treturn :metadata\n\tend\n    return data_kind(fid[group_name])\nend\n\nfunction group_datasets(fid::HDF5.File)\n\tresult = Dict{Symbol, Vector{String}}(\n\t\t:metadata => [],\n\t\t:volume => [],\n\t\t:slice => [],\n\t\t:column => [])\n\n\tfor k in keys(fid)\n\t\tkind = data_kind(fid, k)\n\t\tpush!(result[kind], k)\n\tend\n\treturn result\nend\n\nfunction data_header(gid::HDF5.Group)\n\tslice = parse_multi_slice(attrs(gid)[\"slice\"])\n    kind = data_kind(slice...)\n    write_interval = attrs(gid)[\"write_interval\"]\n    return DataHeader(\n        slice=slice, kind=kind, write_interval=write_interval)\nend\n\nfunction read_header(fid)\n    attrs = HDF5.attributes(fid[\"input\"])\n\n    axes = Axes(\n        fid[\"input/x\"][] * u\"m\",\n        fid[\"input/y\"][] * u\"m\",\n        fid[\"input/t\"][] * u\"Myr\")\n\n    data_sets = Dict()\n    for k in keys(fid)\n        if k == \"input\"\n            continue\n        end\n        data_sets[Symbol(k)] = data_header(fid[k])\n    end\n\n    grid_size = (length(axes.x), length(axes.y))\n    n_facies = attrs[\"n_facies\"][]\n\n    return Header(\n        tag = attrs[\"tag\"][],\n        axes = axes,\n        Δt = attrs[\"delta_t\"][] * u\"Myr\",\n        time_steps = attrs[\"time_steps\"][],\n        grid_size = grid_size,\n        n_facies = n_facies,\n        initial_topography = fid[\"input/initial_topography\"][] * u\"m\",\n        sea_level = fid[\"input/sea_level\"][] * u\"m\",\n        subsidence_rate = attrs[\"subsidence_rate\"][] * u\"m/Myr\",\n        data_sets = data_sets)\nend\n\nfunction read_data(::Type{Val{dim}}, gid::Union{HDF5.File, HDF5.Group}) where {dim}\n\tslice = parse_multi_slice(string(attrs(gid)[\"slice\"]))\n\twrite_interval = attrs(gid)[\"write_interval\"]\n\n\treduce(_) = (:)\n\treduce(::Int) = 1\n\n\tData{dim+1,dim}(\n\t\tslice, write_interval,\n\t\tgid[\"disintegration\"][:, reduce.(slice)..., :] * u\"m\",\n\t\tgid[\"production\"][:, reduce.(slice)..., :] * u\"m\",\n\t\tgid[\"deposition\"][:, reduce.(slice)..., :] * u\"m\",\n\t\tgid[\"sediment_thickness\"][reduce.(slice)..., :] * u\"m\")\nend\n\nfunction read_data(D::Type{Val{dim}}, filename::AbstractString, group) where {dim}\n    h5open(filename) do fid\n        header = read_header(fid)\n\t\tgid = fid[string(group)]\n\t\tdata = read_data(D, gid)\n        header, data\n    end\nend\n\nread_volume(args...) = read_data(Val{3}, args...)\nread_slice(args...) = read_data(Val{2}, args...)\nread_column(args...) = read_data(Val{1}, args...)\n\ntime(header::Header, data::Data) = header.axes.t[1:data.write_interval:end]\n\n<<export-function>>\n\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"<div class=\"noweb-label\">file:<i>test/ExportSpec.jl</i></div>","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"using CarboKitten\nusing CarboKitten.Export: Axes, Header, DataVolume, data_export, CSVExportTrait,\n    age_depth_model, extract_sac, extract_sc, CSV, read_data, extract_sac, extract_wd,\n    read_column\nusing CSV: read as read_csv\nusing TOML\nusing DataFrames\nusing Unitful\n\nconst Amount = typeof(1.0u\"m\")\n\n<<export-test-case>>\n\n@testset \"CarboKitten.Export\" begin\n    sac = data_export(CSVExportTrait{:sediment_accumulation_curve}, HEADER1, COLUMNS1)\n    adm = data_export(CSVExportTrait{:age_depth_model}, HEADER1, COLUMNS1)\n    sc = data_export(CSVExportTrait{:stratigraphic_column}, HEADER1, COLUMNS1)\n\n    <<export-test>>\n    @testset \"Write to folder\" begin\n        using DataFrames: select\n\n        mktempdir() do path\n            spec = CSV(\n                :sediment_accumulation_curve => joinpath(path, \"sac.csv\"),\n                :age_depth_model => joinpath(path, \"adm.csv\"),\n                :stratigraphic_column => joinpath(path, \"sc.csv\"),\n                :water_depth => joinpath(path, \"wd.csv\"),\n                :metadata => joinpath(path, \"metadata.toml\"))\n            data_export(spec, HEADER1, COLUMNS1)\n            for f in values(spec.output_files)\n                @test isfile(f)\n            end\n\n            metadata = TOML.parsefile(spec.output_files[:metadata])\n            @test IdDict(Symbol(k) => v for (k, v) in metadata[\"files\"]) == spec.output_files\n            @test length(metadata[\"locations\"]) == 3\n\n            adm_tab = read_csv(spec.output_files[:age_depth_model], DataFrame)\n            rename!(adm_tab, (n => split(n)[1] for n in names(adm_tab))...)\n            @test select(adm_tab, [\"adm_$(i)\" for i in 1:3]) == \n                select(ustrip(adm), [\"adm_$(i)\" for i in 1:3])\n        end\n    end\n\n    @testset \"Water depth signs\" begin\n        test_path::String = TEST_PATH\n        header, data = read_column(joinpath(test_path, \"bs92_spm.h5\"), :full)\n        wd = extract_wd(header, data, 1)\n        sac = extract_sac(header, data, 1)\n        submerged = wd.wd_1 .> -1.0u\"m\"\n        growing = (sac.sac_1[2:end] .- sac.sac_1[1:end-1]) .> 0.5u\"m\"\n        @test all(growing .&& (submerged[1:end-1] .|| submerged[2:end]) .|| .!growing)\n    end\nend","category":"page"},{"location":"data-export/","page":"CSV Export","title":"CSV Export","text":"","category":"page"},{"location":"cases/tabular-sea-level/#Tabular-sea-levels","page":"Tabular Sea Levels","title":"Tabular sea levels","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"In CarboKitten, the sea-level curve is given as a function of time. This means you can generate sea levels automatically, or if you like interpolate them on a table. In this demo, we show how we can read values from a file and interpolate those for input into the CarboKitten ALCAP model.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"CarboKitten has convenience functions for reading tabular data, both TSV and CSV are supported.","category":"page"},{"location":"cases/tabular-sea-level/#The-data","page":"Tabular Sea Levels","title":"The data","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"In this example we load the sea level data compilation from Miller 2020 [2].","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"(Image: Miller 2020 sea level data)","category":"page"},{"location":"cases/tabular-sea-level/#Loading","page":"Tabular Sea Levels","title":"Loading","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"For this example we have a tab-separated data file, that is distributed with CarboKitten. However, you can have filename point to any tabular data on your filesystem.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"You can use the readdlm function in DelimitedFiles to read most text based table formats. See the DataFrames documentation to find out how to read from most popular data file formats.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"function miller_2020()\n    dir = artifact_dir()\n    filename = joinpath(dir, \"Miller2020\", \"Cenozoic_sea_level_reconstruction.tab\")\n\n    data, header = readdlm(filename, '\\t', header=true)\n    return DataFrame(\n        time=-data[:,4] * u\"kyr\",\n        sealevel=data[:,7] * u\"m\",\n        refkey=categorical(data[:,2]),\n        reference=categorical(data[:,3]))\nend","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"In this example we'll only use the Lisiecky data set.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"using CarboKitten.DataSets: miller_2020\nusing DataFrames\n\ndf = miller_2020()\nlevels(df.refkey)","category":"page"},{"location":"cases/tabular-sea-level/#Interpolating","page":"Tabular Sea Levels","title":"Interpolating","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"There are many ways to interpolate the data we have. We will now stick to the package Interpolations and use the linear interpolator in there.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"function sea_level()\n    df = miller_2020()\n    lisiecki_df = df[df.refkey .== \"846 Lisiecki\", :]\n    sort!(lisiecki_df, [:time])\n\n    return linear_interpolation(\n        lisiecki_df.time,\n        lisiecki_df.sealevel)\nend","category":"page"},{"location":"cases/tabular-sea-level/#Inspecting-our-interval","page":"Tabular Sea Levels","title":"Inspecting our interval","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"We will be running a simulation from 2 million years BA, to 1 million years BA with a time step of 200 years.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"const TIME_PROPERTIES = TimeProperties(\n    t0 = -2.0u\"Myr\",\n    Δt = 200.0u\"yr\",\n    steps = 5000\n)","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"(Image: Our selection from the Miller/Lisiecki dataset)","category":"page"},{"location":"cases/tabular-sea-level/#Other-parameters","page":"Tabular Sea Levels","title":"Other parameters","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"We keep the facies parameters the same as in our other examples. However, because the sea level is fluctuating quite a bit more than in our other examples, we increased the slope two-fold so that the resulting platform fits in our box.","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">⪡tabular-sea-level⪢≣</div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"const PATH = \"data/output\"\nconst TAG = \"lisiecki-sea-level\"\n\nconst FACIES = [\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=500u\"m/Myr\",\n        extinction_coefficient=0.8u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=50.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=400u\"m/Myr\",\n        extinction_coefficient=0.1u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=25.0u\"m/yr\"),\n    ALCAP.Facies(\n        viability_range=(4, 10),\n        activation_range=(6, 10),\n        maximum_growth_rate=100u\"m/Myr\",\n        extinction_coefficient=0.005u\"m^-1\",\n        saturation_intensity=60u\"W/m^2\",\n        diffusion_coefficient=35.0u\"m/yr\")\n]\n\nconst INPUT = ALCAP.Input(\n    tag=\"$TAG\",\n    box=CarboKitten.Box{Coast}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n    time=TIME_PROPERTIES,\n    ca_interval=1,\n    initial_topography=(x, y) -> -x / 200.0 - 100.0u\"m\",\n    sea_level=sea_level(),\n    subsidence_rate=50.0u\"m/Myr\",\n    disintegration_rate=50.0u\"m/Myr\",\n    insolation=400.0u\"W/m^2\",\n    sediment_buffer_size=50,\n    depositional_resolution=0.5u\"m\",\n    facies=FACIES)\n\nfunction main()\n    run_model(Model{ALCAP}, INPUT, \"$(PATH)/$(TAG).h5\")\nend","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"(Image: Summary plot)","category":"page"},{"location":"cases/tabular-sea-level/#Running-the-model","page":"Tabular Sea Levels","title":"Running the model","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/run.jl</i></div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"#| creates: data/output/lisiecki-sea-level.h5\n\nmodule TabularSeaLevel\n\nusing CarboKitten\n\nusing DelimitedFiles: readdlm\nusing DataFrames\nusing CarboKitten.DataSets: artifact_dir\nusing Interpolations\nusing CategoricalArrays\n\n<<tabular-sea-level>>\n\nend\n\nTabularSeaLevel.main()","category":"page"},{"location":"cases/tabular-sea-level/#Plotting-code","page":"Tabular Sea Levels","title":"Plotting code","text":"","category":"section"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/plot.jl</i></div>","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"#| requires: data/output/lisiecki-sea-level.h5\n#| creates:\n#|      - docs/src/_fig/miller-sea-level.svg\n#|      - docs/src/_fig/lisiecki-selection.svg\n#|      - docs/src/_fig/lisiecki-sea-level-summary.png\n#| collect: figures\n\nmodule PlotTabularSeaLevel\n\nusing CarboKitten\nusing CarboKitten.DataSets: artifact_dir\nusing CarboKitten.Visualization: summary_plot\n\nusing DelimitedFiles: readdlm\nusing CairoMakie\nusing DataFrames\nusing Unitful\nusing Interpolations\nusing CategoricalArrays\n\n<<tabular-sea-level>>\n\nfunction plot_miller_data()\n    df = miller_2020()\n    fig = Figure(size=(1000,300))\n    ax = Axis(fig[1, 1]; xlabel=\"time (Ma BP)\", ylabel=\"sealevel (m)\")\n\n    for ref in levels(df.reference)\n        subset = df[df.reference .== ref,:]\n        lines!(ax, subset.time |> in_units_of(u\"Myr\"), subset.sealevel |> in_units_of(u\"m\"), label=ref)\n    end\n    fig[1, 2] = Legend(fig, ax)\n\n    save(\"docs/src/_fig/miller-sea-level.svg\", fig)\n    fig\nend\n\nfunction plot_lisiecki_data()\n    df = miller_2020()\n    lisiecki_df = df[df.refkey .== \"846 Lisiecki\", :]\n    sort!(lisiecki_df, [:time])\n\n    sl = sea_level()\n\n    fig = Figure(size=(1000, 400))\n    ax = Axis(fig[1, 1]; xlabel=\"time (Ma BP)\", ylabel=\"sealevel (m)\", limits=((-2.2, -0.8), nothing))\n\n\n    times = time_axis(TIME_PROPERTIES)\n    lines!(ax, times |> in_units_of(u\"Myr\"), sl.(times) |> in_units_of(u\"m\"), label=\"interpolated sealevel\", color=Makie.wong_colors()[2])\n\n    scatter!(ax, lisiecki_df.time |> in_units_of(u\"Myr\"), lisiecki_df.sealevel |> in_units_of(u\"m\"), label=\"Lisiecki data\")\n    fig[1,2] = Legend(fig, ax)\n\n    save(\"docs/src/_fig/lisiecki-selection.svg\", fig)\n    fig\nend\n\nfunction plot_result()\n    fig = summary_plot(\"data/output/lisiecki-sea-level.h5\")\n    save(\"docs/src/_fig/lisiecki-sea-level-summary.png\", fig)\nend\n\nend\n\nPlotTabularSeaLevel.plot_miller_data()\nPlotTabularSeaLevel.plot_lisiecki_data()\nPlotTabularSeaLevel.plot_result()","category":"page"},{"location":"cases/tabular-sea-level/","page":"Tabular Sea Levels","title":"Tabular Sea Levels","text":"","category":"page"},{"location":"components/waterdepth/#Water-Depth","page":"Water Depth","title":"Water Depth","text":"","category":"section"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"350pt\" height=\"240pt\"\n viewBox=\"0.00 0.00 350.00 240.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 236)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-236 346,-236 346,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-232C150,-232 12,-232 12,-232 6,-232 0,-226 0,-220 0,-220 0,-165 0,-165 0,-159 6,-153 12,-153 12,-153 150,-153 150,-153 156,-153 162,-159 162,-165 162,-165 162,-220 162,-220 162,-226 156,-232 150,-232\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-201.5 155,-201.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-210.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-178.5 7,-201.5 54,-201.5 54,-178.5 7,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-178.5 54,-178.5 54,-201.5 7,-201.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-178.5 54,-201.5 108,-201.5 108,-178.5 54,-178.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-178.5 54,-201.5 108,-201.5 108,-178.5 54,-178.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-178.5 108,-201.5 155,-201.5 155,-178.5 108,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-201.5 108,-201.5 108,-178.5 155,-178.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-159.5 54,-178.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-159.5 108,-178.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node2\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-117C300,-117 42,-117 42,-117 36,-117 30,-111 30,-105 30,-105 30,-12 30,-12 30,-6 36,0 42,0 42,0 300,0 300,0 306,0 312,-6 312,-12 312,-12 312,-105 312,-105 312,-111 306,-117 300,-117\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-86.5 305,-86.5 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-95.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"37,-63.5 37,-86.5 154,-86.5 154,-63.5 37,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-63.5 154,-63.5 154,-86.5 37,-86.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-63.5 154,-86.5 208,-86.5 208,-63.5 154,-63.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-63.5 154,-86.5 208,-86.5 208,-63.5 154,-63.5\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-63.5 208,-86.5 305,-86.5 305,-63.5 208,-63.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-86.5 208,-86.5 208,-63.5 305,-63.5 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-71.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-44.5 154,-63.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-44.5 208,-63.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-51.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-25.5 154,-44.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-25.5 208,-44.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-32.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-6.5 154,-25.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-6.5 208,-25.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M107.27,-152.97C113.07,-144.46 119.38,-135.21 125.69,-125.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"128.73,-127.7 131.48,-117.47 122.95,-123.76 128.73,-127.7\"/>\n</g>\n<!-- Boxes -->\n<g id=\"node3\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-232C330,-232 192,-232 192,-232 186,-232 180,-226 180,-220 180,-220 180,-165 180,-165 180,-159 186,-153 192,-153 192,-153 330,-153 330,-153 336,-153 342,-159 342,-165 342,-165 342,-220 342,-220 342,-226 336,-232 330,-232\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-201.5 335,-201.5 \"/>\n<text text-anchor=\"start\" x=\"237.5\" y=\"-210.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-178.5 187,-201.5 234,-201.5 234,-178.5 187,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-178.5 234,-178.5 234,-201.5 187,-201.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-178.5 234,-201.5 288,-201.5 288,-178.5 234,-178.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-178.5 234,-201.5 288,-201.5 288,-178.5 234,-178.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-178.5 288,-201.5 335,-201.5 335,-178.5 288,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-201.5 288,-201.5 288,-178.5 335,-178.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-159.5 234,-178.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-159.5 288,-178.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M234.73,-152.97C228.93,-144.46 222.62,-135.21 216.31,-125.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"219.05,-123.76 210.52,-117.47 213.27,-127.7 219.05,-123.76\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"The WaterDepth module computes the water depth, given the bedrock elevation, sea level curve, subsidence rate and current sediment height.","category":"page"},{"location":"components/waterdepth/#Input","page":"Water Depth","title":"Input","text":"","category":"section"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"initial_topography(x, y) (a.k.a. initial depth) should be a function taking two coordinates in units of meters, returning an elevation also in meters.\nsea_level(t) should be a function taking a time in millions of years (Myr) returning the eustatic sealevel. This could also be an interpolated table.\nsubsidence_rate a constant rate of subsidence in m/Myr.","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"The signs of these quantities should be such that the following equation holds:","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"T + E = S + W","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"saying Tectonic subsidence plus Eustatic sea-level change equals Sedimentation plus change in Water depth.","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"<div class=\"noweb-label\">file:<i>src/Components/WaterDepth.jl</i></div>","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"@compose module WaterDepth\n@mixin TimeIntegration, Boxes\nusing ..Common\nusing HDF5\nusing ..TimeIntegration: time\n\nexport water_depth\n\n@kwdef struct Input <: AbstractInput\n    sea_level = t -> 0.0u\"m\"\n    initial_topography = (x, y) -> 0.0u\"m\"\n    subsidence_rate::Rate = 0.0u\"m/Myr\"\nend\n\n@kwdef mutable struct State <: AbstractState\n    sediment_height::Matrix{Height}\nend\n\nfunction initial_state(input::AbstractInput)\n    return State(step=0, sediment_height=zeros(Height, input.box.grid_size...))\nend\n\nfunction initial_topography(input::AbstractInput)\n    if input.initial_topography isa AbstractMatrix\n        @assert size(input.initial_topography) == input.box.grid_size\n        return input.initial_topography\n    end\n\n    x, y = box_axes(input.box)\n    return input.initial_topography.(x, y')\nend\n\nfunction water_depth(input::AbstractInput)\n    x, y = box_axes(input.box)\n    eta0 = initial_topography(input)\n    sea_level = input.sea_level\n    subsidence_rate = input.subsidence_rate\n    t0 = input.time.t0\n    get_time = time(input)\n\n    return function (state::AbstractState)\n        t = get_time(state)\n        return sea_level(t) .- eta0 .+\n            (subsidence_rate * (t - t0)) .- state.sediment_height\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    gid = fid[\"input\"]\n    attr = attributes(gid)\n    x, y = box_axes(input.box)\n    t = TimeIntegration.write_times(input)\n\n    gid[\"initial_topography\"] = initial_topography(input) |> in_units_of(u\"m\")\n    gid[\"sea_level\"] = input.sea_level.(t) .|> in_units_of(u\"m\")\n    attr[\"subsidence_rate\"] = input.subsidence_rate |> in_units_of(u\"m/Myr\")\nend\n\nfunction create_dataset(fid, input::AbstractInput)\n    return HDF5.create_dataset(fid, \"sediment_height\", datatype(Float64),\n        dataspace(input.box.grid_size..., input.time.steps),\n        chunk=(input.box.grid_size..., 1))\nend\n\nend","category":"page"},{"location":"components/waterdepth/","page":"Water Depth","title":"Water Depth","text":"","category":"page"},{"location":"utility/#Utility-functions","page":"Utility","title":"Utility functions","text":"","category":"section"},{"location":"utility/#Select-Iterator","page":"Utility","title":"Select Iterator","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"In many cases our model is updating some state as an iterator. I want to be able to select arbitrary slices from that iterator. The Select object contains the main iterable and a selection iterable that should yield integers. When iterated upon, we repeatedly use Iterators.dropwhile to get to the next index.","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">file:<i>src/Utility.jl</i></div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"module Utility\n\nexport select, in_units_of\nusing Unitful\n\nstruct Select\n    iter\n    selection\nend\n\nfunction select(it, sel)\n    Select(enumerate(it), sel)\nend\n\nfunction Base.iterate(s::Select)\n    x = iterate(s.selection)\n    if x !== nothing\n        (idx, selstate) = x\n        ((_, value), rest) = Iterators.peel(Iterators.dropwhile(((i, y),) -> i != idx, s.iter))\n        return (value, (selstate, rest))\n    else\n        return nothing\n    end\nend\n\nfunction Base.iterate(s::Select, state)\n    (selstate, rest) = state\n    x = iterate(s.selection, selstate)\n    if x !== nothing\n        (idx, selstate) = x\n        ((_, value), rest) = Iterators.peel(Iterators.dropwhile(((i, y),) -> i != idx, s.iter))\n        return (value, (selstate, rest))\n    else\n        return nothing\n    end\nend\n\n<<utility>>\n\nend","category":"page"},{"location":"utility/#Range-finder","page":"Utility","title":"Range finder","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"The RangeFinder iterator is used in our algorithm to trace hiatus in the sediment history. This iterator consumes an iterator of booleans and yields values of type UnitRange, giving all ranges for which the input sequence is true consecutively.","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility-spec⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"a = [false, true, true, false, true]\n@test collect(find_ranges(a)) == [2:3, 5:5]","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"struct RangeFinder\n\tv::AbstractVector{Bool}\nend\n\nBase.iterate(r::RangeFinder) = iterate(r, 1)\n\nfunction Base.iterate(r::RangeFinder, i::Union{Int, Nothing})\n\tisnothing(i) && return nothing\n\ta = findnext(r.v, i)\n\tisnothing(a) && return nothing\n\tb = findnext(!, r.v, a)\n\tisnothing(b) && return (a:length(r.v)), nothing\n\treturn (a:b-1), b\nend\n\nBase.eltype(r::RangeFinder) = UnitRange{Int}\nBase.IteratorSize(::Type{RangeFinder}) = Base.SizeUnknown()\n\n\"\"\"\n    find_ranges(v::AbstractVector{Bool})\n\nTake a vector of bools, returns an iterator over all ranges for\nwhich the vector is `true`.\n\"\"\"\nfind_ranges(v::AbstractVector{Bool}) = RangeFinder(v)\n\nexport find_ranges","category":"page"},{"location":"utility/#Tagging-a-sequence-of-vectors","page":"Utility","title":"Tagging a sequence of vectors","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"The enumerate_seq iterator is also used in the algorithm to trace hiatus in sediment accumulation. Here the task is to enumerate a nested sequence while preserving the nested structure.","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility-spec⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"a = [[:a, :b], [:c]]\n@test collect(enumerate_seq(a)) == [[(1, :a), (2, :b)], [(3, :c)]]","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">⪡utility⪢≣</div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"struct TagVectors{T}\n\tvectors::T\nend\n\nfunction Base.iterate(tv::TagVectors{T}) where T\n\ttag = 1\n\tx = iterate(tv.vectors)\n\tisnothing(x) && return nothing\n\t(v_, nit) = x\n\tv = collect(v_)\n\tn = length(v)\n\treturn zip(tag:tag+n-1, v) |> collect, (tag+n, nit)\nend\n\nfunction Base.iterate(tv::TagVectors{T}, st::Tuple{Int,U}) where {T, U}\n\t(tag, it) = st\n\tisnothing(it) && return nothing\n\tx = iterate(tv.vectors, it)\n\tisnothing(x) && return nothing\n\t(v_, nit) = x\n\tv = collect(v_)\n\tn = length(v)\n\treturn zip(tag:tag+n-1, v) |> collect, (tag+n, nit)\nend\n\nBase.IteratorSize(::Type{TagVectors{T}}) where T = Base.IteratorSize(T)\nBase.size(r::TagVectors{T}) where T = size(r.vectors)\nBase.length(r::TagVectors{T}) where T = length(r.vectors)\nBase.eltype(::Type{TagVectors{T}}) where T = Any\n# This should be:\n# Iterators.Zip{Tuple{UnitRange{Int},Vector{eltype(eltype(T))}}}\n# But that doesn't work\n\n\"\"\"\n    enumerate_seq(s)\n\nEnumerates an iterator of sequences, such that the following equivalence\nholds:\n\n    enumerate(flatten(s)) == flatten(enumerate_seq(s))\n\"\"\"\nenumerate_seq(s::T) where T = TagVectors{T}(s)\n\nexport enumerate_seq","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">file:<i>test/UtilitySpec.jl</i></div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"@testset \"CarboKitten.Utility\" begin\n    using CarboKitten.Utility\n\n    <<utility-spec>>\nend","category":"page"},{"location":"utility/#Reading-data-files","page":"Utility","title":"Reading data files","text":"","category":"section"},{"location":"utility/","page":"Utility","title":"Utility","text":"<div class=\"noweb-label\">file:<i>src/DataSets.jl</i></div>","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"module DataSets\n\nexport read_tsv, read_csv\n\nusing DelimitedFiles: readdlm\nusing DataFrames\nusing CategoricalArrays\nusing CSV\nusing Pkg.Artifacts\nusing Unitful\n\nfunction read_tsv(filename)\n    data, header = readdlm(filename, '\\t', header=true)\n    return DataFrame(data, vec(header))\nend\n\nfunction read_csv(filename)\n    return DataFrame(CSV.File(filename))\nend\n\nfunction artifact_dir()\n    subfolder = first(readdir(artifact\"data\"))\n    return joinpath(artifact\"data\", subfolder)\nend\n\nfunction bosscher_schlager_1992()\n    dir = artifact_dir()\n    filename = joinpath(dir, \"Bosscher1992\", \"bs92-sealevel-curve.csv\")\n    df = read_csv(filename)\n    return DataFrame(time=df.time * u\"yr\", sealevel=df.depth * u\"m\")\nend\n\nfunction miller_2020()\n    dir = artifact_dir()\n    filename = joinpath(dir, \"Miller2020\", \"Cenozoic_sea_level_reconstruction.tab\")\n    df = read_tsv(filename)\n    return DataFrame(\n        time=-df[!,4] * u\"kyr\",\n        sealevel=df[!,7] * u\"m\",\n        refkey=categorical(df[!,2]),\n        reference=categorical(df[!,3]))\nend\n\nend","category":"page"},{"location":"utility/","page":"Utility","title":"Utility","text":"","category":"page"},{"location":"denudation/empirical/#Emperical-denudation","page":"Empirical Denudation","title":"Emperical denudation","text":"","category":"section"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Chlorine (Cl) isotopes are an emerging tool to decipher the denudation rates (chemical dissolution + physical erosion) in carbonate-dominated areas.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Research based on the karst region and carbonate platform terrace suggested that the denudation rates are mainly controlled by precipitation and slopes, although the debates about which factor is more important is still ongoing ([7], [8]). In general, the precipitation mainly controls the chemical dissolution while the slope mainly controls the physical erosion. In addition, the type of carbonates may also play an important role ([9]), but given this feature is studied poorly so we will ditch it for now. We have checked and compiled the denudation rates (mm/kyr), and along with precipitation and slopes these serve as a starting point to create a function relating denudation rates (mm/kyr) to precipitation and slopes. The compiled data can be found in OSF database. This is an empirical relationship and has a relatively large uncertainty in terms of fitting.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"(Image: Precipitation and denudation)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Fig 1. The relationship between MAP (mean precipitation per year, mm/y) and denudation rates (mm/ky)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"(Image: Slope denudation data)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Fig 2. The relationship between the slope and the denudation rates (mm/ky)","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"We can see that both the slope and precipitation increase the denudation rates, and that it reaches a 'steady state' after a certain point.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Therefore, we could use the function form of D = P * S, where D is the denudation rate, P parameterizes the effects of precipitation and S the effects of slope. By doing so, we can consider both effects. Such formula structure is similar to RUSLE (Revised Universal Soil Loss Equation) model, a widely used Landscape Evolution Model (LEM) (e.g., [10]). We use sigmoidal function to approximate the influence of P or S on D, by fitting the function with the observed data and rendering parameters a, b, c, d, e, f. These are impleted as empirical_denudation. ","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">⪡empirical-denudation⪢≣</div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"function empirical_denudation(precip::Float64, slope::Any)\n    local a = 9.1363\n    local b = -0.008519\n    local c = 580.51\n    local d = 9.0156\n    local e = -0.1245\n    local f = 4.91086\n    (a ./ (1 .+ exp.(b .* (precip .* 1000 .- c)))) .* (d ./ (1 .+ exp.(e .* (slope .- f)))) .* u\"m/Myr\"\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"This produces the following curve for denudation rate as a function of precipitation (Image: Empirical denudation as function of precipitation) Fig 3. An instance of the function showing denudation rates increases with precipitation.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">file:<i>examples/denudation/empirical-test.jl</i></div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"#| requires: examples/denudation/empirical-test.jl\n#| creates: docs/src/_fig/EmpiricalPrecipitation.png\n#| collect: figures\n\nmodule EmpiricalSpec\nusing CairoMakie\n\nusing CarboKitten\nusing Unitful\n\nusing CarboKitten.Denudation.EmpiricalDenudationMod: empirical_denudation, slope_kernel\n\nconst slope = 30\n\nfunction main()\n    precip = collect(0.4:0.01:2.0)\n\n    result = Vector{typeof(1.0u\"m/Myr\")}(undef,size(precip))\n\n    for i in eachindex(precip)\n        result[i] = empirical_denudation(precip[i],slope)\n    end\n\n    fig = Figure()\n    ax = Axis(fig[1,1],xlabel=\"Precipitation (m/yr)\", ylabel=\"Denudation rates (m/Myr)\")\n    lines!(ax,precip,result)\n    save(\"docs/src/_fig/EmpiricalPrecipitation.png\",fig)\nend\n\nend\n\nEmpiricalSpec.main()","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"</details>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"This function needs two inputs: precipitation and slope. The precipitation is defined as an input parameter in EmpiricalDenudation.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">⪡empirical-denudation⪢≣</div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"@kwdef struct EmpiricalDenudation <: DenudationType\n    precip::typeof(1.0u\"m\")\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"The slope for each cell is calculated by comparing the height (or water-depth) with the neighboring 8 cells, and is implemented in function slope_kernel . The slope is returned in degrees of inclination. This approach has been widely used in industry and ArcGis: how slope works is an example.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">⪡empirical-denudation⪢≣</div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"function slope_kernel(w::Any, cellsize::Float64)\n    dzdx = (-w[1, 1] - 2 * w[2, 1] - w[3, 1] + w[1, 3] + 2 * w[2, 3] + w[3, 3]) / (8 * cellsize)\n    dzdy = (-w[1, 1] - 2 * w[1, 2] - w[1, 3] + w[3, 1] + 2 * w[3, 2] + w[1, 1]) / (8 * cellsize)\n\n    if abs(w[2, 2]) <= min.(abs.(w)...)\n        return 0.0\n    else\n        atan(sqrt(dzdx^2 + dzdy^2)) * (180 / π)\n    end\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"Note that this mode only considers the destruction of mass, and does not apply any redistribution of mass.","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"<div class=\"noweb-label\">file:<i>src/Denudation/EmpiricalDenudationMod.jl</i></div>","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"module EmpiricalDenudationMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...Boxes: Box\nusing Unitful\nexport slope_kernel\n<<empirical-denudation>>\n\nfunction denudation(::Box, p::EmpiricalDenudation, water_depth, slope, facies, state)\n    precip = p.precip ./ u\"m\"\n    denudation_rate = zeros(typeof(1.0u\"m/Myr\"), length(facies), size(slope)...)\n\n    for idx in CartesianIndices(state.ca)\n        f = state.ca[idx]\n        if f == 0\n            continue\n        end\n        if water_depth[idx] <= 0\n            denudation_rate[f,idx] = empirical_denudation.(precip, slope[idx])\n        end\n    end\n    return denudation_rate\nend\n\nfunction redistribution(::Box, p::EmpiricalDenudation, denudation_mass, water_depth)\n    return nothing\nend\n\nend","category":"page"},{"location":"denudation/empirical/","page":"Empirical Denudation","title":"Empirical Denudation","text":"","category":"page"},{"location":"api/#API-Documentation","page":"API Documentation","title":"API Documentation","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"run_model\nBox\nbox_axes\nTimeProperties\ntime_axis","category":"page"},{"location":"api/#CarboKitten.run_model","page":"API Documentation","title":"CarboKitten.run_model","text":"run_model(f, ::Type{Model{M}}, input::AbstractInput) where M\nrun_model(f, ::Type{Model{M}}, input::AbstractInput, state::AbstractState) where M\n\nRun a model and send Frames to callback f. The type parameter M should be a model, being a module with both initial_state! and step! defined.\n\nThe second version with explicit state is used by H5Writer so we can perform an additional action between creating the initial state and starting the model run (saving metadata to the HDF5 file).\n\n\n\n\n\nrun_model(::Type{Model{M}}, input::AbstractInput, output::AbstractOutput) where M\n\nRun a model and save the output to output.\n\n\n\n\n\nrun_model(::Type{Model{M}}, input::AbstractInput, filename::AbstractString) where M\n\nRun a model and write output to HDF5. Here M should be a model, i.e. a module with initial_state, step! and write_header defined. Example:\n\nrun_model(Model{ALCAP}, ALCAP.Example.INPUT, \"example.h5\")\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.Box","page":"API Documentation","title":"CarboKitten.Box","text":"Box{BoundaryType}(grid_size, phys_scale)\n\nStores the spatial properties of the simulation grid, where grid_size is a tuple of two integers and phys_scale is a Quantity of dimension Length.\n\n\n\n\n\n","category":"type"},{"location":"api/#CarboKitten.box_axes","page":"API Documentation","title":"CarboKitten.box_axes","text":"box_axes(box::Box)\n\nReturn the x and y components of the box grid in meters. The grid starts at 0.0u\"m\" and runs to (box.grid_size .- 1) .* box.phys_scale.\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.TimeProperties","page":"API Documentation","title":"CarboKitten.TimeProperties","text":"TimeProperties(t0, Δt, steps, write_interval)\n\nStores properties of the time integration. Here, t0 and Δt should be a Quantity, steps is the number of integration steps, and write_interval the number of steps between writing output.\n\n\n\n\n\n","category":"type"},{"location":"api/#CarboKitten.time_axis","page":"API Documentation","title":"CarboKitten.time_axis","text":"time_axis(time::TimeProperties)\n\nRetrieve the time values for which output was/will be written. Returns a range.\n\n\n\n\n\n","category":"function"},{"location":"api/#Components","page":"API Documentation","title":"Components","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Components.CellularAutomaton, CarboKitten.Components.ActiveLayer]","category":"page"},{"location":"api/#CarboKitten.Components.CellularAutomaton.step_ca-Union{Tuple{BT}, Tuple{Box{BT}, Any}} where BT<:Boundary{2}","page":"API Documentation","title":"CarboKitten.Components.CellularAutomaton.step_ca","text":"step_ca(box, facies)\n\nCreates a propagator for the state, updating the celullar automaton in place.\n\nContract: the state should have ca::Matrix{Int} and ca_priority::Vector{Int} members.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Components.ActiveLayer.disintegrator-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Components.ActiveLayer.disintegrator","text":"disintegrator(input) -> f!\n\nPrepares the disintegration step. Returns a function f!(state::State). The returned function modifies the state, popping sediment from the sediment_buffer and returns an array of Amount.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Components.ActiveLayer.transporter-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Components.ActiveLayer.transporter","text":"transporter(input::Input) -> f\n\nPrepares the transportation step. Returns a function f(state::State, active_layer), transporting the active layer, returning a transported Amount of sediment.\n\n\n\n\n\n","category":"method"},{"location":"api/#Output","page":"API Documentation","title":"Output","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.OutputData]","category":"page"},{"location":"api/#CarboKitten.OutputData.add_data_set","page":"API Documentation","title":"CarboKitten.OutputData.add_data_set","text":"add_data_set(out::T, name::Symbol, spec::OutputSpec)\n\nAdd a data set to the output object.\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.OutputData.frame_writer-Tuple{CarboKitten.OutputData.AbstractInput, Any}","page":"API Documentation","title":"CarboKitten.OutputData.frame_writer","text":"frame_writer(input::AbstractInput, out::T)\n\nReturns a function (idx::Int, state::AbstractState).\n\nWrite the state of the simulation to the output object. It is the responsibility of the implementation to choose to write or not based on the set write interval.\n\nThe default implementation writes the state for all output data sets, and calls write_sediment_thickness.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.OutputData.new_output","page":"API Documentation","title":"CarboKitten.OutputData.new_output","text":"new_output(::Type{T}, input)\n\nCreate a new output object of type T, given input.\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.OutputData.set_attribute","page":"API Documentation","title":"CarboKitten.OutputData.set_attribute","text":"set_attribute(out::T, name::Symbol, value::Any)\n\nSet an attribute in the output object.\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.OutputData.state_writer-Tuple{CarboKitten.OutputData.AbstractInput, Any}","page":"API Documentation","title":"CarboKitten.OutputData.state_writer","text":"state_writer(input::AbstractInput, out::T)\n\nReturns a function (idx::Int, state::AbstractState).\n\nWrite the state of the simulation to the output object. It is the responsibility of the implementation to choose to write or not based on the set write interval.\n\nThe default implementation writes the state for all output data sets, and calls write_sediment_thickness.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.OutputData.write_deposition","page":"API Documentation","title":"CarboKitten.OutputData.write_deposition","text":"write_deposition(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nSee write_sediment_thickness. Should accept 1, 2, and 3 dimensional arrays, corresponding to writing column, slice or volume data. (first axis is facies, then x and y)\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.OutputData.write_disintegration","page":"API Documentation","title":"CarboKitten.OutputData.write_disintegration","text":"write_disintegration(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nSee write_sediment_thickness. Should accept 1, 2, and 3 dimensional arrays, corresponding to writing column, slice or volume data. (first axis is facies, then x and y)\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.OutputData.write_production","page":"API Documentation","title":"CarboKitten.OutputData.write_production","text":"write_production(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nSee write_sediment_thickness. Should accept 1, 2, and 3 dimensional arrays, corresponding to writing column, slice or volume data. (first axis is facies, then x and y)\n\n\n\n\n\n","category":"function"},{"location":"api/#CarboKitten.OutputData.write_sediment_thickness","page":"API Documentation","title":"CarboKitten.OutputData.write_sediment_thickness","text":"write_sediment_thickness(out::T, name::Symbol, idx::Int, data::AbstractArray{Amount, dim}) where {T, dim}\n\nWrite the sediment thickness to the output object. The idx should be corrected for write interval. That is, idx should range from 1 to n_writes for the named data set. This function should be implemented for 0, 1, and 2 dimensional arrays, corresponding to writing column, slice or volume data.\n\nIf your output object type doesn't conform to the standard CarboKitten data layout, you may choose to not implement this function and implement state_writer and frame_writer instead. The same goes for write_production, write_disintegration and write_deposition.\n\n\n\n\n\n","category":"function"},{"location":"api/#Utility","page":"API Documentation","title":"Utility","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Utility, CarboKitten.Skeleton, CarboKitten.Stencil]","category":"page"},{"location":"api/#CarboKitten.Utility.enumerate_seq-Tuple{T} where T","page":"API Documentation","title":"CarboKitten.Utility.enumerate_seq","text":"enumerate_seq(s)\n\nEnumerates an iterator of sequences, such that the following equivalence holds:\n\nenumerate(flatten(s)) == flatten(enumerate_seq(s))\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Utility.find_ranges-Tuple{AbstractVector{Bool}}","page":"API Documentation","title":"CarboKitten.Utility.find_ranges","text":"find_ranges(v::AbstractVector{Bool})\n\nTake a vector of bools, returns an iterator over all ranges for which the vector is true.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Skeleton.skeleton-Tuple{AbstractMatrix{Bool}}","page":"API Documentation","title":"CarboKitten.Skeleton.skeleton","text":"skeleton(bitmap::AbstractMatrix{Bool})\n\nComputes the skeleton of a bitmap, i.e. reduces features with some thickness to a set of line segments. This function is designed with stratigraphic application in mind: we scan each row in the bitmap for connected regions, then link neighbouring regions when they overlap. The result is a graph that represents hiatus in the sediment accumulation.\n\nReturns a tuple of vertices and edges, where vertices is a vector of 2-tuples and edges is a nx2 matrix of indices into the vertices.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Stencil.stencil!-Union{Tuple{BT}, Tuple{sz}, Tuple{dim}, Tuple{F}, Tuple{F, Type{BT}, StaticArraysCore.Size{sz}, Any, Vararg{Any}}} where {F, dim, sz, BT<:Boundary{dim}}","page":"API Documentation","title":"CarboKitten.Stencil.stencil!","text":"stencil!(f, Boundary, Size, out, inp...)\n\nPerforms stencil operation. The function f should take a number of abstract arrays (same as the number of inp values), and return a single value of the same type as elements in out. The Size parameter should be a type parameter size of the stencil, e.g. Size(3, 3) to get a 3 by 3 stencil.\n\nPrefer to use this version over the older implementations.\n\n\n\n\n\n","category":"method"},{"location":"api/#Export","page":"API Documentation","title":"Export","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Export]","category":"page"},{"location":"api/#CarboKitten.Export.age_depth_model-Union{Tuple{Vector{T}}, Tuple{T}} where T","page":"API Documentation","title":"CarboKitten.Export.age_depth_model","text":"age_depth_model(sediment_accumulation_curve::Vector)\nage_depth_model(sediment_accumulation_curve::DataFrame)\n\nCompute the ADM from the SAC. Implemented as:\n\nreverse ∘ accumulate(min) ∘ reverse\n\nThe DataFrame version selects SAC columns, transformed into ADM.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.data_export-Tuple{CarboKitten.Export.CSV, CarboKitten.OutputData.Header, Any}","page":"API Documentation","title":"CarboKitten.Export.data_export","text":"data_export(spec::CSV, header::Header, data)\n\nExports data to CSV. Here, data should be a collection or iterable of DataColumn.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.extract_sac-Tuple{CarboKitten.OutputData.Header, CarboKitten.OutputData.DataColumn, Any}","page":"API Documentation","title":"CarboKitten.Export.extract_sac","text":"extract_sac(header::Header, data::DataColumn)\n\nExtract Sediment Accumumlation Curve (SAC) from the data. The SAC is directly copied from data.sediment_thickness. Returns a DataFrame with time and sac_<n> columns where <n> is in the range 1:length(grid_locations).\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.extract_sc-Tuple{CarboKitten.OutputData.Header, CarboKitten.OutputData.DataColumn, Any}","page":"API Documentation","title":"CarboKitten.Export.extract_sc","text":"extract_sc(header::Header, data::DataColumn)\n\nExtract Stratigraphic Column (SC) from the data. Returns a DataFrame with time and sc<n> columns where <n> is in the range 1:length(grid_locations).\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.extract_wd-Tuple{CarboKitten.OutputData.Header, CarboKitten.OutputData.DataColumn, Any}","page":"API Documentation","title":"CarboKitten.Export.extract_wd","text":"extract_wd(header::Header, data::DataColumn)\n\nExtract the water depth from the data. Returns a DataFrame with time and wd<n> columns where <n> is in the range 1:length(grid_locations).\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.stratigraphic_column-Tuple{CarboKitten.OutputData.Header, CarboKitten.OutputData.DataColumn, Int64}","page":"API Documentation","title":"CarboKitten.Export.stratigraphic_column","text":"stratigraphic_column(header::Header, column::DataColumn, facies::Int)\n\nCompute the Stratigraphic Column for a given grid position loc and facies index. Returns an Array{Quantity, 2} where the Quantity is in units of meters.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.unitful_headers-Tuple{DataFrames.DataFrame}","page":"API Documentation","title":"CarboKitten.Export.unitful_headers","text":"unitful_headers(df::DataFrame)\n\nGets a string representation for all column names including their unit. Returns a Vector{String}.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Export.write_unitful_csv-Tuple{Any, DataFrames.DataFrame}","page":"API Documentation","title":"CarboKitten.Export.write_unitful_csv","text":"write_unitful_csv(io::IO, df::DataFrame)\n\nWrite a CSV from a DataFrame with Unitful units. The units will be represented in the CSV header, and stripped from the individual values.\n\n\n\n\n\n","category":"method"},{"location":"api/#Unitful.ustrip-Tuple{DataFrames.DataFrame}","page":"API Documentation","title":"Unitful.ustrip","text":"ustrip(df::DataFrame)\n\nStrip units from a DataFrame. Returns a new DataFrame.\n\n\n\n\n\n","category":"method"},{"location":"api/#Transport","page":"API Documentation","title":"Transport","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [CarboKitten.Transport.Advection]","category":"page"},{"location":"api/#CarboKitten.Transport.Advection.transport!-Union{Tuple{BT}, Tuple{Box{BT}, Vararg{Any, 5}}} where BT","page":"API Documentation","title":"CarboKitten.Transport.Advection.transport!","text":"transport!(box, diffusivity, wave_velocity,\n           C, w, dC)\n\nComputes dC given a box, diffusivity constant in units of m/Myr, wave_velocity is a function of water depth, returning both velocity in units of m/Myr, and shear in units of 1/Myr, which should be the derivative of the velocity w.r.t. water depth. C is the concentration of entrained sediment, w the water depth, and dC the output derivative of C.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Transport.Advection.transport-Union{Tuple{T}, Tuple{BT}, Tuple{Box{BT}, Any, Any, AbstractArray{T}, Any}} where {BT, T}","page":"API Documentation","title":"CarboKitten.Transport.Advection.transport","text":"transport(box, diffusivity, wave_velocity, wave_shear,\n           C, w)\n\nNon-mutating version of transport!. Allocates and returns dC.\n\n\n\n\n\n","category":"method"},{"location":"api/#Submodules","page":"API Documentation","title":"Submodules","text":"","category":"section"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"Modules = [\n  CarboKitten.Denudation, CarboKitten.Denudation.Abstract,\n  CarboKitten.Denudation.NoDenudationMod\n  ]","category":"page"},{"location":"api/#CarboKitten.Denudation.Abstract.denudation-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Denudation.Abstract.denudation","text":"denudation(box, param, state)\n\nComputes the denudation for a single time-step, given denudation parameters param and a simulation state state. param should have a DenudationType type and state should contain the height property and sealevel.\n\nReturns denudation mass in units of meters.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Denudation.Abstract.denudation-Tuple{Box, CarboKitten.Denudation.Abstract.DenudationType, Vararg{Any, 4}}","page":"API Documentation","title":"CarboKitten.Denudation.Abstract.denudation","text":"denudation(box::Box, param::DenudationType, water_depth, slope, facies)\n\nComputes the amount of denudation. This function is called on a pixel by pixel basis, so all arguments can be assumed to be scalar. The param argument should be of a subtype of DenudationType containing all the input parameters for this specific denudation model.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Denudation.Abstract.redistribution-Tuple{Any}","page":"API Documentation","title":"CarboKitten.Denudation.Abstract.redistribution","text":"redistribution()\n\nTakes state, water_depth in meters and denudation_mass as a 3D array (facies, x and y coordinates) in units of meters.\n\n\n\n\n\n","category":"method"},{"location":"api/#CarboKitten.Denudation.NoDenudationMod","page":"API Documentation","title":"CarboKitten.Denudation.NoDenudationMod","text":"module NoDenudation\n\nDoesn't do any denudation: used for testing purposes.\n\n\n\n\n\n","category":"module"},{"location":"api/","page":"API Documentation","title":"API Documentation","text":"","category":"page"},{"location":"finite-difference-transport/#Finite-Difference-Methods-for-Transport","page":"Finite Difference","title":"Finite Difference Methods for Transport","text":"","category":"section"},{"location":"finite-difference-transport/#Spacial-Finite-Differences","page":"Finite Difference","title":"Spacial Finite Differences","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>src/Transport/DifferentialOperators.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module DifferentialOperators\n\n<<differential-operators>>\n\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"To solve the above equations we use three differential operators: central_difference, upwind and laplacian, defined in the context of a 2-d stencil operation.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Central differences approximates the derivative on a grid by,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"dy_i = fracy_i+1 - y_i-12Delta x","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"We define two variants for directions on the grid.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡differential-operators⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"central_difference(::Type{Val{1}}, a::AbstractMatrix, dx) =\n    (a[3, 2] - a[1, 2]) / (2dx)\n\ncentral_difference(::Type{Val{2}}, a::AbstractMatrix, dx) =\n    (a[2, 3] - a[2, 1]) / (2dx)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Upwind can be used when we know the derivative is being used in an advective context. If we are modeling flow, we better use the value in the direction where the flow is coming from,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"dy_i = begincases\nfracy_i+1 - y_iDelta x  textrmif v  0\nfracy_i - y_i-1Delta x  textrmif v  0\nendcases","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"In our implementation we also multiply with the velocity v to prevent code duplication when expressing advective terms.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡differential-operators⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"upwind(v::T, a1, a2, a3, dx) where {T} =\n    if v < zero(T)\n        v * (a3 - a2) / dx\n    else\n        v * (a2 - a1) / dx\n    end\n\nupwind(::Type{Val{1}}, v, a::AbstractMatrix, dx) =\n    upwind(v, a[:, 2]..., dx)\n\nupwind(::Type{Val{2}}, v, a::AbstractMatrix, dx) =\n    upwind(v, a[2, :]..., dx)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Laplacian is an approximation for the second derivative. Since we differentiate twice we no longer have the annoying situation that the derivative lives \"between\" our spatial discretization,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"nabla^2 y_i j = fracy_i-1j + y_ij-1 + y_i+1j + y_ij+1 - 4y_ijDelta x^2","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡differential-operators⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"laplacian(a::AbstractMatrix, dx) =\n    (a[1, 2] + a[2, 1] + a[3, 2] + a[2, 3] - 4 * a[2, 2]) / dx^2","category":"page"},{"location":"finite-difference-transport/#Solvers","page":"Finite Difference","title":"Solvers","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Since we're trying to prevent complications, we use only explicit solvers for our PDE. We have forward Euler and Runge-Kutta 4 methods in place.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"If you want better solvers, it should be possible (and relatively straight-forward) to implement this transport model using MethodOfLines.jl, but we haven't yet felt the need for that.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"These methods modify the given input y in-place.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>src/Transport/Solvers.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module Solvers\n\nusing Unitful\n\nfunction runge_kutta_4(::Type{T}, box) where {T}\n    U = typeof(1.0 * unit(T) / u\"Myr\")\n    k1 = Array{U}(undef, box.grid_size...)\n    k2 = Array{U}(undef, box.grid_size...)\n    k3 = Array{U}(undef, box.grid_size...)\n    k4 = Array{U}(undef, box.grid_size...)\n    function (df, y, t, dt)\n        k1 .= df(y, t)\n        k2 .= df(y .+ dt/2 .* k1, t + dt/2)\n        k3 .= df(y .+ dt/2 .* k2, t + dt/2)\n        k4 .= df(y .+ dt .* k3, t + dt)\n        y .+= (k1 .+ 2 .* k2 .+ 2 .* k3 .+ k4) .* (dt/6)\n    end\nend\n\nfunction forward_euler(df, y, t, dt)\n    y .+= dt .* df(y, t)\nend\n\nend","category":"page"},{"location":"finite-difference-transport/#Advection","page":"Finite Difference","title":"Advection","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"We are solving sediment transport using finite difference methods. Our active layer approach to transport can be written as an equation in terms of the sediment concentration,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = - d nabla (C nabla w)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"where C is the sediment concentration, d the diffusion coefficient and w the water depth. Similarly, we can set the transport equation when we enable wave transport,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = - d nabla (C nabla w) - v nabla C + s C nabla w","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"where v(w) is the wave transport velocity and s(w) the wave transport shear. This is now no longer a diffusion equation per se, rather an advective system. When we solve the equations, the first term is expanded, so we get,","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = -d nabla^2 w C - d nabla w nabla C - v nabla C + s nabla w C","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"collecting terms:","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"partial_t C = - (d nabla w + v) nabla C + (s nabla w - d nabla^2 w) C","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Note that partial_t C is a component of partial_t eta, and nabla eta = - nabla w. So in that context this advection equation enacts diffusion.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-transport⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"d = diffusivity\nv, s = wave_velocity(w[2, 2])\n\ndw = (central_difference(Val{1}, w, dx), central_difference(Val{2}, w, dx))\nadv = upwind(Val{1}, d * dw[1] + v[1], C, dx) + \n      upwind(Val{2}, d * dw[2] + v[2], C, dx)\nrct = (s[1] * dw[1] + s[2] * dw[2] - d * laplacian(w, dx)) * C[2, 2]\nreturn rct - adv","category":"page"},{"location":"finite-difference-transport/#Adaptive-integration","page":"Finite Difference","title":"Adaptive integration","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"To get efficient time integration we need to work with adaptive time-stepping. On each iteration we pre-compute the advection coefficients, and then the maximum time-step. Using the same pre-computed coefficients we then loop n times such that dtn le dt_textrmmax.","category":"page"},{"location":"finite-difference-transport/#Computing-advection-coefficients","page":"Finite Difference","title":"Computing advection coefficients","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Although this is a stencil operation, it is easier to compute this step directly. This way, we can compute dw and ddw with a single look-up of neighbouring grid cells. We store dw in a Vec2, expecting the wave_velocity to do the same.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Here adv stands for advection term and rct for reaction term, given the generic case","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"dC = - textrmadv nabla C + textrmrct C","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-coef⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"function advection_coef!(box::Box{BT}, diffusivity, wave_velocity, w, adv, rct) where {BT}\n    d = diffusivity\n    dx = box.phys_scale\n    di = (CartesianIndex(1, 0), CartesianIndex(0, 1))\n    for i = eachindex(IndexCartesian(), w)\n        v, s = wave_velocity(w[i])\n\n        wx1 = get_bounded(BT, w, i - di[1])\n        wx2 = get_bounded(BT, w, i + di[1])\n        wy1 = get_bounded(BT, w, i - di[2])\n        wy2 = get_bounded(BT, w, i + di[2])\n\n        dw = Vec2((wx2 - wx1) / (2dx), (wy2 - wy1) / (2dx))\n        ddw = (wx1 + wx2 + wy1 + wy2 - 4*w[i]) / dx^2\n\n        adv[i] = d * dw + v\n        rct[i] = dot(s, dw) - d * ddw\n    end\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Given the advection coefficients we can figure out what the maximal timestep should be.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-coef⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"function max_dt(adv, dx, courant_max)\n    u(a) = abs(a[1]) + abs(a[2])\n    return courant_max / maximum(u.(adv) ./ dx)\nend","category":"page"},{"location":"finite-difference-transport/#Compute-dC","page":"Finite Difference","title":"Compute dC","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Once we know our time step, we can use the adv and rct coefficients to evaluate the sediment transport. We again can't use the stencil or finite difference functionalities, since that would do needless computations. ","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡advection-coef⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"function transport_dC!(box::Box{BT}, adv, rct, C, dC) where {BT}\n    dx = box.phys_scale\n    di = (CartesianIndex(1, 0), CartesianIndex(0, 1))\n\n    @inline upwind(v::T, a, i, di) where {T} =\n        if v < zero(T)\n            v * (get_bounded(BT, a, i+di) - a[i]) / dx\n        else\n            v * (a[i] - get_bounded(BT, a, i-di)) / dx\n        end\n\n    for i = eachindex(IndexCartesian(), dC)\n        dC[i] = rct[i] *  C[i] - upwind(adv[i][1], C, i, di[1]) - upwind(adv[i][2], C, i, di[2]) \n    end\n\n    return dC\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>src/Transport/Advection.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module Advection\n\nusing ....CarboKitten: Box\nusing ...Stencil: stencil!, Size\nusing ...BoundaryTrait: get_bounded\nusing ..DifferentialOperators: central_difference, upwind, laplacian\nusing Unitful\nusing GeometryBasics\nusing LinearAlgebra: dot\n\n<<advection-coef>>\n\n\"\"\"\n    transport!(box, diffusivity, wave_velocity,\n               C, w, dC)\n\nComputes `dC` given a `box`, `diffusivity` constant in units of m/Myr,\n`wave_velocity` is a function of water depth, returning both velocity in units\nof m/Myr, and shear in units of 1/Myr, which should be the derivative of the\nvelocity w.r.t. water depth. `C` is the concentration of entrained sediment,\n`w` the water depth, and `dC` the output derivative of `C`.\n\"\"\"\nfunction transport!(box::Box{BT}, diffusivity, wave_velocity, C, w, dC) where {BT}\n    dx = box.phys_scale\n    stencil!(BT, Size(3, 3), dC, C, w) do C, w\n        <<advection-transport>>\n    end\nend\n\n\"\"\"\n    transport(box, diffusivity, wave_velocity, wave_shear,\n               C, w)\n\nNon-mutating version of [`transport!`](@ref). Allocates and returns `dC`.\n\"\"\"\nfunction transport(box::Box{BT}, diffusivity, wave_velocity, C::AbstractArray{T}, w) where {BT, T}\n\tdC = Array{typeof(1.0 * Unitful.unit(T) / u\"Myr\")}(undef, box.grid_size...)\n    transport!(box, diffusivity, wave_velocity, C, w, dC)\n    return dC\nend\n\nend","category":"page"},{"location":"finite-difference-transport/#Tests","page":"Finite Difference","title":"Tests","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"The following set of tests all involve mutilating a picture of a kitten. The default settings for TestModel have zero wave velocity and diffusivity. We'll enable them one by one. Note again, that what we call diffusivity, in the context of these tests doesn't necessarily behave like diffusion.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/runner.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module Runner\nusing CarboKitten\nusing ProgressLogging\n\nn_steps(input) = input.time.steps\n\nfunction run_model(f, ::Type{Model{M}}, input) where {M}\n    state = M.initial_state(input)\n    f(0, state)\n\n    @progress for i = 1:n_steps(input)\n        M.step!(input, state)\n        f(i, state)\n    end\n\n    return state\nend\n\ndo_nothing(_i, _s) = ()\n\nrun_model(::Type{Model{M}}, input) where {M} = run_model(do_nothing, Model{M}, input)\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/test_model.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"module TestModel\n\nusing CarboKitten\nusing CarboKitten.Transport.Advection: transport\nusing Unitful\n\n@kwdef struct Input\n    box::Box\n    time::TimeProperties\n    initial_state::Array{Float64}\n    topography::Array{typeof(1.0u\"m\")}\n\n    diffusivity = 0.0u\"m/Myr\"\n    wave_velocity = _ -> ((0.0u\"m/Myr\", 0.0u\"m/Myr\"), (0.0u\"1/Myr\", 0.0u\"1/Myr\"))\n\n    solver\nend\n\n@kwdef mutable struct State\n    time::typeof(1.0u\"Myr\")\n    value::Array{Float64}\nend\n\ninitial_state(input) = State(\n    time = input.time.t0,\n    value = copy(input.initial_state))\n\nfunction step!(input, state)\n    input.solver(\n        (a, t) -> transport(\n            input.box, input.diffusivity, input.wave_velocity,\n            a, .-input.topography),\n        state.value, state.time, input.time.Δt)\n    state.time += input.time.Δt\nend\n\nend","category":"page"},{"location":"finite-difference-transport/#Wave-induced-advection","page":"Finite Difference","title":"Wave induced advection","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"With only wave induced advection enabled, we should see a clear translation of the picture of the kitten. The additional diffusion is so called false diffusion, a numerical artifact of the upwind differencing scheme.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"(Image: Flying Cat)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/flying_cat.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"#| creates: docs/src/_fig/flying_cat.png\n#| collect: figures\n\nmodule FlyingCat\n\ninclude(\"runner.jl\")\ninclude(\"test_model.jl\")\n\nusing CarboKitten\nusing FileIO\nusing GLMakie\n\nusing CarboKitten.Transport.Solvers: forward_euler, runge_kutta_4\n\nGLMakie.activate!()\n\nconst BOX = CarboKitten.Box{Periodic{2}}(\n    grid_size=(256, 256), phys_scale=0.05u\"km\")\n\nconst INPUT = TestModel.Input(\n    box = BOX,\n    time = TimeProperties(Δt=100u\"yr\", steps=50),\n    topography = zeros(typeof(1.0u\"m\"), BOX.grid_size),\n    initial_state = load(\"data/cat256.pgm\")'[:, end:-1:1] .|> Float64,\n    wave_velocity = _ -> ((0.4u\"m/yr\", -0.3u\"m/yr\"), (0.0u\"1/yr\", 0.0u\"1/yr\")),\n    solver = runge_kutta_4(Float64, BOX)\n)\n\nfunction run()\n    x, y = box_axes(INPUT.box)\n\n    fig = Figure(size=(800, 400))\n    ax1 = Axis(fig[1, 1], aspect=1)\n    hm1 = heatmap!(ax1, x, y, INPUT.initial_state, colorrange=(0.0,0.7))\n    Colorbar(fig[2, 1], hm1, vertical=false)\n\n    out = Runner.run_model(Model{TestModel}, INPUT)\n    ax2 = Axis(fig[1, 2], aspect=1)\n    hm2 = heatmap!(ax2, x, y, out.value, colorrange=(0.0,0.7))\n    Colorbar(fig[2, 2], hm2, vertical=false)\n\n    save(\"docs/src/_fig/flying_cat.png\", fig)\nend\n\nend\n\nFlyingCat.run()","category":"page"},{"location":"finite-difference-transport/#Diffusion","page":"Finite Difference","title":"Diffusion","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"Next, we only enable the diffusivity term. We set a topography of a single Gaussian peak in the center of the box. Sediment is dispersed down slope.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"(Image: Exploding Kitten)","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>examples/transport/exploding_kitten.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"#| creates: docs/src/_fig/exploding_kitten.png\n#| collect: figures\n\nmodule ExplodingKitten\n\ninclude(\"runner.jl\")\ninclude(\"test_model.jl\")\n\nusing CarboKitten\nusing FileIO\nusing GLMakie\n\nusing CarboKitten.Transport.Solvers: runge_kutta_4\n\nGLMakie.activate!()\n\nconst N = 288\n\nfunction load_cat()\n    b = div(N - 256, 2)\n    cat = zeros(Float64, N, N)\n    cat[b+1:256+b, b+1:256+b] .= (load(\"data/cat256.pgm\")'[:, end:-1:1] .|> Float64)\n    return cat\nend\n\nconst BOX = CarboKitten.Box{Reflected{2}}(grid_size=(N, N), phys_scale=0.05u\"km\")\nconst X, Y = box_axes(BOX)\nconst INPUT = TestModel.Input(\n    box = BOX, \n    time = TimeProperties(Δt=100u\"yr\", steps=100),\n    initial_state = load_cat(),\n    topography = ((x, y) -> 30.0u\"m\" * exp(-((x-7.2u\"km\")^2 + (y-7.2u\"km\")^2)/(2*(3.0u\"km\")^2)) - 30.0u\"m\").(X, Y'),\n    diffusivity = 30.0u\"m/yr\",\n    solver = runge_kutta_4(Float64, BOX)\n)\n\nfunction run()\n    x, y = box_axes(INPUT.box)\n\n    fig = Figure(size=(800, 400))\n    ax1 = Axis(fig[1, 1], aspect=1)\n    hm1 = heatmap!(ax1, x, y, INPUT.topography / u\"m\")\n    Colorbar(fig[2,1], hm1, vertical=false)\n\n    out = Runner.run_model(Model{TestModel}, INPUT)\n    ax2 = Axis(fig[1, 2], aspect=1)\n    hm2 = heatmap!(ax2, x, y, out.value, colorrange=(0.0,0.8))\n    Colorbar(fig[2,2], hm2, vertical=false)\n\n    save(\"docs/src/_fig/exploding_kitten.png\", fig)\nend\n\nend\n\nExplodingKitten.run()","category":"page"},{"location":"finite-difference-transport/#Scale-invariance","page":"Finite Difference","title":"Scale invariance","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"From the conception  of the transport model, it should be evident that the solution to the transport equations should be scale invariant, in the sense that  we can multiply C by any constant, solve the equations, then divide by the same constant and arrive at the same result.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">file:<i>test/Transport/AdvectionSpec.jl</i></div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"using CarboKitten\nusing CarboKitten: Box, box_axes\nusing CarboKitten.Components.TimeIntegration: time\nusing CarboKitten.Transport.Solvers: runge_kutta_4\nusing CarboKitten.Transport.Advection: transport\nusing CarboKitten.Testing: transport_test_input\nusing Unitful\n\n@testset \"CarboKitten.Transport.Advection.scale-invariance\" begin\n\n# test transport code for scale invariance\nlet box = Box{Periodic{2}}(grid_size=(32, 32), phys_scale=1.0u\"m\")\n    solver = runge_kutta_4(Float64, box)\n    wave_velocity = _ -> ((0.5u\"m/s\", 0.0u\"m/s\"), (0.0u\"1/s\", 0.0u\"1/s\"))\n    diffusivity = 5.0u\"m/s\"\n    w = randn(box.grid_size...) * u\"m\"\n    C1 = randn(box.grid_size...)\n    C2 = C1 .* 10.0\n    dt = 1.0u\"s\"\n    df(C, _) = transport(box, diffusivity, wave_velocity, C, w)\n\n    for i = 1:10\n        solver(df, C1, 0.0u\"s\", dt)\n        solver(df, C2, 0.0u\"s\", dt)\n    end\n\n    @test isapprox(C1 .* 10.0, C2)\n\nend\nend\n\n<<test-wave-transport>>","category":"page"},{"location":"finite-difference-transport/#Test-onshore-transport","page":"Finite Difference","title":"Test onshore transport","text":"","category":"section"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"The center of mass of an initial sediment distribution - taken to be a Gaussian bell curve - should move with the same speed as the onshore (wave) velocity while applying some tolerance for inaccuracies from the finite difference scheme for solving the PDEs.","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"<div class=\"noweb-label\">⪡test-wave-transport⪢≣</div>","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"@testset \"CarboKitten.Transport.Advection.wave-transport\" begin\n\nfunction gaussian_initial_sediment(x, y)\n\texp(-(x-10u\"km\")^2 / (2 * (0.5u\"km\")^2)) * 30.0u\"m\"\nend\n\nv_const(v_max) = _ -> (Vec2(v_max, 0.0u\"m/yr\"), Vec2(0.0u\"1/yr\", 0.0u\"1/yr\"))\n\ninput = transport_test_input(\n    initial_topography = (x, y)  -> -35.0u\"m\",\n    initial_sediment = gaussian_initial_sediment,\n    disintegration_rate = 50000.0u\"m/Myr\",\n    wave_velocity = v_const(-5u\"km/Myr\")\n)\n\nfunction center_of_mass(m, x)\n    total_mass = sum(m)        # Total mass\n\n    if total_mass ≈ 0.0u\"m\"\n        return NaN * u\"m\"  # Avoid division by zero\n    end\n\n    x_com = sum(x .* sum(m, dims=2)) / total_mass  # Weighted average along x\n    return x_com\nend\n\nstate = ALCAP.initial_state(input)\n\nresult = []\ntimes = []\n\nrun_model(Model{ALCAP}, input, state) do i, delta\n    if mod(i-1, 250) == 0\n        push!(result, deepcopy(state.sediment_height))\n        push!(times, time(input, state))\n    end\nend\n\n(x, y) = box_axes(input.box)\n\ncom_positions = [center_of_mass(r, x) for r in result]\n\n@assert length(com_positions) == length(times)\nobserved_speeds = (com_positions[2:end] .- com_positions[1:end-1]) ./ \n    (times[2:end] .- times[1:end-1])\n\n# Extract the expected speed from the wave transport\nexpected_speed = input.facies[1].wave_velocity(0.0u\"m\")[1][1]  \ntolerance = 1e-6 * expected_speed  # Set a tolerance for the comparison\n# Check if all speeds are within tolerance\nfor speed in observed_speeds\n    @test speed ≈ expected_speed atol=tolerance\nend\n\nend","category":"page"},{"location":"finite-difference-transport/","page":"Finite Difference","title":"Finite Difference","text":"","category":"page"},{"location":"input-methods/#Input-Methods","page":"Input Methods","title":"Input Methods","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Every model in CarboKitten has its own specific needs in terms of input. However, there are many common idioms used here.","category":"page"},{"location":"input-methods/#Sea-level","page":"Input Methods","title":"Sea level","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"The sea level curve is probably the input parameter that is most often of interest. CarboKitten expects the sea level to be passed on as a function of time. So time must also be defined. In the tutorial you find the following example:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"time = TimeProperties(\n\tΔt = 500u\"yr\",\n\tsteps = 2000\n)","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"To retrieve the range of times which will be written as the model output, one can use the time_axis() function.","category":"page"},{"location":"input-methods/#Sea-level-from-file","page":"Input Methods","title":"Sea level from file","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Reading a single vector of numbers from a example.txt file in the data folder (it will be similar for other formats):","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"dir = \"data\"\nfilename = joinpath(dir, \"example.txt\")\nsea_level = readdlm(filename, '\\t', header=false) * u\"m\"","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Remember that the topmost value in the file will be the first one to be read. In geological datasets this is often the youngest value, but because CarboKitten is a forward model, the first value in the vector of sea level values will be the one used first, so effectively the oldest. Sort your sea level values in the order of decreasing age, or oldest first, for CarboKitten to read them correctly.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Consider several situations involving the file with the values of sea level and the model run:","category":"page"},{"location":"input-methods/#1.-The-file-has-regularly-spaced-(equidistant)-observations","page":"Input Methods","title":"1. The file has regularly spaced (equidistant) observations","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Whether the temporal resolution is lower, the same or higher than the model step, we recommend using linear_interpolation from the package Interpolations.jl or an equivalent function. You will have to interpolate the values to the density determined by Δt. ","category":"page"},{"location":"input-methods/#Running-a-model-at-a-resolution-higher-than-the-resolution-of-the-sea-level-data","page":"Input Methods","title":"Running a model at a resolution higher than the resolution of the sea level data","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"The model may give nicer results at lower Δt than the resolution of the empirical sea level data. This will require \"making up\" data by interpolation. Keep in mind that scientifically you don't know what happened at the interpolated points, so the sea level curve and the carbonate platform generated will be smoother than they would have been if the sea level had been measured at this resolution. You may use the parameter write_times from the component TimeIntegration to model at a higher temporal resolution, but save the results only at a resolution of the input data.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"using Interpolations\n\nSL  = linear_interpolation(time_axis(time), sea_level)","category":"page"},{"location":"input-methods/#2.-The-file-has-irregularly-(not-equidistant)-observations","page":"Input Methods","title":"2. The file has irregularly (not equidistant) observations","text":"","category":"section"},{"location":"input-methods/#2.1.-Interpolation-on-irregular-grid","page":"Input Methods","title":"2.1. Interpolation on irregular grid","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Take the example from the tutorial:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"using CarboKitten.DataSets: miller_2020\nmiller_df = miller_2020()\n\nusing Interpolations\nsort!(miller_df, [:time])\nmiller_sea_level = linear_interpolation(miller_df.time, miller_df.sealevel)","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"This works even though miller_df.time is not equally spaced, which is why this function is very safe if you change your input data a lot. But what happens under the hood is that extrapolation according to the method that is default for linear_interpolation. It may not be the best method for your data, so we recommend checking that and reporting on the type of interpolation used.","category":"page"},{"location":"input-methods/#2.2.-Local-regression-(loess)","page":"Input Methods","title":"2.2. Local regression (loess)","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Loess, or \"Locally Estimated Scatterplot Smoothing\", is very popular among geoscientists. The Smoothers.jl package needs to be installed for this to work (Pkg.add(\"Smoothers\")). ","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"(Image: Loess smoothing of the sea level curve of Miller et al. (2020))","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"It should work as follows:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/loess.jl</i></div>","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"#| creates: docs/src/_fig/loess.png\n#| collect: figures\n\nmodule Script\n\nusing CarboKitten\n\nusing Unitful\nusing CarboKitten.Components\n\nusing CarboKitten.DataSets: miller_2020\nusing Smoothers\nusing GLMakie\n\nGLMakie.activate!()\n\nfunction main()\n\n    miller_df = miller_2020()\n    sort!(miller_df, [:time])\n\n    sl = miller_df.sealevel / u\"m\" .|> NoUnits\n    ti = miller_df.time / u\"kyr\" .|> NoUnits\n\n    fig = Figure()\n    ax = Axis(fig[1,1], xlabel=\"Time [kyr]\", ylabel=\"Sea level [m]\")\n    scatter!(ax, ti, sl)\n    lines!(ax, ti, Smoothers.loess(ti, sl, q = 1000)(ti); color = :tomato)\n    save(\"docs/src/_fig/loess.png\",fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Choosing the q parameter proves difficult. Although the package Smoothers.jl indicates the default value will be estimated, in practice it seems to often result in NaNs. So always plot the result of smoothing to check it has been done correctly.","category":"page"},{"location":"input-methods/#Inline-functions","page":"Input Methods","title":"Inline functions","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"If the function is very simple, you can enter it as an inline anonymous function (also known as a lambda). The following would generate a sinusoid with an amplitude of 10m and a period of 100,000 years.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"const INPUT = Input(\n    ...\n    sea_level = t -> 10.0u\"m\" * sin(2pi / 100.0u\"kyr\")\n    ...)","category":"page"},{"location":"input-methods/#Stochastic-functions","page":"Input Methods","title":"Stochastic functions","text":"","category":"section"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"Functions can capture pre-generated data, so you can generate a stochastic sea-level curve for use in CarboKitten. There are multiple stochastic processes available in DiffEqNoiseProcess.jl and some of them may be relevant for modeling sea level. This example uses OrnsteinUhlenbeckProcess, which is a continuous time equivalent of an AR(1), but here calculated for specific positions determined based on the temporal resolution of the model, set in TIME_PROPERTIES.","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"The outcome looks like an AR(1) process:","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"(Image: Sea-level modeled as Ornstein-Uhlenbeck process)","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"<div class=\"noweb-label\">file:<i>examples/tabular-sea-level/ornstein-uhlenbeck.jl</i></div>","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"#| creates: docs/src/_fig/OU.png\n#| collect: figures\n\nmodule Script\n\nusing CarboKitten\n\nusing Unitful\nusing CarboKitten.Components\nusing GLMakie\nusing Random\n\nGLMakie.activate!()\n\nconst TIME_PROPERTIES = TimeProperties(\n\tΔt = 500u\"yr\",\n\tsteps = 2000\n)\n\nfunction generate_ar1(mean, n, drift, variance)\n\"\"\"\nArguments\n- `mean`: Mean of the process\n- `length`: Length of the process (number of steps)\n- `drift`: Drift parameter\n- `variance`: Variance of the process \n\"\"\"\n    ar1 = Vector{Float64}(undef, n)\n    ar1[1] = mean  # start with the mean for simplicity\n\n    for i in 2:n\n        ar1[i] = drift * ar1[i-1] + (1 - drift) * mean + randn() * sqrt(variance)\n    end\n\n    return ar1\nend\n\nconst θ = 0.4 # drift\nconst μ = 2.0 # mean\nconst σ = 20 # variance\n\nfunction main()\n\nOU = generate_ar1(μ, length(time_axis(TIME_PROPERTIES)), θ, σ)\n\nfig, ax = lines(time_axis(TIME_PROPERTIES) |> in_units_of(u\"Myr\"), collect(OU) .* u\"m\")\n    ax.xlabel = \"time [Myr]\"\n\tax.ylabel = \"sea level [m]\"\n    save(\"docs/src/_fig/OU.png\",fig)\n\nend\n\nend\n\nScript.main()","category":"page"},{"location":"input-methods/","page":"Input Methods","title":"Input Methods","text":"","category":"page"},{"location":"components/components/#Model-Components","page":"Components","title":"Model Components","text":"","category":"section"},{"location":"components/components/","page":"Components","title":"Components","text":"Each model in CarboKitten is composed out of elementary parts. These form a hierarchy of modules that inherit from each other.","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"<!– FIXME: auto-generate this graph –>","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"graph TD;\n    classDef nyi fill:#888;\n\n    time[Time Integration]\n    facies[Facies Base]\n    box[Box]\n    water_depth[Water Depth]\n    uniform_production[Production]\n    cellular_automaton[Cellular Automaton]\n    ca_production[CA Production]\n    h5writer[HDF5 Writer]\n    tag[Tagged Output]\n\n    sediment_buffer[Sediment Buffer]\n    active_layer_transport[Active Layer Transport]\n    denudation[Denudation]\n    class denudation nyi;\n\n    time --> water_depth\n    box --> water_depth\n\n    water_depth --> uniform_production\n    facies --> uniform_production\n\n    box --> cellular_automaton\n    facies --> cellular_automaton\n\n    cellular_automaton --> ca_production\n    uniform_production --> ca_production\n\n    box --> sediment_buffer\n    sediment_buffer --> active_layer_transport\n    water_depth --> active_layer_transport\n    sediment_buffer --> denudation\n    water_depth --> denudation\n\n    box --> h5writer\n    facies --> h5writer\n    time --> h5writer\n    water_depth --> h5writer","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"Not all of these are equally important. The H5Writer implements the core simulation loop and writing a simulation to HDF5 files. For a Model to work with H5Writer it needs to have initial_state, step!, and write_header functions implemented. Each component can have its own write_header implementation. Those are joined together with a special @for_each(P->P.write_header(fid, input), PARENTS) call.","category":"page"},{"location":"components/components/#Contents","page":"Components","title":"Contents","text":"","category":"section"},{"location":"components/components/","page":"Components","title":"Components","text":"Pages = [\"tag.md\", \"boxes.md\", \"time.md\", \"facies.md\",\n         \"production.md\", \"cellular-automata.md\", \"waterdepth.md\", \"hdf5.md\",\n         \"sediment_buffer.md\"]\nDepth = 1","category":"page"},{"location":"components/components/#Common-Definitions","page":"Components","title":"Common Definitions","text":"","category":"section"},{"location":"components/components/","page":"Components","title":"Components","text":"<div class=\"noweb-label\">file:<i>src/Components/Common.jl</i></div>","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"module Common\nexport @u_str, Quantity, Amount, Time, Location, Rate, Intensity, Height, Sediment\nexport AbstractFacies, AbstractInput, AbstractState, AbstractFrame, AbstractOutputSpec\nexport OutputSpec\nexport Box, box_axes, Boundary, Coast, Periodic, Reflected, TimeProperties\nexport in_units_of\nexport Model\nexport @for_each\nexport Size\nexport Frame\n\nusing ModuleMixins\nusing Unitful\nusing StaticArrays\n\nusing ...CarboKitten: Model\nusing ...BoundaryTrait\nusing ...Config: TimeProperties\nusing ...Boxes: Box, box_axes\nusing ...Utility: in_units_of\nusing ...OutputData: AbstractInput, AbstractState, Frame, OutputSpec\n\nconst Amount = typeof(1.0u\"m\")\nconst Time = typeof(1.0u\"Myr\")\nconst Height = typeof(1.0u\"m\")\nconst Location = typeof(1.0u\"m\")\nconst Rate = typeof(1.0u\"m/Myr\")\nconst Intensity = typeof(1.0u\"W/m^2\")\nconst Sediment = typeof(1.0u\"m\")\n\nabstract type AbstractFacies end\n\nend","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"<div class=\"noweb-label\">file:<i>src/Components.jl</i></div>","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"module Components\n\nexport Tag, TimeIntegration, Boxes, WaterDepth, FaciesBase, Production,\n       CAProduction, CellularAutomaton, H5Writer, ActiveLayer, SedimentBuffer,\n       ActiveLayerOnshore, Denudation, InitialSediment\n\nusing ModuleMixins: @compose\n\ninclude(\"Components/Common.jl\")\ninclude(\"Components/Tag.jl\")\ninclude(\"Components/TimeIntegration.jl\")\ninclude(\"Components/Boxes.jl\")\ninclude(\"Components/WaterDepth.jl\")\ninclude(\"Components/FaciesBase.jl\")\ninclude(\"Components/Production.jl\")\ninclude(\"Components/CellularAutomaton.jl\")\ninclude(\"Components/CAProduction.jl\")\n\ninclude(\"Components/SedimentBuffer.jl\")\ninclude(\"Components/InitialSediment.jl\")\ninclude(\"Components/ActiveLayer.jl\")\ninclude(\"Components/Denudation.jl\")\n\ninclude(\"Components/Models.jl\")\ninclude(\"Components/H5Writer.jl\")\n\nlist_components() = filter(\n    c->:AST in names(c, all=true),\n    map(eval, names(Components)))\n\nend","category":"page"},{"location":"components/components/","page":"Components","title":"Components","text":"","category":"page"},{"location":"denudation/chemical/#Chemical-dissolution","page":"Chemical Dissolution","title":"Chemical dissolution","text":"","category":"section"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The details could be found in paper by [11].","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Limestone is made of CaCO_3, easily dissolved. This depends mainly on precipitation (rainfall) and temperature. The paper used equation 1 to quantify this process.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"fracdhdt = 0001 kappa_c q_i over A_i","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Herein dhdt is the chemical weathering rate and the unit is in m/s. Other parameters are defined as: q_i is the discharge of water at a certain cell. A_i is the surface area of the cell. If we assume there would be no surface water on land, q_i reduces to precipitation – evaporation. Let’s set it to 400 mm/y for now. Therefore equation 1 could be reduced to Equation 2.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"fracdhdt = 0001 kappa_c  I","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Where I is runoff (mm/y?). The parameter kappa_c is dimensionless and should be described by equation 3:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"kappa_c = 40 1000 fracCa^2+_eqrho","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Parameter ρ is the density of calcite, and we choose 2700 kgm^3 here. Ca^2+_eq is defined in equation 4:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Ca^2+_eq = (PCO_2 (K_1 K_C K_H) over (4 K_2times gamma Ca (gamma HCO_3)^2))^(13)","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Mass balance coefficients K_1, K_2, K_C, K_H depend on temperature. _PCO_2 is assumed to be between 10^-15 ATM to 10^-35 ATM.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Other parameters can be found in the following table by [11].","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Parameter Description Unit Value\nT Absolute temperature [°K] Tc + 273.16\nI Ion activity [-] 0.1\nA^* Debye-Hückel coefficient [-] -04883 + 8074 times 10^-4T_c\nB^* Debye-Hückel coefficient [-] -03241 + 1600 times 10^-4T_c\nlog gamma Cadagger Activity coefficient [-] -4AsqrtI(1 + 50 x 10^-8BsqrtI)\nlog gamma HCO_3dagger Activity coefficient [-] -1AsqrtI(1 + 54 x 10^-8BsqrtI)\nlog K_1ddagger Mass balance coefficient [ mol L^-1 ] -3563094 - 006091964T + 2183437T + 1268339logT - 1684915T^2\nlog K_2ddagger Mass balance coefficient [ mol L^-1 ] -1078871 - 003252849T + 515179T + 3892561logT - 5637139T^2\nlog K_cddagger Mass balance coefficient [ mol^2 L^-2 ] -1719065 - 0077993T + 2839319T + 71595logT\nlog K_Hddagger Mass balance coefficient [ mol L^-1 atm^-1 ] 1083865 + 001985076T - 691953T - 4045154logT + 669365T^2","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"These parameters are calculated from temperature using the karst_denudation_parameters function:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">⪡karst-parameter-function⪢≣</div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"function karst_denudation_parameters(temp::Float64)\n    A = -0.4883 + 8.074 * 0.0001 * (temp - 273.0)\n    B = -0.3241 + 1.6 * 0.0001 * (temp - 273.0)\n    IA = 0.1 # ion activity\n\n    (K1=10^(-356.3094 - 0.06091964 * temp + 21834.37 / temp + 126.8339 * log10(temp) - 1684915 / (temp^2)),\n        K2=10^(-107.881 - 0.03252849 * temp + 5151.79 / temp + 38.92561 * log10(temp) - 563713.9 / (temp^2)),\n        KC=10^(-171.9065 - 0.077993 * temp + 2839.319 / temp + 71.595 * log10(temp)),\n        KH=10^(108.3865 + 0.01985076 * temp - 6919.53 / temp - 40.4515 * log10(temp) + 669365 / (temp^2)),\n        activity_Ca=10^(-4A * sqrt(IA) / (1 + 10^(-8) * B * sqrt(IA))),\n        activity_Alk=10^(-A * sqrt(IA) / (1 + 5.4 * 10^(-8) * B * sqrt(IA))))\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The output of this function for the K_H parameter is plotted below for a range of input temperatures","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"(Image: KH as function of temperature)","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<details><summary>Plotting code</summary>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">file:<i>examples/denudation/dissolution-test.jl</i></div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"#| requires: examples/denudation/dissolution-test.jl\n#| creates:\n#|   - docs/src/_fig/KHTemp.png\n#|   - docs/src/_fig/Equilibrium_Concs.png\n#|   - docs/src/_fig/DissolutionExample.png\n#| collect: figures\n\nmodule DissolutionSpec\nusing CairoMakie\nusing Unitful\nusing CarboKitten.Denudation.DissolutionMod: equilibrium, dissolution, karst_denudation_parameters\nusing CarboKitten: Box\nusing CarboKitten.Stencil: Periodic, Reflected, stencil\n\n\n@kwdef struct facies\n    infiltration_coefficient :: Float64\n    mass_density :: typeof(1.0u\"kg/m^3\")\n    reactive_surface :: typeof(1.0u\"m^2/m^3\")\nend\n\n\n@kwdef struct Dissolution\n    temp :: Any\n    precip :: Float64\n    pco2 :: Float64\n    reactionrate :: Float64\nend\n\n@kwdef struct state\n    ca::Matrix{Int}\nend\n\nconst BOX = Box{Periodic{2}}(grid_size=(5, 5), phys_scale=1.0u\"km\")\n\n\nconst Facies = facies(infiltration_coefficient = 0.5,\nmass_density = 2.73u\"kg/m^3\",\nreactive_surface = 1000u\"m^2/m^3\")\n\nconst DIS = Dissolution(temp = 285,\nprecip  = 1.0,\npco2 = 10^(-1.5),\nreactionrate = 0.1)\n\nconst STATE = state(ca = \n[ 0  0  1  0  0\n0  1  0  1  1\n0  0  1  0  1\n1  0  1  1  0\n1  1  1  1  0])\n\nconst WD = -10 .* [ 0.0663001  0.115606  0.646196\n0.601523   0.130196  0.390821\n0.864734   0.902935  0.670354]\n\nfunction main()\n    temp = collect(293:0.5:303)\n\n    Eq_result = Array{Any,1}(undef,length(temp))\n    Para_result = Array{Any,1}(undef,length(temp))\n    Dis_result = Array{Any,1}(undef,length(temp))\n    Dis_result_wd = Array{Any,1}(undef,length(WD))\n\n    for i in eachindex(temp)\n        Para_result[i] = karst_denudation_parameters(temp[i])\n    end\n    Para_result_KH = [x.KH for x in Para_result]\n\n    for i in eachindex(temp)\n       Eq_result[i] =  equilibrium(temp[i],DIS.pco2,DIS.precip,Facies)\n    end\n    Eq_result_concs = [x.concentration for x in Eq_result]\n    for i in eachindex(temp)\n        Dis_result[i] = dissolution(temp[i],DIS.precip,DIS.pco2,DIS.reactionrate,WD[1],Facies)\n    end\n    Dis_result\n    for i in eachindex(WD)\n        Dis_result_wd[i] = dissolution(temp[1],DIS.precip,DIS.pco2,DIS.reactionrate,WD[i],Facies)\n    end\n    Dis_result_wd\n\n    fig1 = Figure()\n    ax1 = Axis(fig1[1,1],xlabel=\"Temp (K)\", ylabel=\" concentration (mol/L)\")\n    lines!(ax1,temp,Eq_result_concs)\n    save(\"docs/src/_fig/Equilibrium_Concs.png\",fig1)\n\n    fig2 = Figure()\n    ax2 = Axis(fig2[1,1],xlabel=\"Temp (K)\", ylabel=\"KH\")\n    lines!(ax2,temp,Para_result_KH)\n    save(\"docs/src/_fig/KHTemp.png\",fig2)\n\n    fig3 = Figure()\n    ax3 = Axis(fig3[1,1],xlabel=\"Temp (K)\", ylabel=\"Denudation rates (m/Myr)\")\n    lines!(ax3,temp,Dis_result)\n\n    ax4 = Axis(fig3[1,2],xlabel=\"Water Depth (m)\", ylabel=\"Denudation rates (m/Myr)\")\n    scatter!(ax4,vec(WD),Dis_result_wd)\n    fig3\n    save(\"docs/src/_fig/DissolutionExample.png\",fig3)\nend\nend\n\nDissolutionSpec.main()","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"</details>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The Ca^2+_eq parameter is calculated from temperature using the equilibrium function:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">⪡karst-equilibrium-function⪢≣</div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"function equilibrium(temp::Float64, pco2::Float64, precip::Float64, facies)\n    p = karst_denudation_parameters(temp)\n    mass_density = facies.mass_density ./ u\"kg/m^3\"\n    eq_c = (pco2 .* (p.K1 * p.KC * p.KH) ./ (4 * p.K2 * p.activity_Ca .* (p.activity_Alk)^2)) .^ (1 / 3)\n    eq_d = 1e6 * precip .* facies.infiltration_coefficient * 40 * 1000 .* eq_c ./ mass_density\n    (concentration=eq_c, denudation=eq_d)\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The value of Ca^2+_eq calculated in equilibrium for a range of temperatures: (Image: KH as function of temperature)","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"However, the above discussion is true only if the percolated fluid is saturated (in terms of Ca) when leaving the platform. In some cases, when the fluid is not saturated, the dissolved amount is lower than the scenario described above.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The following articles describe this: [12] and [13]","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Ideally, a reactive transport model should be accurate, but that needs more computation resources. So herein, the author just suggested the dissolution rates of rocks depend on the depth. This makes sense, as the deeper the solution penetrates, the more concentrated it becomes. Also, this does not consider diffusion in this chapter.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The dissolution rate of carbonate follows linear rate laws of:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"F = alpha (c_eq-c(z))","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The rate law is a common expression way to describe the kinetics of certain chemical reactions see Rate Laws.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"F","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"is the dissolution rate, alpha is constant (kinetic co-efficient), c_eq is the concentration in fluid when equilibrium is reached (i.e., no more dissolution, which is Ca^2+_eq in Chapter 1), c(z) is the current concentrationion at depth z in the fluid. This equation then expands to","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"I rm dc = alpha (c_eq-c(z)) L rm dz","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"This equation indicates that the concentration increase in the infiltrated water equals the dissolution of rocks in the thickness of dz. L is the specific length of fractures/porosities (units: mm^2, we can try 100 at the first place). I.e., this term defines the relative reactive surface of the subsurface rocks, or how much surface is actually dissolving. This term is difficult to determine. I is infiltration, but slightly different as chapter 1: this I is the I in each rain event according to the paper. We certainly do not gonna know how this parameter works, so we just set it the same as in chapter 1?","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"However, to solve this equation we still need to know c(z).","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"If assuming the initial percolating water has c(0) = 0, then we could get the following equation (as c is related to depth):","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"c(z) = c_eq (1 - e^(-zlambda))","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Herein, $ \\lambda = {{I} \\over {\\alpha L}} $.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"Therefore,","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"D_rm average = (Itimes fracc_eqrho) (1  (fraclambdaz_0) (1  e^(frac-z_0lambda)))","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"α used in this article is alpha = 210^6 or 3510^7 cm/s (for temp at 298K). This is indeed a controversial parameter TBH. We can try different values and see what happens.","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"These equations are implemented as dissolution function:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">⪡karst-dissolution-function⪢≣</div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"function dissolution(temp, precip, pco2, alpha, water_depth, facies)\n    reactive_surface =  facies.reactive_surface ./u\"m^2/m^3\"\n    λ = precip * 100 .* facies.infiltration_coefficient ./ (alpha .* reactive_surface)\n    eq = equilibrium(temp, pco2, precip, facies) # pass ceq Deq from the last function\n    eq.denudation .* (1 - (λ ./ -water_depth) .* (1 - exp.(water_depth ./ λ))) * u\"m/Myr\"\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"The dedudation rate calculated in this function for varying temperature and water depth is plotted here:","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"(Image: Dissolution as function of temperature and water depth)","category":"page"},{"location":"denudation/chemical/#Implementation","page":"Chemical Dissolution","title":"Implementation","text":"","category":"section"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"<div class=\"noweb-label\">file:<i>src/Denudation/DissolutionMod.jl</i></div>","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"module DissolutionMod\n\nimport ..Abstract: DenudationType, denudation, redistribution\nusing ...BoundaryTrait: Boundary\nusing ...Boxes: Box\nexport Dissolution\nusing Unitful\n\n@kwdef struct Dissolution <: DenudationType\n    temp::typeof(1.0u\"K\")\n    precip::typeof(1.0u\"m\")\n    pco2::typeof(1.0u\"atm\")\n    reactionrate::typeof(1.0u\"m/yr\")\nend\n\n<<karst-parameter-function>>\n\n#calculate ceq and Deq, Kaufman 2002\n<<karst-equilibrium-function>>\n\n<<karst-dissolution-function>>\n\n\nfunction denudation(::Box{BT}, p::Dissolution, water_depth, slope, facies, state) where {BT<:Boundary}\n    temp = p.temp ./ u\"K\"\n    precip = p.precip ./u\"m\"\n    pco2 = p.pco2 ./1.0u\"atm\"\n    reactionrate = p.reactionrate ./u\"m/yr\"\n    denudation_rate = zeros(typeof(1.0u\"m/Myr\"), length(facies), size(state.ca)...)\n\n    for idx in CartesianIndices(state.ca)\n        f = state.ca[idx]\n        if f == 0\n            continue\n        end\n        if water_depth[idx] <= 0\n            denudation_rate[f, idx] = dissolution(temp, precip, pco2, reactionrate, water_depth[idx], facies[f])\n        end\n    end\n    return denudation_rate\nend\n\nfunction redistribution(box::Box{BT}, p::Dissolution, denudation_mass, water_depth) where {BT<:Boundary}\n    return nothing\nend\n\nend","category":"page"},{"location":"denudation/chemical/","page":"Chemical Dissolution","title":"Chemical Dissolution","text":"","category":"page"},{"location":"stencils/#Stencil-operations","page":"Stencils","title":"Stencil operations","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"A stencil is the common term for computing many-to-one operations on grids. Examples of applications are:","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Finite difference schemes\nFinite Impulse Response (FIR) filters\nConvolutions (encompassing the previous two)\nCellular Automata","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Note that for larger convolution kernels, it is often more efficient to perform convolutions in the Fourier domain. On the matter of performance: stencil operations are the textbook example for computations that perform really well on GPUs.","category":"page"},{"location":"stencils/#Implementation","page":"Stencils","title":"Implementation","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Using these helper functions we can now define a stencil operation. Given the boundary trait, a stencil size and a response function, we can transform an array to a next generation.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">⪡stencil-operation⪢≣</div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"\"\"\"\n    stencil!(f, Boundary, Size, out, inp...)\n\nPerforms stencil operation. The function `f` should take a number of\nabstract arrays (same as the number of `inp` values),\nand return a single value of the same type as elements in `out`.\nThe `Size` parameter should be a type parameter size of the stencil,\ne.g. `Size(3, 3)` to get a 3 by 3 stencil.\n\nPrefer to use this version over the older implementations.\n\"\"\"\nfunction stencil!(f::F, ::Type{BT}, ::Size{sz}, out, inp...) where {F, dim, sz, BT <: Boundary{dim}}\n    stencil_multi!(f, BT, Size(sz), out, inp)\nend\n\nfunction stencil_multi!(f::F, ::Type{BT}, ::Size{sz}, out, inp) where {F, dim, sz, BT <: Boundary{dim}}\n    @assert(\n        all(size(a) == size(out) for a in inp),\n        \"inputs have wrong shape: $([size(a) for a in inp]), should be $(size(out))\")\n\n    center = CartesianIndex((div.(sz, 2) .+ 1)...)\n    for i in eachindex(IndexCartesian(), out)\n        nb = (SArray{Tuple{sz...}}(\n                get_bounded(BT, a, i + j - center)\n                for j in CartesianIndices(sz))\n              for a in inp)\n        out[i] = f(nb...)\n    end\n    return out\nend\n\n\nfunction stencil(::Type{TIn}, ::Type{TOut}, ::Type{BT}, n::NTuple{dim,Int}, f::Function) where {TIn, TOut, dim, BT <: Boundary{dim}}\n    m = n .÷ 2\n    stencil_shape = range.(.-m, m)\n    stencil = Array{TIn, dim}(undef, n...)\n\n    function(z_in::AbstractArray{TIn, dim}, z_out::AbstractArray{TOut, dim}, args...)\n        @assert (size(z_in) == size(z_out)) \"sizes of arrays need to be equal\"\n        shape = size(z_in)\n        for i in CartesianIndices(shape)\n            for (k, Δi) in enumerate(CartesianIndices(stencil_shape))\n                stencil[k] = offset_value(BT, z_in, i, Δi)\n            end\n            z_out[i] = f(stencil, args...)\n        end\n    end\nend\n\nstencil(::Type{T}, ::Type{BT}, n::NTuple{dim, Int}, f::Function) where {T, dim, BT <: Boundary{dim}} =\n    stencil(T, T, BT, n, f)\n\nconvolution(::Type{TIn}, ::Type{TOut}, ::Type{B}, kernel::AbstractArray{U, dim}) where { dim, TIn, TOut, U, B <: Boundary{dim} } =\n    stencil(TIn, TOut, B, size(kernel), s -> sum(s .* kernel))\n\nconvolution(::Type{B}, kernel::AbstractArray{T, dim}) where {dim, T, B <: Boundary{dim}} =\n    stencil(T, T, B, size(kernel), s -> sum(s .* kernel))","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"More efficient implementations are imaginable. For instance we could use normal unchecked indexing for most of the array, and only use the offset_value function when we really need it. Another optimisation could be to generate parts of the inner loop, and/or do the outer loop in parallel.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"We will now test this function first on an Elementary CA (ECA), Conway's Game of Life, and a convolution.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<details><summary>Stencil module</summary>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>src/Stencil.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"module Stencil\n\nusing StaticArrays\n\nusing ..Boxes: AbstractBox\nusing ..BoundaryTrait\n\nexport stencil, convolution\n\n<<stencil-operation>>\n\nend","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"</details>","category":"page"},{"location":"stencils/#Examples","page":"Stencils","title":"Examples","text":"","category":"section"},{"location":"stencils/#Elementary-Cellular-Automata","page":"Stencils","title":"Elementary Cellular Automata","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"An Elementary Cellular Automata is a one-dimensional CA with two states. Every next generation depends on the direct neighbourhood of three cells. Since there are 2^3 = 8 patterns and two outcomes for every pattern, there are 2^8 = 256 possible ECA.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>examples/ca/eca.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"#| creates: docs/src/_fig/eca.png\n#| requires: src/Stencil.jl\n#| collect: figures\n\nmodule ECA\n    using CarboKitten.BoundaryTrait\n    using CarboKitten.Stencil\n    using CairoMakie\n\n    rule(i::Int) = function (foo::AbstractVector{T}) where T <: Integer\n        d = foo[1]*4 + foo[2]*2 + foo[3]\n        i & (1 << d) == 0 ? 0 : 1\n    end\n\n    function eca(r::Int, n::Int, iter::Int)\n        y = Array{Int}(undef, n, iter)\n        y[:, 1] = zeros(Int, n)\n        y[div(n, 2), 1] = 1\n        stencil_op = stencil(Int, Periodic{1}, (3,), rule(r))\n        for i in 2:iter\n            stencil_op(view(y, :, i-1), view(y, :, i))\n        end\n        y\n    end\n\n    function plot()\n        fig = Figure(size=(1200,400))\n        for (idx, r) in enumerate([18, 30, 110])\n            ax = Axis(fig[1,idx]; title=\"rule $(r)\", yreversed=true, limits=((1, 256), (1, 128)))\n            heatmap!(ax, eca(r, 256, 128); colormap=:Blues)\n        end\n        save(\"docs/src/_fig/eca.png\", fig)\n    end\nend\n\nECA.plot()","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"(Image: )","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Even these one-dimensional CA show highly complex behaviour. For instance, it has been shown that rule 110 is Turing complete.","category":"page"},{"location":"stencils/#Game-of-Life","page":"Stencils","title":"Game of Life","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Perhaps the most famous CA is Conway's Game of Life. This is a two-dimensional two-state (dead/alive) CA, with the following rules: a cell is alive in the next generation if it is alive and has two neighbours or if it has three neighbours; in all other cases the cell is dead.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>examples/ca/life.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"#| creates: docs/src/_fig/life.gif\n#| requires: src/Stencil.jl\n#| collect: figures\n\nmodule Life\n    using CarboKitten.BoundaryTrait\n    using CarboKitten.Stencil\n    using CairoMakie\n    using .Iterators: take\n\n    \"x is a 3x3 region around the cell at x[2,2].\"\n    rules(x) = let c = x[2, 2], s = sum(x) - c\n        c && s == 2 || s == 3\n    end\n\n    function game_of_life(w, h)\n        y1 = rand(Bool, (w, h))\n        y2 = Array{Bool}(undef, w, h)\n\n        op = stencil(Bool, Periodic{2}, (3, 3), rules)\n        Channel() do ch\n            put!(ch, y1)\n            while true\n                op(y1, y2)\n                (y1, y2) = (y2, y1)\n                put!(ch, y1)\n            end\n        end\n    end\n\n    function plot()\n        life = take(game_of_life(50, 50), 150)\n        fig = Figure()\n        ax = Axis(fig[1,1], aspect=1)\n        record(fig, \"docs/src/_fig/life.gif\", life; framerate=10) do frame\n            heatmap!(ax, frame; colormap=:Blues)\n        end\n    end\nend\n\nLife.plot()","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"(Image: )","category":"page"},{"location":"stencils/#Testing-boundaries-with-a-convolution","page":"Stencils","title":"Testing boundaries with a convolution","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"To test the different boundary types, lets try the following setup. We take a 16x16 image with all zeros except the bottom left gets a value of 1 and the top right pixel gets a value of 2. Now convolve with a Gaussian and see what happens. For the constant boundary, I've set the value to 0.1, to see the effect.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"(Image: )","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"Notice, that for the periodic boundaries, the bottom left and top right are neighbouring. So there the two pixels appear as a single peak. In the reflected case we see a clear distinction between the two corners.","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"#| creates: docs/src/_fig/boundary_types.png\n#| requires: src/Stencil.jl\n#| collect: figures\n\nmodule Script\n\nusing CarboKitten.BoundaryTrait\nusing CarboKitten.Stencil\nusing CairoMakie\n\nfunction plot_boundary_types()\n    n = 16\n    y0 = zeros(Float64, n, n)\n    y0[1, 1] = 1\n    y0[n, n] = 2\n    x = collect(-2:0.25:2)\n    k = exp.(-(x.^2 .+ x'.^2))\n    k ./= sum(k)\n\n    y_periodic = Array{Float64}(undef, n, n)\n    convolution(Periodic{2}, k)(y0, y_periodic)\n    y_reflected = Array{Float64}(undef, n, n)\n    convolution(Reflected{2}, k)(y0, y_reflected)\n    y_constant = Array{Float64}(undef, n, n)\n    convolution(Constant{2, 0.1}, k)(y0, y_constant)\n\n    fig = Figure(size=(900, 300))\n    for (i, y) in enumerate([y_periodic, y_reflected, y_constant])\n        ax = Axis(fig[1,i]; aspect=1)\n        heatmap!(ax, y; colormap=:viridis)\n    end\n    save(\"docs/src/_fig/boundary_types.png\", fig)\nend\nend \n\nScript.plot_boundary_types()","category":"page"},{"location":"stencils/#Tests","page":"Stencils","title":"Tests","text":"","category":"section"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"<div class=\"noweb-label\">file:<i>test/StencilSpec.jl</i></div>","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"@testset \"CarboKitten.Stencil\" begin\n\nusing StaticArrays\nusing CarboKitten\nusing CarboKitten.Stencil: stencil!\n\nlet a = ones(Float64, 10, 10),\n    b = zeros(Float64, 10, 10)\n\n    stencil!(Periodic{2}, Size(3, 3), b, a) do a\n        sum(a)\n    end\n\n    @test all(b .== 9)\nend\n\nend","category":"page"},{"location":"stencils/","page":"Stencils","title":"Stencils","text":"","category":"page"},{"location":"boxes/#Generic-Parameters","page":"Boxes","title":"Generic Parameters","text":"","category":"section"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Config.jl</i></div>","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"module Config\n\nexport TimeProperties\n\nusing ..BoundaryTrait\nusing ..Vectors\n\nusing ..Boxes: Box, axes\nexport Box, axes\n\nusing Unitful\nusing Unitful.DefaultSymbols\nusing ..CarboKitten: TimeProperties\n\n<<config-types>>\n\nend","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"Physical parameters of CarboKitten all should have units, see our refresher on Unitful.jl.","category":"page"},{"location":"boxes/#Time-properties","page":"Boxes","title":"Time properties","text":"","category":"section"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"Time stepping is specified in TimeProperties. We'll have time_steps number of time steps, each of physical time Δt. However, only one in write_interval steps is written to disk.","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">⪡config-types⪢≣</div>","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"","category":"page"},{"location":"boxes/#Vectors","page":"Boxes","title":"Vectors","text":"","category":"section"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"To trace the position of particles we define a NamedTuple with x and y members and define common vector operations on those.","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"<div class=\"noweb-label\">file:<i>src/Vectors.jl</i></div>","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"module Vectors\n\nexport Vec2\n\nVec2 = @NamedTuple{x::Float64, y::Float64}\nBase.:+(a::Vec2, b::Vec2) = (x=a.x+b.x, y=a.y+b.y)\nBase.abs2(a::Vec2) = a.x^2 + a.y^2\nBase.abs(a::Vec2) = √(abs2(a))\nBase.:*(a::Vec2, b::Float64) = (x=a.x*b, y=a.y*b)\nBase.:/(a::Vec2, b::Float64) = (x=a.x/b, y=a.y/b)\nBase.:*(a::Float64, b::Vec2) = b*a\nBase.:-(a::Vec2, b::Vec2) = (x=a.x-b.x, y=a.y-b.y)\nBase.:-(a::Vec2) = (x=-a.x, y=-a.y)\nBase.zero(::Type{Vec2}) = (x=0.0, y=0.0)\n\nend","category":"page"},{"location":"boxes/","page":"Boxes","title":"Boxes","text":"","category":"page"},{"location":"ca-with-production/#CA-with-production","page":"Model with CA and Production","title":"CA with production","text":"","category":"section"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"This model combines BS92 production with the B13 cellular automaton. This production model is implemented in the CAProduction component.","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"(Image: Stratigraphy, production and subsidence under oscillating sea level.)","category":"page"},{"location":"ca-with-production/#Complete-example","page":"Model with CA and Production","title":"Complete example","text":"","category":"section"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"This example is running for 10000 steps to 1Myr on a 100 times 50 grid, starting with a sloped height down to 50m. The sea_level, and initial_depth arguments are functions. The phys_scale argument translate pixels on the grid into physical metres. The write_interval indicates to write output every 10 iterations, summing the production over that range.","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"noweb-label\">file:<i>examples/model/cap/run.jl</i></div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"#| creates: data/output/cap1.h5\n#| requires: src/Models/CAP.jl\n\nmodule Script\n\nusing CarboKitten\n\nconst PERIOD = 200.0u\"kyr\"\nconst AMPLITUDE = 4.0u\"m\"\n\nconst FACIES = [\n\t    CAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate = 500u\"m/Myr\",\n        extinction_coefficient = 0.8u\"m^-1\",\n        saturation_intensity = 60u\"W/m^2\"),\n\n\t    CAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate = 400u\"m/Myr\",\n        extinction_coefficient = 0.1u\"m^-1\",\n        saturation_intensity = 60u\"W/m^2\"),\n\n\t    CAP.Facies(\n        viability_range = (4, 10),\n        activation_range = (6, 10),\n        maximum_growth_rate = 100u\"m/Myr\",\n        extinction_coefficient = 0.005u\"m^-1\",\n        saturation_intensity = 60u\"W/m^2\")\n\t]\n\n\tconst INPUT = CAP.Input(\n\t\ttag = \"cap1\",\n\t\tbox = Box{Coast}(grid_size=(100, 50), phys_scale=150.0u\"m\"),\n\t\ttime = TimeProperties(\n\t\t\tΔt = 200.0u\"yr\",\n\t\t\tsteps = 5000),\n\n        output = Dict(\n            :topography => OutputSpec(write_interval = 500),\n            :profile => OutputSpec(slice = (:, 25))),\n\n\t\tsea_level = t -> 4.0u\"m\" * sin(2π * t / 0.2u\"Myr\"),\n\t\tinitial_topography = (x, y) -> - x / 300.0,\n\t\tsubsidence_rate = 50.0u\"m/Myr\",\n\t\tinsolation = 400.0u\"W/m^2\",\n\t\tfacies = FACIES)\n\n\tmain() = run_model(Model{CAP}, INPUT, \"data/output/cap1.h5\")\nend\n\nScript.main()","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"This writes output to an HDF5 file that you may use for further analysis and visualization.","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"noweb-label\">file:<i>examples/model/cap/plot.jl</i></div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"#| creates: docs/src/_fig/cap1-summary.png\n#| requires: data/output/cap1.h5\n#| collect: figures\nusing GLMakie\nusing CarboKitten.Visualization\n\nGLMakie.activate!()\n\nsave(\"docs/src/_fig/cap1-summary.png\", summary_plot(\"data/output/cap1.h5\"))","category":"page"},{"location":"ca-with-production/#Implementation","page":"Model with CA and Production","title":"Implementation","text":"","category":"section"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"800pt\" height=\"580pt\"\n viewBox=\"0.00 0.00 799.50 580.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 576)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-576 795.5,-576 795.5,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M542,-572C542,-572 404,-572 404,-572 398,-572 392,-566 392,-560 392,-560 392,-505 392,-505 392,-499 398,-493 404,-493 404,-493 542,-493 542,-493 548,-493 554,-499 554,-505 554,-505 554,-560 554,-560 554,-566 548,-572 542,-572\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"399,-541.5 547,-541.5 \"/>\n<text text-anchor=\"start\" x=\"449.5\" y=\"-550.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"399,-518.5 399,-541.5 446,-541.5 446,-518.5 399,-518.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"399,-518.5 446,-518.5 446,-541.5 399,-541.5 \"/>\n<text text-anchor=\"start\" x=\"403\" y=\"-526.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"446,-518.5 446,-541.5 500,-541.5 500,-518.5 446,-518.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"446,-518.5 446,-541.5 500,-541.5 500,-518.5 446,-518.5\"/>\n<text text-anchor=\"start\" x=\"450\" y=\"-526.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"500,-518.5 500,-541.5 547,-541.5 547,-518.5 500,-518.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"547,-541.5 500,-541.5 500,-518.5 547,-518.5 \"/>\n<text text-anchor=\"start\" x=\"504\" y=\"-526.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"446,-499.5 446,-518.5 \"/>\n<text text-anchor=\"start\" x=\"403\" y=\"-506.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"500,-499.5 500,-518.5 \"/>\n<text text-anchor=\"start\" x=\"450\" y=\"-506.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"503\" y=\"-506.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node7\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M338,-457C338,-457 80,-457 80,-457 74,-457 68,-451 68,-445 68,-445 68,-352 68,-352 68,-346 74,-340 80,-340 80,-340 338,-340 338,-340 344,-340 350,-346 350,-352 350,-352 350,-445 350,-445 350,-451 344,-457 338,-457\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"75,-426.5 343,-426.5 \"/>\n<text text-anchor=\"start\" x=\"161.5\" y=\"-435.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"75,-403.5 75,-426.5 192,-426.5 192,-403.5 75,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"75,-403.5 192,-403.5 192,-426.5 75,-426.5 \"/>\n<text text-anchor=\"start\" x=\"79\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"192,-403.5 192,-426.5 246,-426.5 246,-403.5 192,-403.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"192,-403.5 192,-426.5 246,-426.5 246,-403.5 192,-403.5\"/>\n<text text-anchor=\"start\" x=\"196\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"246,-403.5 246,-426.5 343,-426.5 343,-403.5 246,-403.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"343,-426.5 246,-426.5 246,-403.5 343,-403.5 \"/>\n<text text-anchor=\"start\" x=\"250\" y=\"-411.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"192,-384.5 192,-403.5 \"/>\n<text text-anchor=\"start\" x=\"79\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"246,-384.5 246,-403.5 \"/>\n<text text-anchor=\"start\" x=\"196\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"249\" y=\"-391.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"192,-365.5 192,-384.5 \"/>\n<text text-anchor=\"start\" x=\"79\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"246,-365.5 246,-384.5 \"/>\n<text text-anchor=\"start\" x=\"196\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"249\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"192,-346.5 192,-365.5 \"/>\n<text text-anchor=\"start\" x=\"79\" y=\"-353.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"246,-346.5 246,-365.5 \"/>\n<text text-anchor=\"start\" x=\"196\" y=\"-353.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"249\" y=\"-353.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge5\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M395.93,-492.97C376.35,-483.18 354.82,-472.41 333.54,-461.77\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"334.95,-458.56 324.44,-457.22 331.82,-464.82 334.95,-458.56\"/>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node9\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M779.5,-294.5C779.5,-294.5 518.5,-294.5 518.5,-294.5 512.5,-294.5 506.5,-288.5 506.5,-282.5 506.5,-282.5 506.5,-208.5 506.5,-208.5 506.5,-202.5 512.5,-196.5 518.5,-196.5 518.5,-196.5 779.5,-196.5 779.5,-196.5 785.5,-196.5 791.5,-202.5 791.5,-208.5 791.5,-208.5 791.5,-282.5 791.5,-282.5 791.5,-288.5 785.5,-294.5 779.5,-294.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"514,-264.5 785,-264.5 \"/>\n<text text-anchor=\"start\" x=\"574\" y=\"-273.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"514,-241.5 514,-264.5 607,-264.5 607,-241.5 514,-241.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"514,-241.5 607,-241.5 607,-264.5 514,-264.5 \"/>\n<text text-anchor=\"start\" x=\"518\" y=\"-249.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"607,-241.5 607,-264.5 712,-264.5 712,-241.5 607,-241.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"607,-241.5 607,-264.5 712,-264.5 712,-241.5 607,-241.5\"/>\n<text text-anchor=\"start\" x=\"611\" y=\"-249.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"712,-241.5 712,-264.5 785,-264.5 785,-241.5 712,-241.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"785,-264.5 712,-264.5 712,-241.5 785,-241.5 \"/>\n<text text-anchor=\"start\" x=\"716\" y=\"-249.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"607,-222.5 607,-241.5 \"/>\n<text text-anchor=\"start\" x=\"518\" y=\"-229.5\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"712,-222.5 712,-241.5 \"/>\n<text text-anchor=\"start\" x=\"611\" y=\"-229.5\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"715\" y=\"-229.5\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"607,-203.5 607,-222.5 \"/>\n<text text-anchor=\"start\" x=\"518\" y=\"-210.5\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"712,-203.5 712,-222.5 \"/>\n<text text-anchor=\"start\" x=\"611\" y=\"-210.5\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"715\" y=\"-210.5\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge12\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M510.51,-492.76C520.35,-481.66 530.57,-469.24 539,-457 572.67,-408.12 603.25,-347.66 623.58,-304.1\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"626.86,-305.34 627.88,-294.79 620.51,-302.4 626.86,-305.34\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M278,-572C278,-572 140,-572 140,-572 134,-572 128,-566 128,-560 128,-560 128,-505 128,-505 128,-499 134,-493 140,-493 140,-493 278,-493 278,-493 284,-493 290,-499 290,-505 290,-505 290,-560 290,-560 290,-566 284,-572 278,-572\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"135,-541.5 283,-541.5 \"/>\n<text text-anchor=\"start\" x=\"143.5\" y=\"-550.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"135,-518.5 135,-541.5 182,-541.5 182,-518.5 135,-518.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"135,-518.5 182,-518.5 182,-541.5 135,-541.5 \"/>\n<text text-anchor=\"start\" x=\"139\" y=\"-526.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"182,-518.5 182,-541.5 236,-541.5 236,-518.5 182,-518.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"182,-518.5 182,-541.5 236,-541.5 236,-518.5 182,-518.5\"/>\n<text text-anchor=\"start\" x=\"186\" y=\"-526.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"236,-518.5 236,-541.5 283,-541.5 283,-518.5 236,-518.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"283,-541.5 236,-541.5 236,-518.5 283,-518.5 \"/>\n<text text-anchor=\"start\" x=\"240\" y=\"-526.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"182,-499.5 182,-518.5 \"/>\n<text text-anchor=\"start\" x=\"139\" y=\"-506.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"236,-499.5 236,-518.5 \"/>\n<text text-anchor=\"start\" x=\"186\" y=\"-506.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"239\" y=\"-506.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge4\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M209,-492.97C209,-484.98 209,-476.34 209,-467.65\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"212.5,-467.47 209,-457.47 205.5,-467.47 212.5,-467.47\"/>\n</g>\n<!-- CAP -->\n<g id=\"node3\" class=\"node\">\n<title>CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M205,-36C205,-36 175,-36 175,-36 169,-36 163,-30 163,-24 163,-24 163,-12 163,-12 163,-6 169,0 175,0 175,0 205,0 205,0 211,0 217,-6 217,-12 217,-12 217,-24 217,-24 217,-30 211,-36 205,-36\"/>\n<text text-anchor=\"start\" x=\"173.5\" y=\"-15.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAP</text>\n</g>\n<!-- Tag -->\n<g id=\"node4\" class=\"node\">\n<title>Tag</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-151C150,-151 12,-151 12,-151 6,-151 0,-145 0,-139 0,-139 0,-84 0,-84 0,-78 6,-72 12,-72 12,-72 150,-72 150,-72 156,-72 162,-78 162,-84 162,-84 162,-139 162,-139 162,-145 156,-151 150,-151\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-120.5 155,-120.5 \"/>\n<text text-anchor=\"start\" x=\"67\" y=\"-129.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Tag</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-97.5 7,-120.5 54,-120.5 54,-97.5 7,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-97.5 54,-97.5 54,-120.5 7,-120.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-97.5 54,-120.5 108,-120.5 108,-97.5 54,-97.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-97.5 108,-120.5 155,-120.5 155,-97.5 108,-97.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-120.5 108,-120.5 108,-97.5 155,-97.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-105.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-78.5 54,-97.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\">tag</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-78.5 108,-97.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-85.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Tag&#45;&gt;CAP -->\n<g id=\"edge1\" class=\"edge\">\n<title>Tag&#45;&gt;CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M126.91,-71.96C138.78,-62 151.21,-51.57 161.86,-42.62\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"164.22,-45.21 169.63,-36.1 159.72,-39.85 164.22,-45.21\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node5\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M187,-285C187,-285 49,-285 49,-285 43,-285 37,-279 37,-273 37,-273 37,-218 37,-218 37,-212 43,-206 49,-206 49,-206 187,-206 187,-206 193,-206 199,-212 199,-218 199,-218 199,-273 199,-273 199,-279 193,-285 187,-285\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"44,-254.5 192,-254.5 \"/>\n<text text-anchor=\"start\" x=\"80.5\" y=\"-263.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"44,-231.5 44,-254.5 91,-254.5 91,-231.5 44,-231.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"44,-231.5 91,-231.5 91,-254.5 44,-254.5 \"/>\n<text text-anchor=\"start\" x=\"48\" y=\"-239.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"91,-231.5 91,-254.5 145,-254.5 145,-231.5 91,-231.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"91,-231.5 91,-254.5 145,-254.5 145,-231.5 91,-231.5\"/>\n<text text-anchor=\"start\" x=\"95\" y=\"-239.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"145,-231.5 145,-254.5 192,-254.5 192,-231.5 145,-231.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"192,-254.5 145,-254.5 145,-231.5 192,-231.5 \"/>\n<text text-anchor=\"start\" x=\"149\" y=\"-239.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"91,-212.5 91,-231.5 \"/>\n<text text-anchor=\"start\" x=\"48\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\">output</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"145,-212.5 145,-231.5 \"/>\n<text text-anchor=\"start\" x=\"95\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"148\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- H5Writer&#45;&gt;CAP -->\n<g id=\"edge2\" class=\"edge\">\n<title>H5Writer&#45;&gt;CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M144.4,-205.55C154.22,-189.33 164.54,-169.89 171,-151 182.91,-116.15 187.36,-73.64 189.01,-46.45\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"192.53,-46.31 189.55,-36.14 185.54,-45.94 192.53,-46.31\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node6\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M518,-438C518,-438 380,-438 380,-438 374,-438 368,-432 368,-426 368,-426 368,-371 368,-371 368,-365 374,-359 380,-359 380,-359 518,-359 518,-359 524,-359 530,-365 530,-371 530,-371 530,-426 530,-426 530,-432 524,-438 518,-438\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"375,-407.5 523,-407.5 \"/>\n<text text-anchor=\"start\" x=\"405\" y=\"-416.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"375,-384.5 375,-407.5 422,-407.5 422,-384.5 375,-384.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"375,-384.5 422,-384.5 422,-407.5 375,-407.5 \"/>\n<text text-anchor=\"start\" x=\"379\" y=\"-392.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"422,-384.5 422,-407.5 476,-407.5 476,-384.5 422,-384.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"422,-384.5 422,-407.5 476,-407.5 476,-384.5 422,-384.5\"/>\n<text text-anchor=\"start\" x=\"426\" y=\"-392.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"476,-384.5 476,-407.5 523,-407.5 523,-384.5 476,-384.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"523,-407.5 476,-407.5 476,-384.5 523,-384.5 \"/>\n<text text-anchor=\"start\" x=\"480\" y=\"-392.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"422,-365.5 422,-384.5 \"/>\n<text text-anchor=\"start\" x=\"379\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"476,-365.5 476,-384.5 \"/>\n<text text-anchor=\"start\" x=\"426\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"479\" y=\"-372.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge6\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M394.91,-358.87C383.44,-351.85 371.12,-345.14 359,-340 295.49,-313.05 271.51,-330.95 208,-304 198.91,-300.14 189.71,-295.4 180.83,-290.31\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"182.47,-287.22 172.09,-285.13 178.9,-293.24 182.47,-287.22\"/>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge13\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M500.25,-358.81C523.64,-341.15 551.74,-319.93 577.2,-300.71\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"579.49,-303.37 585.36,-294.55 575.27,-297.78 579.49,-303.37\"/>\n</g>\n<!-- Production -->\n<g id=\"node10\" class=\"node\">\n<title>Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M476.5,-304C476.5,-304 229.5,-304 229.5,-304 223.5,-304 217.5,-298 217.5,-292 217.5,-292 217.5,-199 217.5,-199 217.5,-193 223.5,-187 229.5,-187 229.5,-187 476.5,-187 476.5,-187 482.5,-187 488.5,-193 488.5,-199 488.5,-199 488.5,-292 488.5,-292 488.5,-298 482.5,-304 476.5,-304\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"225,-273.5 482,-273.5 \"/>\n<text text-anchor=\"start\" x=\"309.5\" y=\"-282.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Production</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"225,-250.5 225,-273.5 294,-273.5 294,-250.5 225,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"225,-250.5 294,-250.5 294,-273.5 225,-273.5 \"/>\n<text text-anchor=\"start\" x=\"229\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"294,-250.5 294,-273.5 435,-273.5 435,-250.5 294,-250.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"294,-250.5 294,-273.5 435,-273.5 435,-250.5 294,-250.5\"/>\n<text text-anchor=\"start\" x=\"298\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"435,-250.5 435,-273.5 482,-273.5 482,-250.5 435,-250.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"482,-273.5 435,-273.5 435,-250.5 482,-250.5 \"/>\n<text text-anchor=\"start\" x=\"439\" y=\"-258.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"294,-231.5 294,-250.5 \"/>\n<text text-anchor=\"start\" x=\"229\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">insolation</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"435,-231.5 435,-250.5 \"/>\n<text text-anchor=\"start\" x=\"298\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\">maximum_growth_rate</text>\n<text text-anchor=\"start\" x=\"438\" y=\"-238.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"294,-212.5 294,-231.5 \"/>\n<text text-anchor=\"start\" x=\"229\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"435,-212.5 435,-231.5 \"/>\n<text text-anchor=\"start\" x=\"298\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\">extinction_coefficient</text>\n<text text-anchor=\"start\" x=\"438\" y=\"-219.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"294,-193.5 294,-212.5 \"/>\n<text text-anchor=\"start\" x=\"229\" y=\"-200.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"435,-193.5 435,-212.5 \"/>\n<text text-anchor=\"start\" x=\"298\" y=\"-200.5\" font-family=\"monospace\" font-size=\"10.00\">saturation_intensity</text>\n<text text-anchor=\"start\" x=\"438\" y=\"-200.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;Production -->\n<g id=\"edge9\" class=\"edge\">\n<title>FaciesBase&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M424.28,-358.61C415.37,-344.61 405.05,-328.38 395.08,-312.69\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"397.91,-310.62 389.59,-304.05 392,-314.37 397.91,-310.62\"/>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge7\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M174.34,-339.98C165.19,-324.8 155.41,-308.58 146.62,-293.99\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"149.45,-291.9 141.29,-285.14 143.45,-295.52 149.45,-291.9\"/>\n</g>\n<!-- WaterDepth&#45;&gt;Production -->\n<g id=\"edge8\" class=\"edge\">\n<title>WaterDepth&#45;&gt;Production</title>\n<path fill=\"none\" stroke=\"black\" d=\"M263.85,-339.98C272.69,-330.71 281.9,-321.05 290.9,-311.62\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"293.69,-313.76 298.06,-304.11 288.63,-308.93 293.69,-313.76\"/>\n</g>\n<!-- CAProduction -->\n<g id=\"node8\" class=\"node\">\n<title>CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M402.5,-129.5C402.5,-129.5 303.5,-129.5 303.5,-129.5 297.5,-129.5 291.5,-123.5 291.5,-117.5 291.5,-117.5 291.5,-105.5 291.5,-105.5 291.5,-99.5 297.5,-93.5 303.5,-93.5 303.5,-93.5 402.5,-93.5 402.5,-93.5 408.5,-93.5 414.5,-99.5 414.5,-105.5 414.5,-105.5 414.5,-117.5 414.5,-117.5 414.5,-123.5 408.5,-129.5 402.5,-129.5\"/>\n<text text-anchor=\"start\" x=\"298.5\" y=\"-108.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CAProduction</text>\n</g>\n<!-- CAProduction&#45;&gt;CAP -->\n<g id=\"edge3\" class=\"edge\">\n<title>CAProduction&#45;&gt;CAP</title>\n<path fill=\"none\" stroke=\"black\" d=\"M322.34,-93.29C294.96,-77.92 254.84,-55.4 225.96,-39.19\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"227.44,-36 217.01,-34.16 224.01,-42.11 227.44,-36\"/>\n</g>\n<!-- CellularAutomaton&#45;&gt;CAProduction -->\n<g id=\"edge10\" class=\"edge\">\n<title>CellularAutomaton&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M541.3,-196.47C492.99,-174.93 438.49,-150.62 400.59,-133.72\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"401.89,-130.47 391.33,-129.59 399.04,-136.86 401.89,-130.47\"/>\n</g>\n<!-- Production&#45;&gt;CAProduction -->\n<g id=\"edge11\" class=\"edge\">\n<title>Production&#45;&gt;CAProduction</title>\n<path fill=\"none\" stroke=\"black\" d=\"M353,-186.99C353,-170.54 353,-153.38 353,-139.68\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"356.5,-139.52 353,-129.52 349.5,-139.52 356.5,-139.52\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"<div class=\"noweb-label\">file:<i>src/Models/CAP.jl</i></div>","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"@compose module CAP\n@mixin Tag, H5Writer, CAProduction\n\nusing ..Common\nusing ..CAProduction: production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    ca_state = CellularAutomaton.initial_state(input)\n    for _ in 1:20\n        CellularAutomaton.step!(input)(ca_state)\n    end\n\n    sediment_height = zeros(Height, input.box.grid_size...)\n    return State(\n        step=0, sediment_height=sediment_height,\n        ca=ca_state.ca, ca_priority=ca_state.ca_priority)\nend\n\nfunction step!(input::Input)\n    τ = production(input)\n    step_ca = CellularAutomaton.step!(input)\n\n    function (state::State)\n        if mod(state.step, input.ca_interval) == 0\n            step_ca(state)\n        end\n\n        prod = τ(state)\n        Δη = sum(prod; dims=1)[1, :, :]\n        state.sediment_height .+= Δη\n        state.step += 1\n\n        return Frame(\n            production = prod,\n            deposition = prod)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\nend","category":"page"},{"location":"ca-with-production/","page":"Model with CA and Production","title":"Model with CA and Production","text":"","category":"page"},{"location":"components/sediment_buffer/#Sediment-Buffers","page":"Sediment Buffers","title":"Sediment Buffers","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"320pt\" height=\"221pt\"\n viewBox=\"0.00 0.00 320.00 221.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 217)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-217 316,-217 316,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M225,-213C225,-213 87,-213 87,-213 81,-213 75,-207 75,-201 75,-201 75,-146 75,-146 75,-140 81,-134 87,-134 87,-134 225,-134 225,-134 231,-134 237,-140 237,-146 237,-146 237,-201 237,-201 237,-207 231,-213 225,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"82,-182.5 230,-182.5 \"/>\n<text text-anchor=\"start\" x=\"132.5\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"82,-159.5 82,-182.5 129,-182.5 129,-159.5 82,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"82,-159.5 129,-159.5 129,-182.5 82,-182.5 \"/>\n<text text-anchor=\"start\" x=\"86\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"129,-159.5 129,-182.5 183,-182.5 183,-159.5 129,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"129,-159.5 129,-182.5 183,-182.5 183,-159.5 129,-159.5\"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"183,-159.5 183,-182.5 230,-182.5 230,-159.5 183,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"230,-182.5 183,-182.5 183,-159.5 230,-159.5 \"/>\n<text text-anchor=\"start\" x=\"187\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"129,-140.5 129,-159.5 \"/>\n<text text-anchor=\"start\" x=\"86\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"183,-140.5 183,-159.5 \"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"186\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- SedimentBuffer -->\n<g id=\"node2\" class=\"node\">\n<title>SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-98C300,-98 12,-98 12,-98 6,-98 0,-92 0,-86 0,-86 0,-12 0,-12 0,-6 6,0 12,0 12,0 300,0 300,0 306,0 312,-6 312,-12 312,-12 312,-86 312,-86 312,-92 306,-98 300,-98\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-68 305,-68 \"/>\n<text text-anchor=\"start\" x=\"93\" y=\"-76.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">SedimentBuffer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-45 7,-68 154,-68 154,-45 7,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-45 154,-45 154,-68 7,-68 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-45 154,-68 208,-68 208,-45 154,-45\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-45 154,-68 208,-68 208,-45 154,-45\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-45 208,-68 305,-68 305,-45 208,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-68 208,-68 208,-45 305,-45 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-26 154,-45 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer_size</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-26 208,-45 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">sediment_buffer</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-7 154,-26 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">depositional_resolution</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-7 208,-26 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;SedimentBuffer -->\n<g id=\"edge1\" class=\"edge\">\n<title>Boxes&#45;&gt;SedimentBuffer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M156,-133.74C156,-125.68 156,-117.01 156,-108.42\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"159.5,-108.42 156,-98.42 152.5,-108.42 159.5,-108.42\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"For our models of transport and denudation it is important to remember the facies of the sediment for some time into the past. One way to do this, is to remember all contributions of sediment in a stack. Every time we transport or erode sediment, we can pop parcels from this stack. In a three-dimensional model, we need a 2d grid of stacks. Each stack would have its own memory management (which is computationally expensive), and most resources are spent on areas with very little accretion. (In fact, this is what CarboCAT does. We believe this design choice is the main contributor to the difference in run-time between CarboCAT and CarboKitten).","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Instead, we choose a fixed size sediment buffer. Each cell in the buffer represents a parcel of sediment, where we store the relative fractions of each contributing facies. This buffer is only used to determine the facies of disintegrated sediment. The output of the overal model is still the amount of sediment for each iteration.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We can't stress this enough: any inaccuracy in using a fixed size buffer with a chosen granularity only impacts the precision of the composition of transported sediment. Even then, the schema is conservative: no sediment is lost unless erosion is so rampant that it eats through the entire sediment stack. In that case, a simulation should be run with a larger buffer.","category":"page"},{"location":"components/sediment_buffer/#Data-structure","page":"Sediment Buffers","title":"Data structure","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"While the sediment buffer is allocated as a single 4-dimensional array (depth, facies, x, y), it is best to explain its functioning from the perspective of a single cell in our model. We are left with two dimensions: depth (rows) and facies (columns).","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We choose to have the head of our sediment stack always be at the first row. When sediment out-grows the buffer, the deepenst layers are dropped from memory. The head can contain an incomplete amount of sediment, while all rows below the head are either full or empty. When sediment is pushed to the stack and the head row overflows, all rows are copied down one row and the surplus is assigned to the now empty head row. The inverse happens when removing (popping) material from the stack (in computer science stacks are pushed on and popped from). This process is illustrated below.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"(Image: sediment buffer diagram)","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Above we see a buffer. First we push a parcel of size 34, then we pop an amount of 12. This popped parcel will have different fractions from the pushed one, since it also draws from the half filled row that was in the stack before pushing. In this sense, a small amount of facies mixing will take place, depending on the depositional resolution chosen.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Our implementation is such that each cell in the buffer is contiguous in memory. Thus, copying rows of unstrided memory should be very efficient, although the performance remains to be tested.","category":"page"},{"location":"components/sediment_buffer/#Implementation","page":"Sediment Buffers","title":"Implementation","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We define two functions push_sediment! and pop_sediment!. Given a s times n matrix, where n is the number of facies types and s is the depth of the stack, we can grow and shrink sediment. These functions are unit-free, setting Delta z to be equal to 1.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">file:<i>test/SedimentStackSpec.jl</i></div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"@testset \"SedimentStack\" begin\n  using CarboKitten.SedimentStack: push_sediment!, pop_sediment!\n  stack = zeros(Float64, 10, 3)\n  @test pop_sediment!(stack, 0.0) == [0.0, 0.0, 0.0]\n  push_sediment!(stack, [5.0, 0, 0])\n  @test pop_sediment!(stack, 1.5) == [1.5, 0.0, 0.0]\n  push_sediment!(stack, [0.0, 2.0, 0.0])   # (0 0.5) (0 1) (0.5 0.5) (1 0) ...\n  @test pop_sediment!(stack, 2.0) == [0.25, 1.75, 0.0]\n  @test pop_sediment!(stack, 1.5) == [1.25, 0.25, 0.0]\n  @test pop_sediment!(stack, 0.0) == [0.0, 0.0, 0.0]\nend\n\n@testset \"SedimentArray\" begin\n  using CarboKitten.SedimentStack: push_sediment!, peek_sediment\n  sediment = zeros(Float64, 10, 3, 5, 5)\n  for x in 1:10\n    production = rand(3, 5, 5)\n    push_sediment!(sediment, production)\n  end\n  a = peek_sediment(sediment, 1.0)\n  @test all(sum(a; dims=1) .≈ 1.0)\nend","category":"page"},{"location":"components/sediment_buffer/#Pushing-sediment","page":"Sediment Buffers","title":"Pushing sediment","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"The single-cell version of push_sediment! takes as argument col a column (physically speaking a column of sediment) represented by a s times n-matrix and a parcel a n-vector.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡sediment-stack-impl⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"function push_sediment!(col::AbstractMatrix{F}, parcel::AbstractVector{F}) where F <: Real\n    @assert size(col, 2) == length(parcel) \"column $(size(col)) doesn't match parcel $(size(parcel))\"\n    <<push-sediment>>\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"First we check if the amount of sediment is larger than the buffer. A warning is printed and the entire buffer filled in the specified fractions.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"mass = sum(parcel)\nif mass == 0.0\n    return\nend\n\nif mass > size(col)[1]\n    @warn \"pushing a very large parcel of sediment: $mass times depositional resolution\"\n    frac = parcel ./ mass\n    col .= frac\n    return\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"First we determine the total sediment amount Delta, being the sum of the parcel, as well as the amount of sediment in our bucket, the head row.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"bucket = sum(col[1, :])\n@assert bucket >= 0.0 && bucket <= 1.0","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"If the bucket has enough space left for the parcel, we can just add the parcel to the bucket and return.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"if bucket + mass < 1.0\n    col[1,:] .+= parcel\n    return\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Otherwise, we compute the normalized fractions frac of facies in the parcel. We add as much sediment as we can to fill the bucket and copy rows down as far as needed.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"frac = parcel ./ mass\ncol[1,:] .+= frac .* (1.0 - bucket)\nmass -= (1.0 - bucket)\nn = floor(Int64, mass)\n\ncol[n+2:end,:] .= col[1:end-n-1,:]","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"If the parcel has enough material left to fill more rows, those are all filled with the fractions in frac. The head row is assigned whatever is left.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡push-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"na = [CartesianIndex()]\ncol[2:n+1,:] .= frac[na,:]\nmass -= n\ncol[1,:] .= frac .* mass","category":"page"},{"location":"components/sediment_buffer/#Popping-sediment","page":"Sediment Buffers","title":"Popping sediment","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Similar to push_sediment! we have pop_sediment!. We give pop_sediment! the sedimentary column col and the total amount of sediment we require. There is a bit that we will reuse called pop_fraction, which only works if the amount of popped sediment is lower than the contents of the bucket.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡sediment-stack-impl⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"@inline function pop_fraction(col::AbstractMatrix{F}, mass::F) where F <: Real\n    bucket = sum(col[1,:])\n    if mass == 0 || bucket == 0\n        return zeros(F, size(col)[2])\n    end\n\n    @assert mass < bucket \"pop_fraction can only pop from the top cell: $(col), $(Δ)\"\n    parcel = (mass / bucket) .* col[1,:]\n    col[1,:] .-= parcel\n    return parcel\nend\n\nfunction pop_sediment!(col::AbstractMatrix{F}, Δ::F) where F <: Real  # -> Vector{F}\n    <<pop-sediment>>\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"We start by computing the bucket size again. If it is greater than the required amount, we call pop_fraction.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡pop-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"bucket = sum(col[1,:])\n@assert bucket >= 0.0\n\nif Δ < bucket\n  return pop_fraction(col, Δ)\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Otherwise, we start a parcel with the contents of the bucket. Add to that the remaining material in rows below. Now we copy rows from below, setting the bottom n rows to 0. The last step is to call pop_fraction one more time with the remaining required amount.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">⪡pop-sediment⪢≣</div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"parcel = copy(col[1,:])\nΔ -= bucket\nn = floor(Int64, Δ)\n\nif n > (size(col)[1] - 2)\n    @error \"too much material popped of the stack: Δ = $Δ\"\n    parcel .+= sum(col; dims=1)'\n    col .= 0.0\n    return parcel\nend\n\nparcel .+= sum(col[2:n+1,:]; dims=1)'\ncol[1:end-n-1, :] = col[n+2:end, :]\ncol[end-n-1:end, :] .= 0\nΔ -= n\n\nparcel .+= pop_fraction(col, Δ)\nreturn parcel","category":"page"},{"location":"components/sediment_buffer/#Peeking","page":"Sediment Buffers","title":"Peeking","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"Instead of popping sediment, we can also peek at the stack with peek_sediment!, which is a non-destructive way to inspect what the returned parcel would be if we were to call pop_sediment! with the same arguments.","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<details><summary>SedimentStack impl</summary>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">file:<i>src/SedimentStack.jl</i></div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"module SedimentStack\n\nexport push_sediment!, pop_sediment!, peek_sediment\n\n<<sediment-stack-impl>>\n\nfunction push_sediment!(sediment::AbstractArray{F, 4}, p::AbstractArray{F, 3}) where F <: Real\n  _, x, y = size(p)\n  @assert size(sediment, 2) == size(p, 1) \"shapes for sediment $(size(sediment)) doesn't match p $(size(p))\"\n  @views for i in CartesianIndices((x, y))\n    push_sediment!(sediment[:, :, i[1], i[2]], p[:, i[1], i[2]])\n  end\nend\n\nfunction peek_sediment(col::AbstractMatrix{F}, Δ::F) where F <: Real  # -> Vector{F}\n  if Δ == 0\n      return zeros(F, size(col)[2])\n  end\n\n  bucket = sum(col[1,:])\n  if Δ < bucket\n    parcel = (Δ / bucket) .* col[1,:]\n    return parcel\n  end\n\n  parcel = copy(col[1,:])\n  Δ -= bucket\n  n = floor(Int64, Δ)\n\n  parcel .+= sum(col[2:n+1,:]; dims=1)'\n  Δ -= n\n\n  last_bit = (Δ / sum(col[n+2,:])) .* col[n+2,:]\n  parcel .+= last_bit\n\n  return parcel\nend\n\nfunction peek_sediment(sediment::AbstractArray{F,4}, Δ::F) where F <: Real\n  _, f, x, y = size(sediment)\n  out = Array{F, 3}(undef, f, x, y)\n  for i in CartesianIndices((x, y))\n    out[:, i[1], i[2]] = peek_sediment(@view(sediment[:, :, i[1], i[2]]), Δ)\n  end\n  return out\nend\n\nfunction pop_sediment!(cols::AbstractArray{F, 4}, amount::AbstractArray{F, 2}, out::AbstractArray{F, 3}) where F <: Real\n  @views for i in CartesianIndices(amount)\n      out[:, i[1], i[2]] = pop_sediment!(cols[:, :, i[1], i[2]], amount[i[1], i[2]])\n  end\nend\n\nend # module","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"</details>","category":"page"},{"location":"components/sediment_buffer/#Component","page":"Sediment Buffers","title":"Component","text":"","category":"section"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"<div class=\"noweb-label\">file:<i>src/Components/SedimentBuffer.jl</i></div>","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"@compose module SedimentBuffer\n@mixin Boxes\n\nusing ..Common\nusing CarboKitten.SedimentStack: pop_sediment!, push_sediment!, peek_sediment\n\nexport pop_sediment!, push_sediment!, peek_sediment\n\n@kwdef struct Input <: AbstractInput\n    sediment_buffer_size::Int = 50\n    depositional_resolution::Amount = 0.5u\"m\"\nend\n\n@kwdef mutable struct State <: AbstractState\n    sediment_buffer::Array{Float64,4}\nend\n\nend","category":"page"},{"location":"components/sediment_buffer/","page":"Sediment Buffers","title":"Sediment Buffers","text":"","category":"page"},{"location":"components/hdf5/#HDF5-Output","page":"HDF5 Writer","title":"HDF5 Output","text":"","category":"section"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"500pt\" height=\"355pt\"\n viewBox=\"0.00 0.00 500.00 355.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 351)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-351 496,-351 496,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-347C150,-347 12,-347 12,-347 6,-347 0,-341 0,-335 0,-335 0,-280 0,-280 0,-274 6,-268 12,-268 12,-268 150,-268 150,-268 156,-268 162,-274 162,-280 162,-280 162,-335 162,-335 162,-341 156,-347 150,-347\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-316.5 155,-316.5 \"/>\n<text text-anchor=\"start\" x=\"57.5\" y=\"-325.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-293.5 7,-316.5 54,-316.5 54,-293.5 7,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-293.5 54,-293.5 54,-316.5 7,-316.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-293.5 54,-316.5 108,-316.5 108,-293.5 54,-293.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-293.5 54,-316.5 108,-316.5 108,-293.5 54,-293.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-293.5 108,-316.5 155,-316.5 155,-293.5 108,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-316.5 108,-316.5 108,-293.5 155,-293.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-274.5 54,-293.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-274.5 108,-293.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth -->\n<g id=\"node3\" class=\"node\">\n<title>WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M300,-232C300,-232 42,-232 42,-232 36,-232 30,-226 30,-220 30,-220 30,-127 30,-127 30,-121 36,-115 42,-115 42,-115 300,-115 300,-115 306,-115 312,-121 312,-127 312,-127 312,-220 312,-220 312,-226 306,-232 300,-232\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-201.5 305,-201.5 \"/>\n<text text-anchor=\"start\" x=\"123.5\" y=\"-210.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">WaterDepth</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"37,-178.5 37,-201.5 154,-201.5 154,-178.5 37,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"37,-178.5 154,-178.5 154,-201.5 37,-201.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"154,-178.5 154,-201.5 208,-201.5 208,-178.5 154,-178.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"154,-178.5 154,-201.5 208,-201.5 208,-178.5 154,-178.5\"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"208,-178.5 208,-201.5 305,-201.5 305,-178.5 208,-178.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"305,-201.5 208,-201.5 208,-178.5 305,-178.5 \"/>\n<text text-anchor=\"start\" x=\"212\" y=\"-186.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-159.5 154,-178.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">sea_level</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-159.5 208,-178.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-166.5\" font-family=\"monospace\" font-size=\"10.00\">sediment_height</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-140.5 154,-159.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">initial_topography</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-140.5 208,-159.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<polyline fill=\"none\" stroke=\"black\" points=\"154,-121.5 154,-140.5 \"/>\n<text text-anchor=\"start\" x=\"41\" y=\"-128.5\" font-family=\"monospace\" font-size=\"10.00\">subsidence_rate</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"208,-121.5 208,-140.5 \"/>\n<text text-anchor=\"start\" x=\"158\" y=\"-128.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"211\" y=\"-128.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- Boxes&#45;&gt;WaterDepth -->\n<g id=\"edge2\" class=\"edge\">\n<title>Boxes&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M107.27,-267.97C113.07,-259.46 119.38,-250.21 125.69,-240.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"128.73,-242.7 131.48,-232.47 122.95,-238.76 128.73,-242.7\"/>\n</g>\n<!-- TimeIntegration -->\n<g id=\"node2\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-347C330,-347 192,-347 192,-347 186,-347 180,-341 180,-335 180,-335 180,-280 180,-280 180,-274 186,-268 192,-268 192,-268 330,-268 330,-268 336,-268 342,-274 342,-280 342,-280 342,-335 342,-335 342,-341 336,-347 330,-347\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-316.5 335,-316.5 \"/>\n<text text-anchor=\"start\" x=\"195.5\" y=\"-325.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-293.5 187,-316.5 234,-316.5 234,-293.5 187,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-293.5 234,-293.5 234,-316.5 187,-316.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-293.5 234,-316.5 288,-316.5 288,-293.5 234,-293.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-293.5 234,-316.5 288,-316.5 288,-293.5 234,-293.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-293.5 288,-316.5 335,-316.5 335,-293.5 288,-293.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-316.5 288,-316.5 288,-293.5 335,-293.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-301.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-274.5 234,-293.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-274.5 288,-293.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-281.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n<!-- TimeIntegration&#45;&gt;WaterDepth -->\n<g id=\"edge1\" class=\"edge\">\n<title>TimeIntegration&#45;&gt;WaterDepth</title>\n<path fill=\"none\" stroke=\"black\" d=\"M234.73,-267.97C228.93,-259.46 222.62,-250.21 216.31,-240.95\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"219.05,-238.76 210.52,-232.47 213.27,-242.7 219.05,-238.76\"/>\n</g>\n<!-- H5Writer -->\n<g id=\"node5\" class=\"node\">\n<title>H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M360,-79C360,-79 222,-79 222,-79 216,-79 210,-73 210,-67 210,-67 210,-12 210,-12 210,-6 216,0 222,0 222,0 360,0 360,0 366,0 372,-6 372,-12 372,-12 372,-67 372,-67 372,-73 366,-79 360,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"217,-48.5 365,-48.5 \"/>\n<text text-anchor=\"start\" x=\"253.5\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">H5Writer</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"217,-25.5 217,-48.5 264,-48.5 264,-25.5 217,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"217,-25.5 264,-25.5 264,-48.5 217,-48.5 \"/>\n<text text-anchor=\"start\" x=\"221\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"264,-25.5 264,-48.5 318,-48.5 318,-25.5 264,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"264,-25.5 264,-48.5 318,-48.5 318,-25.5 264,-25.5\"/>\n<text text-anchor=\"start\" x=\"268\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"318,-25.5 318,-48.5 365,-48.5 365,-25.5 318,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"365,-48.5 318,-48.5 318,-25.5 365,-25.5 \"/>\n<text text-anchor=\"start\" x=\"322\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"264,-6.5 264,-25.5 \"/>\n<text text-anchor=\"start\" x=\"221\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">output</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"318,-6.5 318,-25.5 \"/>\n<text text-anchor=\"start\" x=\"268\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"321\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- WaterDepth&#45;&gt;H5Writer -->\n<g id=\"edge4\" class=\"edge\">\n<title>WaterDepth&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M223.28,-114.99C231.87,-105.54 240.67,-95.86 248.97,-86.74\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"251.66,-88.97 255.8,-79.22 246.48,-84.27 251.66,-88.97\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node4\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M480,-213C480,-213 342,-213 342,-213 336,-213 330,-207 330,-201 330,-201 330,-146 330,-146 330,-140 336,-134 342,-134 342,-134 480,-134 480,-134 486,-134 492,-140 492,-146 492,-146 492,-201 492,-201 492,-207 486,-213 480,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-182.5 485,-182.5 \"/>\n<text text-anchor=\"start\" x=\"367\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"337,-159.5 337,-182.5 384,-182.5 384,-159.5 337,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"337,-159.5 384,-159.5 384,-182.5 337,-182.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"384,-159.5 384,-182.5 438,-182.5 438,-159.5 384,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"384,-159.5 384,-182.5 438,-182.5 438,-159.5 384,-159.5\"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"438,-159.5 438,-182.5 485,-182.5 485,-159.5 438,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"485,-182.5 438,-182.5 438,-159.5 485,-159.5 \"/>\n<text text-anchor=\"start\" x=\"442\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"384,-140.5 384,-159.5 \"/>\n<text text-anchor=\"start\" x=\"341\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"438,-140.5 438,-159.5 \"/>\n<text text-anchor=\"start\" x=\"388\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"441\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;H5Writer -->\n<g id=\"edge3\" class=\"edge\">\n<title>FaciesBase&#45;&gt;H5Writer</title>\n<path fill=\"none\" stroke=\"black\" d=\"M375.97,-133.97C362.53,-119.19 347.06,-102.17 333.04,-86.74\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"335.6,-84.36 326.28,-79.31 330.42,-89.06 335.6,-84.36\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"We write output to HDF5. In the Input struct the user can specify a dictionary of OutputSpec, specifying how much and at which interval to write output. Typically, you'd want a full topographic output with lower time resolution, and choose a transect with full time resolution. For example, on the ALCAP model:","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"const INPUT = ALCAP.Input(\n    box = Box{Coast}(grid_size = (300, 150), phys_scale = 50.0u\"m\"),\n    time = TimeProperties(Δt = 50.0u\"yr\", steps = 20_000),\n    output = Dict(\n        :topography => OutputSpec(write_interval = 200),\n        :profile => OutputSpec(slice = (:, 75))),\n\n    ...)  # add more options","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"Saving the full output of this simulation would take several hundreds of gigabytes, not gargantuan, but a bit unwieldy if you want to save many simulation runs. With this output specification, we cut down on this significantly.","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"<div class=\"noweb-label\">⪡hdf5-output-spec⪢≣</div>","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"@kwdef struct Input <: AbstractInput\n    output = Dict(:full => OutputSpec((:,:), 1)) \nend","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"The default is to write all output, which is fine for smaller runs. The slice argument of OutputSpec will accept three different forms:","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"(:, :) (default) output the full area of the model.\n(<n>, :) or (:, <n>) output a slice of the model, either with a fixed x or a fixed y coordinate. In our examples we always have the x axis orthogonal to the shoreline, so slicing with a fixed y (the second form) is what we use.\n(<m>, <n>), output a column of the model. If you have a very precise experiment workflow, this could be of use. You'll have to specify each column as a separate output. Most of the time though, we can extract columns from slice data in a post-processing stage, so if all your columns have the same y coordinate, taking a slice is the preferred option.","category":"page"},{"location":"components/hdf5/#Main-loop","page":"HDF5 Writer","title":"Main loop","text":"","category":"section"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"The H5Writer component runs through an overloaded version of run_model. For example:","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"run_model(Model{ALCAP}, ALCAP.Example.INPUT, \"example.h5\")","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"<div class=\"noweb-label\">⪡hdf5-run-model⪢≣</div>","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"\"\"\"\n    run_model(::Type{Model{M}}, input::AbstractInput, filename::AbstractString) where M\n\nRun a model and write output to HDF5. Here `M` should be a model, i.e. a\nmodule with `initial_state`, `step!` and `write_header` defined. Example:\n\n    run_model(Model{ALCAP}, ALCAP.Example.INPUT, \"example.h5\")\n\"\"\"\nfunction run_model(::Type{Model{M}}, input::AbstractInput, filename::AbstractString) where M        \n    state = M.initial_state(input)\n\n    h5open(filename, \"w\") do fid\n        create_group(fid, \"input\")\n        M.write_header(fid, input)\n\n        # create a group for every output item\n        for (k, v) in input.output\n            create_ck_group(fid, input, k, v)\n        end\n        write_state(fid, input, 1, state)\n\n        run_model(Model{M}, input, state) do w, df\n            # write_frame chooses to advance in a dataset\n            # or just to increment on the current frame\n            write_frame(fid, input, w, df)\n            # write_state only writes one in every write_interval\n            # and does no accumulation\n            write_state(fid, input, w+1, state)\n        end\n    end\n\n    return filename\nend","category":"page"},{"location":"components/hdf5/#Implementation","page":"HDF5 Writer","title":"Implementation","text":"","category":"section"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"<div class=\"noweb-label\">file:<i>src/Components/H5Writer.jl</i></div>","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"@compose module H5Writer\n    using ..Common\n    import ..Models: Frame\n\n    using HDF5\n\n    import ...CarboKitten: run_model, Model\n    import ...OutputData: AbstractOutputSpec\n\n    @mixin Boxes, TimeIntegration, FaciesBase, WaterDepth\n\n    <<hdf5-output-spec>>\n\n\taxis_size(::Colon, a::Int) = a\n\taxis_size(::Int, _) = 1\n\taxis_size(r::AbstractRange{Int}, _) = length(r)\n\n\tslice_str(::Colon) = \":\"\n\tslice_str(r::AbstractRange{Int}) = \"$(r.start):$(r.stop)\"\n\tslice_str(i::Int) = \"$(i)\"\n\n    is_column(::Int, ::Int) = true\n    is_column(_, _) = false\n\n    function create_ck_group(fid, input::AbstractInput, name::Symbol, spec::AbstractOutputSpec)\n        nf = n_facies(input)\n        nw = div(input.time.steps, spec.write_interval)\n\n        size = axis_size.(spec.slice, input.box.grid_size)\n\n        grp = HDF5.create_group(fid, string(name))\n        attrs = attributes(grp)\n\t\tattrs[\"slice\"] = join(slice_str.(spec.slice),\",\")\n        attrs[\"write_interval\"] = spec.write_interval\n\n        HDF5.create_dataset(grp, \"production\", datatype(Float64),\n            dataspace(nf, size..., nw),\n            chunk=(nf, size..., 1), deflate=3)\t\n        HDF5.create_dataset(grp, \"disintegration\", datatype(Float64),\n            dataspace(nf, size..., nw),\n            chunk=(nf, size..., 1), deflate=3)\n        HDF5.create_dataset(grp, \"deposition\", datatype(Float64),\n            dataspace(nf, size..., nw),\n            chunk=(nf, size..., 1), deflate=3)\n        HDF5.create_dataset(grp, \"sediment_thickness\", datatype(Float64),\n            dataspace(size..., nw + 1),\n            chunk=(size..., 1), deflate=3)\n    end\n\n    function write_state(fid, input::AbstractInput, idx::Int, state::AbstractState)\n        for (k, v) in input.output\n\t\t\tsize = axis_size.(v.slice, input.box.grid_size)\n            if mod(idx-1, v.write_interval) == 0\n                fid[string(k)][\"sediment_thickness\"][:, :, div(idx-1, v.write_interval)+1] = \n                    (is_column(v.slice...) ?\n                        Float64[state.sediment_height[v.slice...] |> in_units_of(u\"m\");] :\n                        reshape(state.sediment_height[v.slice...], size) |> in_units_of(u\"m\"))\n            end\n        end\n    end\n\n    function write_frame(fid, input::AbstractInput, idx::Int, frame::Frame)\n        try_write(tgt, ::Nothing, v) = ()\n\t\tn_f = n_facies(input)\n        function try_write(tgt, src::AbstractArray, v)\n\t\t\tsize = axis_size.(v.slice, input.box.grid_size)\n            tgt[:, :, :, div(idx-1, v.write_interval) + 1] += \n\t\t\t\t(reshape(src[:, v.slice...], (n_f, size...)) |> in_units_of(u\"m\"))\n        end\n\n        for (k, v) in input.output\n            grp = fid[string(k)]\n            try_write(grp[\"production\"], frame.production, v)\n            try_write(grp[\"disintegration\"], frame.disintegration, v)\n            try_write(grp[\"deposition\"], frame.deposition, v)\n        end\n    end\n\n    <<hdf5-run-model>>\nend","category":"page"},{"location":"components/hdf5/","page":"HDF5 Writer","title":"HDF5 Writer","text":"","category":"page"},{"location":"models/without-ca/#Model-without-CA","page":"Model without CA","title":"Model without CA","text":"","category":"section"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"The following model is similar to the ALCAP model, with the exception that production is not managed by the cellular automaton, rather each facies produces in all grid cells according to their own production curves.","category":"page"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"<div class=\"noweb-label\">file:<i>src/Models/WithoutCA.jl</i></div>","category":"page"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"@compose module WithoutCA\n@mixin Tag, H5Writer, Production, ActiveLayer\n\nusing ..Common\nusing ..Production: uniform_production\nusing ..TimeIntegration\nusing ..WaterDepth\nusing ModuleMixins: @for_each\n\nexport Input, Facies\n\nfunction initial_state(input::Input)\n    sediment_height = zeros(Height, input.box.grid_size...)\n    sediment_buffer = zeros(Float64, input.sediment_buffer_size, n_facies(input), input.box.grid_size...)\n    active_layer = zeros(Amount, n_facies(input), input.box.grid_size...)\n    return State(step=0, sediment_height=sediment_height, sediment_buffer=sediment_buffer, active_layer=active_layer)\nend\n\nfunction step!(input::Input)\n    disintegrate! = ActiveLayer.disintegrator(input)\n    transport! = ActiveLayer.transporter(input)\n    produce = uniform_production(input)\n    dt = input.time.Δt\n    local_water_depth = water_depth(input)\n    na = [CartesianIndex()]\n    pf = cementation_factor(input)\n\n    function (state::State)\n        wd = local_water_depth(state)\n        p = produce(state, wd)\n        d = disintegrate!(state)\n\n        state.active_layer .+= p\n        state.active_layer .+= d\n        transport!(state)\n\n        deposit = pf .* state.active_layer\n        push_sediment!(state.sediment_buffer, deposit ./ input.depositional_resolution .|> NoUnits)\n        state.active_layer .-= deposit\n        state.sediment_height .+= sum(deposit; dims=1)[1,:,:]\n        state.step += 1\n\n        return Frame(\n            production = p,\n            disintegration = d,\n            deposition = deposit)\n    end\nend\n\nfunction write_header(fid, input::AbstractInput)\n    @for_each(P -> P.write_header(fid, input), PARENTS)\nend\n\nend","category":"page"},{"location":"models/without-ca/","page":"Model without CA","title":"Model without CA","text":"","category":"page"},{"location":"components/time/#Time","page":"Time","title":"Time","text":"","category":"section"},{"location":"components/time/","page":"Time","title":"Time","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"170pt\" height=\"87pt\"\n viewBox=\"0.00 0.00 170.00 87.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 83)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-83 166,-83 166,4 -4,4\"/>\n<!-- TimeIntegration -->\n<g id=\"node1\" class=\"node\">\n<title>TimeIntegration</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-79C150,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-12 0,-12 0,-6 6,0 12,0 12,0 150,0 150,0 156,0 162,-6 162,-12 162,-12 162,-67 162,-67 162,-73 156,-79 150,-79\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-48.5 155,-48.5 \"/>\n<text text-anchor=\"start\" x=\"15.5\" y=\"-57.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">TimeIntegration</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-25.5 7,-48.5 54,-48.5 54,-25.5 7,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-25.5 54,-25.5 54,-48.5 7,-48.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-25.5 54,-48.5 108,-48.5 108,-25.5 54,-25.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-25.5 108,-48.5 155,-48.5 155,-25.5 108,-25.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-48.5 108,-48.5 108,-25.5 155,-25.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-33.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-6.5 54,-25.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">time</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-6.5 108,-25.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-13.5\" font-family=\"monospace\" font-size=\"10.00\">step</text>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"CarboKitten.Components.TimeIntegration.time","category":"page"},{"location":"components/time/#CarboKitten.Components.TimeIntegration.time","page":"Time","title":"CarboKitten.Components.TimeIntegration.time","text":"time(input, state)\n\nReturn the time given input and state.\n\n\n\n\n\n","category":"function"},{"location":"components/time/","page":"Time","title":"Time","text":"<div class=\"noweb-label\">file:<i>test/Components/TimeIntegrationSpec.jl</i></div>","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"module TimeIntegrationSpec\nusing Test\nusing CarboKitten.Components.Common\n\n@testset \"Components/TimeIntegration\" begin\n    using CarboKitten.Components.TimeIntegration: write_times, Input, State, time, n_writes\n\n    let input = Input(time=TimeProperties(\n        Δt = 0.2u\"Myr\", steps = 5))\n      @test write_times(input) |> collect == [0.0, 0.2, 0.4, 0.6, 0.8, 1.0] .* u\"Myr\"\n      @test time(input, State(4)) == 0.8u\"Myr\"\n      @test n_writes(input) == 5\n    end\n\n    let input = Input(time=TimeProperties(\n        Δt = 0.02u\"Myr\", steps = 50, t0 = -1.0u\"Myr\"))\n      @test n_writes(input) == 50\n      @test time(input, State(25)) == -0.5u\"Myr\"\n    end\nend\nend","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"<div class=\"noweb-label\">file:<i>src/Components/TimeIntegration.jl</i></div>","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"@compose module TimeIntegration\nusing ..Common\nimport ...CarboKitten: time_axis, n_writes\n\nusing HDF5\nexport time, n_writes, time_axis\n\n@kwdef struct Input <: AbstractInput\n    time::TimeProperties\nend\n\n@kwdef mutable struct State <: AbstractState\n    step::Int\nend\n\nState(_::AbstractInput) = State(0)\n\n\"\"\"\n    time(input, state)\n\nReturn the time given input and state.\n\"\"\"\ntime(input::AbstractInput, state::AbstractState) = input.time.t0 + state.step * input.time.Δt\ntime(tprop::TimeProperties, state::AbstractState) = tprop.t0 + state.step * tprop.Δt\ntime(input::AbstractInput) = let t0 = input.time.t0, dt = input.time.Δt\n    s -> t0 + s.step * dt\nend\n\nwrite_times(input::AbstractInput) = write_times(input.time)\nwrite_times(time::TimeProperties) = (0:n_writes(time)) .* time.Δt .+ time.t0\n\ntime_axis(input::AbstractInput) = time_axis(input.time)\nn_writes(input::AbstractInput) = n_writes(input.time)\n\nfunction write_header(fid, input::AbstractInput)\n    gid = fid[\"input\"]\n    attr = attributes(gid)\n\n    gid[\"t\"] = write_times(input) .|> in_units_of(u\"Myr\")\n    attr[\"t0\"] = input.time.t0 |> in_units_of(u\"Myr\")\n    attr[\"delta_t\"] = input.time.Δt |> in_units_of(u\"Myr\")\n    attr[\"time_steps\"] = input.time.steps\nend\n\nend","category":"page"},{"location":"components/time/","page":"Time","title":"Time","text":"","category":"page"},{"location":"#CarboKitten.jl:-Modeling-Carbonate-Platforms-in-Julia","page":"Introduction","title":"CarboKitten.jl: Modeling Carbonate Platforms in Julia","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"(Image: Entangled badge)","category":"page"},{"location":"#About","page":"Introduction","title":"About","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"CarboKitten is a reimplementation of Peter Burgess' CarboCAT, a model for generating carbonate platform stratigraphies. CarboKitten is a three-dimensional model, having two spatial dimensions and one for stored stediment.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Features:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Cellular Automata to regulate facies type\nAdvection-diffusion based sediment transport","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"(Image: Sample output stratigraphy)","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"CarboKitten is written in Julia for performance and extensibility.","category":"page"},{"location":"#Julia-Quickstarter","page":"Introduction","title":"Julia Quickstarter","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"This code is written in Julia. You may want to check out the following references:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Julia Documentation\nTutorial on Julia for Science and Engineering","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"There are several ways to work with Julia that may be a bit different from what you're used to, if that is Matlab, Python or R.","category":"page"},{"location":"#Installing-Julia","page":"Introduction","title":"Installing Julia","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"The best way to install Julia is to use juliaup at github.com/JuliaLang/juliaup.","category":"page"},{"location":"#REPL","page":"Introduction","title":"REPL","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"The most basic way to work in Julia, is to start the REPL (Read Eval Print Loop).","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"$ julia\n               _\n   _       _ _(_)_     |  Documentation: https://docs.julialang.org\n  (_)     | (_) (_)    |\n   _ _   _| |_  __ _   |  Type \"?\" for help, \"]?\" for Pkg help.\n  | | | | | | |/ _` |  |\n  | | |_| | | | (_| |  |  Version 1.9.3 (2023-08-24)\n _/ |\\__'_|_|_|\\__'_|  |  Official https://julialang.org/ release\n|__/                   |\n\njulia>","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"From here you may use CarboKitten using CarboKitten and run any of the code inside. To work with CarboKitten efficiently, you may want to load Revise. Revise auto-detects changes to loaded code and makes it easy to rerun.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Running CarboKitten will require to load other dependencies, so please consult the documentation on Julia packages to learn how.","category":"page"},{"location":"#VS-Code","page":"Introduction","title":"VS Code","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"VSCode has very good support for working with Julia. Install the official Julia plugin and you should be good to go. Explore options by pressing Ctrl+Shift+P and type Julia to see what you can do. For example: start a REPL, run current script etc.","category":"page"},{"location":"#Jupyter","page":"Introduction","title":"Jupyter","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"You can run Julia code from Jupyter if you install the Julia kernel. Press ] in the REPL to get into Pkg-mode, the prompt will change","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"(CarboKitten) pkg>","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"You may install the IJulia kernel with add IJulia.","category":"page"},{"location":"#Pluto","page":"Introduction","title":"Pluto","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"An alternative (and in our opinion superior) notebook interface is called Pluto.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Pluto is reactive: changes to code cells automatically update downstream dependencies.\nPluto notebooks are written to regular Julia files and can (though maybe shouldn't) be run independent from Pluto.\nThe user interface of Pluto is slightly less mature than Jupyter","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"In Pkg-mode say add Pluto.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"julia> using Pluto\n\njulia> Pluto.run()\n[ Info: Loading...\n┌ Info:\n└ Opening http://localhost:1234/?secret=xyzxyzzy in your default browser... ~ have fun!\n┌ Info:\n│ Press Ctrl+C in this terminal to stop Pluto\n└","category":"page"},{"location":"#Plotting","page":"Introduction","title":"Plotting","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"CarboKitten ships with several routines for visualizing model output. These routines use the Makie.jl package. Makie has three back-ends: CairoMakie, GLMakie and WGLMakie. These are all written in Julia, but they focus on different kinds of results. CairoMakie is relatively slow but results in publication quality vector graphics: SVG or PDF. GLMakie is very fast, renders on your graphics card, but only produces raster images, say PNG. Then WGLMakie does a similar thing, but through the web-browser.","category":"page"},{"location":"#Design-style","page":"Introduction","title":"Design style","text":"","category":"section"},{"location":"#Input-structures","page":"Introduction","title":"Input structures","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Input datastructures are always @kwdef. This makes it easier to understand and modify simulation scripts.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Different components of CarboKitten can work a variety of input types, as long as their expected data members are present. TODO: systematically document type requirements for each component.","category":"page"},{"location":"#Output-data","page":"Introduction","title":"Output data","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"All output is written to HDF5 files. Optionally, you may export parts of the output data to CSV files for further analysis.","category":"page"},{"location":"#Partial-functions","page":"Introduction","title":"Partial functions","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Most of the model code is written in the following particular pattern:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"function component(input)\n    prepare(input)\n\n    return function(state)\n        iterate!(state)\n    end\nend","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"In this case the prepare() statement is run once at the beginning of a model run, while the iterate!(state) statement, possibly modifying the state variable, is being run every iteration.","category":"page"},{"location":"#Entangled","page":"Introduction","title":"Entangled","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"If you plan to make a contribution to the core of CarboKitten, you should be aware of Entangled.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"The documentation for CarboKitten is using Entangled for Literate Programming. This means that code blocks in the documentation contribute to the actual functioning code in the library. When you develop the library code, you should have the Entangled daemon running to keep the documentation synchronized. Included in the CarboKitten repository is a pyproject.toml that manages the Entangled installation for you through Poetry; alternatively, you may install Entangled through pip install entangled-cli.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"To install, run poetry install in the project root, then:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"poetry run entangled watch","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Entangled is still under development and it may occur that the daemon complains about not knowing wether to tangle or stitch, for example when you've accidentally written both markdown and source code. If this happens you may manually entangled tangle or entangled stitch with the --force argument to decide the issue. It may be worth saving your work in version control before doing so.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"A somewhat frequent occurence is that you forgot to run entangled watch while developing. In this case, commit the work you have done to git, then run entangled tangle or entangled stitch (whichever applies). Your files are now back in their old state, but you can git restore the edits you have made and run entangled sync again to propagate the changes. The project should be in a good state again.","category":"page"},{"location":"#Building-Documentation","page":"Introduction","title":"Building Documentation","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"To recreate the plots in the documentation run","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"poetry run brei figures","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"The documentation can be rendered with Documenter.jl.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"julia --workenv=docs docs/make.jl","category":"page"},{"location":"#Project-structure","page":"Introduction","title":"Project structure","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":".\n├── data                # data files\n├── docs                # documentation\n│   ├── make.jl         # docs build script\n│   ├── Manifest.toml   #\n│   ├── Project.toml    # dependencies for building docs\n│   └── src             # markdown source for docs\n├── entangled.toml      # entangled config\n├── examples            # example scripts\n├── Makefile            # command-line short hands\n├── Manifest.toml       #\n├── Project.toml        # project dependencies\n├── pyproject.toml      # dependencies for running Entangled\n├── README.md           #\n├── src                 # tangled library source\n└── test                # unit tests","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"The figures from the documentation in \"docs/src/fig\" are git tracked, but are often regenerated when you change some of their direct dependencies. This makes switching branches harder, it would require issuing \"git stash\" first. We have made sure that the regenerated figures appear in docs/src/_fig and are not git tracked. There is a task in pyproject.toml that takes care of copying from docs/src/_fig to docs/src/fig when this repo is cloned:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"poetry run brei copy_figures","category":"page"},{"location":"#Authors","page":"Introduction","title":"Authors","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Lead engineer: Johan Hidding Netherlands eScience Center email: j.hidding [at] esciencecenter.nl Web page: www.esciencecenter.nl/team/johan-hidding-msc/ ORCID: 0000-0002-7550-1796","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Denudation modelling: Xianyi Liu Utrecht University email: x.liu6 [at] uu.nl Web page: www.uu.nl/staff/XLiu6 ORCID:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Original CarboCAT author: Peter Burgess University of Liverpool Web page: www.liverpool.ac.uk/environmental-sciences/staff/peter-burgess","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Project lead: Emilia Jarochowska Utrecht University email: e.b.jarochowska [at] uu.nl Web page: www.uu.nl/staff/EBJarochowska ORCID: 0000-0001-8937-9405","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Other team members:","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Niklas Hohmann Utrecht University email: n.h.hohmann [at] uu.nl Web page: www.uu.nl/staff/NHohmann ORCID: 0000-0003-1559-1838","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"Hanno Spreeuw Netherlands eScience Center email: h.spreeuw [at] esciencecenter.nl Web page: www.esciencecenter.nl/team/dr-hanno-spreeuw/ ORCID: 0000-0002-5057-0322","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"David De Vleeschouwer Westfälische Wilhelms-Universität Münster Web page: www.uni-muenster.de/GeoPalaeontologie/erdsystemforschung/staff/DeVleeschouwer ORCID: 0000-0002-3323-807X","category":"page"},{"location":"#Copyright","page":"Introduction","title":"Copyright","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Copyright 2023 Netherlands eScience Center and Utrecht University","category":"page"},{"location":"#License","page":"Introduction","title":"License","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see https://www.gnu.org/licenses/.","category":"page"},{"location":"#Funding-information","page":"Introduction","title":"Funding information","text":"","category":"section"},{"location":"","page":"Introduction","title":"Introduction","text":"Funded by the European Union (ERC, MindTheGap, StG project no 101041077). Views and opinions expressed are however those of the author(s) only and do not necessarily reflect those of the European Union or the European Research Council. Neither the European Union nor the granting authority can be held responsible for them.","category":"page"},{"location":"","page":"Introduction","title":"Introduction","text":"","category":"page"},{"location":"components/cellular-automata/#Cellular-Automata","page":"Cellular Automata","title":"Cellular Automata","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"component-dag\" style=\"overflow: scroll\"><?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\"\n \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\">\n<!-- Generated by graphviz version 2.50.0 (20211204.2007)\n -->\n<!-- Pages: 1 -->\n<svg width=\"350pt\" height=\"221pt\"\n viewBox=\"0.00 0.00 350.00 221.00\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\">\n<g id=\"graph0\" class=\"graph\" transform=\"scale(1 1) rotate(0) translate(4 217)\">\n<polygon fill=\"white\" stroke=\"transparent\" points=\"-4,4 -4,-217 346,-217 346,4 -4,4\"/>\n<!-- Boxes -->\n<g id=\"node1\" class=\"node\">\n<title>Boxes</title>\n<path fill=\"none\" stroke=\"black\" d=\"M150,-213C150,-213 12,-213 12,-213 6,-213 0,-207 0,-201 0,-201 0,-146 0,-146 0,-140 6,-134 12,-134 12,-134 150,-134 150,-134 156,-134 162,-140 162,-146 162,-146 162,-201 162,-201 162,-207 156,-213 150,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-182.5 155,-182.5 \"/>\n<text text-anchor=\"start\" x=\"57.5\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">Boxes</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"7,-159.5 7,-182.5 54,-182.5 54,-159.5 7,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"7,-159.5 54,-159.5 54,-182.5 7,-182.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"54,-159.5 54,-182.5 108,-182.5 108,-159.5 54,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"54,-159.5 54,-182.5 108,-182.5 108,-159.5 54,-159.5\"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"108,-159.5 108,-182.5 155,-182.5 155,-159.5 108,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"155,-182.5 108,-182.5 108,-159.5 155,-159.5 \"/>\n<text text-anchor=\"start\" x=\"112\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"54,-140.5 54,-159.5 \"/>\n<text text-anchor=\"start\" x=\"11\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">box</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"108,-140.5 108,-159.5 \"/>\n<text text-anchor=\"start\" x=\"58\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"111\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- CellularAutomaton -->\n<g id=\"node3\" class=\"node\">\n<title>CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M301.5,-98C301.5,-98 40.5,-98 40.5,-98 34.5,-98 28.5,-92 28.5,-86 28.5,-86 28.5,-12 28.5,-12 28.5,-6 34.5,0 40.5,0 40.5,0 301.5,0 301.5,0 307.5,0 313.5,-6 313.5,-12 313.5,-12 313.5,-86 313.5,-86 313.5,-92 307.5,-98 301.5,-98\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"36,-68 307,-68 \"/>\n<text text-anchor=\"start\" x=\"96\" y=\"-76.8\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">CellularAutomaton</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"36,-45 36,-68 129,-68 129,-45 36,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"36,-45 129,-45 129,-68 36,-68 \"/>\n<text text-anchor=\"start\" x=\"40\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"129,-45 129,-68 234,-68 234,-45 129,-45\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"129,-45 129,-68 234,-68 234,-45 129,-45\"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-45 234,-68 307,-68 307,-45 234,-45\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"307,-68 234,-68 234,-45 307,-45 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-52.8\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"129,-26 129,-45 \"/>\n<text text-anchor=\"start\" x=\"40\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">ca_interval</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-26 234,-45 \"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">viability_range</text>\n<text text-anchor=\"start\" x=\"237\" y=\"-33\" font-family=\"monospace\" font-size=\"10.00\">ca</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"129,-7 129,-26 \"/>\n<text text-anchor=\"start\" x=\"40\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">ca_random_seed</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-7 234,-26 \"/>\n<text text-anchor=\"start\" x=\"133\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">activation_range</text>\n<text text-anchor=\"start\" x=\"237\" y=\"-14\" font-family=\"monospace\" font-size=\"10.00\">ca_priority</text>\n</g>\n<!-- Boxes&#45;&gt;CellularAutomaton -->\n<g id=\"edge1\" class=\"edge\">\n<title>Boxes&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M109.48,-133.74C115.79,-125.15 122.6,-115.88 129.31,-106.75\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"132.33,-108.55 135.43,-98.42 126.69,-104.4 132.33,-108.55\"/>\n</g>\n<!-- FaciesBase -->\n<g id=\"node2\" class=\"node\">\n<title>FaciesBase</title>\n<path fill=\"none\" stroke=\"black\" d=\"M330,-213C330,-213 192,-213 192,-213 186,-213 180,-207 180,-201 180,-201 180,-146 180,-146 180,-140 186,-134 192,-134 192,-134 330,-134 330,-134 336,-134 342,-140 342,-146 342,-146 342,-201 342,-201 342,-207 336,-213 330,-213\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-182.5 335,-182.5 \"/>\n<text text-anchor=\"start\" x=\"217\" y=\"-191.3\" font-family=\"Times,serif\" font-weight=\"bold\" font-size=\"14.00\">FaciesBase</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"187,-159.5 187,-182.5 234,-182.5 234,-159.5 187,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"187,-159.5 234,-159.5 234,-182.5 187,-182.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Input</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"234,-159.5 234,-182.5 288,-182.5 288,-159.5 234,-159.5\"/>\n<polygon fill=\"none\" stroke=\"black\" points=\"234,-159.5 234,-182.5 288,-182.5 288,-159.5 234,-159.5\"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">Facies</text>\n<polygon fill=\"#cccccc\" stroke=\"transparent\" points=\"288,-159.5 288,-182.5 335,-182.5 335,-159.5 288,-159.5\"/>\n<polyline fill=\"none\" stroke=\"black\" points=\"335,-182.5 288,-182.5 288,-159.5 335,-159.5 \"/>\n<text text-anchor=\"start\" x=\"292\" y=\"-167.3\" font-family=\"Times,serif\" font-size=\"14.00\">State</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"234,-140.5 234,-159.5 \"/>\n<text text-anchor=\"start\" x=\"191\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\">facies</text>\n<polyline fill=\"none\" stroke=\"black\" points=\"288,-140.5 288,-159.5 \"/>\n<text text-anchor=\"start\" x=\"238\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n<text text-anchor=\"start\" x=\"291\" y=\"-147.5\" font-family=\"monospace\" font-size=\"10.00\"> </text>\n</g>\n<!-- FaciesBase&#45;&gt;CellularAutomaton -->\n<g id=\"edge2\" class=\"edge\">\n<title>FaciesBase&#45;&gt;CellularAutomaton</title>\n<path fill=\"none\" stroke=\"black\" d=\"M232.52,-133.74C226.21,-125.15 219.4,-115.88 212.69,-106.75\"/>\n<polygon fill=\"black\" stroke=\"black\" points=\"215.31,-104.4 206.57,-98.42 209.67,-108.55 215.31,-104.4\"/>\n</g>\n</g>\n</svg>\n</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"This component implements the cellular automaton as described by [3]. ","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"We depend on the box properties being defined. Each Facies should have a viability_range and activation_range defined. Two other parameters are the ca_interval setting how many time steps between every CA advancement, and the ca_random_seed setting the random seed for generating the initial noise.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-input⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"@kwdef struct Facies <: AbstractFacies\n    viability_range::Tuple{Int,Int} = (4, 10)\n    activation_range::Tuple{Int,Int} = (6, 10)\nend\n\n@kwdef struct Input <: AbstractInput\n    ca_interval::Int      = 1\n    ca_random_seed::Int   = 0\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"The state of the CA is stored in ca and ca_priority.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-state⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"@kwdef mutable struct State <: AbstractState\n    ca::Matrix{Int}\n    ca_priority::Vector{Int}\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"The rules function computes the next value of a cell, given the configured vector of facies, the current facies priority order, and a neighbourhood around the cell.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-step⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"function rules(facies, ca_priority, neighbourhood)\n    cell_facies = neighbourhood[3, 3]\n    neighbour_count(f) = sum(neighbourhood .== f)\n    if cell_facies == 0\n        for f in ca_priority\n            n = neighbour_count(f)\n            (a, b) = facies[f].activation_range\n            if a <= n && n <= b\n                return f\n            end\n        end\n        0\n    else\n        n = neighbour_count(cell_facies) - 1\n        (a, b) = facies[cell_facies].viability_range\n        (a <= n && n <= b ? cell_facies : 0)\n    end\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"The paper talks about cycling the order of preference for occupying an empty cell at each iteration. This means that the rules change slightly every iteration. We need this extra function so that we know the boundary type BT at compile time.","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">⪡ca-step⪢≣</div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"\"\"\"\n    step_ca(box, facies)\n\nCreates a propagator for the state, updating the celullar automaton in place.\n\nContract: the `state` should have `ca::Matrix{Int}` and `ca_priority::Vector{Int}`\nmembers.\n\"\"\"\nfunction step_ca(box::Box{BT}, facies) where {BT<:Boundary{2}}\n    tmp = Matrix{Int}(undef, box.grid_size)\n    facies_ = facies\n\n    function (state)\n        p = state.ca_priority\n        stencil!(BT, Size(5, 5), tmp, state.ca) do nb\n            rules(facies_, p, nb)\n        end\n        state.ca, tmp = tmp, state.ca\n        state.ca_priority = circshift(state.ca_priority, 1)\n        return state\n    end\nend","category":"page"},{"location":"components/cellular-automata/#Plot","page":"Cellular Automata","title":"Plot","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">file:<i>examples/ca/burgess-2013.jl</i></div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"#| creates: [\"docs/src/_fig/ca-long-term.svg\"]\n#| collect: figures\nmodule Script\nusing CarboKitten\nusing CarboKitten.Components: CellularAutomaton as CA\nusing CairoMakie\n\nfunction main()\n  input = CA.Input(\n      box = CarboKitten.Box{Periodic{2}}(\n        grid_size=(50, 50), phys_scale=1.0u\"m\"),\n      facies = fill(CA.Facies(), 3)\n  )\n\n  state = CA.initial_state(input)\n  step! = CA.step!(input)\n\n  for _ in 1:1000\n    step!(state)\n  end\n\n  fig = Figure(size=(1000, 500))\n  axes_indices = Iterators.flatten(eachrow(CartesianIndices((2, 4))))\n  xaxis, yaxis = box_axes(input.box)\n  i = 1000\n  for row in 1:2\n    for col in 1:4\n      ax = Axis(fig[row, col], aspect=AxisAspect(1), title=\"step $(i)\")\n\n      if row == 2\n        ax.xlabel = \"x [m]\"\n      end\n      if col == 1\n        ax.ylabel = \"y [m]\"\n      end\n\n      heatmap!(ax, xaxis/u\"m\", yaxis/u\"m\", state.ca)\n      step!(state)\n      i += 1\n    end\n    for _ in 1:996\n      step!(state)\n      i += 1\n    end\n  end\n  save(\"docs/src/_fig/ca-long-term.svg\", fig)\nend\n\nend\n\nScript.main()","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"(Image: CA)","category":"page"},{"location":"components/cellular-automata/#Tests","page":"Cellular Automata","title":"Tests","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">file:<i>test/Components/CellularAutomatonSpec.jl</i></div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"module CellularAutomatonSpec\n\nusing Test\nusing CarboKitten.Components.Common\nusing CarboKitten.Components: CellularAutomaton as CA\n\n@testset \"Components/CellularAutomaton\" begin\n    let facies = fill(CA.Facies((4, 10), (6, 10)), 3),\n        input1 = CA.Input(\n            box=Box{Periodic{2}}(grid_size=(50, 50), phys_scale=1.0u\"m\"),\n            facies=facies),\n        input2 = CA.Input(\n            box=Box{Periodic{2}}(grid_size=(50, 50), phys_scale=1.0u\"m\"),\n            facies=facies,\n            ca_random_seed=1)\n\n        state1 = CA.initial_state(input1)\n        state2 = CA.initial_state(input2)\n        state3 = CA.initial_state(input2)\n\n        @test CA.initial_state(input1).ca == CA.initial_state(input1).ca\n        @test state1.ca != state2.ca\n\n        step! = CA.step!(input1)  # inputs have same rules\n        for i in 1:20\n            step!(state1)\n            step!(state2)\n            step!(state3)\n        end\n\n        @test state1.ca != state2.ca\n        @test state2.ca == state3.ca\n    end\nend\n\nend","category":"page"},{"location":"components/cellular-automata/#Component","page":"Cellular Automata","title":"Component","text":"","category":"section"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"<div class=\"noweb-label\">file:<i>src/Components/CellularAutomaton.jl</i></div>","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"@compose module CellularAutomaton\n    @mixin Boxes, FaciesBase\n    using ..Common\n    using ...Stencil: stencil!\n    using Random\n\n    <<ca-input>>\n    <<ca-state>>\n    <<ca-step>>\n\n    function initial_state(input::AbstractInput)\n        n_facies = length(input.facies)\n        ca = rand(MersenneTwister(input.ca_random_seed), 0:n_facies, input.box.grid_size...)\n        return State(ca, 1:n_facies |> collect)\n    end\n\n    function step!(input::AbstractInput)\n        return step_ca(input.box, input.facies)\n    end\nend","category":"page"},{"location":"components/cellular-automata/","page":"Cellular Automata","title":"Cellular Automata","text":"","category":"page"}]
}
